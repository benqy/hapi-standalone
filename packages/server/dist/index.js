"use strict";var y_=Object.create;var Qi=Object.defineProperty;var dl=Object.getOwnPropertyDescriptor;var g_=Object.getOwnPropertyNames;var m_=Object.getPrototypeOf,__=Object.prototype.hasOwnProperty;var x=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var v_=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of g_(e))!__.call(t,s)&&s!==r&&Qi(t,s,{get:()=>e[s],enumerable:!(n=dl(e,s))||n.enumerable});return t};var sn=(t,e,r)=>(r=t!=null?y_(m_(t)):{},v_(e||!t||!t.__esModule?Qi(r,"default",{value:t,enumerable:!0}):r,t));var pl=(t,e,r,n)=>{for(var s=n>1?void 0:n?dl(e,r):e,i=t.length-1,o;i>=0;i--)(o=t[i])&&(s=(n?o(e,r,s):o(s))||s);return n&&s&&Qi(e,r,s),s};var ml=x((zT,Yi)=>{var b_=require("fs"),x_=require("path");function yl(t){console.log(`[dotenv][DEBUG] ${t}`)}var S_=`
`,w_=/^\s*([\w.-]+)\s*=\s*(.*)?\s*$/,O_=/\\n/g,E_=/\n|\r|\r\n/;function gl(t,e){let r=!!(e&&e.debug),n={};return t.toString().split(E_).forEach(function(s,i){let o=s.match(w_);if(o!=null){let c=o[1],l=o[2]||"",u=l.length-1,a=l[0]==='"'&&l[u]==='"';l[0]==="'"&&l[u]==="'"||a?(l=l.substring(1,u),a&&(l=l.replace(O_,S_))):l=l.trim(),n[c]=l}else r&&yl(`did not match key and value when parsing line ${i+1}: ${s}`)}),n}function k_(t){let e=x_.resolve(process.cwd(),".env"),r="utf8",n=!1;t&&(t.path!=null&&(e=t.path),t.encoding!=null&&(r=t.encoding),t.debug!=null&&(n=!0));try{let s=gl(b_.readFileSync(e,{encoding:r}),{debug:n});return Object.keys(s).forEach(function(i){Object.prototype.hasOwnProperty.call(process.env,i)?n&&yl(`"${i}" is already defined in \`process.env\` and will not be overwritten`):process.env[i]=s[i]}),{parsed:s}}catch(s){return{error:s}}}Yi.exports.config=k_;Yi.exports.parse=gl});var Le=x((HT,_l)=>{_l.exports={options:{NOT_SUPPORTED_VALUE:"not supported",INTERVAL:1e3},isNotSupported(t){return t===this.options.NOT_SUPPORTED_VALUE}}});var vl=x(()=>{var Ki=Le(),on=require("os");Ki.cpu={average:function(){for(var t=0,e=0,r=on.cpus(),n=0,s=r.length;n<s;n++){var i=r[n];for(var o in i.times)e+=i.times[o];t+=i.times.idle}return{totalIdle:t,totalTick:e,avgIdle:t/r.length,avgTotal:e/r.length}},usage:function(t){var e=this;return t||(t=Ki.options.INTERVAL),new Promise(function(r){if(typeof t!="number")throw new TypeError("interval must be a number!");var n=e.average();setTimeout(function(){var s=e.average(),i=s.avgIdle-n.avgIdle,o=s.avgTotal-n.avgTotal,c=(1e4-Math.round(1e4*i/o))/100;return r(c)},t)})},free:function(t){var e=this;return t||(t=Ki.options.INTERVAL),new Promise(function(r){if(typeof t!="number")throw new TypeError("interval must be a number!");e.usage(t).then(function(n){return r(100-n)})})},count:function(){return on.cpus().length},model:function(){return on.cpus()[0].model},loadavg:function(){return on.loadavg()},loadavgTime:function(t){t=parseInt(t,10);var e=on.loadavg();switch(t){case 5:return e[1];case 15:return e[2];default:return e[0]}}}});var St=x((WT,Xi)=>{var C_=require("child_process"),P_=Le();function bl(t){return new Promise(function(e){var r='LC_ALL="en_US.UTF-8";LANG="en_US.UTF-8";LANGUAGE="en_US:en";'+t;C_.exec(r,{shell:!0},function(n,s,i){return e(n||!s?P_.options.NOT_SUPPORTED_VALUE:s)})})}Xi.exports=bl;Xi.exports.wrapExec=function(t){return function(){return bl(t)}}});var xl=x(()=>{var A_=Le(),I_=St(),R_=/^(\S+)\n?\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(.+?)\n/mg;function T_(t,e){var r={};return t.forEach(function(n,s){r[n]=e[s]}),r}function M_(t){var e=[],r;return t.replace(R_,function(){var n=Array.prototype.slice.call(arguments,1,7);if(arguments[7]===0){r=n;return}e.push(T_(r,n))}),e}A_.drive={info:function(t){return t||(t="/"),I_("df -kP").then(function(e){for(var r=null,n=null,s=M_(e),i=0;i<s.length;i++){if(s[i]["Mounted on"]===t){r=s[i];continue}if(s[i]["Mounted on"]==="/"){n=s[i];continue}}if(r===null){if(n===null)throw new Error("disk name invalid and / not found");console.info("disk name invalid, using / as default"),r=n}var o=Math.ceil(r.Used*1024/Math.pow(1024,2)),c=Math.ceil((r.Available||r.Avail)*1024/Math.pow(1024,2)),l=o+c,u=(l/1024).toFixed(1),a=(o/1024).toFixed(1),f=(c/1024).toFixed(1),h=(100*o/l).toFixed(1),d=(100*c/l).toFixed(1);return Promise.resolve({totalGb:u,usedGb:a,freeGb:f,usedPercentage:h,freePercentage:d})})},free:function(t){var e=this;return e.info(t).then(function(r){return Promise.resolve({totalGb:r.totalGb,freeGb:r.freeGb,freePercentage:r.freePercentage})})},used:function(t){var e=this;return e.info(t).then(function(r){return Promise.resolve({totalGb:r.totalGb,usedGb:r.usedGb,usedPercentage:r.usedPercentage})})}}});var Cr=x((YT,Ol)=>{var Sl=Array.prototype.slice;Ol.exports=kr.default=kr.co=kr;kr.wrap=function(t){return e.__generatorFunction__=t,e;function e(){return kr.call(this,t.apply(this,arguments))}};function kr(t){var e=this,r=Sl.call(arguments,1);return new Promise(function(n,s){if(typeof t=="function"&&(t=t.apply(e,r)),!t||typeof t.next!="function")return n(t);i();function i(l){var u;try{u=t.next(l)}catch(a){return s(a)}c(u)}function o(l){var u;try{u=t.throw(l)}catch(a){return s(a)}c(u)}function c(l){if(l.done)return n(l.value);var u=Zi.call(e,l.value);return u&&eo(u)?u.then(i,o):o(new TypeError('You may only yield a function, promise, generator, array, or object, but the following object was passed: "'+String(l.value)+'"'))}})}function Zi(t){return!t||eo(t)?t:L_(t)||wl(t)?kr.call(this,t):typeof t=="function"?D_.call(this,t):Array.isArray(t)?$_.call(this,t):j_(t)?N_.call(this,t):t}function D_(t){var e=this;return new Promise(function(r,n){t.call(e,function(s,i){if(s)return n(s);arguments.length>2&&(i=Sl.call(arguments,1)),r(i)})})}function $_(t){return Promise.all(t.map(Zi,this))}function N_(t){for(var e=new t.constructor,r=Object.keys(t),n=[],s=0;s<r.length;s++){var i=r[s],o=Zi.call(this,t[i]);o&&eo(o)?c(o,i):e[i]=t[i]}return Promise.all(n).then(function(){return e});function c(l,u){e[u]=void 0,n.push(l.then(function(a){e[u]=a}))}}function eo(t){return typeof t.then=="function"}function wl(t){return typeof t.next=="function"&&typeof t.throw=="function"}function L_(t){var e=t.constructor;return e?e.name==="GeneratorFunction"||e.displayName==="GeneratorFunction"?!0:wl(e.prototype):!1}function j_(t){return Object===t.constructor}});var kl=x(El=>{El.isNumber=function(t){return t!==!0&&t!==!1&&!!(t===0||t&&!isNaN(t))};require("util")});var Il=x(()=>{var to=Le(),Vt=require("os"),q_=require("fs"),Al=Cr(),Cl=kl(),Pl=St(),B_=function(){return new Promise(function(t){q_.readFile("/proc/meminfo","utf8",function(e,r){if(e)return t(to.options.NOT_SUPPORTED_VALUE);var n={},s=r.toString().trim().split(`
`);s.forEach(c=>{var l=c.split(":");n[l[0]]=parseInt(l[1],10)});var i=parseInt(n.MemTotal,10)*1024;n.MemAvailable||(n.MemAvailable=n.MemFree+n.Buffers+n.Cached+n.SReclaimable-n.Shmem);var o=n.MemAvailable*1024;return Vt.release()<"3.14"&&(o=((n.MemFree||0)+(n.Buffers||0)+(n.Cached||0))*1024),t({totalMem:i,freeMem:o})})})},F_=Al.wrap(function*(){var t=Vt.totalmem(),e={"Pages purgeable":"purgeable","Pages wired down":"wired","Pages active":"active","Pages inactive":"inactive","Pages occupied by compressor":"compressed"},[r,n]=yield Promise.all([Pl("vm_stat"),Pl("sysctl vm.page_pageable_internal_count")]);r=r.toString().trim(),n=n.toString().trim();var s=4096,i=/page size of (\d+) bytes/.exec(r);i&&Cl.isNumber(i[1])&&(s=Number(i[1]));var[,o]=n.split(":");if(!Cl.isNumber(o))return{totalMem:t,freeMem:Vt.freemem()};o=Number(o)*s;var c=r.split(`
`).filter(d=>d!==""),l={};c.forEach(d=>{var p=d.split(":"),y=p[0],m=p[1].replace(".","").trim();if(e[y]){var S=e[y];l[S]=m*s}});var u=o-l.purgeable,a=l.wired,f=l.compressed,h=u+a+f;return{totalMem:t,freeMem:t-h}});to.mem={info:Al.wrap(function*(){var t=null,e=null,r=yield B_();if(to.isNotSupported(r)){if(t=Vt.totalmem(),e=Vt.freemem(),Vt.platform()==="darwin"){var n=yield F_();t=n.totalMem,e=n.freeMem}}else t=r.totalMem,e=r.freeMem;var s=parseFloat((t/1024/1024).toFixed(2)),i=parseFloat(((t-e)/1024/1024).toFixed(2)),o=parseFloat((s-i).toFixed(2)),c=parseFloat((100*((t-e)/t)).toFixed(2)),l=parseFloat((100*(e/t)).toFixed(2));return{totalMemMb:s,usedMemMb:i,freeMemMb:o,usedMemPercentage:c,freeMemPercentage:l}}),free:function(){var t=this;return t.info().then(function(e){return Promise.resolve({totalMemMb:e.totalMemMb,freeMemMb:e.freeMemMb})})},used:function(){var t=this;return t.info().then(function(e){return Promise.resolve({totalMemMb:e.totalMemMb,usedMemMb:e.usedMemMb})})},totalMem:function(){return Vt.totalmem()}}});var Dl=x(()=>{var an=Le(),Tl=Cr(),Ml=St(),Rl={breakIntoBlocks:function(e){var r=[],n=e.split(`
`),s=[];return n.forEach(function(i){i.length>0&&["	"," "].indexOf(i[0])===-1&&s.length>0&&(r.push(s),s=[]),i.trim()&&s.push(i)}),s.length>0&&r.push(s),r},parseSingleBlock:function(e){var r={};return e.forEach(function(n,s){var i=n.match(/^(\S+)\s+Link/);if(s===0){var o=n.match(/([a-zA-Z0-9]+):\s/);i===null&&o&&(i=o)}if(i){r.device=i[1];var c={};i=n.match(/encap:(\S+)/),i&&(c.encap=i[1]),i=n.match(/HWaddr\s+(\S+)/),i&&(c.hwaddr=i[1]),r.link=c}else{var l=r.other||{};(i=n.match(/collisions:(\S+)/))&&(l.collisions=parseInt(i[1])),(i=n.match(/txqueuelen:(\S+)/))&&(l.txqueuelen=parseInt(i[1])),(i=n.match(/RX bytes:(\S+)/))&&(l.rxBytes=parseInt(i[1])),(i=n.match(/RX packets (\S+) {2}bytes (\S+)/))&&(l.rxBytes=parseInt(i[2])),(i=n.match(/TX bytes:(\S+)/))&&(l.txBytes=parseInt(i[1])),(i=n.match(/TX packets (\S+) {2}bytes (\S+)/))&&(l.txBytes=parseInt(i[2])),r.other=l}}),r}};function U_(){return Tl(function*(){var t=yield Ml("ifconfig");if(an.isNotSupported(t))return t;var e=Rl.breakIntoBlocks(t),r=[];return e.forEach(function(n,s){e[s]=Rl.parseSingleBlock(n),r[s]={interface:e[s].device,inputBytes:e[s].other&&e[s].other.rxBytes||0,outputBytes:e[s].other&&e[s].other.txBytes||0}}),r})}an.netstat={stats:Tl.wrap(function*(){var t=yield Ml("ip -s link");if(an.isNotSupported(t))return U_();for(var e=new RegExp(/[0-9]+: ([\S]+): /g),r=new RegExp(/^\s+RX:\s+bytes\s+packets\s+errors\s+dropped\s+(overrun|missed)\s+mcast\s*\n\s*([0-9]+)\s+/gm),n=new RegExp(/^\s+TX:\s+bytes\s+packets\s+errors\s+dropped\s+carrier\s+collsns\s*\n\s*([0-9]+)\s+/gm),s=[],i=0,o=[];(o=e.exec(t))!==null;)s[i++]={interface:o[1]};for(i=0;(o=r.exec(t))!==null;)s[i++].inputBytes=o[2];for(i=0;(o=n.exec(t))!==null;)s[i++].outputBytes=o[1];return s}),inOut:function(t){var e=this;return t||(t=an.options.INTERVAL),Promise.all([e.stats(),function(){return new Promise(function(r){setTimeout(function(){e.stats().then(r)},t)})}()]).then(function(r){for(var n=r[0],s=r[1],i={total:{inputMb:0,outputMb:0}},o=0,c=0;c<n.length;c++)n[c].interface!=="lo"&&n[c].interface!=="lo0"&&n[c].inputBytes>0&&n[c].outputBytes>0?(i[n[c].interface]={},i[n[c].interface].inputMb=parseFloat(((s[c].inputBytes-n[c].inputBytes)/1e6).toFixed(2)),i[n[c].interface].outputMb=parseFloat(((s[c].outputBytes-n[c].outputBytes)/1e6).toFixed(2)),i.total.inputMb+=parseFloat(i[n[c].interface].inputMb),i.total.outputMb+=parseFloat(i[n[c].interface].outputMb)):o++;return o===n.length?Promise.resolve(an.options.NOT_SUPPORTED_VALUE):Promise.resolve(i)})}}});var Nl=x(()=>{var $l=Le(),z_=require("fs");$l.openfiles={openFd:function(){return new Promise(function(t){z_.readFile("/proc/sys/fs/file-nr",function(e,r){if(e)return t($l.options.NOT_SUPPORTED_VALUE);var n=r.toString().replace(/\n/g,"").split(" ")[0];return n=parseInt(n,10),t(n)})})}}});var Ll=x(()=>{var H_=Le(),V_=St(),ot=V_.wrapExec;H_.osCmd={topCpu:ot("ps -eo pcpu,user,args --no-headers | sort -k 1 -n | tail -n 10 | sort -k 1 -nr | cut -c 1-70"),topMem:ot("ps -eo pmem,pid,cmd | sort -k 1 -n | tail -n 10 | sort -k 1 -nr | cut -c 1-70"),vmstats:ot("vmstat -S m"),processesUsers:ot("ps hax -o user | sort | uniq -c"),diskUsage:ot("df -h"),who:ot("who"),whoami:ot("whoami"),openPorts:ot("lsof -Pni4 | grep ESTABLISHED"),ifconfig:ot("ifconfig")}});var Ul=x(()=>{var Fl=Le(),jl=require("fs"),je=require("os"),ql=Cr(),Bl=St(),ro={checkLastResort:ql.wrap(function*(){return Bl("uname -sr")}),darwin:function(){var t=this;return ql(function*(){var e=yield Bl("sw_vers");if(Fl.isNotSupported(e))return t.checkLastResort();var r=e.match(/[\n\r].*ProductVersion:\s*([^\n\r]*)/)[1],n=e.match(/.*ProductName:\s*([^\n\r]*)/)[1];return n+" "+r})},linux:function(){var t=this;return new Promise(function(e){jl.readFile("/etc/issue",function(r,n){if(r)return t.checkLastResort(e);n=n.toString();var s=n.match(/[\d]+(\.[\d][\d]?)?/);s!==null&&(s=s[0]);var i=n.match(/[\w]*/)[0];if(s!==null&&i!==null){var o=i+" "+s;return e(o)}else{if(i!==null&&i!=="")return e(i);s===null&&jl.readFile("/etc/redhat-release",function(c,l){if(c)return t.checkLastResort(e);l=l.toString(),s=l.match(/[\d]+(\.[\d][\d]?)?/),s!==null&&(s=s[0]);var u="Red Hat "+s;return e(u)})}})})}};Fl.os={oos:function(){var t=je.platform();return t==="linux"?ro.linux():t==="darwin"?ro.darwin():ro.checkLastResort()},platform:function(){return je.platform()},uptime:function(){return je.uptime()},ip:function(){var t=je.platform(),e=je.networkInterfaces(),r="",n=0;try{if(t==="linux"&&e.eth0){for(n=0;n<e.eth0.length;n++)if(je.networkInterfaces().eth0[n].family==="IPv4"){r=je.networkInterfaces().eth0[n].address;break}return r}if(t==="darwin"){for(n=0;n<e.en0.length;n++)if(je.networkInterfaces().en0[n].family==="IPv4"){r=je.networkInterfaces().en0[n].address;break}return r}for(n in e){var s=e[n];for(var i in s)if(s[i].internal===!1&&s[i].family==="IPv4"){r=s[i].address;break}}}catch{r="LOCALHOST"}return r},hostname:function(){return je.hostname()},type:function(){return je.type()},arch:function(){return je.arch()}}});var Hl=x(()=>{var no=Le(),so=St(),G_=require("os"),zl=Cr();no.proc={totalProcesses:zl.wrap(function*(){var t=yield so("top -bn1 | awk 'NR > 7 && $8 ~ /R|S|D|T/ { print $12 }'");if(no.isNotSupported(t)){if(G_.platform()==="darwin"){var e=yield so("ps -A");return e=e.toString().split(`
`),e.length-1}return t}var r=t.split(`
`).length;return r}),zombieProcesses:zl.wrap(function*(){var t=yield so("top -bn1 | awk 'NR > 7 && $8 ~ /Z/ { print $12 }'");return no.isNotSupported(t)?t:t.split(`
`).length})}});var Gl=x(()=>{var Vl=Le(),W_=St(),J_=Cr();Vl.users={openedCount:J_.wrap(function*(){var t=yield W_("who | grep -v localhost | wc -l");return Vl.isNotSupported(t)?t:parseInt(t,10)})}});var io=x((hM,Wl)=>{vl();xl();Il();Dl();Nl();Ll();Ul();Hl();Gl();Wl.exports=Le()});var oo=x(cn=>{"use strict";Object.defineProperty(cn,"__esModule",{value:!0});var Jl;(function(t){t[t.Interval=0]="Interval",t[t.Timeout=1]="Timeout"})(Jl=cn.Type||(cn.Type={}));var Q_=function(){function t(e,r,n,s){this.active=!0,this.paused=!1,this.elapsedTime=0,this.handler=e,this.args=r,this.time=n,this.type=s}return t.prototype.tick=function(e){this.paused||(this.elapsedTime+=e,this.elapsedTime>=this.time&&this.execute())},t.prototype.execute=function(){this.handler.apply(this,this.args),this.type===Jl.Timeout?this.active=!1:this.elapsedTime-=this.time},t.prototype.reset=function(){this.elapsedTime=0},t.prototype.pause=function(){this.paused=!0},t.prototype.resume=function(){this.paused=!1},t.prototype.clear=function(){this.active=!1},t}();cn.Delayed=Q_});var Yl=x((pM,Ql)=>{"use strict";var Y_=function(){function t(e){e===void 0&&(e=!1),this.running=!1,this.now=typeof window<"u"&&window.performance&&window.performance.now&&window.performance.now.bind(window.performance)||Date.now,this.start(e)}return t.prototype.start=function(e){e===void 0&&(e=!1),this.deltaTime=0,this.currentTime=this.now(),this.elapsedTime=0,this.running=!0,e&&(this._interval=setInterval(this.tick.bind(this),16.666666666666668))},t.prototype.stop=function(){this.running=!1,this._interval&&clearInterval(this._interval)},t.prototype.tick=function(e){e===void 0&&(e=this.now()),this.deltaTime=e-this.currentTime,this.currentTime=e,this.elapsedTime+=this.deltaTime},t}();Ql.exports=Y_});var Kl=x(un=>{"use strict";var K_=un&&un.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,s){n.__proto__=s}||function(n,s){for(var i in s)s.hasOwnProperty(i)&&(n[i]=s[i])},t(e,r)};return function(e,r){t(e,r);function n(){this.constructor=e}e.prototype=r===null?Object.create(r):(n.prototype=r.prototype,new n)}}();Object.defineProperty(un,"__esModule",{value:!0});var X_=Yl(),ts=oo(),Z_=function(t){K_(e,t);function e(r){r===void 0&&(r=!1);var n=t.call(this,r)||this;return n.delayed=[],n}return e.prototype.tick=function(){t.prototype.tick.call(this);for(var r=this.delayed,n=r.length;n--;){var s=r[n];if(s.active)s.tick(this.deltaTime);else{r.splice(n,1);continue}}},e.prototype.setInterval=function(r,n){for(var s=[],i=2;i<arguments.length;i++)s[i-2]=arguments[i];var o=new ts.Delayed(r,s,n,ts.Type.Interval);return this.delayed.push(o),o},e.prototype.setTimeout=function(r,n){for(var s=[],i=2;i<arguments.length;i++)s[i-2]=arguments[i];var o=new ts.Delayed(r,s,n,ts.Type.Timeout);return this.delayed.push(o),o},e.prototype.clear=function(){for(var r=this.delayed.length;r--;)this.delayed[r].clear();this.delayed=[]},e}(X_);un.ClockTimer=Z_});var ao=x(ln=>{"use strict";Object.defineProperty(ln,"__esModule",{value:!0});var Xl=oo();ln.Delayed=Xl.Delayed;ln.Type=Xl.Type;var ev=Kl();ln.default=ev.ClockTimer});var tf=x((mM,ef)=>{var co=Object.defineProperty,tv=Object.getOwnPropertyDescriptor,rv=Object.getOwnPropertyNames,nv=Object.prototype.hasOwnProperty,sv=(t,e)=>{for(var r in e)co(t,r,{get:e[r],enumerable:!0})},iv=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of rv(e))!nv.call(t,s)&&s!==r&&co(t,s,{get:()=>e[s],enumerable:!(n=tv(e,s))||n.enumerable});return t},ov=t=>iv(co({},"__esModule",{value:!0}),t),Zl={};sv(Zl,{default:()=>av});ef.exports=ov(Zl);var av=process.env.COLYSEUS_CLOUD?String.raw`
   ______      __                              ________                __
  / ____/___  / /_  __________  __  _______   / ____/ /___  __  ______/ /
 / /   / __ \/ / / / / ___/ _ \/ / / / ___/  / /   / / __ \/ / / / __  /
/ /___/ /_/ / / /_/ (__  )  __/ /_/ (__  )  / /___/ / /_/ / /_/ / /_/ /
\____/\____/_/\__, /____/\___/\__,_/____/   \____/_/\____/\__,_/\__,_/
             /____/

ðŸš€ Thank you for using Colyseus Cloud
â“ If you need help please reach out on support@colyseus.io
`:String.raw`
       ___      _
      / __\___ | |_   _ ___  ___ _   _ ___
     / /  / _ \| | | | / __|/ _ \ | | / __|
    / /__| (_) | | |_| \__ \  __/ |_| \__ \
    \____/\___/|_|\__, |___/\___|\__,_|___/
                  |___/

Multiplayer Framework for Node.js Â· Open-source

ðŸ’– Sponsor Colyseus on GitHub â†’ https://github.com/sponsors/endel
ðŸŒŸ Give it a star on GitHub â†’ https://github.com/colyseus/colyseus
â˜ï¸  Deploy and scale your project on Colyseus Cloud â†’ https://cloud.colyseus.io
`});var nf=x((_M,rf)=>{var Pr=1e3,Ar=Pr*60,Ir=Ar*60,Gt=Ir*24,cv=Gt*7,uv=Gt*365.25;rf.exports=function(t,e){e=e||{};var r=typeof t;if(r==="string"&&t.length>0)return lv(t);if(r==="number"&&isFinite(t))return e.long?hv(t):fv(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))};function lv(t){if(t=String(t),!(t.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(e){var r=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return r*uv;case"weeks":case"week":case"w":return r*cv;case"days":case"day":case"d":return r*Gt;case"hours":case"hour":case"hrs":case"hr":case"h":return r*Ir;case"minutes":case"minute":case"mins":case"min":case"m":return r*Ar;case"seconds":case"second":case"secs":case"sec":case"s":return r*Pr;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}function fv(t){var e=Math.abs(t);return e>=Gt?Math.round(t/Gt)+"d":e>=Ir?Math.round(t/Ir)+"h":e>=Ar?Math.round(t/Ar)+"m":e>=Pr?Math.round(t/Pr)+"s":t+"ms"}function hv(t){var e=Math.abs(t);return e>=Gt?rs(t,e,Gt,"day"):e>=Ir?rs(t,e,Ir,"hour"):e>=Ar?rs(t,e,Ar,"minute"):e>=Pr?rs(t,e,Pr,"second"):t+" ms"}function rs(t,e,r,n){var s=e>=r*1.5;return Math.round(t/r)+" "+n+(s?"s":"")}});var uo=x((vM,sf)=>{function dv(t){r.debug=r,r.default=r,r.coerce=l,r.disable=i,r.enable=s,r.enabled=o,r.humanize=nf(),r.destroy=u,Object.keys(t).forEach(a=>{r[a]=t[a]}),r.names=[],r.skips=[],r.formatters={};function e(a){let f=0;for(let h=0;h<a.length;h++)f=(f<<5)-f+a.charCodeAt(h),f|=0;return r.colors[Math.abs(f)%r.colors.length]}r.selectColor=e;function r(a){let f,h=null,d,p;function y(...m){if(!y.enabled)return;let S=y,R=Number(new Date),w=R-(f||R);S.diff=w,S.prev=f,S.curr=R,f=R,m[0]=r.coerce(m[0]),typeof m[0]!="string"&&m.unshift("%O");let E=0;m[0]=m[0].replace(/%([a-zA-Z%])/g,(T,O)=>{if(T==="%%")return"%";E++;let P=r.formatters[O];if(typeof P=="function"){let j=m[E];T=P.call(S,j),m.splice(E,1),E--}return T}),r.formatArgs.call(S,m),(S.log||r.log).apply(S,m)}return y.namespace=a,y.useColors=r.useColors(),y.color=r.selectColor(a),y.extend=n,y.destroy=r.destroy,Object.defineProperty(y,"enabled",{enumerable:!0,configurable:!1,get:()=>h!==null?h:(d!==r.namespaces&&(d=r.namespaces,p=r.enabled(a)),p),set:m=>{h=m}}),typeof r.init=="function"&&r.init(y),y}function n(a,f){let h=r(this.namespace+(typeof f>"u"?":":f)+a);return h.log=this.log,h}function s(a){r.save(a),r.namespaces=a,r.names=[],r.skips=[];let f,h=(typeof a=="string"?a:"").split(/[\s,]+/),d=h.length;for(f=0;f<d;f++)h[f]&&(a=h[f].replace(/\*/g,".*?"),a[0]==="-"?r.skips.push(new RegExp("^"+a.slice(1)+"$")):r.names.push(new RegExp("^"+a+"$")))}function i(){let a=[...r.names.map(c),...r.skips.map(c).map(f=>"-"+f)].join(",");return r.enable(""),a}function o(a){if(a[a.length-1]==="*")return!0;let f,h;for(f=0,h=r.skips.length;f<h;f++)if(r.skips[f].test(a))return!1;for(f=0,h=r.names.length;f<h;f++)if(r.names[f].test(a))return!0;return!1}function c(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function l(a){return a instanceof Error?a.stack||a.message:a}function u(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return r.enable(r.load()),r}sf.exports=dv});var of=x((Re,ns)=>{Re.formatArgs=yv;Re.save=gv;Re.load=mv;Re.useColors=pv;Re.storage=_v();Re.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();Re.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function pv(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function yv(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+ns.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;t.splice(1,0,e,"color: inherit");let r=0,n=0;t[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(r++,s==="%c"&&(n=r))}),t.splice(n,0,e)}Re.log=console.debug||console.log||(()=>{});function gv(t){try{t?Re.storage.setItem("debug",t):Re.storage.removeItem("debug")}catch{}}function mv(){let t;try{t=Re.storage.getItem("debug")}catch{}return!t&&typeof process<"u"&&"env"in process&&(t=process.env.DEBUG),t}function _v(){try{return localStorage}catch{}}ns.exports=uo()(Re);var{formatters:vv}=ns.exports;vv.j=function(t){try{return JSON.stringify(t)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var cf=x((bM,af)=>{"use strict";af.exports=(t,e=process.argv)=>{let r=t.startsWith("-")?"":t.length===1?"-":"--",n=e.indexOf(r+t),s=e.indexOf("--");return n!==-1&&(s===-1||n<s)}});var ff=x((xM,lf)=>{"use strict";var bv=require("os"),uf=require("tty"),qe=cf(),{env:ue}=process,wt;qe("no-color")||qe("no-colors")||qe("color=false")||qe("color=never")?wt=0:(qe("color")||qe("colors")||qe("color=true")||qe("color=always"))&&(wt=1);"FORCE_COLOR"in ue&&(ue.FORCE_COLOR==="true"?wt=1:ue.FORCE_COLOR==="false"?wt=0:wt=ue.FORCE_COLOR.length===0?1:Math.min(parseInt(ue.FORCE_COLOR,10),3));function lo(t){return t===0?!1:{level:t,hasBasic:!0,has256:t>=2,has16m:t>=3}}function fo(t,e){if(wt===0)return 0;if(qe("color=16m")||qe("color=full")||qe("color=truecolor"))return 3;if(qe("color=256"))return 2;if(t&&!e&&wt===void 0)return 0;let r=wt||0;if(ue.TERM==="dumb")return r;if(process.platform==="win32"){let n=bv.release().split(".");return Number(n[0])>=10&&Number(n[2])>=10586?Number(n[2])>=14931?3:2:1}if("CI"in ue)return["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","GITHUB_ACTIONS","BUILDKITE"].some(n=>n in ue)||ue.CI_NAME==="codeship"?1:r;if("TEAMCITY_VERSION"in ue)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(ue.TEAMCITY_VERSION)?1:0;if(ue.COLORTERM==="truecolor")return 3;if("TERM_PROGRAM"in ue){let n=parseInt((ue.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(ue.TERM_PROGRAM){case"iTerm.app":return n>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(ue.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(ue.TERM)||"COLORTERM"in ue?1:r}function xv(t){let e=fo(t,t&&t.isTTY);return lo(e)}lf.exports={supportsColor:xv,stdout:lo(fo(!0,uf.isatty(1))),stderr:lo(fo(!0,uf.isatty(2)))}});var df=x((fe,is)=>{var Sv=require("tty"),ss=require("util");fe.init=Av;fe.log=kv;fe.formatArgs=Ov;fe.save=Cv;fe.load=Pv;fe.useColors=wv;fe.destroy=ss.deprecate(()=>{},"Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.");fe.colors=[6,2,3,4,5,1];try{let t=ff();t&&(t.stderr||t).level>=2&&(fe.colors=[20,21,26,27,32,33,38,39,40,41,42,43,44,45,56,57,62,63,68,69,74,75,76,77,78,79,80,81,92,93,98,99,112,113,128,129,134,135,148,149,160,161,162,163,164,165,166,167,168,169,170,171,172,173,178,179,184,185,196,197,198,199,200,201,202,203,204,205,206,207,208,209,214,215,220,221])}catch{}fe.inspectOpts=Object.keys(process.env).filter(t=>/^debug_/i.test(t)).reduce((t,e)=>{let r=e.substring(6).toLowerCase().replace(/_([a-z])/g,(s,i)=>i.toUpperCase()),n=process.env[e];return/^(yes|on|true|enabled)$/i.test(n)?n=!0:/^(no|off|false|disabled)$/i.test(n)?n=!1:n==="null"?n=null:n=Number(n),t[r]=n,t},{});function wv(){return"colors"in fe.inspectOpts?!!fe.inspectOpts.colors:Sv.isatty(process.stderr.fd)}function Ov(t){let{namespace:e,useColors:r}=this;if(r){let n=this.color,s="\x1B[3"+(n<8?n:"8;5;"+n),i=`  ${s};1m${e} \x1B[0m`;t[0]=i+t[0].split(`
`).join(`
`+i),t.push(s+"m+"+is.exports.humanize(this.diff)+"\x1B[0m")}else t[0]=Ev()+e+" "+t[0]}function Ev(){return fe.inspectOpts.hideDate?"":new Date().toISOString()+" "}function kv(...t){return process.stderr.write(ss.format(...t)+`
`)}function Cv(t){t?process.env.DEBUG=t:delete process.env.DEBUG}function Pv(){return process.env.DEBUG}function Av(t){t.inspectOpts={};let e=Object.keys(fe.inspectOpts);for(let r=0;r<e.length;r++)t.inspectOpts[e[r]]=fe.inspectOpts[e[r]]}is.exports=uo()(fe);var{formatters:hf}=is.exports;hf.o=function(t){return this.inspectOpts.colors=this.useColors,ss.inspect(t,this.inspectOpts).split(`
`).map(e=>e.trim()).join(" ")};hf.O=function(t){return this.inspectOpts.colors=this.useColors,ss.inspect(t,this.inspectOpts)}});var os=x((SM,ho)=>{typeof process>"u"||process.type==="renderer"||process.browser===!0||process.__nwjs?ho.exports=of():ho.exports=df()});var Ot=x((wM,yf)=>{var yo=Object.defineProperty,Iv=Object.getOwnPropertyDescriptor,Rv=Object.getOwnPropertyNames,Tv=Object.prototype.hasOwnProperty,Mv=(t,e)=>{for(var r in e)yo(t,r,{get:e[r],enumerable:!0})},Dv=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Rv(e))!Tv.call(t,s)&&s!==r&&yo(t,s,{get:()=>e[s],enumerable:!(n=Iv(e,s))||n.enumerable});return t},$v=t=>Dv(yo({},"__esModule",{value:!0}),t),pf={};Mv(pf,{Logger:()=>po,logger:()=>Wt,setLogger:()=>Nv});yf.exports=$v(pf);var po=class{debug(...e){Wt.debug(...e)}error(...e){Wt.error(...e)}info(...e){Wt.info(...e)}trace(...e){Wt.trace(...e)}warn(...e){Wt.warn(...e)}},Wt=console;function Nv(t){Wt=t}});var Pf=x((OM,Cf)=>{var _f=require("fs"),Be=require("path"),Lv=require("url"),jv=process.config&&process.config.variables||{},qv=!!process.env.PREBUILDS_ONLY,bo=process.versions,mo=bo.modules;(bo.deno||process.isBun)&&(mo="unsupported");var go=Fv()?"electron":"node",as=process.arch,cs=process.platform,vf=process.env.LIBC||(Uv(cs)?"musl":"glibc"),_o=process.env.ARM_VERSION||(as==="arm64"?"8":jv.arm_version)||"",bf=(bo.uv||"").split(".")[0];Cf.exports=Je;function Je(t){return typeof __webpack_require__=="function"?__non_webpack_require__(Je.path(t)):require(Je.path(t))}Je.path=function(t){t=Be.resolve(t||".");var e;try{typeof __webpack_require__=="function"?e=__non_webpack_require__(Be.join(t,"package.json")).name:e=require(Be.join(t,"package.json")).name;var r=e.toUpperCase().replace(/-/g,"_")+"_PREBUILD";process.env[r]&&(t=process.env[r])}catch{}if(!qv){var n=gf(Be.join(t,"build/Release"),mf);if(n)return n;var s=gf(Be.join(t,"build/Debug"),mf);if(s)return s}var i=a(t);if(i)return i;var o=a(Be.dirname(process.execPath));if(o)return o;var c=(e[0]=="@"?"":"@"+e+"/")+e+"-"+cs+"-"+as;try{var l=Be.dirname(require("module").createRequire(Lv.pathToFileURL(Be.join(t,"package.json"))).resolve(c));return f(l)}catch{}var u=["platform="+cs,"arch="+as,"runtime="+go,"abi="+mo,"uv="+bf,_o?"armv="+_o:"","libc="+vf,"node="+process.versions.node,process.versions.electron?"electron="+process.versions.electron:"",typeof __webpack_require__=="function"?"webpack=true":""].filter(Boolean).join(" ");throw new Error("No native build was found for "+u+`
    loaded from: `+t+" and package: "+c+`
`);function a(h){var d=vo(Be.join(h,"prebuilds")).map(xf),p=d.filter(Sf(cs,as)).sort(wf)[0];if(p)return f(Be.join(h,"prebuilds",p.name))}function f(h){var d=vo(h).map(Of),p=d.filter(Ef(go,mo)),y=p.sort(kf(go))[0];if(y)return Be.join(h,y.file)}};function vo(t){try{return _f.readdirSync(t)}catch{return[]}}function gf(t,e){var r=vo(t).filter(e);return r[0]&&Be.join(t,r[0])}function mf(t){return/\.node$/.test(t)}function xf(t){var e=t.split("-");if(e.length===2){var r=e[0],n=e[1].split("+");if(r&&n.length&&n.every(Boolean))return{name:t,platform:r,architectures:n}}}function Sf(t,e){return function(r){return r==null||r.platform!==t?!1:r.architectures.includes(e)}}function wf(t,e){return t.architectures.length-e.architectures.length}function Of(t){var e=t.split("."),r=e.pop(),n={file:t,specificity:0};if(r==="node"){for(var s=0;s<e.length;s++){var i=e[s];if(i==="node"||i==="electron"||i==="node-webkit")n.runtime=i;else if(i==="napi")n.napi=!0;else if(i.slice(0,3)==="abi")n.abi=i.slice(3);else if(i.slice(0,2)==="uv")n.uv=i.slice(2);else if(i.slice(0,4)==="armv")n.armv=i.slice(4);else if(i==="glibc"||i==="musl")n.libc=i;else continue;n.specificity++}return n}}function Ef(t,e){return function(r){return!(r==null||r.runtime!==t&&!Bv(r)||r.abi!==e&&!r.napi||r.uv&&r.uv!==bf||r.armv&&r.armv!==_o||r.libc&&r.libc!==vf)}}function Bv(t){return t.runtime==="node"&&t.napi}function kf(t){return function(e,r){return e.runtime!==r.runtime?e.runtime===t?-1:1:e.abi!==r.abi?e.abi?-1:1:e.specificity!==r.specificity?e.specificity>r.specificity?-1:1:0}}function Fv(){return process.versions&&process.versions.electron||process.env.ELECTRON_RUN_AS_NODE?!0:typeof window<"u"&&window.process&&window.process.type==="renderer"}function Uv(t){return t==="linux"&&_f.existsSync("/etc/alpine-release")}Je.parseTags=Of;Je.matchTags=Ef;Je.compareTags=kf;Je.parseTuple=xf;Je.matchTuple=Sf;Je.compareTuples=wf});var If=x((EM,Af)=>{Af.exports=Pf()(__dirname)});var Ss=x(V=>{"use strict";var Vf=require("stream"),zv=require("module"),So;try{So=new TextDecoder}catch{}var M,Me,g=0,Po=[],Yt=Po,dn=0,Q={},H,ct,Te=0,Fe=0,ie,ut,_e=[],U,Rf={useRecords:!1,mapsAsObjects:!0},ps=class{},Ao=new ps;Ao.name="MessagePack 0xC1";var Et=!1,Gf=2,wo,Oo,Eo;try{new Function("")}catch{Gf=1/0}var kt=class t{constructor(e){e&&(e.useRecords===!1&&e.mapsAsObjects===void 0&&(e.mapsAsObjects=!0),e.sequential&&e.trusted!==!1&&(e.trusted=!0,!e.structures&&e.useRecords!=!1&&(e.structures=[],e.maxSharedStructures||(e.maxSharedStructures=0))),e.structures?e.structures.sharedLength=e.structures.length:e.getStructures&&((e.structures=[]).uninitialized=!0,e.structures.sharedLength=0),e.int64AsNumber&&(e.int64AsType="number")),Object.assign(this,e)}unpack(e,r){if(M)return eh(()=>(gs(),this?this.unpack(e,r):t.prototype.unpack.call(Rf,e,r)));!e.buffer&&e.constructor===ArrayBuffer&&(e=typeof Buffer<"u"?Buffer.from(e):new Uint8Array(e)),typeof r=="object"?(Me=r.end||e.length,g=r.start||0):(g=0,Me=r>-1?r:e.length),dn=0,Fe=0,ct=null,Yt=Po,ie=null,M=e;try{U=e.dataView||(e.dataView=new DataView(e.buffer,e.byteOffset,e.byteLength))}catch(n){throw M=null,e instanceof Uint8Array?n:new Error("Source must be a Uint8Array or Buffer but was a "+(e&&typeof e=="object"?e.constructor.name:typeof e))}if(this instanceof t){if(Q=this,this.structures)return H=this.structures,us(r);(!H||H.length>0)&&(H=[])}else Q=Rf,(!H||H.length>0)&&(H=[]);return us(r)}unpackMultiple(e,r){let n,s=0;try{Et=!0;let i=e.length,o=this?this.unpack(e,i):bs.unpack(e,i);if(r){if(r(o,s,g)===!1)return;for(;g<i;)if(s=g,r(us(),s,g)===!1)return}else{for(n=[o];g<i;)s=g,n.push(us());return n}}catch(i){throw i.lastPosition=s,i.values=n,i}finally{Et=!1,gs()}}_mergeStructures(e,r){Oo&&(e=Oo.call(this,e)),e=e||[],Object.isFrozen(e)&&(e=e.map(n=>n.slice(0)));for(let n=0,s=e.length;n<s;n++){let i=e[n];i&&(i.isShared=!0,n>=32&&(i.highByte=n-32>>5))}e.sharedLength=e.length;for(let n in r||[])if(n>=0){let s=e[n],i=r[n];i&&(s&&((e.restoreStructures||(e.restoreStructures=[]))[n]=s),e[n]=i)}return this.structures=e}decode(e,r){return this.unpack(e,r)}};function us(t){try{if(!Q.trusted&&!Et){let r=H.sharedLength||0;r<H.length&&(H.length=r)}let e;if(Q.randomAccessStructure&&M[g]<64&&M[g]>=32&&wo?(e=wo(M,g,Me,Q),M=null,!(t&&t.lazy)&&e&&(e=e.toJSON()),g=Me):e=re(),ie&&(g=ie.postBundlePosition,ie=null),Et&&(H.restoreStructures=null),g==Me)H&&H.restoreStructures&&Tf(),H=null,M=null,ut&&(ut=null);else{if(g>Me)throw new Error("Unexpected end of MessagePack data");if(!Et){let r;try{r=JSON.stringify(e,(n,s)=>typeof s=="bigint"?`${s}n`:s).slice(0,100)}catch(n){r="(JSON view not available "+n+")"}throw new Error("Data read, but end of buffer not reached "+r)}}return e}catch(e){throw H&&H.restoreStructures&&Tf(),gs(),(e instanceof RangeError||e.message.startsWith("Unexpected end of buffer")||g>Me)&&(e.incomplete=!0),e}}function Tf(){for(let t in H.restoreStructures)H[t]=H.restoreStructures[t];H.restoreStructures=null}function re(){let t=M[g++];if(t<160)if(t<128){if(t<64)return t;{let e=H[t&63]||Q.getStructures&&Wf()[t&63];return e?(e.read||(e.read=Io(e,t&63)),e.read()):t}}else if(t<144)if(t-=128,Q.mapsAsObjects){let e={};for(let r=0;r<t;r++){let n=Xf();n==="__proto__"&&(n="__proto_"),e[n]=re()}return e}else{let e=new Map;for(let r=0;r<t;r++)e.set(re(),re());return e}else{t-=144;let e=new Array(t);for(let r=0;r<t;r++)e[r]=re();return Q.freezeData?Object.freeze(e):e}else if(t<192){let e=t-160;if(Fe>=g)return ct.slice(g-Te,(g+=e)-Te);if(Fe==0&&Me<140){let r=e<16?Ro(e):Kf(e);if(r!=null)return r}return ys(e)}else{let e;switch(t){case 192:return null;case 193:return ie?(e=re(),e>0?ie[1].slice(ie.position1,ie.position1+=e):ie[0].slice(ie.position0,ie.position0-=e)):Ao;case 194:return!1;case 195:return!0;case 196:if(e=M[g++],e===void 0)throw new Error("Unexpected end of buffer");return xo(e);case 197:return e=U.getUint16(g),g+=2,xo(e);case 198:return e=U.getUint32(g),g+=4,xo(e);case 199:return Jt(M[g++]);case 200:return e=U.getUint16(g),g+=2,Jt(e);case 201:return e=U.getUint32(g),g+=4,Jt(e);case 202:if(e=U.getFloat32(g),Q.useFloat32>2){let r=Mr[(M[g]&127)<<1|M[g+1]>>7];return g+=4,(r*e+(e>0?.5:-.5)>>0)/r}return g+=4,e;case 203:return e=U.getFloat64(g),g+=8,e;case 204:return M[g++];case 205:return e=U.getUint16(g),g+=2,e;case 206:return e=U.getUint32(g),g+=4,e;case 207:return Q.int64AsType==="number"?(e=U.getUint32(g)*4294967296,e+=U.getUint32(g+4)):Q.int64AsType==="string"?e=U.getBigUint64(g).toString():Q.int64AsType==="auto"?(e=U.getBigUint64(g),e<=BigInt(2)<<BigInt(52)&&(e=Number(e))):e=U.getBigUint64(g),g+=8,e;case 208:return U.getInt8(g++);case 209:return e=U.getInt16(g),g+=2,e;case 210:return e=U.getInt32(g),g+=4,e;case 211:return Q.int64AsType==="number"?(e=U.getInt32(g)*4294967296,e+=U.getUint32(g+4)):Q.int64AsType==="string"?e=U.getBigInt64(g).toString():Q.int64AsType==="auto"?(e=U.getBigInt64(g),e>=BigInt(-2)<<BigInt(52)&&e<=BigInt(2)<<BigInt(52)&&(e=Number(e))):e=U.getBigInt64(g),g+=8,e;case 212:if(e=M[g++],e==114)return jf(M[g++]&63);{let r=_e[e];if(r)return r.read?(g++,r.read(re())):r.noBuffer?(g++,r()):r(M.subarray(g,++g));throw new Error("Unknown extension "+e)}case 213:return e=M[g],e==114?(g++,jf(M[g++]&63,M[g++])):Jt(2);case 214:return Jt(4);case 215:return Jt(8);case 216:return Jt(16);case 217:return e=M[g++],Fe>=g?ct.slice(g-Te,(g+=e)-Te):Jf(e);case 218:return e=U.getUint16(g),g+=2,Fe>=g?ct.slice(g-Te,(g+=e)-Te):Qf(e);case 219:return e=U.getUint32(g),g+=4,Fe>=g?ct.slice(g-Te,(g+=e)-Te):Yf(e);case 220:return e=U.getUint16(g),g+=2,Df(e);case 221:return e=U.getUint32(g),g+=4,Df(e);case 222:return e=U.getUint16(g),g+=2,$f(e);case 223:return e=U.getUint32(g),g+=4,$f(e);default:if(t>=224)return t-256;if(t===void 0){let r=new Error("Unexpected end of MessagePack data");throw r.incomplete=!0,r}throw new Error("Unknown MessagePack token "+t)}}}var Hv=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function Io(t,e){function r(){if(r.count++>Gf){let s=t.read=new Function("r","return function(){return "+(Q.freezeData?"Object.freeze":"")+"({"+t.map(i=>i==="__proto__"?"__proto_:r()":Hv.test(i)?i+":r()":"["+JSON.stringify(i)+"]:r()").join(",")+"})}")(re);return t.highByte===0&&(t.read=Mf(e,t.read)),s()}let n={};for(let s=0,i=t.length;s<i;s++){let o=t[s];o==="__proto__"&&(o="__proto_"),n[o]=re()}return Q.freezeData?Object.freeze(n):n}return r.count=0,t.highByte===0?Mf(e,r):r}var Mf=(t,e)=>function(){let r=M[g++];if(r===0)return e();let n=t<32?-(t+(r<<5)):t+(r<<5),s=H[n]||Wf()[n];if(!s)throw new Error("Record id is not defined for "+n);return s.read||(s.read=Io(s,t)),s.read()};function Wf(){let t=eh(()=>(M=null,Q.getStructures()));return H=Q._mergeStructures(t,H)}var ys=Kt,Jf=Kt,Qf=Kt,Yf=Kt;V.isNativeAccelerationEnabled=!1;function Vv(t){V.isNativeAccelerationEnabled=!0,ys=e(1),Jf=e(2),Qf=e(3),Yf=e(5);function e(r){return function(s){let i=Yt[dn++];if(i==null){if(ie)return Kt(s);let c=M.byteOffset,l=t(g-r+c,Me+c,M.buffer);if(typeof l=="string")i=l,Yt=Po;else if(Yt=l,dn=1,Fe=1,i=Yt[0],i===void 0)throw new Error("Unexpected end of buffer")}let o=i.length;return o<=s?(g+=s,i):(ct=i,Te=g,Fe=g+o,g+=s,i.slice(0,s))}}}function Kt(t){let e;if(t<16&&(e=Ro(t)))return e;if(t>64&&So)return So.decode(M.subarray(g,g+=t));let r=g+t,n=[];for(e="";g<r;){let s=M[g++];if(!(s&128))n.push(s);else if((s&224)===192){let i=M[g++]&63;n.push((s&31)<<6|i)}else if((s&240)===224){let i=M[g++]&63,o=M[g++]&63;n.push((s&31)<<12|i<<6|o)}else if((s&248)===240){let i=M[g++]&63,o=M[g++]&63,c=M[g++]&63,l=(s&7)<<18|i<<12|o<<6|c;l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|l&1023),n.push(l)}else n.push(s);n.length>=4096&&(e+=le.apply(String,n),n.length=0)}return n.length>0&&(e+=le.apply(String,n)),e}function Gv(t,e,r){let n=M;M=t,g=e;try{return Kt(r)}finally{M=n}}function Df(t){let e=new Array(t);for(let r=0;r<t;r++)e[r]=re();return Q.freezeData?Object.freeze(e):e}function $f(t){if(Q.mapsAsObjects){let e={};for(let r=0;r<t;r++){let n=Xf();n==="__proto__"&&(n="__proto_"),e[n]=re()}return e}else{let e=new Map;for(let r=0;r<t;r++)e.set(re(),re());return e}}var le=String.fromCharCode;function Kf(t){let e=g,r=new Array(t);for(let n=0;n<t;n++){let s=M[g++];if((s&128)>0){g=e;return}r[n]=s}return le.apply(String,r)}function Ro(t){if(t<4)if(t<2){if(t===0)return"";{let e=M[g++];if((e&128)>1){g-=1;return}return le(e)}}else{let e=M[g++],r=M[g++];if((e&128)>0||(r&128)>0){g-=2;return}if(t<3)return le(e,r);let n=M[g++];if((n&128)>0){g-=3;return}return le(e,r,n)}else{let e=M[g++],r=M[g++],n=M[g++],s=M[g++];if((e&128)>0||(r&128)>0||(n&128)>0||(s&128)>0){g-=4;return}if(t<6){if(t===4)return le(e,r,n,s);{let i=M[g++];if((i&128)>0){g-=5;return}return le(e,r,n,s,i)}}else if(t<8){let i=M[g++],o=M[g++];if((i&128)>0||(o&128)>0){g-=6;return}if(t<7)return le(e,r,n,s,i,o);let c=M[g++];if((c&128)>0){g-=7;return}return le(e,r,n,s,i,o,c)}else{let i=M[g++],o=M[g++],c=M[g++],l=M[g++];if((i&128)>0||(o&128)>0||(c&128)>0||(l&128)>0){g-=8;return}if(t<10){if(t===8)return le(e,r,n,s,i,o,c,l);{let u=M[g++];if((u&128)>0){g-=9;return}return le(e,r,n,s,i,o,c,l,u)}}else if(t<12){let u=M[g++],a=M[g++];if((u&128)>0||(a&128)>0){g-=10;return}if(t<11)return le(e,r,n,s,i,o,c,l,u,a);let f=M[g++];if((f&128)>0){g-=11;return}return le(e,r,n,s,i,o,c,l,u,a,f)}else{let u=M[g++],a=M[g++],f=M[g++],h=M[g++];if((u&128)>0||(a&128)>0||(f&128)>0||(h&128)>0){g-=12;return}if(t<14){if(t===12)return le(e,r,n,s,i,o,c,l,u,a,f,h);{let d=M[g++];if((d&128)>0){g-=13;return}return le(e,r,n,s,i,o,c,l,u,a,f,h,d)}}else{let d=M[g++],p=M[g++];if((d&128)>0||(p&128)>0){g-=14;return}if(t<15)return le(e,r,n,s,i,o,c,l,u,a,f,h,d,p);let y=M[g++];if((y&128)>0){g-=15;return}return le(e,r,n,s,i,o,c,l,u,a,f,h,d,p,y)}}}}}function Nf(){let t=M[g++],e;if(t<192)e=t-160;else switch(t){case 217:e=M[g++];break;case 218:e=U.getUint16(g),g+=2;break;case 219:e=U.getUint32(g),g+=4;break;default:throw new Error("Expected string")}return Kt(e)}function xo(t){return Q.copyBuffers?Uint8Array.prototype.slice.call(M,g,g+=t):M.subarray(g,g+=t)}function Jt(t){let e=M[g++];if(_e[e]){let r;return _e[e](M.subarray(g,r=g+=t),n=>{g=n;try{return re()}finally{g=r}})}else throw new Error("Unknown extension type "+e)}var Lf=new Array(4096);function Xf(){let t=M[g++];if(t>=160&&t<192){if(t=t-160,Fe>=g)return ct.slice(g-Te,(g+=t)-Te);if(!(Fe==0&&Me<180))return ys(t)}else return g--,re().toString();let e=(t<<5^(t>1?U.getUint16(g):t>0?M[g]:0))&4095,r=Lf[e],n=g,s=g+t-3,i,o=0;if(r&&r.bytes==t){for(;n<s;){if(i=U.getUint32(n),i!=r[o++]){n=1879048192;break}n+=4}for(s+=3;n<s;)if(i=M[n++],i!=r[o++]){n=1879048192;break}if(n===s)return g=n,r.string;s-=3,n=g}for(r=[],Lf[e]=r,r.bytes=t;n<s;)i=U.getUint32(n),r.push(i),n+=4;for(s+=3;n<s;)i=M[n++],r.push(i);let c=t<16?Ro(t):Kf(t);return c!=null?r.string=c:r.string=ys(t)}var jf=(t,e)=>{let r=re().map(i=>i.toString()),n=t;e!==void 0&&(t=t<32?-((e<<5)+t):(e<<5)+t,r.highByte=e);let s=H[t];return s&&(s.isShared||Et)&&((H.restoreStructures||(H.restoreStructures=[]))[t]=s),H[t]=r,r.read=Io(r,n),r.read()};_e[0]=()=>{};_e[0].noBuffer=!0;var Wv={Error,TypeError,ReferenceError};_e[101]=()=>{let t=re();return(Wv[t[0]]||Error)(t[1])};_e[105]=t=>{let e=U.getUint32(g-4);ut||(ut=new Map);let r=M[g],n;r>=144&&r<160||r==220||r==221?n=[]:n={};let s={target:n};ut.set(e,s);let i=re();return s.used?Object.assign(n,i):(s.target=i,i)};_e[112]=t=>{let e=U.getUint32(g-4),r=ut.get(e);return r.used=!0,r.target};_e[115]=()=>new Set(re());var Zf=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64","BigInt64","BigUint64"].map(t=>t+"Array"),Jv=typeof globalThis=="object"?globalThis:window;_e[116]=t=>{let e=t[0],r=Zf[e];if(!r)throw new Error("Could not find typed array for code "+e);return new Jv[r](Uint8Array.prototype.slice.call(t,1).buffer)};_e[120]=()=>{let t=re();return new RegExp(t[0],t[1])};var Qv=[];_e[98]=t=>{let e=(t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3],r=g;return g+=e-t.length,ie=Qv,ie=[Nf(),Nf()],ie.position0=0,ie.position1=0,ie.postBundlePosition=g,g=r,re()};_e[255]=t=>t.length==4?new Date((t[0]*16777216+(t[1]<<16)+(t[2]<<8)+t[3])*1e3):t.length==8?new Date(((t[0]<<22)+(t[1]<<14)+(t[2]<<6)+(t[3]>>2))/1e6+((t[3]&3)*4294967296+t[4]*16777216+(t[5]<<16)+(t[6]<<8)+t[7])*1e3):t.length==12?new Date(((t[0]<<24)+(t[1]<<16)+(t[2]<<8)+t[3])/1e6+((t[4]&128?-281474976710656:0)+t[6]*1099511627776+t[7]*4294967296+t[8]*16777216+(t[9]<<16)+(t[10]<<8)+t[11])*1e3):new Date("invalid");function eh(t){Eo&&Eo();let e=Me,r=g,n=dn,s=Te,i=Fe,o=ct,c=Yt,l=ut,u=ie,a=new Uint8Array(M.slice(0,Me)),f=H,h=H.slice(0,H.length),d=Q,p=Et,y=t();return Me=e,g=r,dn=n,Te=s,Fe=i,ct=o,Yt=c,ut=l,ie=u,M=a,Et=p,H=f,H.splice(0,H.length,...h),Q=d,U=new DataView(M.buffer,M.byteOffset,M.byteLength),y}function gs(){M=null,ut=null,H=null}function Yv(t){t.unpack?_e[t.type]=t.unpack:_e[t.type]=t}var Mr=new Array(147);for(let t=0;t<256;t++)Mr[t]=+("1e"+Math.floor(45.15-t*.30103));var Kv=kt,bs=new kt({useRecords:!1}),Xv=bs.unpack,Zv=bs.unpackMultiple,eb=bs.unpack,th={NEVER:0,ALWAYS:1,DECIMAL_ROUND:3,DECIMAL_FIT:4},rh=new Float32Array(1),qf=new Uint8Array(rh.buffer,0,4);function tb(t){rh[0]=t;let e=Mr[(qf[3]&127)<<1|qf[2]>>7];return(e*t+(t>0?.5:-.5)>>0)/e}function rb(t,e,r){wo=t,Oo=e,Eo=r}var fs;try{fs=new TextEncoder}catch{}var ms,To,xs=typeof Buffer<"u",ls=xs?function(t){return Buffer.allocUnsafeSlow(t)}:Uint8Array,nh=xs?Buffer:Uint8Array,Bf=xs?4294967296:2144337920,b,fn,J,_=0,me,Y=null,sh,nb=21760,sb=/[\u0080-\uFFFF]/,at=Symbol("record-id"),Ct=class extends kt{constructor(e){super(e),this.offset=0;let r,n,s,i,o=nh.prototype.utf8Write?function(v,D){return b.utf8Write(v,D,4294967295)}:fs&&fs.encodeInto?function(v,D){return fs.encodeInto(v,b.subarray(D)).written}:!1,c=this;e||(e={});let l=e&&e.sequential,u=e.structures||e.saveStructures,a=e.maxSharedStructures;if(a==null&&(a=u?32:0),a>8160)throw new Error("Maximum maxSharedStructure is 8160");e.structuredClone&&e.moreTypes==null&&(this.moreTypes=!0);let f=e.maxOwnStructures;f==null&&(f=u?32:64),!this.structures&&e.useRecords!=!1&&(this.structures=[]);let h=a>32||f+a>64,d=a+64,p=a+f+64;if(p>8256)throw new Error("Maximum maxSharedStructure + maxOwnStructure is 8192");let y=[],m=0,S=0;this.pack=this.encode=function(v,D){if(b||(b=new ls(8192),J=b.dataView||(b.dataView=new DataView(b.buffer,0,8192)),_=0),me=b.length-10,me-_<2048?(b=new ls(b.length),J=b.dataView||(b.dataView=new DataView(b.buffer,0,b.length)),me=b.length-10,_=0):_=_+7&2147483640,r=_,i=c.structuredClone?new Map:null,c.bundleStrings&&typeof v!="string"?(Y=[],Y.size=1/0):Y=null,s=c.structures,s){s.uninitialized&&(s=c._mergeStructures(c.getStructures()));let k=s.sharedLength||0;if(k>a)throw new Error("Shared structures is larger than maximum shared structures, try increasing maxSharedStructures to "+s.sharedLength);if(!s.transitions){s.transitions=Object.create(null);for(let A=0;A<k;A++){let N=s[A];if(!N)continue;let B,F=s.transitions;for(let q=0,te=N.length;q<te;q++){let W=N[q];B=F[W],B||(B=F[W]=Object.create(null)),F=B}F[at]=A+64}this.lastNamedStructuresLength=k}l||(s.nextId=k+64)}n&&(n=!1);try{c.randomAccessStructure&&v&&v.constructor&&v.constructor===Object?z(v):w(v);let k=Y;if(Y&&zf(r,w,0),i&&i.idsToInsert){let A=i.idsToInsert.sort((q,te)=>q.offset>te.offset?1:-1),N=A.length,B=-1;for(;k&&N>0;){let q=A[--N].offset+r;q<k.stringsPosition+r&&B===-1&&(B=0),q>k.position+r?B>=0&&(B+=6):(B>=0&&(J.setUint32(k.position+r,J.getUint32(k.position+r)+B),B=-1),k=k.previous,N++)}B>=0&&k&&J.setUint32(k.position+r,J.getUint32(k.position+r)+B),_+=A.length*6,_>me&&P(_),c.offset=_;let F=ob(b.subarray(r,_),A);return i=null,F}return c.offset=_,D&gb?(b.start=r,b.end=_,b):b.subarray(r,_)}finally{if(s){S<10&&S++;let k=s.sharedLength||0;if(s.length>k&&!l&&(s.length=k),m>1e4)s.transitions=null,S=0,m=0,y.length>0&&(y=[]);else if(y.length>0&&!l){for(let A=0,N=y.length;A<N;A++)y[A][at]=0;y=[]}if(n&&c.saveStructures){let A=b.subarray(r,_),N=ih(s,c);return c.saveStructures(N,N.isCompatible)===!1?c.pack(v):(c.lastNamedStructuresLength=k,A)}}D&mb&&(_=r)}};let R=v=>{var D=v.length;D<16?b[_++]=144|D:D<65536?(b[_++]=220,b[_++]=D>>8,b[_++]=D&255):(b[_++]=221,J.setUint32(_,D),_+=4);for(let k=0;k<D;k++)w(v[k])},w=v=>{_>me&&(b=P(_));var D=typeof v,k;if(D==="string"){let A=v.length;if(Y&&A>=4&&A<4096){if((Y.size+=A)>nb){let q,te=(Y[0]?Y[0].length*3+Y[1].length:0)+10;_+te>me&&(b=P(_+te));let W;Y.position?(W=Y,b[_]=200,_+=3,b[_++]=98,q=_-r,_+=4,zf(r,w,0),J.setUint16(q+r-3,_-r-q)):(b[_++]=214,b[_++]=98,q=_-r,_+=4),Y=["",""],Y.previous=W,Y.size=0,Y.position=q}let F=sb.test(v);Y[F?0:1]+=v,b[_++]=193,w(F?-A:A);return}let N;A<32?N=1:A<256?N=2:A<65536?N=3:N=5;let B=A*3;if(_+B>me&&(b=P(_+B)),A<64||!o){let F,q,te,W=_+N;for(F=0;F<A;F++)q=v.charCodeAt(F),q<128?b[W++]=q:q<2048?(b[W++]=q>>6|192,b[W++]=q&63|128):(q&64512)===55296&&((te=v.charCodeAt(F+1))&64512)===56320?(q=65536+((q&1023)<<10)+(te&1023),F++,b[W++]=q>>18|240,b[W++]=q>>12&63|128,b[W++]=q>>6&63|128,b[W++]=q&63|128):(b[W++]=q>>12|224,b[W++]=q>>6&63|128,b[W++]=q&63|128);k=W-_-N}else k=o(v,_+N);k<32?b[_++]=160|k:k<256?(N<2&&b.copyWithin(_+2,_+1,_+1+k),b[_++]=217,b[_++]=k):k<65536?(N<3&&b.copyWithin(_+3,_+2,_+2+k),b[_++]=218,b[_++]=k>>8,b[_++]=k&255):(N<5&&b.copyWithin(_+5,_+3,_+3+k),b[_++]=219,J.setUint32(_,k),_+=4),_+=k}else if(D==="number")if(v>>>0===v)v<32||v<128&&this.useRecords===!1||v<64&&!this.randomAccessStructure?b[_++]=v:v<256?(b[_++]=204,b[_++]=v):v<65536?(b[_++]=205,b[_++]=v>>8,b[_++]=v&255):(b[_++]=206,J.setUint32(_,v),_+=4);else if(v>>0===v)v>=-32?b[_++]=256+v:v>=-128?(b[_++]=208,b[_++]=v+256):v>=-32768?(b[_++]=209,J.setInt16(_,v),_+=2):(b[_++]=210,J.setInt32(_,v),_+=4);else{let A;if((A=this.useFloat32)>0&&v<4294967296&&v>=-2147483648){b[_++]=202,J.setFloat32(_,v);let N;if(A<4||(N=v*Mr[(b[_]&127)<<1|b[_+1]>>7])>>0===N){_+=4;return}else _--}b[_++]=203,J.setFloat64(_,v),_+=8}else if(D==="object"||D==="function")if(!v)b[_++]=192;else{if(i){let N=i.get(v);if(N){if(!N.id){let B=i.idsToInsert||(i.idsToInsert=[]);N.id=B.push(N)}b[_++]=214,b[_++]=112,J.setUint32(_,N.id),_+=4;return}else i.set(v,{offset:_-r})}let A=v.constructor;if(A===Object)O(v,!0);else if(A===Array)R(v);else if(A===Map)if(this.mapAsEmptyObject)b[_++]=128;else{k=v.size,k<16?b[_++]=128|k:k<65536?(b[_++]=222,b[_++]=k>>8,b[_++]=k&255):(b[_++]=223,J.setUint32(_,k),_+=4);for(let[N,B]of v)w(N),w(B)}else{for(let N=0,B=ms.length;N<B;N++){let F=To[N];if(v instanceof F){let q=ms[N];if(q.write){q.type&&(b[_++]=212,b[_++]=q.type,b[_++]=0);let xt=q.write.call(this,v);xt===v?Array.isArray(v)?R(v):O(v):w(xt);return}let te=b,W=J,it=_;b=null;let Ht;try{Ht=q.pack.call(this,v,xt=>(b=te,te=null,_+=xt,_>me&&P(_),{target:b,targetView:J,position:_-xt}),w)}finally{te&&(b=te,J=W,_=it,me=b.length-10)}Ht&&(Ht.length+_>me&&P(Ht.length+_),_=ib(Ht,b,_,q.type));return}}if(Array.isArray(v))R(v);else{if(v.toJSON){let N=v.toJSON();if(N!==v)return w(N)}if(D==="function")return w(this.writeFunction&&this.writeFunction(v));O(v,!v.hasOwnProperty)}}}else if(D==="boolean")b[_++]=v?195:194;else if(D==="bigint"){if(v<BigInt(1)<<BigInt(63)&&v>=-(BigInt(1)<<BigInt(63)))b[_++]=211,J.setBigInt64(_,v);else if(v<BigInt(1)<<BigInt(64)&&v>0)b[_++]=207,J.setBigUint64(_,v);else if(this.largeBigIntToFloat)b[_++]=203,J.setFloat64(_,Number(v));else throw new RangeError(v+" was too large to fit in MessagePack 64-bit integer format, set largeBigIntToFloat to convert to float-64");_+=8}else if(D==="undefined")this.encodeUndefinedAsNil?b[_++]=192:(b[_++]=212,b[_++]=0,b[_++]=0);else throw new Error("Unknown type: "+D)},E=this.variableMapSize||this.coercibleKeyAsNumber?v=>{let D=Object.keys(v),k=D.length;k<16?b[_++]=128|k:k<65536?(b[_++]=222,b[_++]=k>>8,b[_++]=k&255):(b[_++]=223,J.setUint32(_,k),_+=4);let A;if(this.coercibleKeyAsNumber)for(let N=0;N<k;N++){A=D[N];let B=Number(A);w(isNaN(B)?A:B),w(v[A])}else for(let N=0;N<k;N++)w(A=D[N]),w(v[A])}:(v,D)=>{b[_++]=222;let k=_-r;_+=2;let A=0;for(let N in v)(D||v.hasOwnProperty(N))&&(w(N),w(v[N]),A++);b[k+++r]=A>>8,b[k+r]=A&255},C=this.useRecords===!1?E:e.progressiveRecords&&!h?(v,D)=>{let k,A=s.transitions||(s.transitions=Object.create(null)),N=_++-r,B;for(let F in v)if(D||v.hasOwnProperty(F)){if(k=A[F],k)A=k;else{let q=Object.keys(v),te=A;A=s.transitions;let W=0;for(let it=0,Ht=q.length;it<Ht;it++){let xt=q[it];k=A[xt],k||(k=A[xt]=Object.create(null),W++),A=k}N+r+1==_?(_--,j(A,q,W)):L(A,q,N,W),B=!0,A=te[F]}w(v[F])}if(!B){let F=A[at];F?b[N+r]=F:L(A,Object.keys(v),N,0)}}:(v,D)=>{let k,A=s.transitions||(s.transitions=Object.create(null)),N=0;for(let F in v)(D||v.hasOwnProperty(F))&&(k=A[F],k||(k=A[F]=Object.create(null),N++),A=k);let B=A[at];B?B>=96&&h?(b[_++]=((B-=96)&31)+96,b[_++]=B>>5):b[_++]=B:j(A,A.__keys__||Object.keys(v),N);for(let F in v)(D||v.hasOwnProperty(F))&&w(v[F])},T=typeof this.useRecords=="function"&&this.useRecords,O=T?(v,D)=>{T(v)?C(v,D):E(v,D)}:C,P=v=>{let D;if(v>16777216){if(v-r>Bf)throw new Error("Packed buffer would be larger than maximum buffer size");D=Math.min(Bf,Math.round(Math.max((v-r)*(v>67108864?1.25:2),4194304)/4096)*4096)}else D=(Math.max(v-r<<2,b.length-1)>>12)+1<<12;let k=new ls(D);return J=k.dataView||(k.dataView=new DataView(k.buffer,0,D)),v=Math.min(v,b.length),b.copy?b.copy(k,0,r,v):k.set(b.slice(r,v)),_-=r,r=0,me=k.length-10,b=k},j=(v,D,k)=>{let A=s.nextId;A||(A=64),A<d&&this.shouldShareStructure&&!this.shouldShareStructure(D)?(A=s.nextOwnId,A<p||(A=d),s.nextOwnId=A+1):(A>=p&&(A=d),s.nextId=A+1);let N=D.highByte=A>=96&&h?A-96>>5:-1;v[at]=A,v.__keys__=D,s[A-64]=D,A<d?(D.isShared=!0,s.sharedLength=A-63,n=!0,N>=0?(b[_++]=(A&31)+96,b[_++]=N):b[_++]=A):(N>=0?(b[_++]=213,b[_++]=114,b[_++]=(A&31)+96,b[_++]=N):(b[_++]=212,b[_++]=114,b[_++]=A),k&&(m+=S*k),y.length>=f&&(y.shift()[at]=0),y.push(v),w(D))},L=(v,D,k,A)=>{let N=b,B=_,F=me,q=r;b=fn,_=0,r=0,b||(fn=b=new ls(8192)),me=b.length-10,j(v,D,A),fn=b;let te=_;if(b=N,_=B,me=F,r=q,te>1){let W=_+te-1;W>me&&P(W);let it=k+r;b.copyWithin(it+te,it+1,_),b.set(fn.slice(0,te),it),_=W}else b[k+r]=fn[0]},z=(v,D)=>{let k=sh(v,b,_,s,P,(A,N,B)=>{if(B)return n=!0;_=N;let F=b;return w(A),F!==b?{position:_,targetView:J,target:b}:_},this);if(k===0)return O(v,!0);_=k}}useBuffer(e){b=e,J=new DataView(b.buffer,b.byteOffset,b.byteLength),_=0}clearSharedData(){this.structures&&(this.structures=[]),this.typedStructs&&(this.typedStructs=[])}};To=[Date,Set,Error,RegExp,ArrayBuffer,Object.getPrototypeOf(Uint8Array.prototype).constructor,ps];ms=[{pack(t,e,r){let n=t.getTime()/1e3;if((this.useTimestamp32||t.getMilliseconds()===0)&&n>=0&&n<4294967296){let{target:s,targetView:i,position:o}=e(6);s[o++]=214,s[o++]=255,i.setUint32(o,n)}else if(n>0&&n<4294967296){let{target:s,targetView:i,position:o}=e(10);s[o++]=215,s[o++]=255,i.setUint32(o,t.getMilliseconds()*4e6+(n/1e3/4294967296>>0)),i.setUint32(o+4,n)}else if(isNaN(n)){if(this.onInvalidDate)return e(0),r(this.onInvalidDate());let{target:s,targetView:i,position:o}=e(3);s[o++]=212,s[o++]=255,s[o++]=255}else{let{target:s,targetView:i,position:o}=e(15);s[o++]=199,s[o++]=12,s[o++]=255,i.setUint32(o,t.getMilliseconds()*1e6),i.setBigInt64(o+4,BigInt(Math.floor(n)))}}},{pack(t,e,r){if(this.setAsEmptyObject)return e(0),r({});let n=Array.from(t),{target:s,position:i}=e(this.moreTypes?3:0);this.moreTypes&&(s[i++]=212,s[i++]=115,s[i++]=0),r(n)}},{pack(t,e,r){let{target:n,position:s}=e(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=101,n[s++]=0),r([t.name,t.message])}},{pack(t,e,r){let{target:n,position:s}=e(this.moreTypes?3:0);this.moreTypes&&(n[s++]=212,n[s++]=120,n[s++]=0),r([t.source,t.flags])}},{pack(t,e){this.moreTypes?Ff(t,16,e):Uf(xs?Buffer.from(t):new Uint8Array(t),e)}},{pack(t,e){let r=t.constructor;r!==nh&&this.moreTypes?Ff(t,Zf.indexOf(r.name),e):Uf(t,e)}},{pack(t,e){let{target:r,position:n}=e(1);r[n]=193}}];function Ff(t,e,r,n){let s=t.byteLength;if(s+1<256){var{target:i,position:o}=r(4+s);i[o++]=199,i[o++]=s+1}else if(s+1<65536){var{target:i,position:o}=r(5+s);i[o++]=200,i[o++]=s+1>>8,i[o++]=s+1&255}else{var{target:i,position:o,targetView:c}=r(7+s);i[o++]=201,c.setUint32(o,s+1),o+=4}i[o++]=116,i[o++]=e,i.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength),o)}function Uf(t,e){let r=t.byteLength;var n,s;if(r<256){var{target:n,position:s}=e(r+2);n[s++]=196,n[s++]=r}else if(r<65536){var{target:n,position:s}=e(r+3);n[s++]=197,n[s++]=r>>8,n[s++]=r&255}else{var{target:n,position:s,targetView:i}=e(r+5);n[s++]=198,i.setUint32(s,r),s+=4}n.set(t,s)}function ib(t,e,r,n){let s=t.length;switch(s){case 1:e[r++]=212;break;case 2:e[r++]=213;break;case 4:e[r++]=214;break;case 8:e[r++]=215;break;case 16:e[r++]=216;break;default:s<256?(e[r++]=199,e[r++]=s):s<65536?(e[r++]=200,e[r++]=s>>8,e[r++]=s&255):(e[r++]=201,e[r++]=s>>24,e[r++]=s>>16&255,e[r++]=s>>8&255,e[r++]=s&255)}return e[r++]=n,e.set(t,r),r+=s,r}function ob(t,e){let r,n=e.length*6,s=t.length-n;for(;r=e.pop();){let i=r.offset,o=r.id;t.copyWithin(i+n,i,s),n-=6;let c=i+n;t[c++]=214,t[c++]=105,t[c++]=o>>24,t[c++]=o>>16&255,t[c++]=o>>8&255,t[c++]=o&255,s=i}return t}function zf(t,e,r){if(Y.length>0){J.setUint32(Y.position+t,_+r-Y.position-t),Y.stringsPosition=_-t;let n=Y;Y=null,e(n[0]),e(n[1])}}function ab(t){if(t.Class){if(!t.pack&&!t.write)throw new Error("Extension has no pack or write function");if(t.pack&&!t.type)throw new Error("Extension has no type (numeric code to identify the extension)");To.unshift(t.Class),ms.unshift(t)}Yv(t)}function ih(t,e){return t.isCompatible=r=>{let n=!r||(e.lastNamedStructuresLength||0)===r.length;return n||e._mergeStructures(r),n},t}function cb(t,e){sh=t,ih=e}var oh=new Ct({useRecords:!1}),ub=oh.pack,lb=oh.pack,fb=Ct,{NEVER:hb,ALWAYS:db,DECIMAL_ROUND:pb,DECIMAL_FIT:yb}=th,gb=512,mb=1024,ko=3,Tr=0,hn=2,hs=1,Mo=16,ah=["num","object","string","ascii"];ah[Mo]="date";var _b=[!1,!0,!0,!1,!1,!0,!0,!1],ch;try{new Function(""),ch=!0}catch{}var Qt,vb=typeof Buffer<"u",ds,Qe;try{ds=new TextEncoder}catch{}var bb=vb?function(t,e,r){return t.utf8Write(e,r,4294967295)}:ds&&ds.encodeInto?function(t,e,r){return ds.encodeInto(e,t.subarray(r)).written}:!1;cb(uh,Eb);function uh(t,e,r,n,s,i,o){let c=o.typedStructs||(o.typedStructs=[]),l=e.dataView,u=(c.lastStringStart||100)+r,a=e.length-10,f=r;if(r>a){let C=f;e=s(r),l=e.dataView,r-=C,u-=C,f=0,a=e.length-10}let h,d=u,p=c.transitions||(c.transitions=Object.create(null)),y=c.nextId||c.length,m=y<15?1:y<240?2:y<61440?3:y<15728640?4:0;if(m===0)return 0;r+=m;let S=[],R,w=0;for(let C in t){let T=t[C],O=p[C];if(O||(p[C]=O={key:C,parent:p,enumerationOffset:0,ascii0:null,ascii8:null,num8:null,string16:null,object16:null,num32:null,float64:null,date64:null}),r>a){let P=f;e=s(r),l=e.dataView,r-=P,u-=P,d-=P,f=0,a=e.length-10}switch(typeof T){case"number":let P=T;if(P>>0===P&&P<536870912&&P>-520093696){P<246&&P>=0&&(O.num8||P<32&&!O.num32)?(p=O.num8||Oe(O,Tr,1),e[r++]=P):(p=O.num32||Oe(O,Tr,4),l.setUint32(r,P,!0),r+=4);break}else if(P<4294967296&&P>=-2147483648&&(l.setFloat32(r,P,!0),_b[e[r+3]>>>5])){let v;if((v=P*Mr[(e[r+3]&127)<<1|e[r+2]>>7])>>0===v){p=O.num32||Oe(O,Tr,4),r+=4;break}}p=O.num64||Oe(O,Tr,8),l.setFloat64(r,P,!0),r+=8;break;case"string":let j=T.length;if(h=d-u,(j<<2)+d>a){let v=f;e=s((j<<2)+d),l=e.dataView,r-=v,u-=v,d-=v,f=0,a=e.length-10}if(j>65280+h>>2){S.push(C,T,r-f);break}let L,z=d;if(j<64){let v,D,k;for(v=0;v<j;v++)D=T.charCodeAt(v),D<128?e[d++]=D:D<2048?(L=!0,e[d++]=D>>6|192,e[d++]=D&63|128):(D&64512)===55296&&((k=T.charCodeAt(v+1))&64512)===56320?(L=!0,D=65536+((D&1023)<<10)+(k&1023),v++,e[d++]=D>>18|240,e[d++]=D>>12&63|128,e[d++]=D>>6&63|128,e[d++]=D&63|128):(L=!0,e[d++]=D>>12|224,e[d++]=D>>6&63|128,e[d++]=D&63|128)}else d+=bb(e,T,d),L=d-z>j;if(h<160||h<246&&(O.ascii8||O.string8)){if(L)(p=O.string8)||(c.length>10&&(p=O.ascii8)?(p.__type=hn,O.ascii8=null,O.string8=p,i(null,0,!0)):p=Oe(O,hn,1));else if(h===0&&!R){R=!0,p=O.ascii0||Oe(O,ko,0);break}else!(p=O.ascii8)&&!(c.length>10&&(p=O.string8))&&(p=Oe(O,ko,1));e[r++]=h}else p=O.string16||Oe(O,hn,2),l.setUint16(r,h,!0),r+=2;break;case"object":if(T){T.constructor===Date?(p=O.date64||Oe(O,Mo,8),l.setFloat64(r,T.getTime(),!0),r+=8):S.push(C,T,w);break}else O=Hf(O,r,l,-10),O?(p=O,r=Qt):S.push(C,T,w);break;case"boolean":p=O.num8||O.ascii8||Oe(O,Tr,1),e[r++]=T?249:248;break;case"undefined":O=Hf(O,r,l,-9),O?(p=O,r=Qt):S.push(C,T,w);break}w++}for(let C=0,T=S.length;C<T;){let O=S[C++],P=S[C++],j=S[C++],L=p[O];L||(p[O]=L={key:O,parent:p,enumerationOffset:j-w,ascii0:null,ascii8:null,num8:null,string16:null,object16:null,num32:null,float64:null});let z;if(P){let v;h=d-u,h<65280?(p=L.object16,p?v=2:(p=L.object32)?v=4:(p=Oe(L,hs,2),v=2)):(p=L.object32||Oe(L,hs,4),v=4),z=i(P,d),typeof z=="object"?(d=z.position,l=z.targetView,e=z.target,u-=f,r-=f,f=0):d=z,v===2?(l.setUint16(r,h,!0),r+=2):(l.setUint32(r,h,!0),r+=4)}else p=L.object16||Oe(L,hs,2),l.setInt16(r,P===null?-10:-9,!0),r+=2;w++}let E=p[at];if(E==null){E=o.typedStructs.length;let C=[],T=p,O,P;for(;(P=T.__type)!==void 0;){let j=T.__size;T=T.__parent,O=T.key;let L=[P,j,O];T.enumerationOffset&&L.push(T.enumerationOffset),C.push(L),T=T.parent}C.reverse(),p[at]=E,o.typedStructs[E]=C,i(null,0,!0)}switch(m){case 1:if(E>=16)return 0;e[f]=E+32;break;case 2:if(E>=256)return 0;e[f]=56,e[f+1]=E;break;case 3:if(E>=65536)return 0;e[f]=57,l.setUint16(f+1,E,!0);break;case 4:if(E>=16777216)return 0;l.setUint32(f,(E<<8)+58,!0);break}if(r<u){if(u===d)return r;e.copyWithin(r,u,d),d+=r-u,c.lastStringStart=r-f}else if(r>u)return u===d?r:(c.lastStringStart=r-f,uh(t,e,f,n,s,i,o));return d}function Hf(t,e,r,n){let s;if(s=t.ascii8||t.num8)return r.setInt8(e,n,!0),Qt=e+1,s;if(s=t.string16||t.object16)return r.setInt16(e,n,!0),Qt=e+2,s;if(s=t.num32)return r.setUint32(e,3758096640+n,!0),Qt=e+4,s;if(s=t.num64)return r.setFloat64(e,NaN,!0),r.setInt8(e,n),Qt=e+8,s;Qt=e}function Oe(t,e,r){let n=ah[e]+(r<<3),s=t[n]||(t[n]=Object.create(null));return s.__type=e,s.__size=r,s.__parent=t,s}function xb(t){if(!(t instanceof Map))return t;let e=t.get("typed")||[];Object.isFrozen(e)&&(e=e.map(s=>s.slice(0)));let r=t.get("named"),n=Object.create(null);for(let s=0,i=e.length;s<i;s++){let o=e[s],c=n;for(let[l,u,a]of o){let f=c[a];f||(c[a]=f={key:a,parent:c,enumerationOffset:0,ascii0:null,ascii8:null,num8:null,string16:null,object16:null,num32:null,float64:null,date64:null}),c=Oe(f,l,u)}c[at]=s}return e.transitions=n,this.typedStructs=e,this.lastTypedStructuresLength=e.length,r}var Co=Symbol.for("source");function Sb(t,e,r,n){let s=t[e++]-32;if(s>=24)switch(s){case 24:s=t[e++];break;case 25:s=t[e++]+(t[e++]<<8);break;case 26:s=t[e++]+(t[e++]<<8)+(t[e++]<<16);break;case 27:s=t[e++]+(t[e++]<<8)+(t[e++]<<16)+(t[e++]<<24);break}let i=n.typedStructs&&n.typedStructs[s];if(!i){if(t=Uint8Array.prototype.slice.call(t,e,r),r-=e,e=0,n._mergeStructures(n.getStructures()),!n.typedStructs)throw new Error("Could not find any shared typed structures");if(n.lastTypedStructuresLength=n.typedStructs.length,i=n.typedStructs[s],!i)throw new Error("Could not find typed structure "+s)}var o=i.construct;if(!o){o=i.construct=function(){};var c=o.prototype;let u=[],a=0,f;for(let h=0,d=i.length;h<d;h++){let p=i[h],[y,m,S,R]=p;S==="__proto__"&&(S="__proto_");let w={key:S,offset:a};R?u.splice(h+R,0,w):u.push(w);let E;switch(m){case 0:E=()=>0;break;case 1:E=(T,O)=>{let P=T.bytes[O+w.offset];return P>=246?Rr(P):P};break;case 2:E=(T,O)=>{let P=T.bytes,L=(P.dataView||(P.dataView=new DataView(P.buffer,P.byteOffset,P.byteLength))).getUint16(O+w.offset,!0);return L>=65280?Rr(L&255):L};break;case 4:E=(T,O)=>{let P=T.bytes,L=(P.dataView||(P.dataView=new DataView(P.buffer,P.byteOffset,P.byteLength))).getUint32(O+w.offset,!0);return L>=4294967040?Rr(L&255):L};break}w.getRef=E,a+=m;let C;switch(y){case ko:f&&!f.next&&(f.next=w),f=w,w.multiGetCount=0,C=function(T){let O=T.bytes,P=T.position,j=a+P,L=E(T,P);if(typeof L!="number")return L;let z,v=w.next;for(;v&&(z=v.getRef(T,P),typeof z!="number");)z=null,v=v.next;return z==null&&(z=T.bytesEnd-j),T.srcString?T.srcString.slice(L,z):Gv(O,L+j,z-L)};break;case hn:case hs:f&&!f.next&&(f.next=w),f=w,C=function(T){let O=T.position,P=a+O,j=E(T,O);if(typeof j!="number")return j;let L=T.bytes,z,v=w.next;for(;v&&(z=v.getRef(T,O),typeof z!="number");)z=null,v=v.next;if(z==null&&(z=T.bytesEnd-P),y===hn)return L.toString("utf8",j+P,z+P);Qe=T;try{return n.unpack(L,{start:j+P,end:z+P})}finally{Qe=null}};break;case Tr:switch(m){case 4:C=function(T){let O=T.bytes,P=O.dataView||(O.dataView=new DataView(O.buffer,O.byteOffset,O.byteLength)),j=T.position+w.offset,L=P.getInt32(j,!0);if(L<536870912){if(L>-520093696)return L;if(L>-536870912)return Rr(L&255)}let z=P.getFloat32(j,!0),v=Mr[(O[j+3]&127)<<1|O[j+2]>>7];return(v*z+(z>0?.5:-.5)>>0)/v};break;case 8:C=function(T){let O=T.bytes,j=(O.dataView||(O.dataView=new DataView(O.buffer,O.byteOffset,O.byteLength))).getFloat64(T.position+w.offset,!0);if(isNaN(j)){let L=O[T.position+w.offset];if(L>=246)return Rr(L)}return j};break;case 1:C=function(T){let P=T.bytes[T.position+w.offset];return P<246?P:Rr(P)};break}break;case Mo:C=function(T){let O=T.bytes,P=O.dataView||(O.dataView=new DataView(O.buffer,O.byteOffset,O.byteLength));return new Date(P.getFloat64(T.position+w.offset,!0))};break}w.get=C}if(ch){let h=[],d=[],p=0,y;for(let S of u){if(n.alwaysLazyProperty&&n.alwaysLazyProperty(S.key)){y=!0;continue}Object.defineProperty(c,S.key,{get:wb(S.get),enumerable:!0});let R="v"+p++;d.push(R),h.push("["+JSON.stringify(S.key)+"]:"+R+"(s)")}y&&h.push("__proto__:this");let m=new Function(...d,"return function(s){return{"+h.join(",")+"}}").apply(null,u.map(S=>S.get));Object.defineProperty(c,"toJSON",{value(S){return m.call(this,this[Co])}})}else Object.defineProperty(c,"toJSON",{value(h){let d={};for(let p=0,y=u.length;p<y;p++){let m=u[p].key;d[m]=this[m]}return d}})}var l=new o;return l[Co]={bytes:t,position:e,srcString:"",bytesEnd:r},l}function Rr(t){switch(t){case 246:return null;case 247:return;case 248:return!1;case 249:return!0}throw new Error("Unknown constant")}function wb(t){return function(){return t(this[Co])}}function Ob(){Qe&&(Qe.bytes=Uint8Array.prototype.slice.call(Qe.bytes,Qe.position,Qe.bytesEnd),Qe.position=0,Qe.bytesEnd=Qe.bytes.length)}function Eb(t,e){if(e.typedStructs){let n=new Map;n.set("named",t),n.set("typed",e.typedStructs),t=n}let r=e.lastTypedStructuresLength||0;return t.isCompatible=n=>{let s=!0;return n instanceof Map?((n.get("named")||[]).length!==(e.lastNamedStructuresLength||0)&&(s=!1),(n.get("typed")||[]).length!==r&&(s=!1)):(n instanceof Array||Array.isArray(n))&&n.length!==(e.lastNamedStructuresLength||0)&&(s=!1),s||e._mergeStructures(n),s},e.lastTypedStructuresLength=e.typedStructs&&e.typedStructs.length,t}rb(Sb,xb,Ob);var _s=class extends Vf.Transform{constructor(e){e||(e={}),e.writableObjectMode=!0,super(e),e.sequential=!0,this.packr=e.packr||new Ct(e)}_transform(e,r,n){this.push(this.packr.pack(e)),n()}},vs=class extends Vf.Transform{constructor(e){e||(e={}),e.objectMode=!0,super(e),e.structures=[],this.unpackr=e.unpackr||new kt(e)}_transform(e,r,n){this.incompleteBuffer&&(e=Buffer.concat([this.incompleteBuffer,e]),this.incompleteBuffer=null);let s;try{s=this.unpackr.unpackMultiple(e)}catch(i){if(i.incomplete)this.incompleteBuffer=e.slice(i.lastPosition),s=i.values;else throw i}finally{for(let i of s||[])i===null&&(i=this.getNullValue()),this.push(i)}n&&n()}getNullValue(){return Symbol.for(null)}};function kb(t,e={}){if(!t||typeof t!="object")throw new Error("first argument must be an Iterable, Async Iterable, or a Promise for an Async Iterable");if(typeof t[Symbol.iterator]=="function")return Cb(t,e);if(typeof t.then=="function"||typeof t[Symbol.asyncIterator]=="function")return Pb(t,e);throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a Promise")}function*Cb(t,e){let r=new Ct(e);for(let n of t)yield r.pack(n)}async function*Pb(t,e){let r=new Ct(e);for await(let n of t)yield r.pack(n)}function Ab(t,e={}){if(!t||typeof t!="object")throw new Error("first argument must be an Iterable, Async Iterable, Iterator, Async Iterator, or a promise");let r=new kt(e),n,s=i=>{let o;n&&(i=Buffer.concat([n,i]),n=void 0);try{o=r.unpackMultiple(i)}catch(c){if(c.incomplete)n=i.slice(c.lastPosition),o=c.values;else throw c}return o};if(typeof t[Symbol.iterator]=="function")return function*(){for(let o of t)yield*s(o)}();if(typeof t[Symbol.asyncIterator]=="function")return async function*(){for await(let o of t)yield*s(o)}()}var Ib=Ab,Rb=kb,Tb=!1,Mb=!0,Db=process.env.MSGPACKR_NATIVE_ACCELERATION_DISABLED!==void 0&&process.env.MSGPACKR_NATIVE_ACCELERATION_DISABLED.toLowerCase()==="true";if(!Db){let t;try{typeof require=="function"?t=If():t=zv.createRequire(typeof document>"u"?new(require("url")).URL("file:"+__filename).href:document.currentScript&&document.currentScript.src||new URL("node.cjs",document.baseURI).href)("msgpackr-extract"),t&&Vv(t.extractStrings)}catch{}}V.ALWAYS=db;V.C1=Ao;V.DECIMAL_FIT=yb;V.DECIMAL_ROUND=pb;V.Decoder=Kv;V.DecoderStream=vs;V.Encoder=fb;V.EncoderStream=_s;V.FLOAT32_OPTIONS=th;V.NEVER=hb;V.Packr=Ct;V.PackrStream=_s;V.Unpackr=kt;V.UnpackrStream=vs;V.addExtension=ab;V.clearSource=gs;V.decode=eb;V.decodeIter=Ib;V.encode=lb;V.encodeIter=Rb;V.mapsAsObjects=Mb;V.pack=ub;V.roundFloat32=tb;V.unpack=Xv;V.unpackMultiple=Zv;V.useRecords=Tb});var nr=x(I=>{"use strict";Object.defineProperty(I,"__esModule",{value:!0});var Do=function(t,e){return Do=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,n){r.__proto__=n}||function(r,n){for(var s in n)Object.prototype.hasOwnProperty.call(n,s)&&(r[s]=n[s])},Do(t,e)};function pn(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");Do(t,e);function r(){this.constructor=t}t.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}function Zt(t,e,r,n){var s=arguments.length,i=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(t,e,r,n);else for(var c=t.length-1;c>=0;c--)(o=t[c])&&(i=(s<3?o(i):s>3?o(e,r,i):o(e,r))||i);return s>3&&i&&Object.defineProperty(e,r,i),i}function ws(t,e,r){if(r||arguments.length===2)for(var n=0,s=e.length,i;n<s;n++)(i||!(n in e))&&(i||(i=Array.prototype.slice.call(e,0,n)),i[n]=e[n]);return t.concat(i||Array.prototype.slice.call(e))}var Os=255,lh=213;I.OPERATION=void 0;(function(t){t[t.ADD=128]="ADD",t[t.REPLACE=0]="REPLACE",t[t.DELETE=64]="DELETE",t[t.DELETE_AND_ADD=192]="DELETE_AND_ADD",t[t.TOUCH=1]="TOUCH",t[t.CLEAR=10]="CLEAR"})(I.OPERATION||(I.OPERATION={}));var _n=function(){function t(e,r,n){this.changed=!1,this.changes=new Map,this.allChanges=new Set,this.caches={},this.currentCustomOperation=0,this.ref=e,this.setParent(r,n)}return t.prototype.setParent=function(e,r,n){var s=this;if(this.indexes||(this.indexes=this.ref instanceof Ue?this.ref._definition.indexes:{}),this.parent=e,this.parentIndex=n,!!r)if(this.root=r,this.ref instanceof Ue){var i=this.ref._definition;for(var o in i.schema){var c=this.ref[o];if(c&&c.$changes){var l=i.indexes[o];c.$changes.setParent(this.ref,r,l)}}}else typeof this.ref=="object"&&this.ref.forEach(function(u,a){if(u instanceof Ue){var f=u.$changes,h=s.ref.$changes.indexes[a];f.setParent(s.ref,s.root,h)}})},t.prototype.operation=function(e){this.changes.set(--this.currentCustomOperation,e)},t.prototype.change=function(e,r){r===void 0&&(r=I.OPERATION.ADD);var n=typeof e=="number"?e:this.indexes[e];this.assertValidIndex(n,e);var s=this.changes.get(n);(!s||s.op===I.OPERATION.DELETE||s.op===I.OPERATION.TOUCH)&&this.changes.set(n,{op:s&&s.op===I.OPERATION.DELETE?I.OPERATION.DELETE_AND_ADD:r,index:n}),this.allChanges.add(n),this.changed=!0,this.touchParents()},t.prototype.touch=function(e){var r=typeof e=="number"?e:this.indexes[e];this.assertValidIndex(r,e),this.changes.has(r)||this.changes.set(r,{op:I.OPERATION.TOUCH,index:r}),this.allChanges.add(r),this.touchParents()},t.prototype.touchParents=function(){this.parent&&this.parent.$changes.touch(this.parentIndex)},t.prototype.getType=function(e){if(this.ref._definition){var r=this.ref._definition;return r.schema[r.fieldsByIndex[e]]}else{var r=this.parent._definition,n=r.schema[r.fieldsByIndex[this.parentIndex]];return Object.values(n)[0]}},t.prototype.getChildrenFilter=function(){var e=this.parent._definition.childFilters;return e&&e[this.parentIndex]},t.prototype.getValue=function(e){return this.ref.getByIndex(e)},t.prototype.delete=function(e){var r=typeof e=="number"?e:this.indexes[e];if(r===void 0){console.warn("@colyseus/schema ".concat(this.ref.constructor.name,": trying to delete non-existing index: ").concat(e," (").concat(r,")"));return}var n=this.getValue(r);this.changes.set(r,{op:I.OPERATION.DELETE,index:r}),this.allChanges.delete(r),delete this.caches[r],n&&n.$changes&&(n.$changes.parent=void 0),this.changed=!0,this.touchParents()},t.prototype.discard=function(e,r){var n=this;e===void 0&&(e=!1),r===void 0&&(r=!1),this.ref instanceof Ue||this.changes.forEach(function(s){if(s.op===I.OPERATION.DELETE){var i=n.ref.getIndex(s.index);delete n.indexes[i]}}),this.changes.clear(),this.changed=e,r&&this.allChanges.clear(),this.currentCustomOperation=0},t.prototype.discardAll=function(){var e=this;this.changes.forEach(function(r){var n=e.getValue(r.index);n&&n.$changes&&n.$changes.discardAll()}),this.discard()},t.prototype.cache=function(e,r){this.caches[e]=r},t.prototype.clone=function(){return new t(this.ref,this.parent,this.root)},t.prototype.ensureRefId=function(){this.refId===void 0&&(this.refId=this.root.getNextUniqueId())},t.prototype.assertValidIndex=function(e,r){if(e===void 0)throw new Error('ChangeTree: missing index for field "'.concat(r,'"'))},t}();function ke(t,e,r,n){return t[e]||(t[e]=[]),t[e].push(r),n?.forEach(function(s,i){return r(s,i)}),function(){return hh(t[e],t[e].indexOf(r))}}function Cs(t){var e=this,r=typeof this.$changes.getType()!="string";this.$items.forEach(function(n,s){t.push({refId:e.$changes.refId,op:I.OPERATION.DELETE,field:s,value:void 0,previousValue:n}),r&&e.$changes.root.removeRef(n.$changes.refId)})}function hh(t,e){if(e===-1||e>=t.length)return!1;for(var r=t.length-1,n=e;n<r;n++)t[n]=t[n+1];return t.length=r,!0}var $b=function(t,e){var r=t.toString(),n=e.toString();return r<n?-1:r>n?1:0};function Nb(t){return t.$proxy=!0,t=new Proxy(t,{get:function(e,r){return typeof r!="symbol"&&!isNaN(r)?e.at(r):e[r]},set:function(e,r,n){if(typeof r!="symbol"&&!isNaN(r)){var s=Array.from(e.$items.keys()),i=parseInt(s[r]||r);n==null?e.deleteAt(i):e.setAt(i,n)}else e[r]=n;return!0},deleteProperty:function(e,r){return typeof r=="number"?e.deleteAt(r):delete e[r],!0}}),t}var lt=function(){function t(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];this.$changes=new _n(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,this.push.apply(this,e)}return t.prototype.onAdd=function(e,r){return r===void 0&&(r=!0),ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.ADD,e,r?this.$items:void 0)},t.prototype.onRemove=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.DELETE,e)},t.prototype.onChange=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.REPLACE,e)},t.is=function(e){return Array.isArray(e)||e.array!==void 0},Object.defineProperty(t.prototype,"length",{get:function(){return this.$items.size},set:function(e){e===0?this.clear():this.splice(e,this.length-e)},enumerable:!1,configurable:!0}),t.prototype.push=function(){for(var e=this,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var s;return r.forEach(function(i){s=e.$refId++,e.setAt(s,i)}),s},t.prototype.pop=function(){var e=Array.from(this.$indexes.values()).pop();if(e!==void 0){this.$changes.delete(e),this.$indexes.delete(e);var r=this.$items.get(e);return this.$items.delete(e),r}},t.prototype.at=function(e){var r=Array.from(this.$items.keys())[e];return this.$items.get(r)},t.prototype.setAt=function(e,r){var n,s;r.$changes!==void 0&&r.$changes.setParent(this,this.$changes.root,e);var i=(s=(n=this.$changes.indexes[e])===null||n===void 0?void 0:n.op)!==null&&s!==void 0?s:I.OPERATION.ADD;this.$changes.indexes[e]=e,this.$indexes.set(e,e),this.$items.set(e,r),this.$changes.change(e,i)},t.prototype.deleteAt=function(e){var r=Array.from(this.$items.keys())[e];return r===void 0?!1:this.$deleteAt(r)},t.prototype.$deleteAt=function(e){return this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e)},t.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Cs.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:I.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.concat=function(){for(var e,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];return new(t.bind.apply(t,ws([void 0],(e=Array.from(this.$items.values())).concat.apply(e,r),!1)))},t.prototype.join=function(e){return Array.from(this.$items.values()).join(e)},t.prototype.reverse=function(){var e=this,r=Array.from(this.$items.keys()),n=Array.from(this.$items.values()).reverse();return n.forEach(function(s,i){e.setAt(r[i],s)}),this},t.prototype.shift=function(){var e=Array.from(this.$items.keys()),r=e.shift();if(r!==void 0){var n=this.$items.get(r);return this.$deleteAt(r),n}},t.prototype.slice=function(e,r){var n=new t;return n.push.apply(n,Array.from(this.$items.values()).slice(e,r)),n},t.prototype.sort=function(e){var r=this;e===void 0&&(e=$b);var n=Array.from(this.$items.keys()),s=Array.from(this.$items.values()).sort(e);return s.forEach(function(i,o){r.setAt(n[o],i)}),this},t.prototype.splice=function(e,r){r===void 0&&(r=this.length-e);for(var n=Array.from(this.$items.keys()),s=[],i=e;i<e+r;i++)s.push(this.$items.get(n[i])),this.$deleteAt(n[i]);return s},t.prototype.unshift=function(){for(var e=this,r=[],n=0;n<arguments.length;n++)r[n]=arguments[n];var s=this.length,i=r.length,o=Array.from(this.$items.values());return r.forEach(function(c,l){e.setAt(l,c)}),o.forEach(function(c,l){e.setAt(i+l,c)}),s+i},t.prototype.indexOf=function(e,r){return Array.from(this.$items.values()).indexOf(e,r)},t.prototype.lastIndexOf=function(e,r){return r===void 0&&(r=this.length-1),Array.from(this.$items.values()).lastIndexOf(e,r)},t.prototype.every=function(e,r){return Array.from(this.$items.values()).every(e,r)},t.prototype.some=function(e,r){return Array.from(this.$items.values()).some(e,r)},t.prototype.forEach=function(e,r){Array.from(this.$items.values()).forEach(e,r)},t.prototype.map=function(e,r){return Array.from(this.$items.values()).map(e,r)},t.prototype.filter=function(e,r){return Array.from(this.$items.values()).filter(e,r)},t.prototype.reduce=function(e,r){return Array.prototype.reduce.apply(Array.from(this.$items.values()),arguments)},t.prototype.reduceRight=function(e,r){return Array.prototype.reduceRight.apply(Array.from(this.$items.values()),arguments)},t.prototype.find=function(e,r){return Array.from(this.$items.values()).find(e,r)},t.prototype.findIndex=function(e,r){return Array.from(this.$items.values()).findIndex(e,r)},t.prototype.fill=function(e,r,n){throw new Error("ArraySchema#fill() not implemented")},t.prototype.copyWithin=function(e,r,n){throw new Error("ArraySchema#copyWithin() not implemented")},t.prototype.toString=function(){return this.$items.toString()},t.prototype.toLocaleString=function(){return this.$items.toLocaleString()},t.prototype[Symbol.iterator]=function(){return Array.from(this.$items.values())[Symbol.iterator]()},t.prototype.entries=function(){return this.$items.entries()},t.prototype.keys=function(){return this.$items.keys()},t.prototype.values=function(){return this.$items.values()},t.prototype.includes=function(e,r){return Array.from(this.$items.values()).includes(e,r)},t.prototype.flatMap=function(e,r){throw new Error("ArraySchema#flatMap() is not supported.")},t.prototype.flat=function(e){throw new Error("ArraySchema#flat() is not supported.")},t.prototype.findLast=function(){var e=Array.from(this.$items.values());return e.findLast.apply(e,arguments)},t.prototype.findLastIndex=function(){var e=Array.from(this.$items.values());return e.findLastIndex.apply(e,arguments)},t.prototype.setIndex=function(e,r){this.$indexes.set(e,r)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)},t.prototype.toArray=function(){return Array.from(this.$items.values())},t.prototype.toJSON=function(){return this.toArray().map(function(e){return typeof e.toJSON=="function"?e.toJSON():e})},t.prototype.clone=function(e){var r;return e?r=new(t.bind.apply(t,ws([void 0],Array.from(this.$items.values()),!1))):r=new(t.bind.apply(t,ws([void 0],this.map(function(n){return n.$changes?n.clone():n}),!1))),r},t}();function Lb(t){return t.$proxy=!0,t=new Proxy(t,{get:function(e,r){return typeof r!="symbol"&&typeof e[r]>"u"?e.get(r):e[r]},set:function(e,r,n){return typeof r!="symbol"&&r.indexOf("$")===-1&&r!=="onAdd"&&r!=="onRemove"&&r!=="onChange"?e.set(r,n):e[r]=n,!0},deleteProperty:function(e,r){return e.delete(r),!0}}),t}var Ye=function(){function t(e){var r=this;if(this.$changes=new _n(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e)if(e instanceof Map||e instanceof t)e.forEach(function(s,i){return r.set(i,s)});else for(var n in e)this.set(n,e[n])}return t.prototype.onAdd=function(e,r){return r===void 0&&(r=!0),ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.ADD,e,r?this.$items:void 0)},t.prototype.onRemove=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.DELETE,e)},t.prototype.onChange=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.REPLACE,e)},t.is=function(e){return e.map!==void 0},t.prototype[Symbol.iterator]=function(){return this.$items[Symbol.iterator]()},Object.defineProperty(t.prototype,Symbol.toStringTag,{get:function(){return this.$items[Symbol.toStringTag]},enumerable:!1,configurable:!0}),t.prototype.set=function(e,r){if(r==null)throw new Error("MapSchema#set('".concat(e,"', ").concat(r,"): trying to set ").concat(r," value on '").concat(e,"'."));var n=typeof this.$changes.indexes[e]<"u",s=n?this.$changes.indexes[e]:this.$refId++,i=n?I.OPERATION.REPLACE:I.OPERATION.ADD,o=r.$changes!==void 0;return o&&r.$changes.setParent(this,this.$changes.root,s),n?o&&this.$items.get(e)!==r&&(i=I.OPERATION.ADD):(this.$changes.indexes[e]=s,this.$indexes.set(s,e)),this.$items.set(e,r),this.$changes.change(e,i),this},t.prototype.get=function(e){return this.$items.get(e)},t.prototype.delete=function(e){return this.$changes.delete(e),this.$items.delete(e)},t.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Cs.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:I.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.has=function(e){return this.$items.has(e)},t.prototype.forEach=function(e){this.$items.forEach(e)},t.prototype.entries=function(){return this.$items.entries()},t.prototype.keys=function(){return this.$items.keys()},t.prototype.values=function(){return this.$items.values()},Object.defineProperty(t.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),t.prototype.setIndex=function(e,r){this.$indexes.set(e,r)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)},t.prototype.toJSON=function(){var e={};return this.forEach(function(r,n){e[n]=typeof r.toJSON=="function"?r.toJSON():r}),e},t.prototype.clone=function(e){var r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(function(n,s){n.$changes?r.set(s,n.clone()):r.set(s,n)})),r},t}(),dh={};function vn(t,e){dh[t]=e}function ks(t){return dh[t]}var No=function(){function t(){this.indexes={},this.fieldsByIndex={},this.deprecated={},this.descriptors={}}return t.create=function(e){var r=new t;return r.schema=Object.assign({},e&&e.schema||{}),r.indexes=Object.assign({},e&&e.indexes||{}),r.fieldsByIndex=Object.assign({},e&&e.fieldsByIndex||{}),r.descriptors=Object.assign({},e&&e.descriptors||{}),r.deprecated=Object.assign({},e&&e.deprecated||{}),r},t.prototype.addField=function(e,r){var n=this.getNextFieldIndex();this.fieldsByIndex[n]=e,this.indexes[e]=n,this.schema[e]=Array.isArray(r)?{array:r[0]}:r},t.prototype.hasField=function(e){return this.indexes[e]!==void 0},t.prototype.addFilter=function(e,r){return this.filters||(this.filters={},this.indexesWithFilters=[]),this.filters[this.indexes[e]]=r,this.indexesWithFilters.push(this.indexes[e]),!0},t.prototype.addChildrenFilter=function(e,r){var n=this.indexes[e],s=this.schema[e];if(ks(Object.keys(s)[0]))return this.childFilters||(this.childFilters={}),this.childFilters[n]=r,!0;console.warn("@filterChildren: field '".concat(e,"' can't have children. Ignoring filter."))},t.prototype.getChildrenFilter=function(e){return this.childFilters&&this.childFilters[this.indexes[e]]},t.prototype.getNextFieldIndex=function(){return Object.keys(this.schema||{}).length},t}();function jb(t){return t._context&&t._context.useFilters}var Ps=function(){function t(){this.types={},this.schemas=new Map,this.useFilters=!1}return t.prototype.has=function(e){return this.schemas.has(e)},t.prototype.get=function(e){return this.types[e]},t.prototype.add=function(e,r){r===void 0&&(r=this.schemas.size),e._definition=No.create(e._definition),e._typeid=r,this.types[r]=e,this.schemas.set(e,r)},t.create=function(e){return e===void 0&&(e={}),function(r){return e.context||(e.context=new t),De(r,e)}},t}(),ph=new Ps;function De(t,e){return e===void 0&&(e={}),function(r,n){var s=e.context||ph,i=r.constructor;if(i._context=s,!t)throw new Error("".concat(i.name,': @type() reference provided for "').concat(n,`" is undefined. Make sure you don't have any circular dependencies.`));s.has(i)||s.add(i);var o=i._definition;if(o.addField(n,t),o.descriptors[n]){if(o.deprecated[n])return;try{throw new Error("@colyseus/schema: Duplicate '".concat(n,"' definition on '").concat(i.name,`'.
Check @type() annotation`))}catch(h){var c=h.stack.split(`
`)[4].trim();throw new Error("".concat(h.message," ").concat(c))}}var l=lt.is(t),u=!l&&Ye.is(t);if(typeof t!="string"&&!Ue.is(t)){var a=Object.values(t)[0];typeof a!="string"&&!s.has(a)&&s.add(a)}if(e.manual){o.descriptors[n]={enumerable:!0,configurable:!0,writable:!0};return}var f="_".concat(n);o.descriptors[f]={enumerable:!1,configurable:!1,writable:!0},o.descriptors[n]={get:function(){return this[f]},set:function(h){h!==this[f]&&(h!=null?(l&&!(h instanceof lt)&&(h=new(lt.bind.apply(lt,ws([void 0],h,!1)))),u&&!(h instanceof Ye)&&(h=new Ye(h)),h.$proxy===void 0&&(u?h=Lb(h):l&&(h=Nb(h))),this.$changes.change(n),h.$changes&&h.$changes.setParent(this,this.$changes.root,this._definition.indexes[n])):this[f]&&this.$changes.delete(n),this[f]=h)},enumerable:!0,configurable:!0}}}function qb(t){return function(e,r){var n=e.constructor,s=n._definition;s.addFilter(r,t)&&(n._context.useFilters=!0)}}function Bb(t){return function(e,r){var n=e.constructor,s=n._definition;s.addChildrenFilter(r,t)&&(n._context.useFilters=!0)}}function Fb(t){return t===void 0&&(t=!0),function(e,r){var n=e.constructor,s=n._definition;s.deprecated[r]=!0,t&&(s.descriptors[r]={get:function(){throw new Error("".concat(r," is deprecated."))},set:function(i){},enumerable:!1,configurable:!0})}}function Ub(t,e,r){r===void 0&&(r={}),r.context||(r.context=t._context||r.context||ph);for(var n in e)De(e[n],r)(t.prototype,n);return t}function zb(t){for(var e=0,r=0,n=0,s=t.length;n<s;n++)e=t.charCodeAt(n),e<128?r+=1:e<2048?r+=2:e<55296||e>=57344?r+=3:(n++,r+=4);return r}function yh(t,e,r){for(var n=0,s=0,i=r.length;s<i;s++)n=r.charCodeAt(s),n<128?t[e++]=n:n<2048?(t[e++]=192|n>>6,t[e++]=128|n&63):n<55296||n>=57344?(t[e++]=224|n>>12,t[e++]=128|n>>6&63,t[e++]=128|n&63):(s++,n=65536+((n&1023)<<10|r.charCodeAt(s)&1023),t[e++]=240|n>>18,t[e++]=128|n>>12&63,t[e++]=128|n>>6&63,t[e++]=128|n&63)}function gh(t,e){t.push(e&255)}function ve(t,e){t.push(e&255)}function mh(t,e){t.push(e&255),t.push(e>>8&255)}function Lo(t,e){t.push(e&255),t.push(e>>8&255)}function yn(t,e){t.push(e&255),t.push(e>>8&255),t.push(e>>16&255),t.push(e>>24&255)}function tr(t,e){var r=e>>24,n=e>>16,s=e>>8,i=e;t.push(i&255),t.push(s&255),t.push(n&255),t.push(r&255)}function _h(t,e){var r=Math.floor(e/Math.pow(2,32)),n=e>>>0;tr(t,n),tr(t,r)}function vh(t,e){var r=e/Math.pow(2,32)>>0,n=e>>>0;tr(t,n),tr(t,r)}function Hb(t,e){bh(t,e)}function Vb(t,e){jo(t,e)}var gn=new Int32Array(2),Gb=new Float32Array(gn.buffer),Wb=new Float64Array(gn.buffer);function bh(t,e){Gb[0]=e,yn(t,gn[0])}function jo(t,e){Wb[0]=e,yn(t,gn[0]),yn(t,gn[1])}function Jb(t,e){return ve(t,e?1:0)}function Es(t,e){e||(e="");var r=zb(e),n=0;if(r<32)t.push(r|160),n=1;else if(r<256)t.push(217),ve(t,r),n=2;else if(r<65536)t.push(218),Lo(t,r),n=3;else if(r<4294967296)t.push(219),tr(t,r),n=5;else throw new Error("String too long");return yh(t,t.length,e),n+r}function Ee(t,e){if(isNaN(e))return Ee(t,0);if(isFinite(e)){if(e!==(e|0))return t.push(203),jo(t,e),9}else return Ee(t,e>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER);return e>=0?e<128?(ve(t,e),1):e<256?(t.push(204),ve(t,e),2):e<65536?(t.push(205),Lo(t,e),3):e<4294967296?(t.push(206),tr(t,e),5):(t.push(207),vh(t,e),9):e>=-32?(t.push(224|e+32),1):e>=-128?(t.push(208),gh(t,e),2):e>=-32768?(t.push(209),mh(t,e),3):e>=-2147483648?(t.push(210),yn(t,e),5):(t.push(211),_h(t,e),9)}var qo=Object.freeze({__proto__:null,utf8Write:yh,int8:gh,uint8:ve,int16:mh,uint16:Lo,int32:yn,uint32:tr,int64:_h,uint64:vh,float32:Hb,float64:Vb,writeFloat32:bh,writeFloat64:jo,boolean:Jb,string:Es,number:Ee});function Qb(t,e,r){for(var n="",s=0,i=e,o=e+r;i<o;i++){var c=t[i];if(!(c&128)){n+=String.fromCharCode(c);continue}if((c&224)===192){n+=String.fromCharCode((c&31)<<6|t[++i]&63);continue}if((c&240)===224){n+=String.fromCharCode((c&15)<<12|(t[++i]&63)<<6|(t[++i]&63)<<0);continue}if((c&248)===240){s=(c&7)<<18|(t[++i]&63)<<12|(t[++i]&63)<<6|(t[++i]&63)<<0,s>=65536?(s-=65536,n+=String.fromCharCode((s>>>10)+55296,(s&1023)+56320)):n+=String.fromCharCode(s);continue}console.error("Invalid byte "+c.toString(16))}return n}function xh(t,e){return bn(t,e)<<24>>24}function bn(t,e){return t[e.offset++]}function Sh(t,e){return As(t,e)<<16>>16}function As(t,e){return t[e.offset++]|t[e.offset++]<<8}function rr(t,e){return t[e.offset++]|t[e.offset++]<<8|t[e.offset++]<<16|t[e.offset++]<<24}function Dr(t,e){return rr(t,e)>>>0}function Yb(t,e){return Bo(t,e)}function Kb(t,e){return Fo(t,e)}function wh(t,e){var r=Dr(t,e),n=rr(t,e)*Math.pow(2,32);return n+r}function Oh(t,e){var r=Dr(t,e),n=Dr(t,e)*Math.pow(2,32);return n+r}var mn=new Int32Array(2),Xb=new Float32Array(mn.buffer),Zb=new Float64Array(mn.buffer);function Bo(t,e){return mn[0]=rr(t,e),Xb[0]}function Fo(t,e){return mn[0]=rr(t,e),mn[1]=rr(t,e),Zb[0]}function ex(t,e){return bn(t,e)>0}function Eh(t,e){var r=t[e.offset++],n;r<192?n=r&31:r===217?n=bn(t,e):r===218?n=As(t,e):r===219&&(n=Dr(t,e));var s=Qb(t,e.offset,n);return e.offset+=n,s}function tx(t,e){var r=t[e.offset];return r<192&&r>160||r===217||r===218||r===219}function Xt(t,e){var r=t[e.offset++];if(r<128)return r;if(r===202)return Bo(t,e);if(r===203)return Fo(t,e);if(r===204)return bn(t,e);if(r===205)return As(t,e);if(r===206)return Dr(t,e);if(r===207)return Oh(t,e);if(r===208)return xh(t,e);if(r===209)return Sh(t,e);if(r===210)return rr(t,e);if(r===211)return wh(t,e);if(r>223)return(255-r+1)*-1}function rx(t,e){var r=t[e.offset];return r<128||r>=202&&r<=211}function nx(t,e){return t[e.offset]<160}function kh(t,e){return t[e.offset-1]===Os&&(t[e.offset]<128||t[e.offset]>=202&&t[e.offset]<=211)}var Ch=Object.freeze({__proto__:null,int8:xh,uint8:bn,int16:Sh,uint16:As,int32:rr,uint32:Dr,float32:Yb,float64:Kb,int64:wh,uint64:Oh,readFloat32:Bo,readFloat64:Fo,boolean:ex,string:Eh,stringCheck:tx,number:Xt,numberCheck:rx,arrayCheck:nx,switchStructureCheck:kh}),Uo=function(){function t(e){var r=this;this.$changes=new _n(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e&&e.forEach(function(n){return r.add(n)})}return t.prototype.onAdd=function(e,r){return r===void 0&&(r=!0),ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.ADD,e,r?this.$items:void 0)},t.prototype.onRemove=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.DELETE,e)},t.prototype.onChange=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.REPLACE,e)},t.is=function(e){return e.collection!==void 0},t.prototype.add=function(e){var r=this.$refId++,n=e.$changes!==void 0;return n&&e.$changes.setParent(this,this.$changes.root,r),this.$changes.indexes[r]=r,this.$indexes.set(r,r),this.$items.set(r,e),this.$changes.change(r),r},t.prototype.at=function(e){var r=Array.from(this.$items.keys())[e];return this.$items.get(r)},t.prototype.entries=function(){return this.$items.entries()},t.prototype.delete=function(e){for(var r=this.$items.entries(),n,s;(s=r.next())&&!s.done;)if(e===s.value[1]){n=s.value[0];break}return n===void 0?!1:(this.$changes.delete(n),this.$indexes.delete(n),this.$items.delete(n))},t.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Cs.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:I.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.has=function(e){return Array.from(this.$items.values()).some(function(r){return r===e})},t.prototype.forEach=function(e){var r=this;this.$items.forEach(function(n,s,i){return e(n,s,r)})},t.prototype.values=function(){return this.$items.values()},Object.defineProperty(t.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),t.prototype.setIndex=function(e,r){this.$indexes.set(e,r)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)},t.prototype.toArray=function(){return Array.from(this.$items.values())},t.prototype.toJSON=function(){var e=[];return this.forEach(function(r,n){e.push(typeof r.toJSON=="function"?r.toJSON():r)}),e},t.prototype.clone=function(e){var r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(function(n){n.$changes?r.add(n.clone()):r.add(n)})),r},t}(),zo=function(){function t(e){var r=this;this.$changes=new _n(this),this.$items=new Map,this.$indexes=new Map,this.$refId=0,e&&e.forEach(function(n){return r.add(n)})}return t.prototype.onAdd=function(e,r){return r===void 0&&(r=!0),ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.ADD,e,r?this.$items:void 0)},t.prototype.onRemove=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.DELETE,e)},t.prototype.onChange=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.REPLACE,e)},t.is=function(e){return e.set!==void 0},t.prototype.add=function(e){var r,n;if(this.has(e))return!1;var s=this.$refId++;e.$changes!==void 0&&e.$changes.setParent(this,this.$changes.root,s);var i=(n=(r=this.$changes.indexes[s])===null||r===void 0?void 0:r.op)!==null&&n!==void 0?n:I.OPERATION.ADD;return this.$changes.indexes[s]=s,this.$indexes.set(s,s),this.$items.set(s,e),this.$changes.change(s,i),s},t.prototype.entries=function(){return this.$items.entries()},t.prototype.delete=function(e){for(var r=this.$items.entries(),n,s;(s=r.next())&&!s.done;)if(e===s.value[1]){n=s.value[0];break}return n===void 0?!1:(this.$changes.delete(n),this.$indexes.delete(n),this.$items.delete(n))},t.prototype.clear=function(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Cs.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:I.OPERATION.CLEAR}),this.$changes.touchParents()},t.prototype.has=function(e){for(var r=this.$items.values(),n=!1,s;(s=r.next())&&!s.done;)if(e===s.value){n=!0;break}return n},t.prototype.forEach=function(e){var r=this;this.$items.forEach(function(n,s,i){return e(n,s,r)})},t.prototype.values=function(){return this.$items.values()},Object.defineProperty(t.prototype,"size",{get:function(){return this.$items.size},enumerable:!1,configurable:!0}),t.prototype.setIndex=function(e,r){this.$indexes.set(e,r)},t.prototype.getIndex=function(e){return this.$indexes.get(e)},t.prototype.getByIndex=function(e){return this.$items.get(this.$indexes.get(e))},t.prototype.deleteByIndex=function(e){var r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)},t.prototype.toArray=function(){return Array.from(this.$items.values())},t.prototype.toJSON=function(){var e=[];return this.forEach(function(r,n){e.push(typeof r.toJSON=="function"?r.toJSON():r)}),e},t.prototype.clone=function(e){var r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(function(n){n.$changes?r.add(n.clone()):r.add(n)})),r},t}(),sx=function(){function t(){this.refIds=new WeakSet,this.containerIndexes=new WeakMap}return t.prototype.addRefId=function(e){this.refIds.has(e)||(this.refIds.add(e),this.containerIndexes.set(e,new Set))},t.get=function(e){return e.$filterState===void 0&&(e.$filterState=new t),e.$filterState},t}(),ix=function(){function t(){this.refs=new Map,this.refCounts={},this.deletedRefs=new Set,this.nextUniqueId=0}return t.prototype.getNextUniqueId=function(){return this.nextUniqueId++},t.prototype.addRef=function(e,r,n){n===void 0&&(n=!0),this.refs.set(e,r),n&&(this.refCounts[e]=(this.refCounts[e]||0)+1)},t.prototype.removeRef=function(e){this.refCounts[e]=this.refCounts[e]-1,this.deletedRefs.add(e)},t.prototype.clearRefs=function(){this.refs.clear(),this.deletedRefs.clear(),this.refCounts={}},t.prototype.garbageCollectDeletedRefs=function(){var e=this;this.deletedRefs.forEach(function(r){if(!(e.refCounts[r]>0)){var n=e.refs.get(r);if(n instanceof Ue)for(var s in n._definition.schema)typeof n._definition.schema[s]!="string"&&n[s]&&n[s].$changes&&e.removeRef(n[s].$changes.refId);else{var i=n.$changes.parent._definition,o=i.schema[i.fieldsByIndex[n.$changes.parentIndex]];typeof Object.values(o)[0]=="function"&&Array.from(n.values()).forEach(function(c){return e.removeRef(c.$changes.refId)})}e.refs.delete(r),delete e.refCounts[r]}}),this.deletedRefs.clear()},t}(),Ho=function(t){pn(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e}(Error);function ox(t,e,r,n){var s,i=!1;switch(e){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":s="number",isNaN(t)&&console.log('trying to encode "NaN" in '.concat(r.constructor.name,"#").concat(n));break;case"string":s="string",i=!0;break;case"boolean":return}if(typeof t!==s&&(!i||i&&t!==null)){var o="'".concat(JSON.stringify(t),"'").concat(t&&t.constructor&&" (".concat(t.constructor.name,")")||"");throw new Ho("a '".concat(s,"' was expected, but ").concat(o," was provided in ").concat(r.constructor.name,"#").concat(n))}}function fh(t,e,r,n){if(!(t instanceof e))throw new Ho("a '".concat(e.name,"' was expected, but '").concat(t.constructor.name,"' was provided in ").concat(r.constructor.name,"#").concat(n))}function ax(t,e,r,n,s){ox(r,t,n,s);var i=qo[t];if(i)i(e,r);else throw new Ho("a '".concat(t,"' was expected, but ").concat(r," was provided in ").concat(n.constructor.name,"#").concat(s))}function cx(t,e,r){return Ch[t](e,r)}var Ue=function(){function t(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];Object.defineProperties(this,{$changes:{value:new _n(this,void 0,new ix),enumerable:!1,writable:!0},$callbacks:{value:void 0,enumerable:!1,writable:!0}});var n=this._definition.descriptors;n&&Object.defineProperties(this,n),e[0]&&this.assign(e[0])}return t.onError=function(e){console.error(e)},t.is=function(e){return e._definition&&e._definition.schema!==void 0},t.prototype.onChange=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.REPLACE,e)},t.prototype.onRemove=function(e){return ke(this.$callbacks||(this.$callbacks=[]),I.OPERATION.DELETE,e)},t.prototype.assign=function(e){return Object.assign(this,e),this},Object.defineProperty(t.prototype,"_definition",{get:function(){return this.constructor._definition},enumerable:!1,configurable:!0}),t.prototype.setDirty=function(e,r){this.$changes.change(e,r)},t.prototype.listen=function(e,r,n){var s=this;return n===void 0&&(n=!0),this.$callbacks||(this.$callbacks={}),this.$callbacks[e]||(this.$callbacks[e]=[]),this.$callbacks[e].push(r),n&&this[e]!==void 0&&r(this[e],void 0),function(){return hh(s.$callbacks[e],s.$callbacks[e].indexOf(r))}},t.prototype.decode=function(e,r,n){var s;r===void 0&&(r={offset:0}),n===void 0&&(n=this);var i=[],o=this.$changes.root,c=e.length,l=0;for(o.refs.set(l,this);r.offset<c;){var u=e[r.offset++];if(u==Os){l=Xt(e,r);var a=o.refs.get(l);if(!a)throw new Error('"refId" not found: '.concat(l));n=a;continue}var f=n.$changes,h=n._definition!==void 0,d=h?u>>6<<6:u;if(d===I.OPERATION.CLEAR){n.clear(i);continue}var p=h?u%(d||255):Xt(e,r),y=h?n._definition.fieldsByIndex[p]:"",m=f.getType(p),S=void 0,R=void 0,w=void 0;if(h?R=n["_".concat(y)]:(R=n.getByIndex(p),(d&I.OPERATION.ADD)===I.OPERATION.ADD?(w=n instanceof Ye?Eh(e,r):p,n.setIndex(p,w)):w=n.getIndex(p)),(d&I.OPERATION.DELETE)===I.OPERATION.DELETE&&(d!==I.OPERATION.DELETE_AND_ADD&&n.deleteByIndex(p),R&&R.$changes&&o.removeRef(R.$changes.refId),S=null),y===void 0){console.warn("@colyseus/schema: definition mismatch");for(var E={offset:r.offset};r.offset<c&&!(kh(e,r)&&(E.offset=r.offset+1,o.refs.has(Xt(e,E))));)r.offset++;continue}else if(d!==I.OPERATION.DELETE)if(t.is(m)){var C=Xt(e,r);if(S=o.refs.get(C),d!==I.OPERATION.REPLACE){var T=this.getSchemaType(e,r,m);S||(S=this.createTypeInstance(T),S.$changes.refId=C,R&&(S.$callbacks=R.$callbacks,R.$changes.refId&&C!==R.$changes.refId&&o.removeRef(R.$changes.refId))),o.addRef(C,S,S!==R)}}else if(typeof m=="string")S=cx(m,e,r);else{var O=ks(Object.keys(m)[0]),P=Xt(e,r),j=o.refs.has(P)?R||o.refs.get(P):new O.constructor;if(S=j.clone(!0),S.$changes.refId=P,R&&(S.$callbacks=R.$callbacks,R.$changes.refId&&P!==R.$changes.refId)){o.removeRef(R.$changes.refId);for(var L=R.entries(),z=void 0;(z=L.next())&&!z.done;){var v=(s=z.value,s[0]),D=s[1];i.push({refId:P,op:I.OPERATION.DELETE,field:v,value:void 0,previousValue:D})}}o.addRef(P,S,j!==R)}if(S!=null){if(S.$changes&&S.$changes.setParent(f.ref,f.root,p),n instanceof t)n[y]=S;else if(n instanceof Ye){var v=w;n.$items.set(v,S),n.$changes.allChanges.add(p)}else if(n instanceof lt)n.setAt(p,S);else if(n instanceof Uo){var k=n.add(S);n.setIndex(p,k)}else if(n instanceof zo){var k=n.add(S);k!==!1&&n.setIndex(p,k)}}R!==S&&i.push({refId:l,op:d,field:y,dynamicIndex:w,value:S,previousValue:R})}return this._triggerChanges(i),o.garbageCollectDeletedRefs(),i},t.prototype.encode=function(e,r,n){e===void 0&&(e=!1),r===void 0&&(r=[]),n===void 0&&(n=!1);for(var s=this.$changes,i=new WeakSet,o=[s],c=1,l=0;l<c;l++){var u=o[l],a=u.ref,f=a instanceof t;u.ensureRefId(),i.add(u),u!==s&&(u.changed||e)&&(ve(r,Os),Ee(r,u.refId));for(var h=e?Array.from(u.allChanges):Array.from(u.changes.values()),d=0,p=h.length;d<p;d++){var y=e?{op:I.OPERATION.ADD,index:h[d]}:h[d],m=y.index,S=f?a._definition.fieldsByIndex&&a._definition.fieldsByIndex[m]:m,R=r.length;if(y.op!==I.OPERATION.TOUCH)if(f)ve(r,m|y.op);else{if(ve(r,y.op),y.op===I.OPERATION.CLEAR)continue;Ee(r,m)}if(!f&&(y.op&I.OPERATION.ADD)==I.OPERATION.ADD&&a instanceof Ye){var w=u.ref.$indexes.get(m);Es(r,w)}if(y.op!==I.OPERATION.DELETE){var E=u.getType(m),C=u.getValue(m);if(C&&C.$changes&&!i.has(C.$changes)&&(o.push(C.$changes),C.$changes.ensureRefId(),c++),y.op!==I.OPERATION.TOUCH){if(t.is(E))fh(C,E,a,S),Ee(r,C.$changes.refId),(y.op&I.OPERATION.ADD)===I.OPERATION.ADD&&this.tryEncodeTypeId(r,E,C.constructor);else if(typeof E=="string")ax(E,r,C,a,S);else{var T=ks(Object.keys(E)[0]);fh(a["_".concat(S)],T.constructor,a,S),Ee(r,C.$changes.refId)}n&&u.cache(m,r.slice(R))}}}!e&&!n&&u.discard()}return r},t.prototype.encodeAll=function(e){return this.encode(!0,[],e)},t.prototype.applyFilters=function(e,r){var n,s;r===void 0&&(r=!1);for(var i=this,o=new Set,c=sx.get(e),l=[this.$changes],u=1,a=[],f=function(d){var p=l[d];if(o.has(p.refId))return"continue";var y=p.ref,m=y instanceof t;ve(a,Os),Ee(a,p.refId);var S=c.refIds.has(p),R=r||!S;c.addRefId(p);var w=c.containerIndexes.get(p),E=R?Array.from(p.allChanges):Array.from(p.changes.values());if(!r&&m&&y._definition.indexesWithFilters){var C=y._definition.indexesWithFilters;C.forEach(function(A){!w.has(A)&&p.allChanges.has(A)&&(R?E.push(A):E.push({op:I.OPERATION.ADD,index:A}))})}for(var T=0,O=E.length;T<O;T++){var P=R?{op:I.OPERATION.ADD,index:E[T]}:E[T];if(P.op===I.OPERATION.CLEAR){ve(a,P.op);continue}var j=P.index;if(P.op===I.OPERATION.DELETE){m?ve(a,P.op|j):(ve(a,P.op),Ee(a,j));continue}var L=p.getValue(j),z=p.getType(j);if(m){var v=y._definition.filters&&y._definition.filters[j];if(v&&!v.call(y,e,L,i)){L&&L.$changes&&o.add(L.$changes.refId);continue}}else{var D=p.parent,v=p.getChildrenFilter();if(v&&!v.call(D,e,y.$indexes.get(j),L,i)){L&&L.$changes&&o.add(L.$changes.refId);continue}}if(L.$changes&&(l.push(L.$changes),u++),P.op!==I.OPERATION.TOUCH)if(P.op===I.OPERATION.ADD||m)a.push.apply(a,(n=p.caches[j])!==null&&n!==void 0?n:[]),w.add(j);else if(w.has(j))a.push.apply(a,(s=p.caches[j])!==null&&s!==void 0?s:[]);else{if(w.add(j),ve(a,I.OPERATION.ADD),Ee(a,j),y instanceof Ye){var k=p.ref.$indexes.get(j);Es(a,k)}L.$changes?Ee(a,L.$changes.refId):qo[z](a,L)}else if(L.$changes&&!m){if(ve(a,I.OPERATION.ADD),Ee(a,j),y instanceof Ye){var k=p.ref.$indexes.get(j);Es(a,k)}Ee(a,L.$changes.refId)}}},h=0;h<u;h++)f(h);return a},t.prototype.clone=function(){var e,r=new this.constructor,n=this._definition.schema;for(var s in n)typeof this[s]=="object"&&typeof((e=this[s])===null||e===void 0?void 0:e.clone)=="function"?r[s]=this[s].clone():r[s]=this[s];return r},t.prototype.toJSON=function(){var e=this._definition.schema,r=this._definition.deprecated,n={};for(var s in e)!r[s]&&this[s]!==null&&typeof this[s]<"u"&&(n[s]=typeof this[s].toJSON=="function"?this[s].toJSON():this["_".concat(s)]);return n},t.prototype.discardAllChanges=function(){this.$changes.discardAll()},t.prototype.getByIndex=function(e){return this[this._definition.fieldsByIndex[e]]},t.prototype.deleteByIndex=function(e){this[this._definition.fieldsByIndex[e]]=void 0},t.prototype.tryEncodeTypeId=function(e,r,n){r._typeid!==n._typeid&&(ve(e,lh),Ee(e,n._typeid))},t.prototype.getSchemaType=function(e,r,n){var s;return e[r.offset]===lh&&(r.offset++,s=this.constructor._context.get(Xt(e,r))),s||n},t.prototype.createTypeInstance=function(e){var r=new e;return r.$changes.root=this.$changes.root,r},t.prototype._triggerChanges=function(e){for(var r,n,s,i,o,c,l,u,a,f=new Set,h=this.$changes.root.refs,d=function(y){var m=e[y],S=m.refId,R=h.get(S),w=R.$callbacks;if((m.op&I.OPERATION.DELETE)===I.OPERATION.DELETE&&m.previousValue instanceof t&&((n=(r=m.previousValue.$callbacks)===null||r===void 0?void 0:r[I.OPERATION.DELETE])===null||n===void 0||n.forEach(function(E){return E()})),!w)return"continue";if(R instanceof t){if(!f.has(S))try{(s=w?.[I.OPERATION.REPLACE])===null||s===void 0||s.forEach(function(E){return E(e)})}catch(E){t.onError(E)}try{w.hasOwnProperty(m.field)&&((i=w[m.field])===null||i===void 0||i.forEach(function(E){return E(m.value,m.previousValue)}))}catch(E){t.onError(E)}}else m.op===I.OPERATION.ADD&&m.previousValue===void 0?(o=w[I.OPERATION.ADD])===null||o===void 0||o.forEach(function(E){var C;return E(m.value,(C=m.dynamicIndex)!==null&&C!==void 0?C:m.field)}):m.op===I.OPERATION.DELETE?m.previousValue!==void 0&&((c=w[I.OPERATION.DELETE])===null||c===void 0||c.forEach(function(E){var C;return E(m.previousValue,(C=m.dynamicIndex)!==null&&C!==void 0?C:m.field)})):m.op===I.OPERATION.DELETE_AND_ADD&&(m.previousValue!==void 0&&((l=w[I.OPERATION.DELETE])===null||l===void 0||l.forEach(function(E){var C;return E(m.previousValue,(C=m.dynamicIndex)!==null&&C!==void 0?C:m.field)})),(u=w[I.OPERATION.ADD])===null||u===void 0||u.forEach(function(E){var C;return E(m.value,(C=m.dynamicIndex)!==null&&C!==void 0?C:m.field)})),m.value!==m.previousValue&&((a=w[I.OPERATION.REPLACE])===null||a===void 0||a.forEach(function(E){var C;return E(m.value,(C=m.dynamicIndex)!==null&&C!==void 0?C:m.field)}));f.add(S)},p=0;p<e.length;p++)d(p)},t._definition=No.create(),t}();function ux(t){for(var e=[t.$changes],r=1,n={},s=n,i=function(c){var l=e[c];l.changes.forEach(function(u){var a=l.ref,f=u.index,h=a._definition?a._definition.fieldsByIndex[f]:a.$indexes.get(f);s[h]=l.getValue(f)})},o=0;o<r;o++)i(o);return n}var er={context:new Ps},Vo=function(t){pn(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return Zt([De("string",er)],e.prototype,"name",void 0),Zt([De("string",er)],e.prototype,"type",void 0),Zt([De("number",er)],e.prototype,"referencedType",void 0),e}(Ue),$o=function(t){pn(e,t);function e(){var r=t!==null&&t.apply(this,arguments)||this;return r.fields=new lt,r}return Zt([De("number",er)],e.prototype,"id",void 0),Zt([De([Vo],er)],e.prototype,"fields",void 0),e}(Ue),lx=function(t){pn(e,t);function e(){var r=t!==null&&t.apply(this,arguments)||this;return r.types=new lt,r}return e.encode=function(r){var n=r.constructor,s=new e;s.rootType=n._typeid;var i=function(u,a){for(var f in a){var h=new Vo;h.name=f;var d=void 0;if(typeof a[f]=="string")d=a[f];else{var p=a[f],y=void 0;Ue.is(p)?(d="ref",y=a[f]):(d=Object.keys(p)[0],typeof p[d]=="string"?d+=":"+p[d]:y=p[d]),h.referencedType=y?y._typeid:-1}h.type=d,u.fields.push(h)}s.types.push(u)},o=n._context.types;for(var c in o){var l=new $o;l.id=Number(c),i(l,o[c]._definition.schema)}return s.encodeAll()},e.decode=function(r,n){var s=new Ps,i=new e;i.decode(r,n);var o=i.types.reduce(function(f,h){var d=function(y){pn(m,y);function m(){return y!==null&&y.apply(this,arguments)||this}return m}(Ue),p=h.id;return f[p]=d,s.add(d,p),f},{});i.types.forEach(function(f){var h=o[f.id];f.fields.forEach(function(d){var p;if(d.referencedType!==void 0){var y=d.type,m=o[d.referencedType];if(!m){var S=d.type.split(":");y=S[0],m=S[1]}y==="ref"?De(m,{context:s})(h.prototype,d.name):De((p={},p[y]=m,p),{context:s})(h.prototype,d.name)}else De(d.type,{context:s})(h.prototype,d.name)})});var c=o[i.rootType],l=new c;for(var u in c._definition.schema){var a=c._definition.schema[u];typeof a!="string"&&(l[u]=typeof a=="function"?new a:new(ks(Object.keys(a)[0])).constructor)}return l},Zt([De([$o],er)],e.prototype,"types",void 0),Zt([De("number",er)],e.prototype,"rootType",void 0),e}(Ue);vn("map",{constructor:Ye});vn("array",{constructor:lt});vn("set",{constructor:zo});vn("collection",{constructor:Uo});I.ArraySchema=lt;I.CollectionSchema=Uo;I.Context=Ps;I.MapSchema=Ye;I.Reflection=lx;I.ReflectionField=Vo;I.ReflectionType=$o;I.Schema=Ue;I.SchemaDefinition=No;I.SetSchema=zo;I.decode=Ch;I.defineTypes=Ub;I.deprecated=Fb;I.dumpChanges=ux;I.encode=qo;I.filter=qb;I.filterChildren=Bb;I.hasFilter=jb;I.registerType=vn;I.type=De});var Pt=x((PM,Th)=>{var Wo=Object.defineProperty,fx=Object.getOwnPropertyDescriptor,hx=Object.getOwnPropertyNames,dx=Object.prototype.hasOwnProperty,px=(t,e)=>{for(var r in e)Wo(t,r,{get:e[r],enumerable:!0})},yx=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of hx(e))!dx.call(t,s)&&s!==r&&Wo(t,s,{get:()=>e[s],enumerable:!(n=fx(e,s))||n.enumerable});return t},gx=t=>yx(Wo({},"__esModule",{value:!0}),t),Ph={};px(Ph,{ErrorCode:()=>Ih,IpcProtocol:()=>Rh,Protocol:()=>Ah,getMessageBytes:()=>vx,utf8Length:()=>Rs,utf8Write:()=>Go});Th.exports=gx(Ph);var mx=Ss(),Is=nr(),_x=Ot(),Ah=(t=>(t[t.JOIN_ROOM=10]="JOIN_ROOM",t[t.ERROR=11]="ERROR",t[t.LEAVE_ROOM=12]="LEAVE_ROOM",t[t.ROOM_DATA=13]="ROOM_DATA",t[t.ROOM_STATE=14]="ROOM_STATE",t[t.ROOM_STATE_PATCH=15]="ROOM_STATE_PATCH",t[t.ROOM_DATA_SCHEMA=16]="ROOM_DATA_SCHEMA",t[t.ROOM_DATA_BYTES=17]="ROOM_DATA_BYTES",t[t.WS_CLOSE_NORMAL=1e3]="WS_CLOSE_NORMAL",t[t.WS_CLOSE_CONSENTED=4e3]="WS_CLOSE_CONSENTED",t[t.WS_CLOSE_WITH_ERROR=4002]="WS_CLOSE_WITH_ERROR",t[t.WS_CLOSE_DEVMODE_RESTART=4010]="WS_CLOSE_DEVMODE_RESTART",t[t.WS_SERVER_DISCONNECT=4201]="WS_SERVER_DISCONNECT",t[t.WS_TOO_MANY_CLIENTS=4202]="WS_TOO_MANY_CLIENTS",t))(Ah||{}),Ih=(t=>(t[t.MATCHMAKE_NO_HANDLER=4210]="MATCHMAKE_NO_HANDLER",t[t.MATCHMAKE_INVALID_CRITERIA=4211]="MATCHMAKE_INVALID_CRITERIA",t[t.MATCHMAKE_INVALID_ROOM_ID=4212]="MATCHMAKE_INVALID_ROOM_ID",t[t.MATCHMAKE_UNHANDLED=4213]="MATCHMAKE_UNHANDLED",t[t.MATCHMAKE_EXPIRED=4214]="MATCHMAKE_EXPIRED",t[t.AUTH_FAILED=4215]="AUTH_FAILED",t[t.APPLICATION_ERROR=4216]="APPLICATION_ERROR",t))(Ih||{}),Rh=(t=>(t[t.SUCCESS=0]="SUCCESS",t[t.ERROR=1]="ERROR",t[t.TIMEOUT=2]="TIMEOUT",t))(Rh||{}),vx={10:(t,e,r)=>{let n=0,s=Rs(t),i=Rs(e),o=r?r.length:0,c=Buffer.allocUnsafe(1+s+i+o);if(c.writeUInt8(10,n++),Go(c,n,t),n+=s,Go(c,n,e),n+=i,r)for(let l=0,u=r.length;l<u;l++)c.writeUInt8(r[l],n++);return c},11:(t,e="")=>{let r=[11];return Is.encode.number(r,t),Is.encode.string(r,e),r},14:t=>[14,...t],16:t=>{let e=t.constructor._typeid;if(e===void 0)throw _x.logger.warn("Starting at colyseus >= 0.13 You must provide a type and message when calling `this.broadcast()` or `client.send()`. Please see: https://docs.colyseus.io/migrating/0.13/"),new Error(`an instance of Schema was expected, but ${JSON.stringify(t)} has been provided.`);return[16,e,...t.encodeAll()]},raw:(t,e,r,n)=>{let s=[t],i=typeof e;if(i==="string")Is.encode.string(s,e);else if(i==="number")Is.encode.number(s,e);else throw new Error(`Protocol.ROOM_DATA: message type not supported "${e.toString()}"`);let o;if(r!==void 0){let c=(0,mx.pack)(r);o=new Uint8Array(s.length+c.byteLength),o.set(new Uint8Array(s),0),o.set(new Uint8Array(c),s.length)}else n!==void 0?(o=new Uint8Array(s.length+(n.byteLength||n.length)),o.set(new Uint8Array(s),0),o.set(new Uint8Array(n),s.length)):o=new Uint8Array(s);return o}};function Go(t,e,r=""){t[e++]=Rs(r)-1;let n=0;for(let s=0,i=r.length;s<i;s++)n=r.charCodeAt(s),n<128?t[e++]=n:n<2048?(t[e++]=192|n>>6,t[e++]=128|n&63):n<55296||n>=57344?(t[e++]=224|n>>12,t[e++]=128|n>>6&63,t[e++]=128|n&63):(s++,n=65536+((n&1023)<<10|r.charCodeAt(s)&1023),t[e++]=240|n>>18,t[e++]=128|n>>12&63,t[e++]=128|n>>6&63,t[e++]=128|n&63)}function Rs(t=""){let e=0,r=0;for(let n=0,s=t.length;n<s;n++)e=t.charCodeAt(n),e<128?r+=1:e<2048?r+=2:e<55296||e>=57344?r+=3:(n++,r+=4);return r+1}});var $r=x((AM,Dh)=>{var Qo=Object.defineProperty,bx=Object.getOwnPropertyDescriptor,xx=Object.getOwnPropertyNames,Sx=Object.prototype.hasOwnProperty,wx=(t,e)=>{for(var r in e)Qo(t,r,{get:e[r],enumerable:!0})},Ox=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of xx(e))!Sx.call(t,s)&&s!==r&&Qo(t,s,{get:()=>e[s],enumerable:!(n=bx(e,s))||n.enumerable});return t},Ex=t=>Ox(Qo({},"__esModule",{value:!0}),t),Mh={};wx(Mh,{ServerError:()=>Jo});Dh.exports=Ex(Mh);var kx=Pt(),Jo=class t extends Error{code;constructor(e=kx.ErrorCode.MATCHMAKE_UNHANDLED,r){super(r),Error.captureStackTrace&&Error.captureStackTrace(this,t),this.name="ServerError",this.code=e}}});var Ke=x((IM,Lh)=>{var Cx=Object.create,Ts=Object.defineProperty,Px=Object.getOwnPropertyDescriptor,Ax=Object.getOwnPropertyNames,Ix=Object.getPrototypeOf,Rx=Object.prototype.hasOwnProperty,Tx=(t,e)=>{for(var r in e)Ts(t,r,{get:e[r],enumerable:!0})},$h=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Ax(e))!Rx.call(t,s)&&s!==r&&Ts(t,s,{get:()=>e[s],enumerable:!(n=Px(e,s))||n.enumerable});return t},Mx=(t,e,r)=>(r=t!=null?Cx(Ix(t)):{},$h(e||!t||!t.__esModule?Ts(r,"default",{value:t,enumerable:!0}):r,t)),Dx=t=>$h(Ts({},"__esModule",{value:!0}),t),Nh={};Tx(Nh,{debugAndPrintError:()=>zx,debugConnection:()=>Lx,debugDriver:()=>jx,debugError:()=>Yo,debugMatchMaking:()=>qx,debugMessage:()=>Bx,debugPatch:()=>Fx,debugPresence:()=>Ux});Lh.exports=Dx(Nh);var sr=Mx(os()),$x=Ot(),Nx=$r(),Lx=(0,sr.default)("colyseus:connection"),jx=(0,sr.default)("colyseus:driver"),Yo=(0,sr.default)("colyseus:errors"),qx=(0,sr.default)("colyseus:matchmaking"),Bx=(0,sr.default)("colyseus:message"),Fx=(0,sr.default)("colyseus:patch"),Ux=(0,sr.default)("colyseus:presence"),zx=t=>{let e=t instanceof Error?t.stack:t;t instanceof Nx.ServerError||$x.logger.error(e),Yo.call(Yo,e)}});var jh=x((RM,Zo)=>{var Ko=require("crypto");Ko.randomFillSync?(Xo={},Zo.exports=function(t){var e=Xo[t];return e||(e=Buffer.allocUnsafe(t),t<=255&&(Xo[t]=e)),Ko.randomFillSync(e)}):Zo.exports=Ko.randomBytes;var Xo});var qh=x((TM,Ds)=>{Ds.exports="-_";var Ms=36;for(;Ms--;)Ds.exports+=Ms.toString(36),Ms>9&&(Ds.exports+=Ms.toString(36).toUpperCase())});var ea=x((MM,Bh)=>{var Hx=jh(),Vx=qh();Bh.exports=function(t){t=t||21;for(var e=Hx(t),r="";t--;)r+=Vx[e[t]&63];return r}});var At=x((DM,Hh)=>{var Gx=Object.create,$s=Object.defineProperty,Wx=Object.getOwnPropertyDescriptor,Jx=Object.getOwnPropertyNames,Qx=Object.getPrototypeOf,Yx=Object.prototype.hasOwnProperty,Kx=(t,e)=>{for(var r in e)$s(t,r,{get:e[r],enumerable:!0})},Fh=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Jx(e))!Yx.call(t,s)&&s!==r&&$s(t,s,{get:()=>e[s],enumerable:!(n=Wx(e,s))||n.enumerable});return t},Xx=(t,e,r)=>(r=t!=null?Gx(Qx(t)):{},Fh(e||!t||!t.__esModule?$s(r,"default",{value:t,enumerable:!0}):r,t)),Zx=t=>Fh($s({},"__esModule",{value:!0}),t),Uh={};Kx(Uh,{Deferred:()=>ta,DummyServer:()=>ra,REMOTE_ROOM_SHORT_TIMEOUT:()=>iS,generateId:()=>oS,merge:()=>lS,registerGracefulShutdown:()=>cS,retry:()=>zh,spliceOne:()=>uS});Hh.exports=Zx(Uh);var eS=Xx(ea()),tS=Ss(),rS=Ke(),nS=require("events"),sS=nr(),iS=Number(process.env.COLYSEUS_PRESENCE_SHORT_TIMEOUT||500);function oS(t=9){return(0,eS.default)(t)}var aS=["SIGINT","SIGTERM","SIGUSR2"];function cS(t){process.on("uncaughtException",e=>{(0,rS.debugAndPrintError)(e),t(e)}),aS.forEach(e=>process.once(e,()=>t()))}function zh(t,e=3,r=[],n=0){return new Promise((s,i)=>{t().then(s).catch(o=>{r.indexOf(o.constructor)!==-1&&n++<e?setTimeout(()=>{zh(t,e,r,n).then(s).catch(c=>i(c))},Math.floor(Math.random()*Math.pow(2,n)*400)):i(o)})})}function uS(t,e){if(e===-1||e>=t.length)return!1;let r=t.length-1;for(let n=e;n<r;n++)t[n]=t[n+1];return t.length=r,!0}var ta=class{promise;resolve;reject;constructor(){this.promise=new Promise((e,r)=>{this.resolve=e,this.reject=r})}then(e){return this.promise.then.apply(this.promise,arguments)}catch(e){return this.promise.catch(e)}};function lS(t,...e){for(let r=0,n=e.length;r<n;r++){let s=e[r];for(let i in s)s.hasOwnProperty(i)&&(t[i]=s[i])}return t}var ra=class extends nS.EventEmitter{};(0,tS.addExtension)({Class:sS.Schema,type:0,read(t){return t},write(t){return t.toJSON()}})});var Jh=x(($M,Wh)=>{var na=Object.defineProperty,fS=Object.getOwnPropertyDescriptor,hS=Object.getOwnPropertyNames,dS=Object.prototype.hasOwnProperty,pS=(t,e)=>{for(var r in e)na(t,r,{get:e[r],enumerable:!0})},yS=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of hS(e))!dS.call(t,s)&&s!==r&&na(t,s,{get:()=>e[s],enumerable:!(n=fS(e,s))||n.enumerable});return t},gS=t=>yS(na({},"__esModule",{value:!0}),t),Gh={};pS(Gh,{requestFromIPC:()=>_S,subscribeIPC:()=>vS});Wh.exports=gS(Gh);var mS=Ke(),Nr=Pt(),Vh=At();async function _S(t,e,r,n,s=Vh.REMOTE_ROOM_SHORT_TIMEOUT){return new Promise((i,o)=>{let c,l=(0,Vh.generateId)(),u=`ipc:${l}`,a=()=>{t.unsubscribe(u),clearTimeout(c)};t.subscribe(u,f=>{let[h,d]=f;h===Nr.IpcProtocol.SUCCESS?i(d):h===Nr.IpcProtocol.ERROR&&o(d),a()}),t.publish(e,[r,l,n]),c=setTimeout(()=>{a(),o(`IPC timed out. method: ${r}, args: ${JSON.stringify(n)}`)},s)})}async function vS(t,e,r,n){await t.subscribe(r,s=>{let[i,o,c]=s,l=(a,f)=>{t.publish(`ipc:${o}`,[a,f])},u;try{u=n(i,c)}catch(a){return(0,mS.debugAndPrintError)(a),l(Nr.IpcProtocol.ERROR,a.message||a)}if(!(u instanceof Promise))return l(Nr.IpcProtocol.SUCCESS,u);u.then(a=>l(Nr.IpcProtocol.SUCCESS,a)).catch(a=>{let f=a&&a.message||a;l(Nr.IpcProtocol.ERROR,f)})})}});var Lr=x((NM,Zh)=>{var bS=Object.create,js=Object.defineProperty,xS=Object.getOwnPropertyDescriptor,SS=Object.getOwnPropertyNames,wS=Object.getPrototypeOf,OS=Object.prototype.hasOwnProperty,ES=(t,e)=>{for(var r in e)js(t,r,{get:e[r],enumerable:!0})},Qh=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of SS(e))!OS.call(t,s)&&s!==r&&js(t,s,{get:()=>e[s],enumerable:!(n=xS(e,s))||n.enumerable});return t},kS=(t,e,r)=>(r=t!=null?bS(wS(t)):{},Qh(e||!t||!t.__esModule?js(r,"default",{value:t,enumerable:!0}):r,t)),CS=t=>Qh(js({},"__esModule",{value:!0}),t),Yh={};ES(Yh,{cacheRoomHistory:()=>TS,debugDevMode:()=>Ns,getPreviousProcessId:()=>MS,getProcessRestoreKey:()=>Xh,getRoomRestoreListKey:()=>Ls,isDevMode:()=>Kh,reloadFromCache:()=>RS,setDevMode:()=>IS});Zh.exports=CS(Yh);var PS=kS(os()),AS=Ke(),ir=or(),Ns=(0,PS.default)("colyseus:devmode"),Kh=!1;function IS(t){Kh=t}async function RS(){let t=Object.entries(await ir.presence.hgetall(Ls()));Ns("rooms to restore: %i",t.length);for(let[e,r]of t){let n=JSON.parse(r);Ns("restoring room %s (%s)",n.roomName,e);let s=await(0,ir.handleCreateRoom)(n.roomName,n.clientOptions,e),i=(0,ir.getRoomById)(s.roomId);console.debug(`\u{1F504} room '${e}' has been restored.`),n.hasOwnProperty("state")&&(i.state.decode(n.state),i.setState(i.state.clone()),console.debug(`\u{1F4CB} room '${e}' state =>`,i.state.toJSON())),i.onRestoreRoom?.(n.cache);for(let o of n.clients)await(0,ir.remoteRoomCall)(s.roomId,"_reserveSeat",[o,{},20,!1,!0])}t.length>0&&console.debug("\u2705",t.length,"room(s) have been restored.")}async function TS(t){for(let e of Object.values(t)){let r=await ir.presence.hget(Ls(),e.roomId);if(r)try{let n=JSON.parse(r);n.cache=e.onCacheRoom?.(),Ns("caching room %s (%s)",e.roomName,e.roomId),e.state&&(n.state=e.state.encodeAll()),n.clients=e.clients.map(s=>s.sessionId);for(let s in e.reservedSeats)n.clients.push(s);await ir.presence.hset(Ls(),e.roomId,JSON.stringify(n)),console.debug(`\u{1F4BE} caching room '${e.roomId}' (clients: ${e.clients.length}, state size: ${(n.state||[]).length} bytes)`)}catch(n){(0,AS.debugAndPrintError)(`\u274C couldn't cache room '${e.roomId}', due to:
${n.stack}`)}}}async function MS(t){return await ir.presence.hget(Xh(),t)}function Ls(){return"roomhistory"}function Xh(){return"processhistory"}});var Fs=x((LM,rd)=>{var DS=Object.create,Bs=Object.defineProperty,$S=Object.getOwnPropertyDescriptor,NS=Object.getOwnPropertyNames,LS=Object.getPrototypeOf,jS=Object.prototype.hasOwnProperty,qS=(t,e)=>{for(var r in e)Bs(t,r,{get:e[r],enumerable:!0})},ed=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of NS(e))!jS.call(t,s)&&s!==r&&Bs(t,s,{get:()=>e[s],enumerable:!(n=$S(e,s))||n.enumerable});return t},BS=(t,e,r)=>(r=t!=null?DS(LS(t)):{},ed(e||!t||!t.__esModule?Bs(r,"default",{value:t,enumerable:!0}):r,t)),FS=t=>ed(Bs({},"__esModule",{value:!0}),t),td={};qS(td,{subscribeLobby:()=>zS,updateLobby:()=>US});rd.exports=FS(td);var qs=BS(or()),sa="$lobby";function US(t,e=!1){let r=t.listing;!r.unlisted&&!r.private&&qs.presence.publish(sa,`${r.roomId},${e?1:0}`)}async function zS(t){let e=async r=>{let[n,s]=r.split(",");if(s==="1")t(n,null);else{let i=(await qs.query({roomId:n}))[0];t(n,i)}};return await qs.presence.subscribe(sa,e),()=>qs.presence.unsubscribe(sa,e)}});var aa=x((jM,od)=>{var oa=Object.defineProperty,HS=Object.getOwnPropertyDescriptor,VS=Object.getOwnPropertyNames,GS=Object.prototype.hasOwnProperty,WS=(t,e)=>{for(var r in e)oa(t,r,{get:e[r],enumerable:!0})},JS=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of VS(e))!GS.call(t,s)&&s!==r&&oa(t,s,{get:()=>e[s],enumerable:!(n=HS(e,s))||n.enumerable});return t},QS=t=>JS(oa({},"__esModule",{value:!0}),t),sd={};WS(sd,{INVALID_OPTION_KEYS:()=>id,RegisteredHandler:()=>ia});od.exports=QS(sd);var YS=require("events"),nd=Ot(),jr=Fs(),id=["clients","locked","private","metadata","name","processId","roomId"],ia=class extends YS.EventEmitter{klass;options;filterOptions=[];sortOptions;constructor(e,r){if(super(),typeof e!="function")throw nd.logger.debug("You are likely not importing your room class correctly."),new Error(`class is expected but ${typeof e} was provided.`);this.klass=e,this.options=r}enableRealtimeListing(){return this.on("create",e=>(0,jr.updateLobby)(e)),this.on("lock",e=>(0,jr.updateLobby)(e)),this.on("unlock",e=>(0,jr.updateLobby)(e)),this.on("join",e=>(0,jr.updateLobby)(e)),this.on("leave",(e,r,n)=>{n||(0,jr.updateLobby)(e)}),this.on("dispose",e=>(0,jr.updateLobby)(e,!0)),this}filterBy(e){return this.filterOptions=e,this}sortBy(e){return this.sortOptions=e,this}getFilterOptions(e){return this.filterOptions.reduce((r,n,s,i)=>{let o=i[s];return e.hasOwnProperty(o)&&(id.indexOf(o)!==-1?nd.logger.warn(`option "${o}" has internal usage and is going to be ignored.`):r[o]=e[o]),r},{})}}});var ud=x((qM,cd)=>{var ua=Object.defineProperty,KS=Object.getOwnPropertyDescriptor,XS=Object.getOwnPropertyNames,ZS=Object.prototype.hasOwnProperty,ew=(t,e)=>{for(var r in e)ua(t,r,{get:e[r],enumerable:!0})},tw=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of XS(e))!ZS.call(t,s)&&s!==r&&ua(t,s,{get:()=>e[s],enumerable:!(n=KS(e,s))||n.enumerable});return t},rw=t=>tw(ua({},"__esModule",{value:!0}),t),ad={};ew(ad,{NoneSerializer:()=>ca});cd.exports=rw(ad);var ca=class{id="none";reset(e){}getFullState(e){return null}applyPatches(e,r){return!1}}});var pd=x((BM,dd)=>{var nw=Object.create,Us=Object.defineProperty,sw=Object.getOwnPropertyDescriptor,iw=Object.getOwnPropertyNames,ow=Object.getPrototypeOf,aw=Object.prototype.hasOwnProperty,cw=(t,e)=>{for(var r in e)Us(t,r,{get:e[r],enumerable:!0})},ld=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of iw(e))!aw.call(t,s)&&s!==r&&Us(t,s,{get:()=>e[s],enumerable:!(n=sw(e,s))||n.enumerable});return t},uw=(t,e,r)=>(r=t!=null?nw(ow(t)):{},ld(e||!t||!t.__esModule?Us(r,"default",{value:t,enumerable:!0}):r,t)),lw=t=>ld(Us({},"__esModule",{value:!0}),t),fd={};cw(fd,{Deferred:()=>la,DummyServer:()=>fa,REMOTE_ROOM_SHORT_TIMEOUT:()=>pw,generateId:()=>yw,merge:()=>vw,registerGracefulShutdown:()=>mw,retry:()=>hd,spliceOne:()=>_w});dd.exports=lw(fd);var fw=uw(ea()),hw=Ke(),dw=require("events"),pw=Number(process.env.COLYSEUS_PRESENCE_SHORT_TIMEOUT||2e3);function yw(t=9){return(0,fw.default)(t)}var gw=["SIGINT","SIGTERM","SIGUSR2"];function mw(t){process.on("uncaughtException",e=>{(0,hw.debugAndPrintError)(e),t(e)}),gw.forEach(e=>process.once(e,()=>t()))}function hd(t,e=3,r=[],n=0){return new Promise((s,i)=>{t().then(s).catch(o=>{r.indexOf(o.constructor)!==-1&&n++<e?setTimeout(()=>{hd(t,e,r,n).then(s).catch(c=>i(c))},Math.floor(Math.random()*Math.pow(2,n)*400)):i(o)})})}var la=class{promise;resolve;reject;constructor(){this.promise=new Promise((e,r)=>{this.resolve=e,this.reject=r})}then(e){return this.promise.then.apply(this.promise,arguments)}catch(e){return this.promise.catch(e)}};function _w(t,e){if(e===-1||e>=t.length)return!1;let r=t.length-1;for(let n=e;n<r;n++)t[n]=t[n+1];return t.length=r,!0}function vw(t,...e){for(let r=0,n=e.length;r<n;r++){let s=e[r];for(let i in s)s.hasOwnProperty(i)&&(t[i]=s[i])}return t}var fa=class extends dw.EventEmitter{}});var zs=x((FM,md)=>{var pa=Object.defineProperty,bw=Object.getOwnPropertyDescriptor,xw=Object.getOwnPropertyNames,Sw=Object.prototype.hasOwnProperty,ww=(t,e)=>{for(var r in e)pa(t,r,{get:e[r],enumerable:!0})},Ow=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of xw(e))!Sw.call(t,s)&&s!==r&&pa(t,s,{get:()=>e[s],enumerable:!(n=bw(e,s))||n.enumerable});return t},Ew=t=>Ow(pa({},"__esModule",{value:!0}),t),yd={};ww(yd,{ClientArray:()=>da,ClientState:()=>gd,Transport:()=>ha});md.exports=Ew(yd);var kw=pd(),ha=class{server},gd=(t=>(t[t.JOINING=0]="JOINING",t[t.JOINED=1]="JOINED",t[t.RECONNECTED=2]="RECONNECTED",t[t.LEAVING=3]="LEAVING",t))(gd||{}),da=class extends Array{getById(e){return this.find(r=>r.sessionId===e)}delete(e){return(0,kw.spliceOne)(this,this.indexOf(e))}}});var _a=x((UM,xd)=>{var ma=Object.defineProperty,Cw=Object.getOwnPropertyDescriptor,Pw=Object.getOwnPropertyNames,Aw=Object.prototype.hasOwnProperty,Iw=(t,e)=>{for(var r in e)ma(t,r,{get:e[r],enumerable:!0})},Rw=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Pw(e))!Aw.call(t,s)&&s!==r&&ma(t,s,{get:()=>e[s],enumerable:!(n=Cw(e,s))||n.enumerable});return t},Tw=t=>Rw(ma({},"__esModule",{value:!0}),t),bd={};Iw(bd,{SchemaSerializer:()=>ga});xd.exports=Tw(bd);var ya=nr(),xn=Ke(),_d=Pt(),vd=zs(),ga=class{id="schema";state;useFilters=!1;handshakeCache;reset(e){this.state=e,this.useFilters=(0,ya.hasFilter)(e.constructor)}getFullState(e){let r=this.state.encodeAll(this.useFilters);return e&&this.useFilters?this.state.applyFilters(e,!0):r}applyPatches(e){let r=this.state.$changes.changes.size>0;if(r){let n=e.length;xn.debugPatch.enabled&&(xn.debugPatch.dumpChanges=(0,ya.dumpChanges)(this.state));let s=this.state.encode(!1,[],this.useFilters);if(this.useFilters){for(;n--;){let i=e[n];if(i.state===vd.ClientState.JOINED){let o=this.state.applyFilters(i);i.raw([_d.Protocol.ROOM_STATE_PATCH,...o])}}this.state.discardAllChanges()}else for(s.unshift(_d.Protocol.ROOM_STATE_PATCH);n--;){let i=e[n];i.state===vd.ClientState.JOINED&&i.raw(s)}xn.debugPatch.enabled&&(0,xn.debugPatch)("%d bytes sent to %d clients, %j",s.length,e.length,xn.debugPatch.dumpChanges)}return r}handshake(){return this.handshakeCache||(this.handshakeCache=this.state&&ya.Reflection.encode(this.state)),this.handshakeCache}}});var qr=x((zM,Cd)=>{var Mw=Object.create,Hs=Object.defineProperty,Dw=Object.getOwnPropertyDescriptor,$w=Object.getOwnPropertyNames,Nw=Object.getPrototypeOf,Lw=Object.prototype.hasOwnProperty,jw=(t,e)=>{for(var r in e)Hs(t,r,{get:e[r],enumerable:!0})},wd=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of $w(e))!Lw.call(t,s)&&s!==r&&Hs(t,s,{get:()=>e[s],enumerable:!(n=Dw(e,s))||n.enumerable});return t},qw=(t,e,r)=>(r=t!=null?Mw(Nw(t)):{},wd(e||!t||!t.__esModule?Hs(r,"default",{value:t,enumerable:!0}):r,t)),Bw=t=>wd(Hs({},"__esModule",{value:!0}),t),Od={};jw(Od,{DEFAULT_SEAT_RESERVATION_TIME:()=>Ed,Room:()=>ba,RoomInternalState:()=>kd});Cd.exports=Bw(Od);var Fw=Ss(),ar=nr(),Uw=qw(ao()),zw=require("events"),Hw=Ot(),Vw=ud(),Gw=_a(),oe=Pt(),Sd=At(),Ww=Lr(),Xe=Ke(),va=$r(),cr=zs(),Jw=1e3/20,Qw=1e3/60,Yw=new Vw.NoneSerializer,Ed=Number(process.env.COLYSEUS_SEAT_RESERVATION_TIME||15),kd=(t=>(t[t.CREATING=0]="CREATING",t[t.CREATED=1]="CREATED",t[t.DISPOSING=2]="DISPOSING",t))(kd||{}),ba=class{get locked(){return this._locked}get metadata(){return this.listing.metadata}listing;clock=new Uw.default;#e;#t;maxClients=1/0;patchRate=Jw;autoDispose=!0;state;presence;clients=new cr.ClientArray;_events=new zw.EventEmitter;seatReservationTime=Ed;reservedSeats={};reservedSeatTimeouts={};_reconnections={};_reconnectingSessionId=new Map;onMessageHandlers={};_serializer=Yw;_afterNextPatchQueue=[];_simulationInterval;_patchInterval;_internalState=0;_locked=!1;_lockedExplicitly=!1;_maxClientsReached=!1;_autoDisposeTimeout;constructor(e){this.presence=e,this._events.once("dispose",async()=>{try{await this._dispose()}catch(r){(0,Xe.debugAndPrintError)(`onDispose error: ${r&&r.message||r||"promise rejected"}`)}this._events.emit("disconnect")}),this.setPatchRate(this.patchRate),this.resetAutoDisposeTimeout(this.seatReservationTime)}get roomName(){return this.#t}set roomName(e){if(this.#t)throw new va.ServerError(oe.ErrorCode.APPLICATION_ERROR,"'roomName' cannot be overwritten.");this.#t=e}get roomId(){return this.#e}set roomId(e){if(this._internalState!==0&&!Ww.isDevMode)throw new va.ServerError(oe.ErrorCode.APPLICATION_ERROR,"'roomId' can only be overridden upon room creation.");this.#e=e}onAuth(e,r,n){return!0}hasReachedMaxClients(){return this.clients.length+Object.keys(this.reservedSeats).length>=this.maxClients||this._internalState===2}setSeatReservationTime(e){return this.seatReservationTime=e,this}hasReservedSeat(e,r){if(r){let n=this._reconnections[r];return n&&n[0]===e&&this.reservedSeats[e]!==void 0&&this._reconnectingSessionId.has(e)}else return this.reservedSeats[e]!==void 0&&(!this._reconnectingSessionId.has(e)||this._reconnectingSessionId.get(e)===e)}checkReconnectionToken(e){let r=this._reconnections[e],n=r&&r[0];if(this.hasReservedSeat(n))return this._reconnectingSessionId.set(n,e),n}setSimulationInterval(e,r=Qw){this._simulationInterval&&clearInterval(this._simulationInterval),e&&(this._simulationInterval=setInterval(()=>{this.clock.tick(),e(this.clock.deltaTime)},r))}setPatchRate(e){this.patchRate=e,this._patchInterval&&(clearInterval(this._patchInterval),this._patchInterval=void 0),e!==null&&e!==0&&(this._patchInterval=setInterval(()=>this.broadcastPatch(),e))}setState(e){this.clock.start(),"_definition"in e&&this.setSerializer(new Gw.SchemaSerializer),this._serializer.reset(e),this.state=e}setSerializer(e){this._serializer=e}async setMetadata(e){if(!this.listing.metadata)this.listing.metadata=e;else{for(let r in e)e.hasOwnProperty(r)&&(this.listing.metadata[r]=e[r]);"markModified"in this.listing&&this.listing.markModified("metadata")}this._internalState===1&&await this.listing.save()}async setPrivate(e=!0){this.listing.private=e,this._internalState===1&&await this.listing.save()}async lock(){this._lockedExplicitly=arguments[0]===void 0,!this._locked&&(this._locked=!0,await this.listing.updateOne({$set:{locked:this._locked}}),this._events.emit("lock"))}async unlock(){arguments[0]===void 0&&(this._lockedExplicitly=!1),this._locked&&(this._locked=!1,await this.listing.updateOne({$set:{locked:this._locked}}),this._events.emit("unlock"))}send(e,r,n,s){Hw.logger.warn("DEPRECATION WARNING: use client.send(...) instead of this.send(client, ...)"),e.send(r,n,s)}broadcast(e,r,n){let s=typeof e=="object",i=s?r:n;if(i&&i.afterNextPatch){delete i.afterNextPatch,this._afterNextPatchQueue.push(["broadcast",arguments]);return}s?this.broadcastMessageSchema(e,i):this.broadcastMessageType(e,r,i)}broadcastPatch(){if(this.onBeforePatch&&this.onBeforePatch(this.state),this._simulationInterval||this.clock.tick(),!this.state)return!1;let e=this._serializer.applyPatches(this.clients,this.state);return this._dequeueAfterPatchMessages(),e}onMessage(e,r){return this.onMessageHandlers[e]=r,()=>delete this.onMessageHandlers[e]}async disconnect(e=oe.Protocol.WS_CLOSE_CONSENTED){if(this._internalState===2)return;this._internalState=2,await this.listing.remove(),this.autoDispose=!0;let r=new Promise(s=>this._events.once("disconnect",()=>s()));for(let[s,i]of Object.values(this._reconnections))i.reject();let n=this.clients.length;if(n>0)for(;n--;)this._forciblyCloseClient(this.clients[n],e);else this._events.emit("dispose");return await r}async _onJoin(e,r){let n=e.sessionId;e._reconnectionToken=(0,Sd.generateId)(),this.reservedSeatTimeouts[n]&&(clearTimeout(this.reservedSeatTimeouts[n]),delete this.reservedSeatTimeouts[n]),this._autoDisposeTimeout&&(clearTimeout(this._autoDisposeTimeout),this._autoDisposeTimeout=void 0);let s=this.reservedSeats[n];delete this.reservedSeats[n],e._afterNextPatchQueue=this._afterNextPatchQueue,e.ref.onleave=this._onLeave.bind(this,e),e.ref.once("close",e.ref.onleave),this.clients.push(e);let i=this._reconnectingSessionId.get(n);if(i)this._reconnections[i]?.[1].resolve(e);else try{if(e.auth=await this.onAuth(e,s,r),!e.auth)throw new va.ServerError(oe.ErrorCode.AUTH_FAILED,"onAuth failed");this.onJoin&&await this.onJoin(e,s,e.auth)}catch(o){throw this.clients.delete(e),o.code||(o.code=oe.ErrorCode.APPLICATION_ERROR),o}finally{delete this.reservedSeats[n]}this._events.emit("join",e),e.ref.on("message",this._onMessage.bind(this,e)),e.raw(oe.getMessageBytes[oe.Protocol.JOIN_ROOM](e._reconnectionToken,this._serializer.id,this._serializer.handshake&&this._serializer.handshake()))}allowReconnection(e,r){if(r===void 0&&(console.warn('DEPRECATED: allowReconnection() requires a second argument. Using "manual" mode.'),r="manual"),r==="manual"&&(r=1/0),this._internalState===2)throw this._disposeIfEmpty(),new Error("disconnecting");let n=e.sessionId,s=e._reconnectionToken;this._reserveSeat(n,!0,r,!0);let i=new Sd.Deferred;this._reconnections[s]=[n,i],r!==1/0&&(this.reservedSeatTimeouts[n]=setTimeout(()=>i.reject(!1),r*1e3));let o=()=>{delete this._reconnections[s],delete this.reservedSeats[n],delete this.reservedSeatTimeouts[n],this._reconnectingSessionId.delete(n)};return i.then(c=>{c.auth=e.auth,c.userData=e.userData,e.ref=c.ref,e.state=cr.ClientState.RECONNECTED,clearTimeout(this.reservedSeatTimeouts[n]),o()}).catch(()=>{o(),this.resetAutoDisposeTimeout()}),i}resetAutoDisposeTimeout(e=1){clearTimeout(this._autoDisposeTimeout),this.autoDispose&&(this._autoDisposeTimeout=setTimeout(()=>{this._autoDisposeTimeout=void 0,this._disposeIfEmpty()},e*1e3))}broadcastMessageSchema(e,r={}){(0,Xe.debugMessage)("broadcast: %O",e);let n=oe.getMessageBytes[oe.Protocol.ROOM_DATA_SCHEMA](e),s=typeof r.except<"u"?Array.isArray(r.except)?r.except:[r.except]:void 0,i=this.clients.length;for(;i--;){let o=this.clients[i];(!s||!s.includes(o))&&o.enqueueRaw(n)}}broadcastMessageType(e,r,n={}){(0,Xe.debugMessage)("broadcast: %O",r);let s=oe.getMessageBytes.raw(oe.Protocol.ROOM_DATA,e,r),i=typeof n.except<"u"?Array.isArray(n.except)?n.except:[n.except]:void 0,o=this.clients.length;for(;o--;){let c=this.clients[o];(!i||!i.includes(c))&&c.enqueueRaw(s)}}sendFullState(e){e.enqueueRaw(oe.getMessageBytes[oe.Protocol.ROOM_STATE](this._serializer.getFullState(e)))}_dequeueAfterPatchMessages(){let e=this._afterNextPatchQueue.length;if(e>0){for(let r=0;r<e;r++){let[n,s]=this._afterNextPatchQueue[r];n==="broadcast"?this.broadcast.apply(this,s):n.raw.apply(n,s)}this._afterNextPatchQueue.splice(0,e)}}async _reserveSeat(e,r=!0,n=this.seatReservationTime,s=!1,i){return!s&&this.hasReachedMaxClients()?!1:(this.reservedSeats[e]=r,s||(await this._incrementClientCount(),this.reservedSeatTimeouts[e]=setTimeout(async()=>{delete this.reservedSeats[e],delete this.reservedSeatTimeouts[e],await this._decrementClientCount()},n*1e3),this.resetAutoDisposeTimeout(n)),i&&this._reconnectingSessionId.set(e,e),!0)}_disposeIfEmpty(){let e=this.autoDispose&&this._autoDisposeTimeout===void 0&&this.clients.length===0&&Object.keys(this.reservedSeats).length===0;return e&&this._events.emit("dispose"),e}async _dispose(){this._internalState=2,await this.listing.remove();let e;return this.onDispose&&(e=this.onDispose()),this._patchInterval&&(clearInterval(this._patchInterval),this._patchInterval=void 0),this._simulationInterval&&(clearInterval(this._simulationInterval),this._simulationInterval=void 0),this._autoDisposeTimeout&&(clearInterval(this._autoDisposeTimeout),this._autoDisposeTimeout=void 0),this.clock.clear(),this.clock.stop(),await(e||Promise.resolve())}_onMessage(e,r){if(e.state===cr.ClientState.LEAVING)return;let n={offset:0},s=ar.decode.uint8(r,n);if(!r){(0,Xe.debugAndPrintError)(`${this.roomName} (${this.roomId}), couldn't decode message: ${r}`);return}if(s===oe.Protocol.ROOM_DATA){let i=ar.decode.stringCheck(r,n)?ar.decode.string(r,n):ar.decode.number(r,n),o;try{o=r.length>n.offset?(0,Fw.unpack)(new Uint8Array(r.slice(n.offset,r.length))):void 0,(0,Xe.debugMessage)("received: '%s' -> %j",i,o)}catch(c){(0,Xe.debugAndPrintError)(c);return}this.onMessageHandlers[i]?this.onMessageHandlers[i](e,o):this.onMessageHandlers["*"]?this.onMessageHandlers["*"](e,i,o):(0,Xe.debugAndPrintError)(`onMessage for "${i}" not registered.`)}else if(s===oe.Protocol.ROOM_DATA_BYTES){let i=ar.decode.stringCheck(r,n)?ar.decode.string(r,n):ar.decode.number(r,n),o=r.slice(n.offset,r.length);(0,Xe.debugMessage)("received: '%s' -> %j",i,o),this.onMessageHandlers[i]?this.onMessageHandlers[i](e,o):this.onMessageHandlers["*"]?this.onMessageHandlers["*"](e,i,o):(0,Xe.debugAndPrintError)(`onMessage for "${i}" not registered.`)}else s===oe.Protocol.JOIN_ROOM&&e.state===cr.ClientState.JOINING?(e.state=cr.ClientState.JOINED,this.state&&this.sendFullState(e),e._enqueuedMessages.length>0&&e._enqueuedMessages.forEach(i=>e.raw(i)),delete e._enqueuedMessages):s===oe.Protocol.LEAVE_ROOM&&this._forciblyCloseClient(e,oe.Protocol.WS_CLOSE_CONSENTED)}_forciblyCloseClient(e,r){e.ref.removeAllListeners("message"),e.ref.removeListener("close",e.ref.onleave),this._onLeave(e,r).then(()=>e.leave(r))}async _onLeave(e,r){if(this.clients.delete(e)&&this.onLeave)try{e.state=cr.ClientState.LEAVING,await this.onLeave(e,r===oe.Protocol.WS_CLOSE_CONSENTED)}catch(s){(0,Xe.debugAndPrintError)(`onLeave error: ${s&&s.message||s||"promise rejected"}`)}if(e.state!==cr.ClientState.RECONNECTED){let s=await this._decrementClientCount();this._events.emit("leave",e,s)}}async _incrementClientCount(){!this._locked&&this.hasReachedMaxClients()&&(this._maxClientsReached=!0,this.lock.call(this,!0)),await this.listing.updateOne({$inc:{clients:1},$set:{locked:this._locked}})}async _decrementClientCount(){let e=this._disposeIfEmpty();return this._internalState===2?!0:(e||(this._maxClientsReached&&!this._lockedExplicitly&&(this._maxClientsReached=!1,this.unlock.call(this,!0)),await this.listing.updateOne({$inc:{clients:-1},$set:{locked:this._locked}})),e)}}});var Gs=x((HM,Td)=>{var Kw=Object.create,Vs=Object.defineProperty,Xw=Object.getOwnPropertyDescriptor,Zw=Object.getOwnPropertyNames,e1=Object.getPrototypeOf,t1=Object.prototype.hasOwnProperty,r1=(t,e)=>{for(var r in e)Vs(t,r,{get:e[r],enumerable:!0})},Ad=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Zw(e))!t1.call(t,s)&&s!==r&&Vs(t,s,{get:()=>e[s],enumerable:!(n=Xw(e,s))||n.enumerable});return t},Id=(t,e,r)=>(r=t!=null?Kw(e1(t)):{},Ad(e||!t||!t.__esModule?Vs(r,"default",{value:t,enumerable:!0}):r,t)),n1=t=>Ad(Vs({},"__esModule",{value:!0}),t),Rd={};r1(Rd,{LocalPresence:()=>wa});Td.exports=n1(Rd);var xa=Id(require("fs")),s1=Id(require("path")),i1=require("events"),o1=At(),Pd=Lr(),Sa=s1.default.resolve(".devmode.json"),wa=class{channels=new i1.EventEmitter;data={};hash={};keys={};subscriptions={};timeouts={};constructor(){if(Pd.isDevMode&&xa.default.existsSync(Sa)){let e=xa.default.readFileSync(Sa).toString("utf-8")||"{}",r=JSON.parse(e);this.data=r.data,this.hash=r.hash,this.keys=r.keys}}subscribe(e,r){return this.subscriptions[e]||(this.subscriptions[e]=[]),this.subscriptions[e].push(r),this.channels.on(e,r),this}unsubscribe(e,r){let n=this.subscriptions[e];if(n){if(r){let s=n.indexOf(r);s!==-1&&(n.splice(s,1),this.channels.removeListener(e,r)),n.length===0&&delete this.subscriptions[e]}else n.forEach(s=>this.channels.removeListener(e,s)),delete this.subscriptions[e];return this}}publish(e,r){return this.channels.emit(e,r),this}async exists(e){return this.channels.listenerCount(e)>0}set(e,r){this.keys[e]=r}setex(e,r,n){this.timeouts[e]&&clearTimeout(this.timeouts[e]),this.keys[e]=r,this.timeouts[e]=setTimeout(()=>{delete this.keys[e],delete this.timeouts[e]},n*1e3)}get(e){return this.keys[e]}del(e){delete this.keys[e],delete this.data[e],delete this.hash[e]}sadd(e,r){this.data[e]||(this.data[e]=[]),this.data[e].indexOf(r)===-1&&this.data[e].push(r)}async smembers(e){return this.data[e]||[]}async sismember(e,r){return this.data[e]&&this.data[e].includes(r)?1:0}srem(e,r){this.data[e]&&(0,o1.spliceOne)(this.data[e],this.data[e].indexOf(r))}scard(e){return(this.data[e]||[]).length}async sinter(...e){let r={};for(let n=0,s=e.length;n<s;n++)(await this.smembers(e[n])).forEach(i=>{r[i]||(r[i]=0),r[i]++});return Object.keys(r).reduce((n,s)=>(r[s]>1&&n.push(s),n),[])}hset(e,r,n){this.hash[e]||(this.hash[e]={}),this.hash[e][r]=n}hincrby(e,r,n){this.hash[e]||(this.hash[e]={});let s=Number(this.hash[e][r]||"0");return s+=n,this.hash[e][r]=s.toString(),s}async hget(e,r){return this.hash[e]&&this.hash[e][r]}async hgetall(e){return this.hash[e]||{}}hdel(e,r){this.hash[e]&&delete this.hash[e][r]}async hlen(e){return this.hash[e]&&Object.keys(this.hash[e]).length||0}async incr(e){return this.keys[e]||(this.keys[e]=0),this.keys[e]++,Promise.resolve(this.keys[e])}async decr(e){return this.keys[e]||(this.keys[e]=0),this.keys[e]--,Promise.resolve(this.keys[e])}shutdown(){if(Pd.isDevMode){let e=JSON.stringify({data:this.data,hash:this.hash,keys:this.keys});xa.default.writeFileSync(Sa,e,{encoding:"utf-8"})}}}});var $d=x((VM,Dd)=>{var Ea=Object.defineProperty,a1=Object.getOwnPropertyDescriptor,c1=Object.getOwnPropertyNames,u1=Object.prototype.hasOwnProperty,l1=(t,e)=>{for(var r in e)Ea(t,r,{get:e[r],enumerable:!0})},f1=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of c1(e))!u1.call(t,s)&&s!==r&&Ea(t,s,{get:()=>e[s],enumerable:!(n=a1(e,s))||n.enumerable});return t},h1=t=>f1(Ea({},"__esModule",{value:!0}),t),Md={};l1(Md,{SeatReservationError:()=>Oa});Dd.exports=h1(Md);var Oa=class extends Error{constructor(e){super(e)}}});var jd=x((GM,Ld)=>{var Nd=Object.defineProperty,d1=Object.getOwnPropertyDescriptor,p1=Object.getOwnPropertyNames,y1=Object.prototype.hasOwnProperty,g1=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of p1(e))!y1.call(t,s)&&s!==r&&Nd(t,s,{get:()=>e[s],enumerable:!(n=d1(e,s))||n.enumerable});return t},m1=t=>g1(Nd({},"__esModule",{value:!0}),t),_1={};Ld.exports=m1(_1)});var Fd=x((WM,Bd)=>{var Ca=Object.defineProperty,v1=Object.getOwnPropertyDescriptor,b1=Object.getOwnPropertyNames,x1=Object.prototype.hasOwnProperty,S1=(t,e)=>{for(var r in e)Ca(t,r,{get:e[r],enumerable:!0})},w1=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of b1(e))!x1.call(t,s)&&s!==r&&Ca(t,s,{get:()=>e[s],enumerable:!(n=v1(e,s))||n.enumerable});return t},O1=t=>w1(Ca({},"__esModule",{value:!0}),t),qd={};S1(qd,{Query:()=>ka});Bd.exports=O1(qd);var ka=class{$rooms;conditions;constructor(e,r){this.$rooms=e.slice(0),this.conditions=r}sort(e){this.$rooms=this.$rooms.sort((r,n)=>{for(let s in e)if(e.hasOwnProperty(s)){let i=e[s];if(i===1||i==="asc"||i==="ascending"){if(r[s]>n[s])return 1;if(r[s]<n[s])return-1}else{if(r[s]>n[s])return-1;if(r[s]<n[s])return 1}}})}then(e,r){let n=this.$rooms.find(s=>{for(let i in this.conditions)if(this.conditions.hasOwnProperty(i)&&s[i]!==this.conditions[i])return!1;return!0});return e(n)}}});var Hd=x((JM,zd)=>{var Aa=Object.defineProperty,E1=Object.getOwnPropertyDescriptor,k1=Object.getOwnPropertyNames,C1=Object.prototype.hasOwnProperty,P1=(t,e)=>{for(var r in e)Aa(t,r,{get:e[r],enumerable:!0})},A1=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of k1(e))!C1.call(t,s)&&s!==r&&Aa(t,s,{get:()=>e[s],enumerable:!(n=E1(e,s))||n.enumerable});return t},I1=t=>A1(Aa({},"__esModule",{value:!0}),t),Ud={};P1(Ud,{RoomCache:()=>Pa});zd.exports=I1(Ud);var R1=At(),Pa=class{clients=0;locked=!1;private=!1;maxClients=1/0;metadata;name;publicAddress;processId;roomId;createdAt;unlisted=!1;$rooms;constructor(e,r){this.createdAt=new Date;for(let n in e)e.hasOwnProperty(n)&&(this[n]=e[n]);Object.defineProperty(this,"$rooms",{value:r,enumerable:!1,writable:!0})}save(){this.$rooms.indexOf(this)===-1&&this.$rooms.push(this)}updateOne(e){if(e.$set)for(let r in e.$set)e.$set.hasOwnProperty(r)&&(this[r]=e.$set[r]);if(e.$inc)for(let r in e.$inc)e.$inc.hasOwnProperty(r)&&(this[r]+=e.$inc[r])}remove(){if(!this.$rooms)return;let e=this.$rooms.indexOf(this);e!==-1&&((0,R1.spliceOne)(this.$rooms,e),this.$rooms=null)}}});var Ws=x((QM,Gd)=>{var Ra=Object.defineProperty,T1=Object.getOwnPropertyDescriptor,M1=Object.getOwnPropertyNames,D1=Object.prototype.hasOwnProperty,$1=(t,e)=>{for(var r in e)Ra(t,r,{get:e[r],enumerable:!0})},N1=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of M1(e))!D1.call(t,s)&&s!==r&&Ra(t,s,{get:()=>e[s],enumerable:!(n=T1(e,s))||n.enumerable});return t},L1=t=>N1(Ra({},"__esModule",{value:!0}),t),Vd={};$1(Vd,{IRoomListingData:()=>Sn.IRoomListingData,LocalDriver:()=>Ia,MatchMakerDriver:()=>Sn.MatchMakerDriver,QueryHelpers:()=>Sn.QueryHelpers,RoomListingData:()=>Sn.RoomListingData,SortOptions:()=>Sn.SortOptions});Gd.exports=L1(Vd);var Sn=jd(),j1=Fd(),q1=Hd(),Ia=class{rooms=[];createInstance(e={}){return new q1.RoomCache(e,this.rooms)}has(e){return this.rooms.some(r=>r.roomId===e)}find(e){return this.rooms.filter(r=>{for(let n in e)if(e.hasOwnProperty(n)&&r[n]!==e[n])return!1;return!0})}findOne(e){return new j1.Query(this.rooms,e)}clear(){this.rooms=[]}shutdown(){}}});var Zd=x((YM,Xd)=>{var B1=Object.create,Js=Object.defineProperty,F1=Object.getOwnPropertyDescriptor,U1=Object.getOwnPropertyNames,z1=Object.getPrototypeOf,H1=Object.prototype.hasOwnProperty,V1=(t,e)=>{for(var r in e)Js(t,r,{get:e[r],enumerable:!0})},Yd=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of U1(e))!H1.call(t,s)&&s!==r&&Js(t,s,{get:()=>e[s],enumerable:!(n=F1(e,s))||n.enumerable});return t},G1=(t,e,r)=>(r=t!=null?B1(z1(t)):{},Yd(e||!t||!t.__esModule?Js(r,"default",{value:t,enumerable:!0}):r,t)),W1=t=>Yd(Js({},"__esModule",{value:!0}),t),Kd={};V1(Kd,{default:()=>J1});Xd.exports=W1(Kd);var Wd=Pt(),Jd=$r(),Qd=G1(or()),J1={DEFAULT_CORS_HEADERS:{"Access-Control-Allow-Headers":"Origin, X-Requested-With, Content-Type, Accept","Access-Control-Allow-Methods":"OPTIONS, POST, GET","Access-Control-Allow-Origin":"*","Access-Control-Max-Age":"2592000"},exposedMethods:["joinOrCreate","create","join","joinById","reconnect"],allowedRoomNameChars:/([a-zA-Z_\-0-9]+)/gi,matchmakeRoute:"matchmake",getCorsHeaders(t){return{}},getAvailableRooms(t){let e={locked:!1,private:!1};return t&&(e.name=t),Qd.query(e)},async invokeMethod(t,e,r={}){if(this.exposedMethods.indexOf(t)===-1)throw new Jd.ServerError(Wd.ErrorCode.MATCHMAKE_NO_HANDLER,`invalid method "${t}"`);try{return await Qd[t](e,r)}catch(n){throw new Jd.ServerError(n.code||Wd.ErrorCode.MATCHMAKE_UNHANDLED,n.message)}}}});var tp=x((ep,wn)=>{(function(){var t,e,r,n,s,i,o,c,l;e={},c=this,typeof wn<"u"&&wn!==null&&wn.exports?wn.exports=e:c.ipaddr=e,o=function(u,a,f,h){var d,p;if(u.length!==a.length)throw new Error("ipaddr: cannot match CIDR for objects with different lengths");for(d=0;h>0;){if(p=f-h,p<0&&(p=0),u[d]>>p!==a[d]>>p)return!1;h-=f,d+=1}return!0},e.subnetMatch=function(u,a,f){var h,d,p,y,m;f==null&&(f="unicast");for(p in a)for(y=a[p],y[0]&&!(y[0]instanceof Array)&&(y=[y]),h=0,d=y.length;h<d;h++)if(m=y[h],u.kind()===m[0].kind()&&u.match.apply(u,m))return p;return f},e.IPv4=function(){function u(a){var f,h,d;if(a.length!==4)throw new Error("ipaddr: ipv4 octet count should be 4");for(f=0,h=a.length;f<h;f++)if(d=a[f],!(0<=d&&d<=255))throw new Error("ipaddr: ipv4 octet should fit in 8 bits");this.octets=a}return u.prototype.kind=function(){return"ipv4"},u.prototype.toString=function(){return this.octets.join(".")},u.prototype.toNormalizedString=function(){return this.toString()},u.prototype.toByteArray=function(){return this.octets.slice(0)},u.prototype.match=function(a,f){var h;if(f===void 0&&(h=a,a=h[0],f=h[1]),a.kind()!=="ipv4")throw new Error("ipaddr: cannot match ipv4 address with non-ipv4 one");return o(this.octets,a.octets,8,f)},u.prototype.SpecialRanges={unspecified:[[new u([0,0,0,0]),8]],broadcast:[[new u([255,255,255,255]),32]],multicast:[[new u([224,0,0,0]),4]],linkLocal:[[new u([169,254,0,0]),16]],loopback:[[new u([127,0,0,0]),8]],carrierGradeNat:[[new u([100,64,0,0]),10]],private:[[new u([10,0,0,0]),8],[new u([172,16,0,0]),12],[new u([192,168,0,0]),16]],reserved:[[new u([192,0,0,0]),24],[new u([192,0,2,0]),24],[new u([192,88,99,0]),24],[new u([198,51,100,0]),24],[new u([203,0,113,0]),24],[new u([240,0,0,0]),4]]},u.prototype.range=function(){return e.subnetMatch(this,this.SpecialRanges)},u.prototype.toIPv4MappedAddress=function(){return e.IPv6.parse("::ffff:"+this.toString())},u.prototype.prefixLengthFromSubnetMask=function(){var a,f,h,d,p,y,m;for(m={0:8,128:7,192:6,224:5,240:4,248:3,252:2,254:1,255:0},a=0,p=!1,f=h=3;h>=0;f=h+=-1)if(d=this.octets[f],d in m){if(y=m[d],p&&y!==0)return null;y!==8&&(p=!0),a+=y}else return null;return 32-a},u}(),r="(0?\\d+|0x[a-f0-9]+)",n={fourOctet:new RegExp("^"+r+"\\."+r+"\\."+r+"\\."+r+"$","i"),longValue:new RegExp("^"+r+"$","i")},e.IPv4.parser=function(u){var a,f,h,d,p;if(f=function(y){return y[0]==="0"&&y[1]!=="x"?parseInt(y,8):parseInt(y)},a=u.match(n.fourOctet))return function(){var y,m,S,R;for(S=a.slice(1,6),R=[],y=0,m=S.length;y<m;y++)h=S[y],R.push(f(h));return R}();if(a=u.match(n.longValue)){if(p=f(a[1]),p>4294967295||p<0)throw new Error("ipaddr: address outside defined range");return function(){var y,m;for(m=[],d=y=0;y<=24;d=y+=8)m.push(p>>d&255);return m}().reverse()}else return null},e.IPv6=function(){function u(a,f){var h,d,p,y,m,S;if(a.length===16)for(this.parts=[],h=d=0;d<=14;h=d+=2)this.parts.push(a[h]<<8|a[h+1]);else if(a.length===8)this.parts=a;else throw new Error("ipaddr: ipv6 part count should be 8 or 16");for(S=this.parts,p=0,y=S.length;p<y;p++)if(m=S[p],!(0<=m&&m<=65535))throw new Error("ipaddr: ipv6 part should fit in 16 bits");f&&(this.zoneId=f)}return u.prototype.kind=function(){return"ipv6"},u.prototype.toString=function(){return this.toNormalizedString().replace(/((^|:)(0(:|$))+)/,"::")},u.prototype.toRFC5952String=function(){var a,f,h,d,p;for(d=/((^|:)(0(:|$)){2,})/g,p=this.toNormalizedString(),a=0,f=-1;h=d.exec(p);)h[0].length>f&&(a=h.index,f=h[0].length);return f<0?p:p.substring(0,a)+"::"+p.substring(a+f)},u.prototype.toByteArray=function(){var a,f,h,d,p;for(a=[],p=this.parts,f=0,h=p.length;f<h;f++)d=p[f],a.push(d>>8),a.push(d&255);return a},u.prototype.toNormalizedString=function(){var a,f,h;return a=function(){var d,p,y,m;for(y=this.parts,m=[],d=0,p=y.length;d<p;d++)f=y[d],m.push(f.toString(16));return m}.call(this).join(":"),h="",this.zoneId&&(h="%"+this.zoneId),a+h},u.prototype.toFixedLengthString=function(){var a,f,h;return a=function(){var d,p,y,m;for(y=this.parts,m=[],d=0,p=y.length;d<p;d++)f=y[d],m.push(f.toString(16).padStart(4,"0"));return m}.call(this).join(":"),h="",this.zoneId&&(h="%"+this.zoneId),a+h},u.prototype.match=function(a,f){var h;if(f===void 0&&(h=a,a=h[0],f=h[1]),a.kind()!=="ipv6")throw new Error("ipaddr: cannot match ipv6 address with non-ipv6 one");return o(this.parts,a.parts,16,f)},u.prototype.SpecialRanges={unspecified:[new u([0,0,0,0,0,0,0,0]),128],linkLocal:[new u([65152,0,0,0,0,0,0,0]),10],multicast:[new u([65280,0,0,0,0,0,0,0]),8],loopback:[new u([0,0,0,0,0,0,0,1]),128],uniqueLocal:[new u([64512,0,0,0,0,0,0,0]),7],ipv4Mapped:[new u([0,0,0,0,0,65535,0,0]),96],rfc6145:[new u([0,0,0,0,65535,0,0,0]),96],rfc6052:[new u([100,65435,0,0,0,0,0,0]),96],"6to4":[new u([8194,0,0,0,0,0,0,0]),16],teredo:[new u([8193,0,0,0,0,0,0,0]),32],reserved:[[new u([8193,3512,0,0,0,0,0,0]),32]]},u.prototype.range=function(){return e.subnetMatch(this,this.SpecialRanges)},u.prototype.isIPv4MappedAddress=function(){return this.range()==="ipv4Mapped"},u.prototype.toIPv4Address=function(){var a,f,h;if(!this.isIPv4MappedAddress())throw new Error("ipaddr: trying to convert a generic ipv6 address to ipv4");return h=this.parts.slice(-2),a=h[0],f=h[1],new e.IPv4([a>>8,a&255,f>>8,f&255])},u.prototype.prefixLengthFromSubnetMask=function(){var a,f,h,d,p,y,m;for(m={0:16,32768:15,49152:14,57344:13,61440:12,63488:11,64512:10,65024:9,65280:8,65408:7,65472:6,65504:5,65520:4,65528:3,65532:2,65534:1,65535:0},a=0,p=!1,f=h=7;h>=0;f=h+=-1)if(d=this.parts[f],d in m){if(y=m[d],p&&y!==0)return null;y!==16&&(p=!0),a+=y}else return null;return 128-a},u}(),s="(?:[0-9a-f]+::?)+",l="%[0-9a-z]{1,}",i={zoneIndex:new RegExp(l,"i"),native:new RegExp("^(::)?("+s+")?([0-9a-f]+)?(::)?("+l+")?$","i"),transitional:new RegExp("^((?:"+s+")|(?:::)(?:"+s+")?)"+(r+"\\."+r+"\\."+r+"\\."+r)+("("+l+")?$"),"i")},t=function(u,a){var f,h,d,p,y,m;if(u.indexOf("::")!==u.lastIndexOf("::"))return null;for(m=(u.match(i.zoneIndex)||[])[0],m&&(m=m.substring(1),u=u.replace(/%.+$/,"")),f=0,h=-1;(h=u.indexOf(":",h+1))>=0;)f++;if(u.substr(0,2)==="::"&&f--,u.substr(-2,2)==="::"&&f--,f>a)return null;for(y=a-f,p=":";y--;)p+="0:";return u=u.replace("::",p),u[0]===":"&&(u=u.slice(1)),u[u.length-1]===":"&&(u=u.slice(0,-1)),a=function(){var S,R,w,E;for(w=u.split(":"),E=[],S=0,R=w.length;S<R;S++)d=w[S],E.push(parseInt(d,16));return E}(),{parts:a,zoneId:m}},e.IPv6.parser=function(u){var a,f,h,d,p,y,m;if(i.native.test(u))return t(u,8);if((d=u.match(i.transitional))&&(m=d[6]||"",a=t(d[1].slice(0,-1)+m,6),a.parts)){for(y=[parseInt(d[2]),parseInt(d[3]),parseInt(d[4]),parseInt(d[5])],f=0,h=y.length;f<h;f++)if(p=y[f],!(0<=p&&p<=255))return null;return a.parts.push(y[0]<<8|y[1]),a.parts.push(y[2]<<8|y[3]),{parts:a.parts,zoneId:a.zoneId}}return null},e.IPv4.isIPv4=e.IPv6.isIPv6=function(u){return this.parser(u)!==null},e.IPv4.isValid=function(u){var a;try{return new this(this.parser(u)),!0}catch(f){return a=f,!1}},e.IPv4.isValidFourPartDecimal=function(u){return!!(e.IPv4.isValid(u)&&u.match(/^(0|[1-9]\d*)(\.(0|[1-9]\d*)){3}$/))},e.IPv6.isValid=function(u){var a,f;if(typeof u=="string"&&u.indexOf(":")===-1)return!1;try{return a=this.parser(u),new this(a.parts,a.zoneId),!0}catch(h){return f=h,!1}},e.IPv4.parse=function(u){var a;if(a=this.parser(u),a===null)throw new Error("ipaddr: string is not formatted like ip address");return new this(a)},e.IPv6.parse=function(u){var a;if(a=this.parser(u),a.parts===null)throw new Error("ipaddr: string is not formatted like ip address");return new this(a.parts,a.zoneId)},e.IPv4.parseCIDR=function(u){var a,f,h;if((f=u.match(/^(.+)\/(\d+)$/))&&(a=parseInt(f[2]),a>=0&&a<=32))return h=[this.parse(f[1]),a],Object.defineProperty(h,"toString",{value:function(){return this.join("/")}}),h;throw new Error("ipaddr: string is not formatted like an IPv4 CIDR range")},e.IPv4.subnetMaskFromPrefixLength=function(u){var a,f,h;if(u=parseInt(u),u<0||u>32)throw new Error("ipaddr: invalid IPv4 prefix length");for(h=[0,0,0,0],f=0,a=Math.floor(u/8);f<a;)h[f]=255,f++;return a<4&&(h[a]=Math.pow(2,u%8)-1<<8-u%8),new this(h)},e.IPv4.broadcastAddressFromCIDR=function(u){var a,f,h,d,p,y;try{for(a=this.parseCIDR(u),d=a[0].toByteArray(),y=this.subnetMaskFromPrefixLength(a[1]).toByteArray(),p=[],h=0;h<4;)p.push(parseInt(d[h],10)|parseInt(y[h],10)^255),h++;return new this(p)}catch(m){throw f=m,new Error("ipaddr: the address does not have IPv4 CIDR format")}},e.IPv4.networkAddressFromCIDR=function(u){var a,f,h,d,p,y;try{for(a=this.parseCIDR(u),d=a[0].toByteArray(),y=this.subnetMaskFromPrefixLength(a[1]).toByteArray(),p=[],h=0;h<4;)p.push(parseInt(d[h],10)&parseInt(y[h],10)),h++;return new this(p)}catch(m){throw f=m,new Error("ipaddr: the address does not have IPv4 CIDR format")}},e.IPv6.parseCIDR=function(u){var a,f,h;if((f=u.match(/^(.+)\/(\d+)$/))&&(a=parseInt(f[2]),a>=0&&a<=128))return h=[this.parse(f[1]),a],Object.defineProperty(h,"toString",{value:function(){return this.join("/")}}),h;throw new Error("ipaddr: string is not formatted like an IPv6 CIDR range")},e.isValid=function(u){return e.IPv6.isValid(u)||e.IPv4.isValid(u)},e.parse=function(u){if(e.IPv6.isValid(u))return e.IPv6.parse(u);if(e.IPv4.isValid(u))return e.IPv4.parse(u);throw new Error("ipaddr: the address has neither IPv6 nor IPv4 format")},e.parseCIDR=function(u){var a;try{return e.IPv6.parseCIDR(u)}catch(f){a=f;try{return e.IPv4.parseCIDR(u)}catch(h){throw a=h,new Error("ipaddr: the address has neither IPv6 nor IPv4 CIDR format")}}},e.fromByteArray=function(u){var a;if(a=u.length,a===4)return new e.IPv4(u);if(a===16)return new e.IPv6(u);throw new Error("ipaddr: the binary input is neither an IPv6 nor IPv4 address")},e.process=function(u){var a;return a=this.parse(u),a.kind()==="ipv6"&&a.isIPv4MappedAddress()?a.toIPv4Address():a}}).call(ep)});var op=x((KM,Ma)=>{"use strict";var Q1=require("os"),rp=require("default-gateway"),Ta=tp();function np(t){let e=Q1.networkInterfaces(),r=Ta.parse(t),n;return Object.keys(e).some(s=>e[s].some(i=>{let o=Ta.parse(i.netmask).prefixLengthFromSubnetMask(),c=Ta.parseCIDR(`${i.address}/${o}`);return c[0]&&c[0].kind()===r.kind()&&r.match(c)&&(n=c[0].toString()),!!n})),n}function sp(t){return rp[t]().then(e=>np(e.gateway)||null).catch(()=>null)}function ip(t){try{let e=rp[t].sync();return np(e.gateway)||null}catch{return null}}var Br={};Br.v6=()=>sp("v6");Br.v4=()=>sp("v4");Br.v6.sync=()=>ip("v6");Br.v4.sync=()=>ip("v4");Ma.exports=Br;Ma.exports.default=Br});var Da=x((XM,dp)=>{var Y1=Object.create,Qs=Object.defineProperty,K1=Object.getOwnPropertyDescriptor,X1=Object.getOwnPropertyNames,Z1=Object.getPrototypeOf,eO=Object.prototype.hasOwnProperty,tO=(t,e)=>{for(var r in e)Qs(t,r,{get:e[r],enumerable:!0})},ap=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of X1(e))!eO.call(t,s)&&s!==r&&Qs(t,s,{get:()=>e[s],enumerable:!(n=K1(e,s))||n.enumerable});return t},rO=(t,e,r)=>(r=t!=null?Y1(Z1(t)):{},ap(e||!t||!t.__esModule?Qs(r,"default",{value:t,enumerable:!0}):r,t)),nO=t=>ap(Qs({},"__esModule",{value:!0}),t),cp={};tO(cp,{getHostname:()=>fp,registerNode:()=>iO,unregisterNode:()=>oO});dp.exports=nO(cp);var sO=rO(op()),up="colyseus:nodes",lp="colyseus:nodes:discovery";async function fp(){return process.env.SELF_HOSTNAME||await sO.default.v4()}async function hp(t){let e=await fp(),r=process.env.SELF_PORT??t.port;return r?`${t.processId}/${e}:${r}`:`${t.processId}/${e}`}async function iO(t,e){let r=await hp(e);await t.sadd(up,r),await t.publish(lp,`add,${r}`)}async function oO(t,e){let r=await hp(e);await t.srem(up,r),await t.publish(lp,`remove,${r}`)}});var or=x((ZM,wp)=>{var aO=Object.create,Xs=Object.defineProperty,cO=Object.getOwnPropertyDescriptor,uO=Object.getOwnPropertyNames,lO=Object.getPrototypeOf,fO=Object.prototype.hasOwnProperty,hO=(t,e)=>{for(var r in e)Xs(t,r,{get:e[r],enumerable:!0})},yp=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of uO(e))!fO.call(t,s)&&s!==r&&Xs(t,s,{get:()=>e[s],enumerable:!(n=cO(e,s))||n.enumerable});return t},dO=(t,e,r)=>(r=t!=null?aO(lO(t)):{},yp(e||!t||!t.__esModule?Xs(r,"default",{value:t,enumerable:!0}):r,t)),pO=t=>yp(Xs({},"__esModule",{value:!0}),t),gp={};hO(gp,{MatchMakerDriver:()=>_p.MatchMakerDriver,controller:()=>_O.default,create:()=>SO,createRoom:()=>La,defineRoomType:()=>CO,disconnectAll:()=>vp,driver:()=>Rt,findOneRoomAvailable:()=>Na,getRoomById:()=>IO,getRoomCountKey:()=>ur,gracefullyShutdown:()=>RO,handleCreateRoom:()=>Ks,hasHandler:()=>AO,isGracefullyShuttingDown:()=>On,join:()=>wO,joinById:()=>EO,joinOrCreate:()=>xO,onReady:()=>$a,presence:()=>K,processId:()=>ae,publicAddress:()=>Ys,query:()=>kO,reconnect:()=>OO,remoteRoomCall:()=>ei,removeRoomType:()=>PO,reserveSeatFor:()=>En,setup:()=>bO});wp.exports=pO(gp);var He=Pt(),Zs=Jh(),et=At(),pe=Lr(),yO=aa(),gO=qr(),mO=Gs(),ft=Ke(),mp=$d(),Ze=$r(),_p=Ws(),_O=dO(Zd()),pp=Ot(),vO=Da(),tt={},It={},Ys,ae,K,Rt,On,$a;async function bO(t,e,r){$a=new et.Deferred,K=t||new mO.LocalPresence,Rt=e||new _p.LocalDriver,Ys=r,pe.isDevMode&&(ae=await(0,pe.getPreviousProcessId)(await(0,vO.getHostname)())),ae||(ae=(0,et.generateId)()),On=!1,(0,Zs.subscribeIPC)(K,ae,Ba(),(n,s)=>Ks.apply(void 0,s)),await K.hset(ur(),ae,"0"),pe.isDevMode&&await(0,pe.reloadFromCache)(),$a.resolve()}async function xO(t,e={}){return await(0,et.retry)(async()=>{let r=await Na(t,e);return r||(r=await La(t,e)),await En(r,e)},5,[mp.SeatReservationError])}async function SO(t,e={}){let r=await La(t,e);return En(r,e)}async function wO(t,e={}){return await(0,et.retry)(async()=>{let r=await Na(t,e);if(!r)throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_INVALID_CRITERIA,"no rooms found with provided criteria");return En(r,e)})}async function OO(t,e={}){let r=await Rt.findOne({roomId:t});if(!r)throw pp.logger.info(`\u274C room "${t}" has been disposed. Did you missed .allowReconnection()?
\u{1F449} https://docs.colyseus.io/server/room/#allowreconnection-client-seconds`),new Ze.ServerError(He.ErrorCode.MATCHMAKE_INVALID_ROOM_ID,`room "${t}" has been disposed.`);let n=e.reconnectionToken;if(!n)throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_UNHANDLED,"'reconnectionToken' must be provided for reconnection.");let s=await ei(r.roomId,"checkReconnectionToken",[n]);if(s)return{room:r,sessionId:s};throw pp.logger.info(`\u274C reconnection token invalid or expired. Did you missed .allowReconnection()?
\u{1F449} https://docs.colyseus.io/server/room/#allowreconnection-client-seconds`),new Ze.ServerError(He.ErrorCode.MATCHMAKE_EXPIRED,"reconnection token invalid or expired.")}async function EO(t,e={}){let r=await Rt.findOne({roomId:t});if(r){if(r.locked)throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_INVALID_ROOM_ID,`room "${t}" is locked`)}else throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_INVALID_ROOM_ID,`room "${t}" not found`);return En(r,e)}async function kO(t={}){return await Rt.find(t)}async function Na(t,e){return await TO(t,async()=>{let r=tt[t];if(!r)throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_NO_HANDLER,`provided room name "${t}" not defined`);let n=Rt.findOne({locked:!1,name:t,private:!1,...r.getFilterOptions(e)});return r.sortOptions&&n.sort(r.sortOptions),await n})}async function ei(t,e,r,n=et.REMOTE_ROOM_SHORT_TIMEOUT){let s=It[t];if(s)return!r&&typeof s[e]!="function"?s[e]:await s[e].apply(s,r&&r.map(i=>JSON.parse(JSON.stringify(i))));try{return await(0,Zs.requestFromIPC)(K,ja(t),e,r)}catch{let o=`${e}${r&&" with args "+JSON.stringify(r)||""}`;throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_UNHANDLED,`remote room (${t}) timed out, requesting "${o}". (${n}ms exceeded)`)}}function CO(t,e,r){let n=new yO.RegisteredHandler(e,r);return tt[t]=n,pe.isDevMode||bp(t),n}function PO(t){delete tt[t],pe.isDevMode||bp(t)}function AO(t){return tt[t]!==void 0}async function La(t,e){let r=await K.hgetall(ur()),n=Object.keys(r).sort((i,o)=>Number(r[i])>Number(r[o])?1:-1)[0]||ae,s;if(n===ae)s=await Ks(t,e);else try{s=await(0,Zs.requestFromIPC)(K,Ba(n),void 0,[t,e],et.REMOTE_ROOM_SHORT_TIMEOUT)}catch(i){await K.hdel(ur(),n),(0,ft.debugAndPrintError)(i),s=await Ks(t,e)}return pe.isDevMode&&K.hset((0,pe.getRoomRestoreListKey)(),s.roomId,JSON.stringify({clientOptions:e,roomName:t,processId:ae})),s}async function Ks(t,e,r){let n=tt[t];if(!n)throw new Ze.ServerError(He.ErrorCode.MATCHMAKE_NO_HANDLER,`provided room name "${t}" not defined`);let s=new n.klass;r&&pe.isDevMode?s.roomId=r:s.roomId=(0,et.generateId)(),s.roomName=t,s.presence=K;let i=n.getFilterOptions(e);if(Ys&&(i.publicAddress=Ys),s.listing=Rt.createInstance({name:t,processId:ae,...i}),s.onCreate)try{await s.onCreate((0,et.merge)({},e,n.options)),K.hincrby(ur(),ae,1)}catch(o){throw(0,ft.debugAndPrintError)(o),new Ze.ServerError(o.code||He.ErrorCode.MATCHMAKE_UNHANDLED,o.message)}return s._internalState=gO.RoomInternalState.CREATED,s.listing.roomId=s.roomId,s.listing.maxClients=s.maxClients,(0,ft.debugMatchMaking)("spawning '%s', roomId: %s, processId: %s",t,s.roomId,ae),s._events.on("lock",$O.bind(this,s)),s._events.on("unlock",NO.bind(this,s)),s._events.on("join",MO.bind(this,s)),s._events.on("leave",DO.bind(this,s)),s._events.once("dispose",LO.bind(this,t,s)),s._events.once("disconnect",()=>s._events.removeAllListeners()),await xp(s,!0),await s.listing.save(),n.emit("create",s),s.listing}function IO(t){return It[t]}function vp(t){let e=[];for(let r in It)It.hasOwnProperty(r)&&e.push(It[r].disconnect(t));return e}async function RO(){return On?Promise.reject("already_shutting_down"):(On=!0,(0,ft.debugMatchMaking)(`${ae} is shutting down!`),pe.isDevMode&&await(0,pe.cacheRoomHistory)(It),K.hdel(ur(),ae),K.unsubscribe(Ba()),Promise.all(vp(pe.isDevMode?He.Protocol.WS_CLOSE_DEVMODE_RESTART:void 0)))}async function En(t,e){let r=(0,et.generateId)();(0,ft.debugMatchMaking)("reserving seat. sessionId: '%s', roomId: '%s', processId: '%s'",r,t.roomId,ae);let n;try{n=await ei(t.roomId,"_reserveSeat",[r,e])}catch(i){(0,ft.debugMatchMaking)(i),n=!1}if(!n)throw new mp.SeatReservationError(`${t.roomId} is already full.`);let s={room:t,sessionId:r};return pe.isDevMode&&(s.devMode=pe.isDevMode),s}async function bp(t){let e=await Rt.find({name:t},{_id:1});await K.del(qa(t)),await Promise.all(e.map(async r=>{try{await ei(r.roomId,"roomId")}catch{(0,ft.debugMatchMaking)(`cleaning up stale room '${t}', roomId: ${r.roomId}`),r.remove()}}))}async function xp(t,e=!1){return It[t.roomId]=t,e&&await(0,Zs.subscribeIPC)(K,ae,ja(t.roomId),(r,n)=>!n&&typeof t[r]!="function"?t[r]:t[r].apply(t,n)),!0}async function TO(t,e){return new Promise(async(r,n)=>{let s=qa(t),i=await K.incr(s)-1,o=Math.min(i*100,et.REMOTE_ROOM_SHORT_TIMEOUT);i>0&&(0,ft.debugMatchMaking)("receiving %d concurrent requests for joining '%s' (waiting %d ms)",i,t,o),setTimeout(async()=>{try{let c=await e();r(c)}catch(c){n(c)}finally{await K.decr(s)}},o)})}function MO(t,e){K.incr(Sp()),tt[t.roomName].emit("join",t,e)}function DO(t,e,r){K.decr(Sp()),tt[t.roomName].emit("leave",t,e,r)}function $O(t){tt[t.roomName].emit("lock",t)}async function NO(t){await xp(t)&&tt[t.roomName].emit("unlock",t)}async function LO(t,e){(0,ft.debugMatchMaking)("disposing '%s' (%s) on processId '%s'",t,e.roomId,ae),On||(K.hincrby(ur(),ae,-1),pe.isDevMode&&await K.hdel((0,pe.getRoomRestoreListKey)(),e.roomId)),tt[t].emit("dispose",e),K.del(qa(t)),K.unsubscribe(ja(e.roomId)),delete It[e.roomId]}function ur(){return"roomcount"}function ja(t){return`$${t}`}function qa(t){return`c:${t}`}function Ba(t=ae){return`p:${t}`}function Sp(){return"_ccu"}});var Tp=x((eD,Rp)=>{var jO=Object.create,ti=Object.defineProperty,qO=Object.getOwnPropertyDescriptor,BO=Object.getOwnPropertyNames,FO=Object.getPrototypeOf,UO=Object.prototype.hasOwnProperty,zO=(t,e)=>{for(var r in e)ti(t,r,{get:e[r],enumerable:!0})},Pp=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of BO(e))!UO.call(t,s)&&s!==r&&ti(t,s,{get:()=>e[s],enumerable:!(n=qO(e,s))||n.enumerable});return t},Ap=(t,e,r)=>(r=t!=null?jO(FO(t)):{},Pp(e||!t||!t.__esModule?ti(r,"default",{value:t,enumerable:!0}):r,t)),HO=t=>Pp(ti({},"__esModule",{value:!0}),t),Ip={};zO(Ip,{Server:()=>Fa});Rp.exports=HO(Ip);var VO=Ap(tf()),Op=Ke(),he=Ap(or()),Ep=qr(),GO=At(),kp=Da(),WO=Gs(),JO=Ws(),kn=Ot(),Cp=Lr(),Fa=class{transport;presence;driver;port;greet;constructor(e={}){let{gracefullyShutdown:r=!0,greet:n=!0}=e;(0,Cp.setDevMode)(e.devMode===!0),this.presence=e.presence||new WO.LocalPresence,this.driver=e.driver||new JO.LocalDriver,this.greet=n,this.attach(e),he.setup(this.presence,this.driver,e.publicAddress),r&&(0,GO.registerGracefulShutdown)(s=>this.gracefullyShutdown(!0,s)),e.logger&&(0,kn.setLogger)(e.logger)}attach(e){(e.pingInterval!==void 0||e.pingMaxRetries!==void 0||e.server!==void 0||e.verifyClient!==void 0)&&(kn.logger.warn("DEPRECATION WARNING: 'pingInterval', 'pingMaxRetries', 'server', and 'verifyClient' Server options will be permanently moved to WebSocketTransport on v0.15"),kn.logger.warn(`new Server({
  transport: new WebSocketTransport({
    pingInterval: ...,
    pingMaxRetries: ...,
    server: ...,
    verifyClient: ...
  })
})`),kn.logger.warn("\u{1F449} Documentation: https://docs.colyseus.io/server/transport/"));let r=e.transport||this.getDefaultTransport(e);delete e.transport,this.transport=r,this.transport.server&&(this.transport.server.once("listening",()=>this.registerProcessForDiscovery()),this.attachMatchMakingRoutes(this.transport.server))}async listen(e,r,n,s){return this.port=e,await he.onReady,this.greet&&console.log(VO.default),new Promise((i,o)=>{this.transport.server?.on("error",c=>o(c)),this.transport.listen(e,r,n,c=>{s&&s(c),c?o(c):i()})})}async registerProcessForDiscovery(){await(0,kp.registerNode)(this.presence,{port:this.port,processId:he.processId})}define(e,r,n){return he.defineRoomType(e,r,n)}removeRoomType(e){he.removeRoomType(e)}async gracefullyShutdown(e=!0,r){if(!he.isGracefullyShuttingDown){await(0,kp.unregisterNode)(this.presence,{port:this.port,processId:he.processId});try{await he.gracefullyShutdown(),this.transport.shutdown(),this.presence.shutdown(),this.driver.shutdown(),await this.onShutdownCallback()}catch(n){(0,Op.debugAndPrintError)(`error during shutdown: ${n}`)}finally{e&&process.exit(r&&!Cp.isDevMode?1:0)}}}simulateLatency(e){kn.logger.warn(`\u{1F4F6}\uFE0F\u2757 Colyseus latency simulation enabled \u2192 ${e}ms latency for round trip.`);let r=e/2;this.transport.simulateLatency(r);let n=Ep.Room.prototype._onMessage;Ep.Room.prototype._onMessage=function(s,i){let o=Buffer.from(i);setTimeout(()=>n.call(this,s,o),r)}}onShutdown(e){this.onShutdownCallback=e}getDefaultTransport(e){throw new Error("Please provide a 'transport' layer. Default transport not set.")}onShutdownCallback=()=>Promise.resolve();attachMatchMakingRoutes(e){let r=e.listeners("request").slice(0);e.removeAllListeners("request"),e.on("request",(n,s)=>{if(n.url.indexOf(`/${he.controller.matchmakeRoute}`)!==-1)(0,Op.debugMatchMaking)("received matchmake request: %s",n.url),this.handleMatchMakeRequest(n,s);else for(let i=0,o=r.length;i<o;i++)r[i].call(e,n,s)})}async handleMatchMakeRequest(e,r){if(he.isGracefullyShuttingDown){r.writeHead(503,{}),r.end();return}let n=Object.assign({},he.controller.DEFAULT_CORS_HEADERS,he.controller.getCorsHeaders.call(void 0,e));if(e.method==="OPTIONS")r.writeHead(204,n),r.end();else if(e.method==="POST"){let s=e.url.match(he.controller.allowedRoomNameChars),i=s.indexOf(he.controller.matchmakeRoute),o=s[i+1],c=s[i+2]||"",l=[];e.on("data",u=>l.push(u)),e.on("end",async()=>{n["Content-Type"]="application/json",r.writeHead(200,n);try{let u=JSON.parse(Buffer.concat(l).toString()),a=await he.controller.invokeMethod(o,c,u);r.write(JSON.stringify(a))}catch(u){r.write(JSON.stringify({code:u.code,error:u.message}))}r.end()})}else if(e.method==="GET"){let s=e.url.match(he.controller.allowedRoomNameChars),i=s.length>1?s[s.length-1]:"";n["Content-Type"]="application/json",r.writeHead(200,n),r.write(JSON.stringify(await he.controller.getAvailableRooms(i))),r.end()}}}});var $p=x((tD,Dp)=>{var Mp=Object.defineProperty,QO=Object.getOwnPropertyDescriptor,YO=Object.getOwnPropertyNames,KO=Object.prototype.hasOwnProperty,XO=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of YO(e))!KO.call(t,s)&&s!==r&&Mp(t,s,{get:()=>e[s],enumerable:!(n=QO(e,s))||n.enumerable});return t},ZO=t=>XO(Mp({},"__esModule",{value:!0}),t),eE={};Dp.exports=ZO(eE)});var jp=x((rD,Lp)=>{var Np=Object.defineProperty,tE=Object.getOwnPropertyDescriptor,rE=Object.getOwnPropertyNames,nE=Object.prototype.hasOwnProperty,sE=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of rE(e))!nE.call(t,s)&&s!==r&&Np(t,s,{get:()=>e[s],enumerable:!(n=tE(e,s))||n.enumerable});return t},iE=t=>sE(Np({},"__esModule",{value:!0}),t),oE={};Lp.exports=iE(oE)});var Up=x((nD,Fp)=>{var aE=Object.create,ri=Object.defineProperty,cE=Object.getOwnPropertyDescriptor,uE=Object.getOwnPropertyNames,lE=Object.getPrototypeOf,fE=Object.prototype.hasOwnProperty,hE=(t,e)=>{for(var r in e)ri(t,r,{get:e[r],enumerable:!0})},qp=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of uE(e))!fE.call(t,s)&&s!==r&&ri(t,s,{get:()=>e[s],enumerable:!(n=cE(e,s))||n.enumerable});return t},dE=(t,e,r)=>(r=t!=null?aE(lE(t)):{},qp(e||!t||!t.__esModule?ri(r,"default",{value:t,enumerable:!0}):r,t)),pE=t=>qp(ri({},"__esModule",{value:!0}),t),Bp={};hE(Bp,{LobbyRoom:()=>Ua});Fp.exports=pE(Bp);var yE=dE(or()),gE=Fs(),mE=qr(),Ua=class extends mE.Room{rooms=[];unsubscribeLobby;clientOptions={};async onCreate(e){this.listing.unlisted=!0,this.unsubscribeLobby=await(0,gE.subscribeLobby)((r,n)=>{let s=this.rooms.findIndex(o=>o.roomId===r),i=this.clients.filter(o=>this.clientOptions[o.sessionId]);if(n)if(s===-1)this.rooms.push(n),i.forEach(o=>{this.filterItemForClient(n,this.clientOptions[o.sessionId].filter)&&o.send("+",[r,n])});else{let o=this.rooms[s];this.rooms[s]=n,i.forEach(c=>{let l=this.filterItemForClient(o,this.clientOptions[c.sessionId].filter),u=this.filterItemForClient(n,this.clientOptions[c.sessionId].filter);l&&!u?c.send("-",r):u&&c.send("+",[r,n])})}else if(s!==-1){let o=this.rooms[s];this.rooms.splice(s,1),i.forEach(c=>{this.filterItemForClient(o,this.clientOptions[c.sessionId].filter)&&c.send("-",r)})}}),this.rooms=await yE.query({private:!1,unlisted:!1}),this.onMessage("filter",(r,n)=>{this.clientOptions[r.sessionId].filter=n,r.send("rooms",this.filterItemsForClient(this.clientOptions[r.sessionId]))})}onJoin(e,r){this.clientOptions[e.sessionId]=r||{},e.send("rooms",this.filterItemsForClient(this.clientOptions[e.sessionId]))}onLeave(e){delete this.clientOptions[e.sessionId]}onDispose(){this.unsubscribeLobby&&this.unsubscribeLobby()}filterItemsForClient(e){let r=e.filter;return r?this.rooms.filter(n=>this.filterItemForClient(n,r)):this.rooms}filterItemForClient(e,r){if(!r)return!0;let n=!0;if(r.name!==e.name&&(n=!1),r.metadata){for(let s in r.metadata)if(e.metadata[s]!==r.metadata[s]){n=!1;break}}return n}}});var Gp=x((sD,Vp)=>{var Ha=Object.defineProperty,_E=Object.getOwnPropertyDescriptor,vE=Object.getOwnPropertyNames,bE=Object.prototype.hasOwnProperty,xE=(t,e)=>{for(var r in e)Ha(t,r,{get:e[r],enumerable:!0})},SE=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of vE(e))!bE.call(t,s)&&s!==r&&Ha(t,s,{get:()=>e[s],enumerable:!(n=_E(e,s))||n.enumerable});return t},wE=t=>SE(Ha({},"__esModule",{value:!0}),t),zp={};xE(zp,{RelayRoom:()=>za});Vp.exports=wE(zp);var Fr=nr(),OE=qr(),Hp=new Fr.Context,Cn=class extends Fr.Schema{connected;name;sessionId};(0,Fr.defineTypes)(Cn,{connected:"boolean",name:"string",sessionId:"string"},{context:Hp});var ni=class extends Fr.Schema{players=new Fr.MapSchema};(0,Fr.defineTypes)(ni,{players:{map:Cn}},{context:Hp});var za=class extends OE.Room{allowReconnectionTime=0;onCreate(e){this.setState(new ni),e.maxClients&&(this.maxClients=e.maxClients),e.allowReconnectionTime&&(this.allowReconnectionTime=Math.min(e.allowReconnectionTime,40)),e.metadata&&this.setMetadata(e.metadata),this.onMessage("*",(r,n,s)=>{this.broadcast(n,[r.sessionId,s],{except:r})})}onJoin(e,r={}){let n=new Cn;n.connected=!0,n.sessionId=e.sessionId,r.name&&(n.name=r.name),this.state.players.set(e.sessionId,n)}async onLeave(e,r){if(this.allowReconnectionTime>0){let n=this.state.players.get(e.sessionId);n.connected=!1;try{if(r)throw new Error("consented leave");await this.allowReconnection(e,this.allowReconnectionTime),n.connected=!0}catch{this.state.players.delete(e.sessionId)}}}}});var rt=x((iD,Wa)=>{var EE=Object.create,oi=Object.defineProperty,kE=Object.getOwnPropertyDescriptor,CE=Object.getOwnPropertyNames,PE=Object.getPrototypeOf,AE=Object.prototype.hasOwnProperty,IE=(t,e)=>{for(var r in e)oi(t,r,{get:e[r],enumerable:!0})},ii=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of CE(e))!AE.call(t,s)&&s!==r&&oi(t,s,{get:()=>e[s],enumerable:!(n=kE(e,s))||n.enumerable});return t},RE=(t,e,r)=>(ii(t,e,"default"),r&&ii(r,e,"default")),Kp=(t,e,r)=>(r=t!=null?EE(PE(t)):{},ii(e||!t||!t.__esModule?oi(r,"default",{value:t,enumerable:!0}):r,t)),TE=t=>ii(oi({},"__esModule",{value:!0}),t),Ga={};IE(Ga,{Client:()=>Pn.Client,ClientArray:()=>Pn.ClientArray,ClientState:()=>Pn.ClientState,Clock:()=>Wp.default,Deferred:()=>si.Deferred,Delayed:()=>Wp.Delayed,DummyServer:()=>si.DummyServer,ErrorCode:()=>Va.ErrorCode,ISendOptions:()=>Pn.ISendOptions,LobbyRoom:()=>FE.LobbyRoom,LocalPresence:()=>LE.LocalPresence,Presence:()=>NE.Presence,Protocol:()=>Va.Protocol,RegisteredHandler:()=>ME.RegisteredHandler,RelayRoom:()=>UE.RelayRoom,Room:()=>Qp.Room,RoomInternalState:()=>Qp.RoomInternalState,SchemaSerializer:()=>qE.SchemaSerializer,Serializer:()=>jE.Serializer,Server:()=>Jp.Server,ServerError:()=>DE.ServerError,ServerOptions:()=>Jp.ServerOptions,Transport:()=>Pn.Transport,debugAndPrintError:()=>Tt.debugAndPrintError,debugConnection:()=>Tt.debugConnection,debugDriver:()=>Tt.debugDriver,debugError:()=>Tt.debugError,debugMatchMaking:()=>Tt.debugMatchMaking,debugMessage:()=>Tt.debugMessage,debugPatch:()=>Tt.debugPatch,debugPresence:()=>Tt.debugPresence,generateId:()=>si.generateId,getMessageBytes:()=>Va.getMessageBytes,isDevMode:()=>BE.isDevMode,logger:()=>zE.logger,matchMaker:()=>$E,spliceOne:()=>si.spliceOne,subscribeLobby:()=>Yp.subscribeLobby,updateLobby:()=>Yp.updateLobby});Wa.exports=TE(Ga);var Wp=Kp(ao()),Jp=Tp(),Qp=qr(),Va=Pt(),ME=aa(),DE=$r(),$E=Kp(or()),Yp=Fs();RE(Ga,Ws(),Wa.exports);var Pn=zs(),NE=$p(),LE=Gs(),jE=jp(),qE=_a(),si=At(),BE=Lr(),Tt=Ke(),FE=Up(),UE=Gp(),zE=Ot()});var lr=x((oD,Xp)=>{"use strict";Xp.exports={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),EMPTY_BUFFER:Buffer.alloc(0),NOOP:()=>{}}});var An=x((aD,Ja)=>{"use strict";var{EMPTY_BUFFER:HE}=lr();function Zp(t,e){if(t.length===0)return HE;if(t.length===1)return t[0];let r=Buffer.allocUnsafe(e),n=0;for(let s=0;s<t.length;s++){let i=t[s];r.set(i,n),n+=i.length}return n<e?r.slice(0,n):r}function e0(t,e,r,n,s){for(let i=0;i<s;i++)r[n+i]=t[i]^e[i&3]}function t0(t,e){let r=t.length;for(let n=0;n<r;n++)t[n]^=e[n&3]}function r0(t){return t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)}function ai(t){if(ai.readOnly=!0,Buffer.isBuffer(t))return t;let e;return t instanceof ArrayBuffer?e=Buffer.from(t):ArrayBuffer.isView(t)?e=Buffer.from(t.buffer,t.byteOffset,t.byteLength):(e=Buffer.from(t),ai.readOnly=!1),e}try{let t=require("bufferutil"),e=t.BufferUtil||t;Ja.exports={concat:Zp,mask(r,n,s,i,o){o<48?e0(r,n,s,i,o):e.mask(r,n,s,i,o)},toArrayBuffer:r0,toBuffer:ai,unmask(r,n){r.length<32?t0(r,n):e.unmask(r,n)}}}catch{Ja.exports={concat:Zp,mask:e0,toArrayBuffer:r0,toBuffer:ai,unmask:t0}}});var i0=x((cD,s0)=>{"use strict";var n0=Symbol("kDone"),Qa=Symbol("kRun"),Ya=class{constructor(e){this[n0]=()=>{this.pending--,this[Qa]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[Qa]()}[Qa](){if(this.pending!==this.concurrency&&this.jobs.length){let e=this.jobs.shift();this.pending++,e(this[n0])}}};s0.exports=Ya});var Tn=x((uD,u0)=>{"use strict";var In=require("zlib"),o0=An(),VE=i0(),{kStatusCode:a0,NOOP:GE}=lr(),WE=Buffer.from([0,0,255,255]),li=Symbol("permessage-deflate"),ht=Symbol("total-length"),Rn=Symbol("callback"),Mt=Symbol("buffers"),ui=Symbol("error"),ci,Ka=class{constructor(e,r,n){if(this._maxPayload=n|0,this._options=e||{},this._threshold=this._options.threshold!==void 0?this._options.threshold:1024,this._isServer=!!r,this._deflate=null,this._inflate=null,this.params=null,!ci){let s=this._options.concurrencyLimit!==void 0?this._options.concurrencyLimit:10;ci=new VE(s)}}static get extensionName(){return"permessage-deflate"}offer(){let e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:this._options.clientMaxWindowBits==null&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){let e=this._deflate[Rn];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){let r=this._options,n=e.find(s=>!(r.serverNoContextTakeover===!1&&s.server_no_context_takeover||s.server_max_window_bits&&(r.serverMaxWindowBits===!1||typeof r.serverMaxWindowBits=="number"&&r.serverMaxWindowBits>s.server_max_window_bits)||typeof r.clientMaxWindowBits=="number"&&!s.client_max_window_bits));if(!n)throw new Error("None of the extension offers can be accepted");return r.serverNoContextTakeover&&(n.server_no_context_takeover=!0),r.clientNoContextTakeover&&(n.client_no_context_takeover=!0),typeof r.serverMaxWindowBits=="number"&&(n.server_max_window_bits=r.serverMaxWindowBits),typeof r.clientMaxWindowBits=="number"?n.client_max_window_bits=r.clientMaxWindowBits:(n.client_max_window_bits===!0||r.clientMaxWindowBits===!1)&&delete n.client_max_window_bits,n}acceptAsClient(e){let r=e[0];if(this._options.clientNoContextTakeover===!1&&r.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(!r.client_max_window_bits)typeof this._options.clientMaxWindowBits=="number"&&(r.client_max_window_bits=this._options.clientMaxWindowBits);else if(this._options.clientMaxWindowBits===!1||typeof this._options.clientMaxWindowBits=="number"&&r.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"');return r}normalizeParams(e){return e.forEach(r=>{Object.keys(r).forEach(n=>{let s=r[n];if(s.length>1)throw new Error(`Parameter "${n}" must have only a single value`);if(s=s[0],n==="client_max_window_bits"){if(s!==!0){let i=+s;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${n}": ${s}`);s=i}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${n}": ${s}`)}else if(n==="server_max_window_bits"){let i=+s;if(!Number.isInteger(i)||i<8||i>15)throw new TypeError(`Invalid value for parameter "${n}": ${s}`);s=i}else if(n==="client_no_context_takeover"||n==="server_no_context_takeover"){if(s!==!0)throw new TypeError(`Invalid value for parameter "${n}": ${s}`)}else throw new Error(`Unknown parameter "${n}"`);r[n]=s})}),e}decompress(e,r,n){ci.add(s=>{this._decompress(e,r,(i,o)=>{s(),n(i,o)})})}compress(e,r,n){ci.add(s=>{this._compress(e,r,(i,o)=>{s(),n(i,o)})})}_decompress(e,r,n){let s=this._isServer?"client":"server";if(!this._inflate){let i=`${s}_max_window_bits`,o=typeof this.params[i]!="number"?In.Z_DEFAULT_WINDOWBITS:this.params[i];this._inflate=In.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),this._inflate[li]=this,this._inflate[ht]=0,this._inflate[Mt]=[],this._inflate.on("error",QE),this._inflate.on("data",c0)}this._inflate[Rn]=n,this._inflate.write(e),r&&this._inflate.write(WE),this._inflate.flush(()=>{let i=this._inflate[ui];if(i){this._inflate.close(),this._inflate=null,n(i);return}let o=o0.concat(this._inflate[Mt],this._inflate[ht]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[ht]=0,this._inflate[Mt]=[],r&&this.params[`${s}_no_context_takeover`]&&this._inflate.reset()),n(null,o)})}_compress(e,r,n){let s=this._isServer?"server":"client";if(!this._deflate){let i=`${s}_max_window_bits`,o=typeof this.params[i]!="number"?In.Z_DEFAULT_WINDOWBITS:this.params[i];this._deflate=In.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[ht]=0,this._deflate[Mt]=[],this._deflate.on("error",GE),this._deflate.on("data",JE)}this._deflate[Rn]=n,this._deflate.write(e),this._deflate.flush(In.Z_SYNC_FLUSH,()=>{if(!this._deflate)return;let i=o0.concat(this._deflate[Mt],this._deflate[ht]);r&&(i=i.slice(0,i.length-4)),this._deflate[Rn]=null,this._deflate[ht]=0,this._deflate[Mt]=[],r&&this.params[`${s}_no_context_takeover`]&&this._deflate.reset(),n(null,i)})}};u0.exports=Ka;function JE(t){this[Mt].push(t),this[ht]+=t.length}function c0(t){if(this[ht]+=t.length,this[li]._maxPayload<1||this[ht]<=this[li]._maxPayload){this[Mt].push(t);return}this[ui]=new RangeError("Max payload size exceeded"),this[ui].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[ui][a0]=1009,this.removeListener("data",c0),this.reset()}function QE(t){this[li]._inflate=null,t[a0]=1007,this[Rn](t)}});var Za=x((lD,Xa)=>{"use strict";function l0(t){return t>=1e3&&t<=1014&&t!==1004&&t!==1005&&t!==1006||t>=3e3&&t<=4999}function f0(t){let e=t.length,r=0;for(;r<e;)if(!(t[r]&128))r++;else if((t[r]&224)===192){if(r+1===e||(t[r+1]&192)!==128||(t[r]&254)===192)return!1;r+=2}else if((t[r]&240)===224){if(r+2>=e||(t[r+1]&192)!==128||(t[r+2]&192)!==128||t[r]===224&&(t[r+1]&224)===128||t[r]===237&&(t[r+1]&224)===160)return!1;r+=3}else if((t[r]&248)===240){if(r+3>=e||(t[r+1]&192)!==128||(t[r+2]&192)!==128||(t[r+3]&192)!==128||t[r]===240&&(t[r+1]&240)===128||t[r]===244&&t[r+1]>143||t[r]>244)return!1;r+=4}else return!1;return!0}try{let t=require("utf-8-validate");typeof t=="object"&&(t=t.Validation.isValidUTF8),Xa.exports={isValidStatusCode:l0,isValidUTF8(e){return e.length<150?f0(e):t(e)}}}catch{Xa.exports={isValidStatusCode:l0,isValidUTF8:f0}}});var nc=x((fD,m0)=>{"use strict";var{Writable:YE}=require("stream"),h0=Tn(),{BINARY_TYPES:KE,EMPTY_BUFFER:XE,kStatusCode:ZE,kWebSocket:ek}=lr(),{concat:ec,toArrayBuffer:tk,unmask:rk}=An(),{isValidStatusCode:nk,isValidUTF8:d0}=Za(),Mn=0,p0=1,y0=2,g0=3,tc=4,sk=5,rc=class extends YE{constructor(e,r,n,s){super(),this._binaryType=e||KE[0],this[ek]=void 0,this._extensions=r||{},this._isServer=!!n,this._maxPayload=s|0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=Mn,this._loop=!1}_write(e,r,n){if(this._opcode===8&&this._state==Mn)return n();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(n)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){let n=this._buffers[0];return this._buffers[0]=n.slice(e),n.slice(0,e)}let r=Buffer.allocUnsafe(e);do{let n=this._buffers[0],s=r.length-e;e>=n.length?r.set(this._buffers.shift(),s):(r.set(new Uint8Array(n.buffer,n.byteOffset,e),s),this._buffers[0]=n.slice(e)),e-=n.length}while(e>0);return r}startLoop(e){let r;this._loop=!0;do switch(this._state){case Mn:r=this.getInfo();break;case p0:r=this.getPayloadLength16();break;case y0:r=this.getPayloadLength64();break;case g0:this.getMask();break;case tc:r=this.getData(e);break;default:this._loop=!1;return}while(this._loop);e(r)}getInfo(){if(this._bufferedBytes<2){this._loop=!1;return}let e=this.consume(2);if(e[0]&48)return this._loop=!1,ce(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");let r=(e[0]&64)===64;if(r&&!this._extensions[h0.extensionName])return this._loop=!1,ce(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=(e[0]&128)===128,this._opcode=e[0]&15,this._payloadLength=e[1]&127,this._opcode===0){if(r)return this._loop=!1,ce(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,ce(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(this._opcode===1||this._opcode===2){if(this._fragmented)return this._loop=!1,ce(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=r}else if(this._opcode>7&&this._opcode<11){if(!this._fin)return this._loop=!1,ce(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(r)return this._loop=!1,ce(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._payloadLength>125)return this._loop=!1,ce(RangeError,`invalid payload length ${this._payloadLength}`,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}else return this._loop=!1,ce(RangeError,`invalid opcode ${this._opcode}`,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin&&!this._fragmented&&(this._fragmented=this._opcode),this._masked=(e[1]&128)===128,this._isServer){if(!this._masked)return this._loop=!1,ce(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,ce(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(this._payloadLength===126)this._state=p0;else if(this._payloadLength===127)this._state=y0;else return this.haveLength()}getPayloadLength16(){if(this._bufferedBytes<2){this._loop=!1;return}return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength()}getPayloadLength64(){if(this._bufferedBytes<8){this._loop=!1;return}let e=this.consume(8),r=e.readUInt32BE(0);return r>Math.pow(2,53-32)-1?(this._loop=!1,ce(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=r*Math.pow(2,32)+e.readUInt32BE(4),this.haveLength())}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&this._maxPayload>0))return this._loop=!1,ce(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=g0:this._state=tc}getMask(){if(this._bufferedBytes<4){this._loop=!1;return}this._mask=this.consume(4),this._state=tc}getData(e){let r=XE;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength){this._loop=!1;return}r=this.consume(this._payloadLength),this._masked&&rk(r,this._mask)}if(this._opcode>7)return this.controlMessage(r);if(this._compressed){this._state=sk,this.decompress(r,e);return}return r.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(r)),this.dataMessage()}decompress(e,r){this._extensions[h0.extensionName].decompress(e,this._fin,(s,i)=>{if(s)return r(s);if(i.length){if(this._messageLength+=i.length,this._messageLength>this._maxPayload&&this._maxPayload>0)return r(ce(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(i)}let o=this.dataMessage();if(o)return r(o);this.startLoop(r)})}dataMessage(){if(this._fin){let e=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],this._opcode===2){let n;this._binaryType==="nodebuffer"?n=ec(r,e):this._binaryType==="arraybuffer"?n=tk(ec(r,e)):n=r,this.emit("message",n)}else{let n=ec(r,e);if(!d0(n))return this._loop=!1,ce(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",n.toString())}}this._state=Mn}controlMessage(e){if(this._opcode===8)if(this._loop=!1,e.length===0)this.emit("conclude",1005,""),this.end();else{if(e.length===1)return ce(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");{let r=e.readUInt16BE(0);if(!nk(r))return ce(RangeError,`invalid status code ${r}`,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");let n=e.slice(2);if(!d0(n))return ce(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",r,n.toString()),this.end()}}else this._opcode===9?this.emit("ping",e):this.emit("pong",e);this._state=Mn}};m0.exports=rc;function ce(t,e,r,n,s){let i=new t(r?`Invalid WebSocket frame: ${e}`:e);return Error.captureStackTrace(i,ce),i.code=s,i[ZE]=n,i}});var ic=x((pD,b0)=>{"use strict";var hD=require("net"),dD=require("tls"),{randomFillSync:ik}=require("crypto"),_0=Tn(),{EMPTY_BUFFER:ok}=lr(),{isValidStatusCode:ak}=Za(),{mask:v0,toBuffer:dt}=An(),fr=Buffer.alloc(4),sc=class t{constructor(e,r){this._extensions=r||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,r){let n=r.mask&&r.readOnly,s=r.mask?6:2,i=e.length;e.length>=65536?(s+=8,i=127):e.length>125&&(s+=2,i=126);let o=Buffer.allocUnsafe(n?e.length+s:s);return o[0]=r.fin?r.opcode|128:r.opcode,r.rsv1&&(o[0]|=64),o[1]=i,i===126?o.writeUInt16BE(e.length,2):i===127&&(o.writeUInt32BE(0,2),o.writeUInt32BE(e.length,6)),r.mask?(ik(fr,0,4),o[1]|=128,o[s-4]=fr[0],o[s-3]=fr[1],o[s-2]=fr[2],o[s-1]=fr[3],n?(v0(e,fr,o,s,e.length),[o]):(v0(e,fr,e,0,e.length),[o,e])):[o,e]}close(e,r,n,s){let i;if(e===void 0)i=ok;else{if(typeof e!="number"||!ak(e))throw new TypeError("First argument must be a valid error code number");if(r===void 0||r==="")i=Buffer.allocUnsafe(2),i.writeUInt16BE(e,0);else{let o=Buffer.byteLength(r);if(o>123)throw new RangeError("The message must not be greater than 123 bytes");i=Buffer.allocUnsafe(2+o),i.writeUInt16BE(e,0),i.write(r,2)}}this._deflating?this.enqueue([this.doClose,i,n,s]):this.doClose(i,n,s)}doClose(e,r,n){this.sendFrame(t.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:r,readOnly:!1}),n)}ping(e,r,n){let s=dt(e);if(s.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,s,r,dt.readOnly,n]):this.doPing(s,r,dt.readOnly,n)}doPing(e,r,n,s){this.sendFrame(t.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:r,readOnly:n}),s)}pong(e,r,n){let s=dt(e);if(s.length>125)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,s,r,dt.readOnly,n]):this.doPong(s,r,dt.readOnly,n)}doPong(e,r,n,s){this.sendFrame(t.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:r,readOnly:n}),s)}send(e,r,n){let s=dt(e),i=this._extensions[_0.extensionName],o=r.binary?2:1,c=r.compress;if(this._firstFragment?(this._firstFragment=!1,c&&i&&(c=s.length>=i._threshold),this._compress=c):(c=!1,o=0),r.fin&&(this._firstFragment=!0),i){let l={fin:r.fin,rsv1:c,opcode:o,mask:r.mask,readOnly:dt.readOnly};this._deflating?this.enqueue([this.dispatch,s,this._compress,l,n]):this.dispatch(s,this._compress,l,n)}else this.sendFrame(t.frame(s,{fin:r.fin,rsv1:!1,opcode:o,mask:r.mask,readOnly:dt.readOnly}),n)}dispatch(e,r,n,s){if(!r){this.sendFrame(t.frame(e,n),s);return}let i=this._extensions[_0.extensionName];this._bufferedBytes+=e.length,this._deflating=!0,i.compress(e,n.fin,(o,c)=>{if(this._socket.destroyed){let l=new Error("The socket was closed while data was being compressed");typeof s=="function"&&s(l);for(let u=0;u<this._queue.length;u++){let a=this._queue[u][4];typeof a=="function"&&a(l)}return}this._bufferedBytes-=e.length,this._deflating=!1,n.readOnly=!1,this.sendFrame(t.frame(c,n),s),this.dequeue()})}dequeue(){for(;!this._deflating&&this._queue.length;){let e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,r){e.length===2?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],r),this._socket.uncork()):this._socket.write(e[0],r)}};b0.exports=sc});var S0=x((yD,x0)=>{"use strict";var Ur=class{constructor(e,r){this.target=r,this.type=e}},oc=class extends Ur{constructor(e,r){super("message",r),this.data=e}},ac=class extends Ur{constructor(e,r,n){super("close",n),this.wasClean=n._closeFrameReceived&&n._closeFrameSent,this.reason=r,this.code=e}},cc=class extends Ur{constructor(e){super("open",e)}},uc=class extends Ur{constructor(e,r){super("error",r),this.message=e.message,this.error=e}},ck={addEventListener(t,e,r){if(typeof e!="function")return;function n(l){e.call(this,new oc(l,this))}function s(l,u){e.call(this,new ac(l,u,this))}function i(l){e.call(this,new uc(l,this))}function o(){e.call(this,new cc(this))}let c=r&&r.once?"once":"on";t==="message"?(n._listener=e,this[c](t,n)):t==="close"?(s._listener=e,this[c](t,s)):t==="error"?(i._listener=e,this[c](t,i)):t==="open"?(o._listener=e,this[c](t,o)):this[c](t,e)},removeEventListener(t,e){let r=this.listeners(t);for(let n=0;n<r.length;n++)(r[n]===e||r[n]._listener===e)&&this.removeListener(t,r[n])}};x0.exports=ck});var lc=x((gD,w0)=>{"use strict";var Dn=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function nt(t,e,r){t[e]===void 0?t[e]=[r]:t[e].push(r)}function uk(t){let e=Object.create(null);if(t===void 0||t==="")return e;let r=Object.create(null),n=!1,s=!1,i=!1,o,c,l=-1,u=-1,a=0;for(;a<t.length;a++){let h=t.charCodeAt(a);if(o===void 0)if(u===-1&&Dn[h]===1)l===-1&&(l=a);else if(h===32||h===9)u===-1&&l!==-1&&(u=a);else if(h===59||h===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${a}`);u===-1&&(u=a);let d=t.slice(l,u);h===44?(nt(e,d,r),r=Object.create(null)):o=d,l=u=-1}else throw new SyntaxError(`Unexpected character at index ${a}`);else if(c===void 0)if(u===-1&&Dn[h]===1)l===-1&&(l=a);else if(h===32||h===9)u===-1&&l!==-1&&(u=a);else if(h===59||h===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${a}`);u===-1&&(u=a),nt(r,t.slice(l,u),!0),h===44&&(nt(e,o,r),r=Object.create(null),o=void 0),l=u=-1}else if(h===61&&l!==-1&&u===-1)c=t.slice(l,a),l=u=-1;else throw new SyntaxError(`Unexpected character at index ${a}`);else if(s){if(Dn[h]!==1)throw new SyntaxError(`Unexpected character at index ${a}`);l===-1?l=a:n||(n=!0),s=!1}else if(i)if(Dn[h]===1)l===-1&&(l=a);else if(h===34&&l!==-1)i=!1,u=a;else if(h===92)s=!0;else throw new SyntaxError(`Unexpected character at index ${a}`);else if(h===34&&t.charCodeAt(a-1)===61)i=!0;else if(u===-1&&Dn[h]===1)l===-1&&(l=a);else if(l!==-1&&(h===32||h===9))u===-1&&(u=a);else if(h===59||h===44){if(l===-1)throw new SyntaxError(`Unexpected character at index ${a}`);u===-1&&(u=a);let d=t.slice(l,u);n&&(d=d.replace(/\\/g,""),n=!1),nt(r,c,d),h===44&&(nt(e,o,r),r=Object.create(null),o=void 0),c=void 0,l=u=-1}else throw new SyntaxError(`Unexpected character at index ${a}`)}if(l===-1||i)throw new SyntaxError("Unexpected end of input");u===-1&&(u=a);let f=t.slice(l,u);return o===void 0?nt(e,f,r):(c===void 0?nt(r,f,!0):n?nt(r,c,f.replace(/\\/g,"")):nt(r,c,f),nt(e,o,r)),e}function lk(t){return Object.keys(t).map(e=>{let r=t[e];return Array.isArray(r)||(r=[r]),r.map(n=>[e].concat(Object.keys(n).map(s=>{let i=n[s];return Array.isArray(i)||(i=[i]),i.map(o=>o===!0?s:`${s}=${o}`).join("; ")})).join("; ")).join(", ")}).join(", ")}w0.exports={format:lk,parse:uk}});var gc=x((_D,M0)=>{"use strict";var fk=require("events"),hk=require("https"),dk=require("http"),k0=require("net"),pk=require("tls"),{randomBytes:yk,createHash:gk}=require("crypto"),{Readable:mD}=require("stream"),{URL:fc}=require("url"),Dt=Tn(),mk=nc(),_k=ic(),{BINARY_TYPES:O0,EMPTY_BUFFER:hc,GUID:vk,kStatusCode:bk,kWebSocket:ye,NOOP:C0}=lr(),{addEventListener:xk,removeEventListener:Sk}=S0(),{format:wk,parse:Ok}=lc(),{toBuffer:Ek}=An(),pt=["CONNECTING","OPEN","CLOSING","CLOSED"],dc=[8,13],kk=30*1e3,ne=class t extends fk{constructor(e,r,n){super(),this._binaryType=O0[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage="",this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=t.CONNECTING,this._receiver=null,this._sender=null,this._socket=null,e!==null?(this._bufferedAmount=0,this._isServer=!1,this._redirects=0,Array.isArray(r)?r=r.join(", "):typeof r=="object"&&r!==null&&(n=r,r=void 0),P0(this,e,r,n)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){O0.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get onclose(){}set onclose(e){}get onerror(){}set onerror(e){}get onopen(){}set onopen(e){}get onmessage(){}set onmessage(e){}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,r,n){let s=new mk(this.binaryType,this._extensions,this._isServer,n);this._sender=new _k(e,this._extensions),this._receiver=s,this._socket=e,s[ye]=this,e[ye]=this,s.on("conclude",Ak),s.on("drain",Ik),s.on("error",Rk),s.on("message",Tk),s.on("ping",Mk),s.on("pong",Dk),e.setTimeout(0),e.setNoDelay(),r.length>0&&e.unshift(r),e.on("close",I0),e.on("data",fi),e.on("end",R0),e.on("error",T0),this._readyState=t.OPEN,this.emit("open")}emitClose(){if(!this._socket){this._readyState=t.CLOSED,this.emit("close",this._closeCode,this._closeMessage);return}this._extensions[Dt.extensionName]&&this._extensions[Dt.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=t.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,r){if(this.readyState!==t.CLOSED){if(this.readyState===t.CONNECTING){let n="WebSocket was closed before the connection was established";return $e(this,this._req,n)}if(this.readyState===t.CLOSING){this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end();return}this._readyState=t.CLOSING,this._sender.close(e,r,!this._isServer,n=>{n||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),kk)}}ping(e,r,n){if(this.readyState===t.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(n=e,e=r=void 0):typeof r=="function"&&(n=r,r=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==t.OPEN){yc(this,e,n);return}r===void 0&&(r=!this._isServer),this._sender.ping(e||hc,r,n)}pong(e,r,n){if(this.readyState===t.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof e=="function"?(n=e,e=r=void 0):typeof r=="function"&&(n=r,r=void 0),typeof e=="number"&&(e=e.toString()),this.readyState!==t.OPEN){yc(this,e,n);return}r===void 0&&(r=!this._isServer),this._sender.pong(e||hc,r,n)}send(e,r,n){if(this.readyState===t.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if(typeof r=="function"&&(n=r,r={}),typeof e=="number"&&(e=e.toString()),this.readyState!==t.OPEN){yc(this,e,n);return}let s={binary:typeof e!="string",mask:!this._isServer,compress:!0,fin:!0,...r};this._extensions[Dt.extensionName]||(s.compress=!1),this._sender.send(e||hc,s,n)}terminate(){if(this.readyState!==t.CLOSED){if(this.readyState===t.CONNECTING){let e="WebSocket was closed before the connection was established";return $e(this,this._req,e)}this._socket&&(this._readyState=t.CLOSING,this._socket.destroy())}}};Object.defineProperty(ne,"CONNECTING",{enumerable:!0,value:pt.indexOf("CONNECTING")});Object.defineProperty(ne.prototype,"CONNECTING",{enumerable:!0,value:pt.indexOf("CONNECTING")});Object.defineProperty(ne,"OPEN",{enumerable:!0,value:pt.indexOf("OPEN")});Object.defineProperty(ne.prototype,"OPEN",{enumerable:!0,value:pt.indexOf("OPEN")});Object.defineProperty(ne,"CLOSING",{enumerable:!0,value:pt.indexOf("CLOSING")});Object.defineProperty(ne.prototype,"CLOSING",{enumerable:!0,value:pt.indexOf("CLOSING")});Object.defineProperty(ne,"CLOSED",{enumerable:!0,value:pt.indexOf("CLOSED")});Object.defineProperty(ne.prototype,"CLOSED",{enumerable:!0,value:pt.indexOf("CLOSED")});["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(t=>{Object.defineProperty(ne.prototype,t,{enumerable:!0})});["open","error","close","message"].forEach(t=>{Object.defineProperty(ne.prototype,`on${t}`,{enumerable:!0,get(){let e=this.listeners(t);for(let r=0;r<e.length;r++)if(e[r]._listener)return e[r]._listener},set(e){let r=this.listeners(t);for(let n=0;n<r.length;n++)r[n]._listener&&this.removeListener(t,r[n]);this.addEventListener(t,e)}})});ne.prototype.addEventListener=xk;ne.prototype.removeEventListener=Sk;M0.exports=ne;function P0(t,e,r,n){let s={protocolVersion:dc[1],maxPayload:104857600,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...n,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!dc.includes(s.protocolVersion))throw new RangeError(`Unsupported protocol version: ${s.protocolVersion} (supported versions: ${dc.join(", ")})`);let i;e instanceof fc?(i=e,t._url=e.href):(i=new fc(e),t._url=e);let o=i.protocol==="ws+unix:";if(!i.host&&(!o||!i.pathname)){let d=new Error(`Invalid URL: ${t.url}`);if(t._redirects===0)throw d;pc(t,d);return}let c=i.protocol==="wss:"||i.protocol==="https:",l=c?443:80,u=yk(16).toString("base64"),a=c?hk.get:dk.get,f;if(s.createConnection=c?Pk:Ck,s.defaultPort=s.defaultPort||l,s.port=i.port||l,s.host=i.hostname.startsWith("[")?i.hostname.slice(1,-1):i.hostname,s.headers={"Sec-WebSocket-Version":s.protocolVersion,"Sec-WebSocket-Key":u,Connection:"Upgrade",Upgrade:"websocket",...s.headers},s.path=i.pathname+i.search,s.timeout=s.handshakeTimeout,s.perMessageDeflate&&(f=new Dt(s.perMessageDeflate!==!0?s.perMessageDeflate:{},!1,s.maxPayload),s.headers["Sec-WebSocket-Extensions"]=wk({[Dt.extensionName]:f.offer()})),r&&(s.headers["Sec-WebSocket-Protocol"]=r),s.origin&&(s.protocolVersion<13?s.headers["Sec-WebSocket-Origin"]=s.origin:s.headers.Origin=s.origin),(i.username||i.password)&&(s.auth=`${i.username}:${i.password}`),o){let d=s.path.split(":");s.socketPath=d[0],s.path=d[1]}if(s.followRedirects){if(t._redirects===0){t._originalUnixSocket=o,t._originalSecure=c,t._originalHostOrSocketPath=o?s.socketPath:i.host;let d=n&&n.headers;if(n={...n,headers:{}},d)for(let[p,y]of Object.entries(d))n.headers[p.toLowerCase()]=y}else{let d=o?t._originalUnixSocket?s.socketPath===t._originalHostOrSocketPath:!1:t._originalUnixSocket?!1:i.host===t._originalHostOrSocketPath;(!d||t._originalSecure&&!c)&&(delete s.headers.authorization,delete s.headers.cookie,d||delete s.headers.host,s.auth=void 0)}s.auth&&!n.headers.authorization&&(n.headers.authorization="Basic "+Buffer.from(s.auth).toString("base64"))}let h=t._req=a(s);s.timeout&&h.on("timeout",()=>{$e(t,h,"Opening handshake has timed out")}),h.on("error",d=>{h===null||h.aborted||(h=t._req=null,pc(t,d))}),h.on("response",d=>{let p=d.headers.location,y=d.statusCode;if(p&&s.followRedirects&&y>=300&&y<400){if(++t._redirects>s.maxRedirects){$e(t,h,"Maximum redirects exceeded");return}h.abort();let m;try{m=new fc(p,e)}catch(S){pc(t,S);return}P0(t,m,r,n)}else t.emit("unexpected-response",h,d)||$e(t,h,`Unexpected server response: ${d.statusCode}`)}),h.on("upgrade",(d,p,y)=>{if(t.emit("upgrade",d),t.readyState!==ne.CONNECTING)return;if(h=t._req=null,d.headers.upgrade.toLowerCase()!=="websocket"){$e(t,p,"Invalid Upgrade header");return}let m=gk("sha1").update(u+vk).digest("base64");if(d.headers["sec-websocket-accept"]!==m){$e(t,p,"Invalid Sec-WebSocket-Accept header");return}let S=d.headers["sec-websocket-protocol"],R=(r||"").split(/, */),w;if(!r&&S?w="Server sent a subprotocol but none was requested":r&&!S?w="Server sent no subprotocol":S&&!R.includes(S)&&(w="Server sent an invalid subprotocol"),w){$e(t,p,w);return}S&&(t._protocol=S);let E=d.headers["sec-websocket-extensions"];if(E!==void 0){if(!f){$e(t,p,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");return}let C;try{C=Ok(E)}catch{$e(t,p,"Invalid Sec-WebSocket-Extensions header");return}let T=Object.keys(C);if(T.length){if(T.length!==1||T[0]!==Dt.extensionName){$e(t,p,"Server indicated an extension that was not requested");return}try{f.accept(C[Dt.extensionName])}catch{$e(t,p,"Invalid Sec-WebSocket-Extensions header");return}t._extensions[Dt.extensionName]=f}}t.setSocket(p,y,s.maxPayload)})}function pc(t,e){t._readyState=ne.CLOSING,t.emit("error",e),t.emitClose()}function Ck(t){return t.path=t.socketPath,k0.connect(t)}function Pk(t){return t.path=void 0,!t.servername&&t.servername!==""&&(t.servername=k0.isIP(t.host)?"":t.host),pk.connect(t)}function $e(t,e,r){t._readyState=ne.CLOSING;let n=new Error(r);Error.captureStackTrace(n,$e),e.setHeader?(e.abort(),e.socket&&!e.socket.destroyed&&e.socket.destroy(),e.once("abort",t.emitClose.bind(t)),t.emit("error",n)):(e.destroy(n),e.once("error",t.emit.bind(t,"error")),e.once("close",t.emitClose.bind(t)))}function yc(t,e,r){if(e){let n=Ek(e).length;t._socket?t._sender._bufferedBytes+=n:t._bufferedAmount+=n}if(r){let n=new Error(`WebSocket is not open: readyState ${t.readyState} (${pt[t.readyState]})`);r(n)}}function Ak(t,e){let r=this[ye];r._closeFrameReceived=!0,r._closeMessage=e,r._closeCode=t,r._socket[ye]!==void 0&&(r._socket.removeListener("data",fi),process.nextTick(A0,r._socket),t===1005?r.close():r.close(t,e))}function Ik(){this[ye]._socket.resume()}function Rk(t){let e=this[ye];e._socket[ye]!==void 0&&(e._socket.removeListener("data",fi),process.nextTick(A0,e._socket),e.close(t[bk])),e.emit("error",t)}function E0(){this[ye].emitClose()}function Tk(t){this[ye].emit("message",t)}function Mk(t){let e=this[ye];e.pong(t,!e._isServer,C0),e.emit("ping",t)}function Dk(t){this[ye].emit("pong",t)}function A0(t){t.resume()}function I0(){let t=this[ye];this.removeListener("close",I0),this.removeListener("data",fi),this.removeListener("end",R0),t._readyState=ne.CLOSING;let e;!this._readableState.endEmitted&&!t._closeFrameReceived&&!t._receiver._writableState.errorEmitted&&(e=t._socket.read())!==null&&t._receiver.write(e),t._receiver.end(),this[ye]=void 0,clearTimeout(t._closeTimer),t._receiver._writableState.finished||t._receiver._writableState.errorEmitted?t.emitClose():(t._receiver.on("error",E0),t._receiver.on("finish",E0))}function fi(t){this[ye]._receiver.write(t)||this.pause()}function R0(){let t=this[ye];t._readyState=ne.CLOSING,t._receiver.end(),this.end()}function T0(){let t=this[ye];this.removeListener("error",T0),this.on("error",C0),t&&(t._readyState=ne.CLOSING,this.destroy())}});var L0=x((vD,N0)=>{"use strict";var{Duplex:$k}=require("stream");function D0(t){t.emit("close")}function Nk(){!this.destroyed&&this._writableState.finished&&this.destroy()}function $0(t){this.removeListener("error",$0),this.destroy(),this.listenerCount("error")===0&&this.emit("error",t)}function Lk(t,e){let r=!0,n=!0;function s(){r&&t._socket.resume()}t.readyState===t.CONNECTING?t.once("open",function(){t._receiver.removeAllListeners("drain"),t._receiver.on("drain",s)}):(t._receiver.removeAllListeners("drain"),t._receiver.on("drain",s));let i=new $k({...e,autoDestroy:!1,emitClose:!1,objectMode:!1,writableObjectMode:!1});return t.on("message",function(c){i.push(c)||(r=!1,t._socket.pause())}),t.once("error",function(c){i.destroyed||(n=!1,i.destroy(c))}),t.once("close",function(){i.destroyed||i.push(null)}),i._destroy=function(o,c){if(t.readyState===t.CLOSED){c(o),process.nextTick(D0,i);return}let l=!1;t.once("error",function(a){l=!0,c(a)}),t.once("close",function(){l||c(o),process.nextTick(D0,i)}),n&&t.terminate()},i._final=function(o){if(t.readyState===t.CONNECTING){t.once("open",function(){i._final(o)});return}t._socket!==null&&(t._socket._writableState.finished?(o(),i._readableState.endEmitted&&i.destroy()):(t._socket.once("finish",function(){o()}),t.close()))},i._read=function(){(t.readyState===t.OPEN||t.readyState===t.CLOSING)&&!r&&(r=!0,t._receiver._writableState.needDrain||t._socket.resume())},i._write=function(o,c,l){if(t.readyState===t.CONNECTING){t.once("open",function(){i._write(o,c,l)});return}t.send(o,l)},i.on("end",Nk),i.on("error",$0),i}N0.exports=Lk});var U0=x((wD,F0)=>{"use strict";var jk=require("events"),hi=require("http"),bD=require("https"),xD=require("net"),SD=require("tls"),{createHash:qk}=require("crypto"),hr=Tn(),Bk=gc(),{format:Fk,parse:Uk}=lc(),{GUID:zk,kWebSocket:Hk}=lr(),Vk=/^[+/0-9A-Za-z]{22}==$/,j0=0,q0=1,B0=2,_c=class extends jk{constructor(e,r){if(super(),e={maxPayload:100*1024*1024,perMessageDeflate:!1,handleProtocols:null,clientTracking:!0,verifyClient:null,noServer:!1,backlog:null,server:null,host:null,path:null,port:null,...e},e.port==null&&!e.server&&!e.noServer||e.port!=null&&(e.server||e.noServer)||e.server&&e.noServer)throw new TypeError('One and only one of the "port", "server", or "noServer" options must be specified');if(e.port!=null?(this._server=hi.createServer((n,s)=>{let i=hi.STATUS_CODES[426];s.writeHead(426,{"Content-Length":i.length,"Content-Type":"text/plain"}),s.end(i)}),this._server.listen(e.port,e.host,e.backlog,r)):e.server&&(this._server=e.server),this._server){let n=this.emit.bind(this,"connection");this._removeListeners=Gk(this._server,{listening:this.emit.bind(this,"listening"),error:this.emit.bind(this,"error"),upgrade:(s,i,o)=>{this.handleUpgrade(s,i,o,n)}})}e.perMessageDeflate===!0&&(e.perMessageDeflate={}),e.clientTracking&&(this.clients=new Set),this.options=e,this._state=j0}address(){if(this.options.noServer)throw new Error('The server is operating in "noServer" mode');return this._server?this._server.address():null}close(e){if(e&&this.once("close",e),this._state===B0){process.nextTick(mc,this);return}if(this._state===q0)return;if(this._state=q0,this.clients)for(let n of this.clients)n.terminate();let r=this._server;if(r&&(this._removeListeners(),this._removeListeners=this._server=null,this.options.port!=null)){r.close(mc.bind(void 0,this));return}process.nextTick(mc,this)}shouldHandle(e){if(this.options.path){let r=e.url.indexOf("?");if((r!==-1?e.url.slice(0,r):e.url)!==this.options.path)return!1}return!0}handleUpgrade(e,r,n,s){r.on("error",vc);let i=e.headers["sec-websocket-key"]!==void 0?e.headers["sec-websocket-key"].trim():!1,o=+e.headers["sec-websocket-version"],c={};if(e.method!=="GET"||e.headers.upgrade.toLowerCase()!=="websocket"||!i||!Vk.test(i)||o!==8&&o!==13||!this.shouldHandle(e))return $n(r,400);if(this.options.perMessageDeflate){let l=new hr(this.options.perMessageDeflate,!0,this.options.maxPayload);try{let u=Uk(e.headers["sec-websocket-extensions"]);u[hr.extensionName]&&(l.accept(u[hr.extensionName]),c[hr.extensionName]=l)}catch{return $n(r,400)}}if(this.options.verifyClient){let l={origin:e.headers[`${o===8?"sec-websocket-origin":"origin"}`],secure:!!(e.socket.authorized||e.socket.encrypted),req:e};if(this.options.verifyClient.length===2){this.options.verifyClient(l,(u,a,f,h)=>{if(!u)return $n(r,a||401,f,h);this.completeUpgrade(i,c,e,r,n,s)});return}if(!this.options.verifyClient(l))return $n(r,401)}this.completeUpgrade(i,c,e,r,n,s)}completeUpgrade(e,r,n,s,i,o){if(!s.readable||!s.writable)return s.destroy();if(s[Hk])throw new Error("server.handleUpgrade() was called more than once with the same socket, possibly due to a misconfiguration");if(this._state>j0)return $n(s,503);let l=["HTTP/1.1 101 Switching Protocols","Upgrade: websocket","Connection: Upgrade",`Sec-WebSocket-Accept: ${qk("sha1").update(e+zk).digest("base64")}`],u=new Bk(null),a=n.headers["sec-websocket-protocol"];if(a&&(a=a.split(",").map(Wk),this.options.handleProtocols?a=this.options.handleProtocols(a,n):a=a[0],a&&(l.push(`Sec-WebSocket-Protocol: ${a}`),u._protocol=a)),r[hr.extensionName]){let f=r[hr.extensionName].params,h=Fk({[hr.extensionName]:[f]});l.push(`Sec-WebSocket-Extensions: ${h}`),u._extensions=r}this.emit("headers",l,n),s.write(l.concat(`\r
`).join(`\r
`)),s.removeListener("error",vc),u.setSocket(s,i,this.options.maxPayload),this.clients&&(this.clients.add(u),u.on("close",()=>this.clients.delete(u))),o(u,n)}};F0.exports=_c;function Gk(t,e){for(let r of Object.keys(e))t.on(r,e[r]);return function(){for(let n of Object.keys(e))t.removeListener(n,e[n])}}function mc(t){t._state=B0,t.emit("close")}function vc(){this.destroy()}function $n(t,e,r,n){t.writable&&(r=r||hi.STATUS_CODES[e],n={Connection:"close","Content-Type":"text/html","Content-Length":Buffer.byteLength(r),...n},t.write(`HTTP/1.1 ${e} ${hi.STATUS_CODES[e]}\r
`+Object.keys(n).map(s=>`${s}: ${n[s]}`).join(`\r
`)+`\r
\r
`+r)),t.removeListener("error",vc),t.destroy()}function Wk(t){return t.trim()}});var bc=x((OD,z0)=>{"use strict";var Nn=gc();Nn.createWebSocketStream=L0();Nn.Server=U0();Nn.Receiver=nc();Nn.Sender=ic();z0.exports=Nn});var Sc=x((ED,G0)=>{var Jk=Object.create,di=Object.defineProperty,Qk=Object.getOwnPropertyDescriptor,Yk=Object.getOwnPropertyNames,Kk=Object.getPrototypeOf,Xk=Object.prototype.hasOwnProperty,Zk=(t,e)=>{for(var r in e)di(t,r,{get:e[r],enumerable:!0})},H0=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Yk(e))!Xk.call(t,s)&&s!==r&&di(t,s,{get:()=>e[s],enumerable:!(n=Qk(e,s))||n.enumerable});return t},eC=(t,e,r)=>(r=t!=null?Jk(Kk(t)):{},H0(e||!t||!t.__esModule?di(r,"default",{value:t,enumerable:!0}):r,t)),tC=t=>H0(di({},"__esModule",{value:!0}),t),V0={};Zk(V0,{WebSocketClient:()=>xc});G0.exports=tC(V0);var rC=eC(bc()),Ce=rt(),nC=nr(),sC={binary:!0},xc=class{constructor(e,r){this.id=e,this.ref=r,this.sessionId=e}sessionId;state=Ce.ClientState.JOINING;_enqueuedMessages=[];_afterNextPatchQueue;_reconnectionToken;sendBytes(e,r,n){(0,Ce.debugMessage)("send bytes(to %s): '%s' -> %j",this.sessionId,e,r),this.enqueueRaw(Ce.getMessageBytes.raw(Ce.Protocol.ROOM_DATA_BYTES,e,void 0,r),n)}send(e,r,n){(0,Ce.debugMessage)("send(to %s): '%s' -> %j",this.sessionId,e,r),this.enqueueRaw(e instanceof nC.Schema?Ce.getMessageBytes[Ce.Protocol.ROOM_DATA_SCHEMA](e):Ce.getMessageBytes.raw(Ce.Protocol.ROOM_DATA,e,r),n)}enqueueRaw(e,r){if(r?.afterNextPatch){this._afterNextPatchQueue.push([this,arguments]);return}if(this.state===Ce.ClientState.JOINING){this._enqueuedMessages.push(e);return}this.raw(e,r)}raw(e,r,n){this.ref.readyState===rC.default.OPEN&&this.ref.send(e,sC,n)}error(e,r="",n){this.raw(Ce.getMessageBytes[Ce.Protocol.ERROR](e,r),void 0,n)}get readyState(){return this.ref.readyState}leave(e,r){this.ref.close(e,r)}close(e,r){Ce.logger.warn("DEPRECATION WARNING: use client.leave() instead of client.close()");try{throw new Error}catch(n){Ce.logger.info(n.stack)}this.leave(e,r)}toJSON(){return{sessionId:this.sessionId,readyState:this.readyState}}}});var K0=x((kD,Y0)=>{var iC=Object.create,pi=Object.defineProperty,oC=Object.getOwnPropertyDescriptor,aC=Object.getOwnPropertyNames,cC=Object.getPrototypeOf,uC=Object.prototype.hasOwnProperty,lC=(t,e)=>{for(var r in e)pi(t,r,{get:e[r],enumerable:!0})},W0=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of aC(e))!uC.call(t,s)&&s!==r&&pi(t,s,{get:()=>e[s],enumerable:!(n=oC(e,s))||n.enumerable});return t},J0=(t,e,r)=>(r=t!=null?iC(cC(t)):{},W0(e||!t||!t.__esModule?pi(r,"default",{value:t,enumerable:!0}):r,t)),fC=t=>W0(pi({},"__esModule",{value:!0}),t),Q0={};lC(Q0,{WebSocketTransport:()=>Oc});Y0.exports=fC(Q0);var hC=J0(require("http")),dC=require("url"),wc=J0(bc()),dr=rt(),pC=Sc();function yC(){}function gC(){this.pingCount=0}var Oc=class extends dr.Transport{wss;pingInterval;pingIntervalMS;pingMaxRetries;constructor(e={}){super(),e.perMessageDeflate===void 0&&(e.perMessageDeflate=!1),this.pingIntervalMS=e.pingInterval!==void 0?e.pingInterval:3e3,this.pingMaxRetries=e.pingMaxRetries!==void 0?e.pingMaxRetries:2,!e.server&&!e.noServer&&(e.server=hC.default.createServer()),this.wss=new wc.default.Server(e),this.wss.on("connection",this.onConnection),this.wss.on("error",r=>(0,dr.debugAndPrintError)(r)),this.server=e.server,this.pingIntervalMS>0&&this.pingMaxRetries>0&&(this.server.on("listening",()=>this.autoTerminateUnresponsiveClients(this.pingIntervalMS,this.pingMaxRetries)),this.server.on("close",()=>clearInterval(this.pingInterval)))}listen(e,r,n,s){return this.server.listen(e,r,n,s),this}shutdown(){this.wss.close(),this.server.close()}simulateLatency(e){let r=wc.default.prototype.send;wc.default.prototype.send=function(...n){setTimeout(()=>r.apply(this,n),e)}}autoTerminateUnresponsiveClients(e,r){this.pingInterval=setInterval(()=>{this.wss.clients.forEach(n=>{if(n.pingCount>=r)return(0,dr.debugConnection)("terminating unresponsive client"),n.terminate();n.pingCount++,n.ping(yC)})},e)}async onConnection(e,r){e.on("error",a=>(0,dr.debugAndPrintError)(a.message+`
`+a.stack)),e.on("pong",gC);let n=r||e.upgradeReq,s=new dC.URL(`ws://server/${n.url}`),i=s.searchParams.get("sessionId"),o=s.pathname.match(/\/[a-zA-Z0-9_\-]+\/([a-zA-Z0-9_\-]+)$/),c=o&&o[1],l=dr.matchMaker.getRoomById(c);e.pingCount=0;let u=new pC.WebSocketClient(i,e);try{if(!l||!l.hasReservedSeat(i,s.searchParams.get("reconnectionToken")))throw new Error("seat reservation expired.");await l._onJoin(u,n)}catch(a){(0,dr.debugAndPrintError)(a),u.error(a.code,a.message,()=>e.close(dr.Protocol.WS_CLOSE_WITH_ERROR))}}}});var ty=x((CD,ey)=>{var Ec=Object.defineProperty,mC=Object.getOwnPropertyDescriptor,_C=Object.getOwnPropertyNames,vC=Object.prototype.hasOwnProperty,bC=(t,e)=>{for(var r in e)Ec(t,r,{get:e[r],enumerable:!0})},xC=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of _C(e))!vC.call(t,s)&&s!==r&&Ec(t,s,{get:()=>e[s],enumerable:!(n=mC(e,s))||n.enumerable});return t},SC=t=>xC(Ec({},"__esModule",{value:!0}),t),Z0={};bC(Z0,{TransportOptions:()=>X0.TransportOptions,WebSocketClient:()=>wC.WebSocketClient,WebSocketTransport:()=>X0.WebSocketTransport});ey.exports=SC(Z0);var wC=Sc(),X0=K0()});var uy=x((PD,cy)=>{var ny=9007199254740991,OC="[object Arguments]",EC="[object Function]",kC="[object GeneratorFunction]",CC=/^(?:0|[1-9]\d*)$/;function sy(t,e,r){switch(r.length){case 0:return t.call(e);case 1:return t.call(e,r[0]);case 2:return t.call(e,r[0],r[1]);case 3:return t.call(e,r[0],r[1],r[2])}return t.apply(e,r)}function PC(t,e){for(var r=-1,n=Array(t);++r<t;)n[r]=e(r);return n}var Ln=Object.prototype,jn=Ln.hasOwnProperty,iy=Ln.toString,AC=Ln.propertyIsEnumerable,ry=Math.max;function IC(t,e){var r=BC(t)||qC(t)?PC(t.length,String):[],n=r.length,s=!!n;for(var i in t)(e||jn.call(t,i))&&!(s&&(i=="length"||ay(i,n)))&&r.push(i);return r}function RC(t,e,r,n){return t===void 0||kc(t,Ln[r])&&!jn.call(n,r)?e:t}function TC(t,e,r){var n=t[e];(!(jn.call(t,e)&&kc(n,r))||r===void 0&&!(e in t))&&(t[e]=r)}function MC(t){if(!Pc(t))return jC(t);var e=LC(t),r=[];for(var n in t)n=="constructor"&&(e||!jn.call(t,n))||r.push(n);return r}function oy(t,e){return e=ry(e===void 0?t.length-1:e,0),function(){for(var r=arguments,n=-1,s=ry(r.length-e,0),i=Array(s);++n<s;)i[n]=r[e+n];n=-1;for(var o=Array(e+1);++n<e;)o[n]=r[n];return o[e]=i,sy(t,this,o)}}function DC(t,e,r,n){r||(r={});for(var s=-1,i=e.length;++s<i;){var o=e[s],c=n?n(r[o],t[o],o,r,t):void 0;TC(r,o,c===void 0?t[o]:c)}return r}function $C(t){return oy(function(e,r){var n=-1,s=r.length,i=s>1?r[s-1]:void 0,o=s>2?r[2]:void 0;for(i=t.length>3&&typeof i=="function"?(s--,i):void 0,o&&NC(r[0],r[1],o)&&(i=s<3?void 0:i,s=1),e=Object(e);++n<s;){var c=r[n];c&&t(e,c,n,i)}return e})}function ay(t,e){return e=e??ny,!!e&&(typeof t=="number"||CC.test(t))&&t>-1&&t%1==0&&t<e}function NC(t,e,r){if(!Pc(r))return!1;var n=typeof e;return(n=="number"?Cc(r)&&ay(e,r.length):n=="string"&&e in r)?kc(r[e],t):!1}function LC(t){var e=t&&t.constructor,r=typeof e=="function"&&e.prototype||Ln;return t===r}function jC(t){var e=[];if(t!=null)for(var r in Object(t))e.push(r);return e}function kc(t,e){return t===e||t!==t&&e!==e}function qC(t){return FC(t)&&jn.call(t,"callee")&&(!AC.call(t,"callee")||iy.call(t)==OC)}var BC=Array.isArray;function Cc(t){return t!=null&&zC(t.length)&&!UC(t)}function FC(t){return HC(t)&&Cc(t)}function UC(t){var e=Pc(t)?iy.call(t):"";return e==EC||e==kC}function zC(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=ny}function Pc(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function HC(t){return!!t&&typeof t=="object"}var VC=$C(function(t,e,r,n){DC(e,WC(e),t,n)}),GC=oy(function(t){return t.push(void 0,RC),sy(VC,void 0,t)});function WC(t){return Cc(t)?IC(t,!0):MC(t)}cy.exports=GC});var yy=x((AD,py)=>{var JC=9007199254740991,QC="[object Arguments]",YC="[object Function]",KC="[object GeneratorFunction]",XC=typeof global=="object"&&global&&global.Object===Object&&global,ZC=typeof self=="object"&&self&&self.Object===Object&&self,eP=XC||ZC||Function("return this")();function tP(t,e){for(var r=-1,n=e.length,s=t.length;++r<n;)t[s+r]=e[r];return t}var Ac=Object.prototype,rP=Ac.hasOwnProperty,hy=Ac.toString,ly=eP.Symbol,nP=Ac.propertyIsEnumerable,fy=ly?ly.isConcatSpreadable:void 0;function dy(t,e,r,n,s){var i=-1,o=t.length;for(r||(r=sP),s||(s=[]);++i<o;){var c=t[i];e>0&&r(c)?e>1?dy(c,e-1,r,n,s):tP(s,c):n||(s[s.length]=c)}return s}function sP(t){return aP(t)||oP(t)||!!(fy&&t&&t[fy])}function iP(t){var e=t?t.length:0;return e?dy(t,1):[]}function oP(t){return uP(t)&&rP.call(t,"callee")&&(!nP.call(t,"callee")||hy.call(t)==QC)}var aP=Array.isArray;function cP(t){return t!=null&&fP(t.length)&&!lP(t)}function uP(t){return dP(t)&&cP(t)}function lP(t){var e=hP(t)?hy.call(t):"";return e==YC||e==KC}function fP(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=JC}function hP(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function dP(t){return!!t&&typeof t=="object"}py.exports=iP});var _y=x((ID,my)=>{var pP=9007199254740991,yP="[object Arguments]",gP="[object Function]",mP="[object GeneratorFunction]",Ic=Object.prototype,_P=Ic.hasOwnProperty,gy=Ic.toString,vP=Ic.propertyIsEnumerable;function bP(t){return SP(t)&&_P.call(t,"callee")&&(!vP.call(t,"callee")||gy.call(t)==yP)}function xP(t){return t!=null&&OP(t.length)&&!wP(t)}function SP(t){return kP(t)&&xP(t)}function wP(t){var e=EP(t)?gy.call(t):"";return e==gP||e==mP}function OP(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=pP}function EP(t){var e=typeof t;return!!t&&(e=="object"||e=="function")}function kP(t){return!!t&&typeof t=="object"}my.exports=bP});var Hr=x(zr=>{"use strict";Object.defineProperty(zr,"__esModule",{value:!0});var CP=uy();zr.defaults=CP;var PP=yy();zr.flatten=PP;var AP=_y();zr.isArguments=AP;function IP(){}zr.noop=IP});var yi=x((TD,vy)=>{"use strict";function X(t,r){var r=r||{};this._head=0,this._tail=0,this._capacity=r.capacity,this._capacityMask=3,this._list=new Array(4),Array.isArray(t)&&this._fromArray(t)}X.prototype.peekAt=function(e){var r=e;if(r===(r|0)){var n=this.size();if(!(r>=n||r<-n))return r<0&&(r+=n),r=this._head+r&this._capacityMask,this._list[r]}};X.prototype.get=function(e){return this.peekAt(e)};X.prototype.peek=function(){if(this._head!==this._tail)return this._list[this._head]};X.prototype.peekFront=function(){return this.peek()};X.prototype.peekBack=function(){return this.peekAt(-1)};Object.defineProperty(X.prototype,"length",{get:function(){return this.size()}});X.prototype.size=function(){return this._head===this._tail?0:this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};X.prototype.unshift=function(e){if(e===void 0)return this.size();var r=this._list.length;return this._head=this._head-1+r&this._capacityMask,this._list[this._head]=e,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.pop(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};X.prototype.shift=function(){var e=this._head;if(e!==this._tail){var r=this._list[e];return this._list[e]=void 0,this._head=e+1&this._capacityMask,e<2&&this._tail>1e4&&this._tail<=this._list.length>>>2&&this._shrinkArray(),r}};X.prototype.push=function(e){if(e===void 0)return this.size();var r=this._tail;return this._list[r]=e,this._tail=r+1&this._capacityMask,this._tail===this._head&&this._growArray(),this._capacity&&this.size()>this._capacity&&this.shift(),this._head<this._tail?this._tail-this._head:this._capacityMask+1-(this._head-this._tail)};X.prototype.pop=function(){var e=this._tail;if(e!==this._head){var r=this._list.length;this._tail=e-1+r&this._capacityMask;var n=this._list[this._tail];return this._list[this._tail]=void 0,this._head<2&&e>1e4&&e<=r>>>2&&this._shrinkArray(),n}};X.prototype.removeOne=function(e){var r=e;if(r===(r|0)&&this._head!==this._tail){var n=this.size(),s=this._list.length;if(!(r>=n||r<-n)){r<0&&(r+=n),r=this._head+r&this._capacityMask;var i=this._list[r],o;if(e<n/2){for(o=e;o>0;o--)this._list[r]=this._list[r=r-1+s&this._capacityMask];this._list[r]=void 0,this._head=this._head+1+s&this._capacityMask}else{for(o=n-1-e;o>0;o--)this._list[r]=this._list[r=r+1+s&this._capacityMask];this._list[r]=void 0,this._tail=this._tail-1+s&this._capacityMask}return i}}};X.prototype.remove=function(e,r){var n=e,s,i=r;if(n===(n|0)&&this._head!==this._tail){var o=this.size(),c=this._list.length;if(!(n>=o||n<-o||r<1)){if(n<0&&(n+=o),r===1||!r)return s=new Array(1),s[0]=this.removeOne(n),s;if(n===0&&n+r>=o)return s=this.toArray(),this.clear(),s;n+r>o&&(r=o-n);var l;for(s=new Array(r),l=0;l<r;l++)s[l]=this._list[this._head+n+l&this._capacityMask];if(n=this._head+n&this._capacityMask,e+r===o){for(this._tail=this._tail-r+c&this._capacityMask,l=r;l>0;l--)this._list[n=n+1+c&this._capacityMask]=void 0;return s}if(e===0){for(this._head=this._head+r+c&this._capacityMask,l=r-1;l>0;l--)this._list[n=n+1+c&this._capacityMask]=void 0;return s}if(n<o/2){for(this._head=this._head+e+r+c&this._capacityMask,l=e;l>0;l--)this.unshift(this._list[n=n-1+c&this._capacityMask]);for(n=this._head-1+c&this._capacityMask;i>0;)this._list[n=n-1+c&this._capacityMask]=void 0,i--;e<0&&(this._tail=n)}else{for(this._tail=n,n=n+r+c&this._capacityMask,l=o-(r+e);l>0;l--)this.push(this._list[n++]);for(n=this._tail;i>0;)this._list[n=n+1+c&this._capacityMask]=void 0,i--}return this._head<2&&this._tail>1e4&&this._tail<=c>>>2&&this._shrinkArray(),s}}};X.prototype.splice=function(e,r){var n=e;if(n===(n|0)){var s=this.size();if(n<0&&(n+=s),!(n>s))if(arguments.length>2){var i,o,c,l=arguments.length,u=this._list.length,a=2;if(!s||n<s/2){for(o=new Array(n),i=0;i<n;i++)o[i]=this._list[this._head+i&this._capacityMask];for(r===0?(c=[],n>0&&(this._head=this._head+n+u&this._capacityMask)):(c=this.remove(n,r),this._head=this._head+n+u&this._capacityMask);l>a;)this.unshift(arguments[--l]);for(i=n;i>0;i--)this.unshift(o[i-1])}else{o=new Array(s-(n+r));var f=o.length;for(i=0;i<f;i++)o[i]=this._list[this._head+n+r+i&this._capacityMask];for(r===0?(c=[],n!=s&&(this._tail=this._head+n+u&this._capacityMask)):(c=this.remove(n,r),this._tail=this._tail-f+u&this._capacityMask);a<l;)this.push(arguments[a++]);for(i=0;i<f;i++)this.push(o[i])}return c}else return this.remove(n,r)}};X.prototype.clear=function(){this._head=0,this._tail=0};X.prototype.isEmpty=function(){return this._head===this._tail};X.prototype.toArray=function(){return this._copyArray(!1)};X.prototype._fromArray=function(e){for(var r=0;r<e.length;r++)this.push(e[r])};X.prototype._copyArray=function(e){var r=[],n=this._list,s=n.length,i;if(e||this._head>this._tail){for(i=this._head;i<s;i++)r.push(n[i]);for(i=0;i<this._tail;i++)r.push(n[i])}else for(i=this._head;i<this._tail;i++)r.push(n[i]);return r};X.prototype._growArray=function(){this._head&&(this._list=this._copyArray(!0),this._head=0),this._tail=this._list.length,this._list.length<<=1,this._capacityMask=this._capacityMask<<1|1};X.prototype._shrinkArray=function(){this._list.length>>>=1,this._capacityMask>>>=1};vy.exports=X});var by=x((MD,RP)=>{RP.exports={acl:{arity:-2,flags:["admin","noscript","loading","stale","skip_slowlog"],keyStart:0,keyStop:0,step:0},append:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},asking:{arity:1,flags:["fast"],keyStart:0,keyStop:0,step:0},auth:{arity:-2,flags:["noscript","loading","stale","skip_monitor","skip_slowlog","fast","no_auth"],keyStart:0,keyStop:0,step:0},bgrewriteaof:{arity:1,flags:["admin","noscript"],keyStart:0,keyStop:0,step:0},bgsave:{arity:-1,flags:["admin","noscript"],keyStart:0,keyStop:0,step:0},bitcount:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},bitfield:{arity:-2,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},bitfield_ro:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},bitop:{arity:-4,flags:["write","denyoom"],keyStart:2,keyStop:-1,step:1},bitpos:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},blmove:{arity:6,flags:["write","denyoom","noscript"],keyStart:1,keyStop:2,step:1},blpop:{arity:-3,flags:["write","noscript"],keyStart:1,keyStop:-2,step:1},brpop:{arity:-3,flags:["write","noscript"],keyStart:1,keyStop:-2,step:1},brpoplpush:{arity:4,flags:["write","denyoom","noscript"],keyStart:1,keyStop:2,step:1},bzpopmax:{arity:-3,flags:["write","noscript","fast"],keyStart:1,keyStop:-2,step:1},bzpopmin:{arity:-3,flags:["write","noscript","fast"],keyStart:1,keyStop:-2,step:1},client:{arity:-2,flags:["admin","noscript","random","loading","stale"],keyStart:0,keyStop:0,step:0},cluster:{arity:-2,flags:["admin","random","stale"],keyStart:0,keyStop:0,step:0},command:{arity:-1,flags:["random","loading","stale"],keyStart:0,keyStop:0,step:0},config:{arity:-2,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},copy:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},dbsize:{arity:1,flags:["readonly","fast"],keyStart:0,keyStop:0,step:0},debug:{arity:-2,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},decr:{arity:2,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},decrby:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},del:{arity:-2,flags:["write"],keyStart:1,keyStop:-1,step:1},discard:{arity:1,flags:["noscript","loading","stale","fast"],keyStart:0,keyStop:0,step:0},dump:{arity:2,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},echo:{arity:2,flags:["fast"],keyStart:0,keyStop:0,step:0},eval:{arity:-3,flags:["noscript","may_replicate","movablekeys"],keyStart:0,keyStop:0,step:0},evalsha:{arity:-3,flags:["noscript","may_replicate","movablekeys"],keyStart:0,keyStop:0,step:0},exec:{arity:1,flags:["noscript","loading","stale","skip_monitor","skip_slowlog"],keyStart:0,keyStop:0,step:0},exists:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:-1,step:1},expire:{arity:3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},expireat:{arity:3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},failover:{arity:-1,flags:["admin","noscript","stale"],keyStart:0,keyStop:0,step:0},flushall:{arity:-1,flags:["write"],keyStart:0,keyStop:0,step:0},flushdb:{arity:-1,flags:["write"],keyStart:0,keyStop:0,step:0},geoadd:{arity:-5,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},geodist:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},geohash:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},geopos:{arity:-2,flags:["readonly"],keyStart:1,keyStop:1,step:1},georadius:{arity:-6,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},georadius_ro:{arity:-6,flags:["readonly"],keyStart:1,keyStop:1,step:1},georadiusbymember:{arity:-5,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},georadiusbymember_ro:{arity:-5,flags:["readonly"],keyStart:1,keyStop:1,step:1},geosearch:{arity:-7,flags:["readonly"],keyStart:1,keyStop:1,step:1},geosearchstore:{arity:-8,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},get:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},getbit:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},getdel:{arity:2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},getex:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},getrange:{arity:4,flags:["readonly"],keyStart:1,keyStop:1,step:1},getset:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hdel:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},hello:{arity:-1,flags:["noscript","loading","stale","skip_monitor","skip_slowlog","fast","no_auth"],keyStart:0,keyStop:0,step:0},hexists:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hget:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hgetall:{arity:2,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},hincrby:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hincrbyfloat:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hkeys:{arity:2,flags:["readonly","sort_for_script"],keyStart:1,keyStop:1,step:1},hlen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hmget:{arity:-3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hmset:{arity:-4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},"host:":{arity:-1,flags:["readonly","loading","stale"],keyStart:0,keyStop:0,step:0},hrandfield:{arity:-2,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},hscan:{arity:-3,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},hset:{arity:-4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hsetnx:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},hstrlen:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},hvals:{arity:2,flags:["readonly","sort_for_script"],keyStart:1,keyStop:1,step:1},incr:{arity:2,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},incrby:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},incrbyfloat:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},info:{arity:-1,flags:["random","loading","stale"],keyStart:0,keyStop:0,step:0},keys:{arity:2,flags:["readonly","sort_for_script"],keyStart:0,keyStop:0,step:0},lastsave:{arity:1,flags:["random","loading","stale","fast"],keyStart:0,keyStop:0,step:0},latency:{arity:-2,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},lindex:{arity:3,flags:["readonly"],keyStart:1,keyStop:1,step:1},linsert:{arity:5,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},llen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},lmove:{arity:5,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},lolwut:{arity:-1,flags:["readonly","fast"],keyStart:0,keyStop:0,step:0},lpop:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},lpos:{arity:-3,flags:["readonly"],keyStart:1,keyStop:1,step:1},lpush:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},lpushx:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},lrange:{arity:4,flags:["readonly"],keyStart:1,keyStop:1,step:1},lrem:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},lset:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},ltrim:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},memory:{arity:-2,flags:["readonly","random","movablekeys"],keyStart:0,keyStop:0,step:0},mget:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:-1,step:1},migrate:{arity:-6,flags:["write","random","movablekeys"],keyStart:0,keyStop:0,step:0},module:{arity:-2,flags:["admin","noscript"],keyStart:0,keyStop:0,step:0},monitor:{arity:1,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},move:{arity:3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},mset:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:2},msetnx:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:2},multi:{arity:1,flags:["noscript","loading","stale","fast"],keyStart:0,keyStop:0,step:0},object:{arity:-2,flags:["readonly","random"],keyStart:2,keyStop:2,step:1},persist:{arity:2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},pexpire:{arity:3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},pexpireat:{arity:3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},pfadd:{arity:-2,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},pfcount:{arity:-2,flags:["readonly","may_replicate"],keyStart:1,keyStop:-1,step:1},pfdebug:{arity:-3,flags:["write","denyoom","admin"],keyStart:2,keyStop:2,step:1},pfmerge:{arity:-2,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},pfselftest:{arity:1,flags:["admin"],keyStart:0,keyStop:0,step:0},ping:{arity:-1,flags:["stale","fast"],keyStart:0,keyStop:0,step:0},post:{arity:-1,flags:["readonly","loading","stale"],keyStart:0,keyStop:0,step:0},psetex:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},psubscribe:{arity:-2,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},psync:{arity:-3,flags:["admin","noscript"],keyStart:0,keyStop:0,step:0},pttl:{arity:2,flags:["readonly","random","fast"],keyStart:1,keyStop:1,step:1},publish:{arity:3,flags:["pubsub","loading","stale","fast","may_replicate"],keyStart:0,keyStop:0,step:0},pubsub:{arity:-2,flags:["pubsub","random","loading","stale"],keyStart:0,keyStop:0,step:0},punsubscribe:{arity:-1,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},quit:{arity:1,flags:["loading","stale","readonly"],keyStart:0,keyStop:0,step:0},randomkey:{arity:1,flags:["readonly","random"],keyStart:0,keyStop:0,step:0},readonly:{arity:1,flags:["fast"],keyStart:0,keyStop:0,step:0},readwrite:{arity:1,flags:["fast"],keyStart:0,keyStop:0,step:0},rename:{arity:3,flags:["write"],keyStart:1,keyStop:2,step:1},renamenx:{arity:3,flags:["write","fast"],keyStart:1,keyStop:2,step:1},replconf:{arity:-1,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},replicaof:{arity:3,flags:["admin","noscript","stale"],keyStart:0,keyStop:0,step:0},reset:{arity:1,flags:["noscript","loading","stale","fast"],keyStart:0,keyStop:0,step:0},restore:{arity:-4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},"restore-asking":{arity:-4,flags:["write","denyoom","asking"],keyStart:1,keyStop:1,step:1},role:{arity:1,flags:["noscript","loading","stale","fast"],keyStart:0,keyStop:0,step:0},rpop:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},rpoplpush:{arity:3,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},rpush:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},rpushx:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},sadd:{arity:-3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},save:{arity:1,flags:["admin","noscript"],keyStart:0,keyStop:0,step:0},scan:{arity:-2,flags:["readonly","random"],keyStart:0,keyStop:0,step:0},scard:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},script:{arity:-2,flags:["noscript","may_replicate"],keyStart:0,keyStop:0,step:0},sdiff:{arity:-2,flags:["readonly","sort_for_script"],keyStart:1,keyStop:-1,step:1},sdiffstore:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},select:{arity:2,flags:["loading","stale","fast"],keyStart:0,keyStop:0,step:0},set:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},setbit:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},setex:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},setnx:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},setrange:{arity:4,flags:["write","denyoom"],keyStart:1,keyStop:1,step:1},shutdown:{arity:-1,flags:["admin","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},sinter:{arity:-2,flags:["readonly","sort_for_script"],keyStart:1,keyStop:-1,step:1},sinterstore:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},sismember:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},slaveof:{arity:3,flags:["admin","noscript","stale"],keyStart:0,keyStop:0,step:0},slowlog:{arity:-2,flags:["admin","random","loading","stale"],keyStart:0,keyStop:0,step:0},smembers:{arity:2,flags:["readonly","sort_for_script"],keyStart:1,keyStop:1,step:1},smismember:{arity:-3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},smove:{arity:4,flags:["write","fast"],keyStart:1,keyStop:2,step:1},sort:{arity:-2,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},spop:{arity:-2,flags:["write","random","fast"],keyStart:1,keyStop:1,step:1},srandmember:{arity:-2,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},srem:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},sscan:{arity:-3,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},stralgo:{arity:-2,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},strlen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},subscribe:{arity:-2,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},substr:{arity:4,flags:["readonly"],keyStart:1,keyStop:1,step:1},sunion:{arity:-2,flags:["readonly","sort_for_script"],keyStart:1,keyStop:-1,step:1},sunionstore:{arity:-3,flags:["write","denyoom"],keyStart:1,keyStop:-1,step:1},swapdb:{arity:3,flags:["write","fast"],keyStart:0,keyStop:0,step:0},sync:{arity:1,flags:["admin","noscript"],keyStart:0,keyStop:0,step:0},time:{arity:1,flags:["random","loading","stale","fast"],keyStart:0,keyStop:0,step:0},touch:{arity:-2,flags:["readonly","fast"],keyStart:1,keyStop:-1,step:1},ttl:{arity:2,flags:["readonly","random","fast"],keyStart:1,keyStop:1,step:1},type:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},unlink:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:-1,step:1},unsubscribe:{arity:-1,flags:["pubsub","noscript","loading","stale"],keyStart:0,keyStop:0,step:0},unwatch:{arity:1,flags:["noscript","loading","stale","fast"],keyStart:0,keyStop:0,step:0},wait:{arity:3,flags:["noscript"],keyStart:0,keyStop:0,step:0},watch:{arity:-2,flags:["noscript","loading","stale","fast"],keyStart:1,keyStop:-1,step:1},xack:{arity:-4,flags:["write","random","fast"],keyStart:1,keyStop:1,step:1},xadd:{arity:-5,flags:["write","denyoom","random","fast"],keyStart:1,keyStop:1,step:1},xautoclaim:{arity:-6,flags:["write","random","fast"],keyStart:1,keyStop:1,step:1},xclaim:{arity:-6,flags:["write","random","fast"],keyStart:1,keyStop:1,step:1},xdel:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},xgroup:{arity:-2,flags:["write","denyoom"],keyStart:2,keyStop:2,step:1},xinfo:{arity:-2,flags:["readonly","random"],keyStart:2,keyStop:2,step:1},xlen:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},xpending:{arity:-3,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},xrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},xread:{arity:-4,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},xreadgroup:{arity:-7,flags:["write","movablekeys"],keyStart:0,keyStop:0,step:0},xrevrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},xsetid:{arity:3,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},xtrim:{arity:-2,flags:["write","random"],keyStart:1,keyStop:1,step:1},zadd:{arity:-4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},zcard:{arity:2,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zcount:{arity:4,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zdiff:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zdiffstore:{arity:-4,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},zincrby:{arity:4,flags:["write","denyoom","fast"],keyStart:1,keyStop:1,step:1},zinter:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zinterstore:{arity:-4,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1},zlexcount:{arity:4,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zmscore:{arity:-3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zpopmax:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},zpopmin:{arity:-2,flags:["write","fast"],keyStart:1,keyStop:1,step:1},zrandmember:{arity:-2,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},zrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrangebylex:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrangebyscore:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrangestore:{arity:-5,flags:["write","denyoom"],keyStart:1,keyStop:2,step:1},zrank:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zrem:{arity:-3,flags:["write","fast"],keyStart:1,keyStop:1,step:1},zremrangebylex:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},zremrangebyrank:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},zremrangebyscore:{arity:4,flags:["write"],keyStart:1,keyStop:1,step:1},zrevrange:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrevrangebylex:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrevrangebyscore:{arity:-4,flags:["readonly"],keyStart:1,keyStop:1,step:1},zrevrank:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zscan:{arity:-3,flags:["readonly","random"],keyStart:1,keyStop:1,step:1},zscore:{arity:3,flags:["readonly","fast"],keyStart:1,keyStop:1,step:1},zunion:{arity:-3,flags:["readonly","movablekeys"],keyStart:0,keyStop:0,step:0},zunionstore:{arity:-4,flags:["write","denyoom","movablekeys"],keyStart:1,keyStop:1,step:1}}});var Gr=x(Vr=>{"use strict";var gi=by();Vr.list=Object.keys(gi);var Rc={};Vr.list.forEach(function(t){Rc[t]=gi[t].flags.reduce(function(e,r){return e[r]=!0,e},{})});Vr.exists=function(t){return!!gi[t]};Vr.hasFlag=function(t,e){if(!Rc[t])throw new Error("Unknown command "+t);return!!Rc[t][e]};Vr.getKeyIndexes=function(t,e,r){var n=gi[t];if(!n)throw new Error("Unknown command "+t);if(!Array.isArray(e))throw new Error("Expect args to be an array");var s=[],i,o,c,l;switch(t){case"zunionstore":case"zinterstore":s.push(0);case"eval":case"evalsha":for(c=Number(e[1])+2,i=2;i<c;i++)s.push(i);break;case"sort":for(l=r&&r.parseExternalKey,s.push(0),i=1;i<e.length-1;i++)if(typeof e[i]=="string"){var u=e[i].toUpperCase();u==="GET"?(i+=1,e[i]!=="#"&&(l?s.push([i,xy(e[i])]):s.push(i))):u==="BY"?(i+=1,l?s.push([i,xy(e[i])]):s.push(i)):u==="STORE"&&(i+=1,s.push(i))}break;case"migrate":if(e[2]===""){for(i=5;i<e.length-1;i++)if(e[i].toUpperCase()==="KEYS"){for(var a=i+1;a<e.length;a++)s.push(a);break}}else s.push(2);break;case"xreadgroup":case"xread":for(i=t==="xread"?0:3;i<e.length-1;i++)if(String(e[i]).toUpperCase()==="STREAMS"){for(a=i+1;a<=i+(e.length-1-i)/2;a++)s.push(a);break}break;default:if(n.step>0)for(o=n.keyStart-1,c=n.keyStop>0?n.keyStop:e.length+n.keyStop+1,i=o;i<c;i+=n.step)s.push(i);break}return s};function xy(t){typeof t!="string"&&(t=String(t));var e=t.indexOf("->");return e===-1?t.length:e}});var mi=x(($D,Tc)=>{var Sy=[0,4129,8258,12387,16516,20645,24774,28903,33032,37161,41290,45419,49548,53677,57806,61935,4657,528,12915,8786,21173,17044,29431,25302,37689,33560,45947,41818,54205,50076,62463,58334,9314,13379,1056,5121,25830,29895,17572,21637,42346,46411,34088,38153,58862,62927,50604,54669,13907,9842,5649,1584,30423,26358,22165,18100,46939,42874,38681,34616,63455,59390,55197,51132,18628,22757,26758,30887,2112,6241,10242,14371,51660,55789,59790,63919,35144,39273,43274,47403,23285,19156,31415,27286,6769,2640,14899,10770,56317,52188,64447,60318,39801,35672,47931,43802,27814,31879,19684,23749,11298,15363,3168,7233,60846,64911,52716,56781,44330,48395,36200,40265,32407,28342,24277,20212,15891,11826,7761,3696,65439,61374,57309,53244,48923,44858,40793,36728,37256,33193,45514,41451,53516,49453,61774,57711,4224,161,12482,8419,20484,16421,28742,24679,33721,37784,41979,46042,49981,54044,58239,62302,689,4752,8947,13010,16949,21012,25207,29270,46570,42443,38312,34185,62830,58703,54572,50445,13538,9411,5280,1153,29798,25671,21540,17413,42971,47098,34713,38840,59231,63358,50973,55100,9939,14066,1681,5808,26199,30326,17941,22068,55628,51565,63758,59695,39368,35305,47498,43435,22596,18533,30726,26663,6336,2273,14466,10403,52093,56156,60223,64286,35833,39896,43963,48026,19061,23124,27191,31254,2801,6864,10931,14994,64814,60687,56684,52557,48554,44427,40424,36297,31782,27655,23652,19525,15522,11395,7392,3265,61215,65342,53085,57212,44955,49082,36825,40952,28183,32310,20053,24180,11923,16050,3793,7920],TP=function(e){for(var r,n=0,s=0,i=[],o=e.length;n<o;n++)r=e.charCodeAt(n),r<128?i[s++]=r:r<2048?(i[s++]=r>>6|192,i[s++]=r&63|128):(r&64512)===55296&&n+1<e.length&&(e.charCodeAt(n+1)&64512)===56320?(r=65536+((r&1023)<<10)+(e.charCodeAt(++n)&1023),i[s++]=r>>18|240,i[s++]=r>>12&63|128,i[s++]=r>>6&63|128,i[s++]=r&63|128):(i[s++]=r>>12|224,i[s++]=r>>6&63|128,i[s++]=r&63|128);return i},wy=Tc.exports=function(e){for(var r,n=0,s=-1,i=0,o=0,c=typeof e=="string"?TP(e):e,l=c.length;n<l;){if(r=c[n++],s===-1)r===123&&(s=n);else if(r!==125)o=Sy[(r^o>>8)&255]^o<<8;else if(n-1!==s)return o&16383;i=Sy[(r^i>>8)&255]^i<<8}return i&16383};Tc.exports.generateMulti=function(e){for(var r=1,n=e.length,s=wy(e[0]);r<n;)if(wy(e[r++])!==s)return-1;return s}});var Oy=x($t=>{"use strict";Object.defineProperty($t,"__esModule",{value:!0});$t.tryCatch=$t.errorObj=void 0;$t.errorObj={e:{}};var Mc;function MP(t,e){try{let r=Mc;return Mc=null,r.apply(this,arguments)}catch(r){return $t.errorObj.e=r,$t.errorObj}}function DP(t){return Mc=t,MP}$t.tryCatch=DP});var yt=x(Dc=>{"use strict";Object.defineProperty(Dc,"__esModule",{value:!0});var Wr=Oy();function Ey(t){setTimeout(function(){throw t},0)}function $P(t,e,r){return typeof e=="function"&&t.then(n=>{let s;r!==void 0&&Object(r).spread&&Array.isArray(n)?s=Wr.tryCatch(e).apply(void 0,[null].concat(n)):s=n===void 0?Wr.tryCatch(e)(null):Wr.tryCatch(e)(null,n),s===Wr.errorObj&&Ey(s.e)},n=>{if(!n){let i=new Error(n+"");Object.assign(i,{cause:n}),n=i}let s=Wr.tryCatch(e)(n);s===Wr.errorObj&&Ey(s.e)}),t}Dc.default=$P});var Py=x(Jr=>{"use strict";Object.defineProperty(Jr,"__esModule",{value:!0});var NP=os(),$c=200;Jr.MAX_ARGUMENT_LENGTH=$c;var LP="ioredis";function ky(t){if(t!==null)switch(typeof t){case"boolean":return;case"number":return;case"object":if(Buffer.isBuffer(t))return t.toString("hex");if(Array.isArray(t))return t.join(",");try{return JSON.stringify(t)}catch{return}case"string":return t}}Jr.getStringValue=ky;function Cy(t,e){let{length:r}=t;return r<=e?t:t.slice(0,e)+' ... <REDACTED full-length="'+r+'">'}Jr.genRedactedString=Cy;function jP(t){let e=NP.default(`${LP}:${t}`);function r(...n){if(e.enabled){for(let s=1;s<n.length;s++){let i=ky(n[s]);typeof i=="string"&&i.length>$c&&(n[s]=Cy(i,$c))}return e.apply(null,n)}}return Object.defineProperties(r,{namespace:{get(){return e.namespace}},enabled:{get(){return e.enabled}},destroy:{get(){return e.destroy}},log:{get(){return e.log},set(n){e.log=n}}}),r}Jr.default=jP});var Ay=x(Nc=>{"use strict";Object.defineProperty(Nc,"__esModule",{value:!0});Nc.default={RedisCloudFixed:{ca:`-----BEGIN CERTIFICATE-----
MIIDTzCCAjegAwIBAgIJAKSVpiDswLcwMA0GCSqGSIb3DQEBBQUAMD4xFjAUBgNV
BAoMDUdhcmFudGlhIERhdGExJDAiBgNVBAMMG1NTTCBDZXJ0aWZpY2F0aW9uIEF1
dGhvcml0eTAeFw0xMzEwMDExMjE0NTVaFw0yMzA5MjkxMjE0NTVaMD4xFjAUBgNV
BAoMDUdhcmFudGlhIERhdGExJDAiBgNVBAMMG1NTTCBDZXJ0aWZpY2F0aW9uIEF1
dGhvcml0eTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBALZqkh/DczWP
JnxnHLQ7QL0T4B4CDKWBKCcisriGbA6ZePWVNo4hfKQC6JrzfR+081NeD6VcWUiz
rmd+jtPhIY4c+WVQYm5PKaN6DT1imYdxQw7aqO5j2KUCEh/cznpLxeSHoTxlR34E
QwF28Wl3eg2vc5ct8LjU3eozWVk3gb7alx9mSA2SgmuX5lEQawl++rSjsBStemY2
BDwOpAMXIrdEyP/cVn8mkvi/BDs5M5G+09j0gfhyCzRWMQ7Hn71u1eolRxwVxgi3
TMn+/vTaFSqxKjgck6zuAYjBRPaHe7qLxHNr1So/Mc9nPy+3wHebFwbIcnUojwbp
4nctkWbjb2cCAwEAAaNQME4wHQYDVR0OBBYEFP1whtcrydmW3ZJeuSoKZIKjze3w
MB8GA1UdIwQYMBaAFP1whtcrydmW3ZJeuSoKZIKjze3wMAwGA1UdEwQFMAMBAf8w
DQYJKoZIhvcNAQEFBQADggEBAG2erXhwRAa7+ZOBs0B6X57Hwyd1R4kfmXcs0rta
lbPpvgULSiB+TCbf3EbhJnHGyvdCY1tvlffLjdA7HJ0PCOn+YYLBA0pTU/dyvrN6
Su8NuS5yubnt9mb13nDGYo1rnt0YRfxN+8DM3fXIVr038A30UlPX2Ou1ExFJT0MZ
uFKY6ZvLdI6/1cbgmguMlAhM+DhKyV6Sr5699LM3zqeI816pZmlREETYkGr91q7k
BpXJu/dtHaGxg1ZGu6w/PCsYGUcECWENYD4VQPd8N32JjOfu6vEgoEAwfPP+3oGp
Z4m3ewACcWOAenqflb+cQYC4PsF7qbXDmRaWrbKntOlZ3n0=
-----END CERTIFICATE-----
`},RedisCloudFlexible:{ca:`-----BEGIN CERTIFICATE-----
MIIGMTCCBBmgAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwajELMAkGA1UEBhMCVVMx
CzAJBgNVBAgMAkNBMQswCQYDVQQHDAJDQTESMBAGA1UECgwJUmVkaXNMYWJzMS0w
KwYDVQQDDCRSZWRpc0xhYnMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwHhcN
MTgwMjI1MTUzNzM3WhcNMjgwMjIzMTUzNzM3WjBfMQswCQYDVQQGEwJVUzELMAkG
A1UECAwCQ0ExEjAQBgNVBAoMCVJlZGlzTGFiczEvMC0GA1UEAwwmUkNQIEludGVy
bWVkaWF0ZSBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkwggIiMA0GCSqGSIb3DQEBAQUA
A4ICDwAwggIKAoICAQDf9dqbxc8Bq7Ctq9rWcxrGNKKHivqLAFpPq02yLPx6fsOv
Tq7GsDChAYBBc4v7Y2Ap9RD5Vs3dIhEANcnolf27QwrG9RMnnvzk8pCvp1o6zSU4
VuOE1W66/O1/7e2rVxyrnTcP7UgK43zNIXu7+tiAqWsO92uSnuMoGPGpeaUm1jym
hjWKtkAwDFSqvHY+XL5qDVBEjeUe+WHkYUg40cAXjusAqgm2hZt29c2wnVrxW25W
P0meNlzHGFdA2AC5z54iRiqj57dTfBTkHoBczQxcyw6hhzxZQ4e5I5zOKjXXEhZN
r0tA3YC14CTabKRus/JmZieyZzRgEy2oti64tmLYTqSlAD78pRL40VNoaSYetXLw
hhNsXCHgWaY6d5bLOc/aIQMAV5oLvZQKvuXAF1IDmhPA+bZbpWipp0zagf1P1H3s
UzsMdn2KM0ejzgotbtNlj5TcrVwpmvE3ktvUAuA+hi3FkVx1US+2Gsp5x4YOzJ7u
P1WPk6ShF0JgnJH2ILdj6kttTWwFzH17keSFICWDfH/+kM+k7Y1v3EXMQXE7y0T9
MjvJskz6d/nv+sQhY04xt64xFMGTnZjlJMzfQNi7zWFLTZnDD0lPowq7l3YiPoTT
t5Xky83lu0KZsZBo0WlWaDG00gLVdtRgVbcuSWxpi5BdLb1kRab66JptWjxwXQID
AQABo4HrMIHoMDoGA1UdHwQzMDEwL6AtoCuGKWh0dHBzOi8vcmwtY2Etc2VydmVy
LnJlZGlzbGFicy5jb20vdjEvY3JsMEYGCCsGAQUFBwEBBDowODA2BggrBgEFBQcw
AYYqaHR0cHM6Ly9ybC1jYS1zZXJ2ZXIucmVkaXNsYWJzLmNvbS92MS9vY3NwMB0G
A1UdDgQWBBQHar5OKvQUpP2qWt6mckzToeCOHDAfBgNVHSMEGDAWgBQi42wH6hM4
L2sujEvLM0/u8lRXTzASBgNVHRMBAf8ECDAGAQH/AgEAMA4GA1UdDwEB/wQEAwIB
hjANBgkqhkiG9w0BAQsFAAOCAgEAirEn/iTsAKyhd+pu2W3Z5NjCko4NPU0EYUbr
AP7+POK2rzjIrJO3nFYQ/LLuC7KCXG+2qwan2SAOGmqWst13Y+WHp44Kae0kaChW
vcYLXXSoGQGC8QuFSNUdaeg3RbMDYFT04dOkqufeWVccoHVxyTSg9eD8LZuHn5jw
7QDLiEECBmIJHk5Eeo2TAZrx4Yx6ufSUX5HeVjlAzqwtAqdt99uCJ/EL8bgpWbe+
XoSpvUv0SEC1I1dCAhCKAvRlIOA6VBcmzg5Am12KzkqTul12/VEFIgzqu0Zy2Jbc
AUPrYVu/+tOGXQaijy7YgwH8P8n3s7ZeUa1VABJHcxrxYduDDJBLZi+MjheUDaZ1
jQRHYevI2tlqeSBqdPKG4zBY5lS0GiAlmuze5oENt0P3XboHoZPHiqcK3VECgTVh
/BkJcuudETSJcZDmQ8YfoKfBzRQNg2sv/hwvUv73Ss51Sco8GEt2lD8uEdib1Q6z
zDT5lXJowSzOD5ZA9OGDjnSRL+2riNtKWKEqvtEG3VBJoBzu9GoxbAc7wIZLxmli
iF5a/Zf5X+UXD3s4TMmy6C4QZJpAA2egsSQCnraWO2ULhh7iXMysSkF/nzVfZn43
iqpaB8++9a37hWq14ZmOv0TJIDz//b2+KC4VFXWQ5W5QC6whsjT+OlG4p5ZYG0jo
616pxqo=
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
MIIFujCCA6KgAwIBAgIJAJ1aTT1lu2ScMA0GCSqGSIb3DQEBCwUAMGoxCzAJBgNV
BAYTAlVTMQswCQYDVQQIDAJDQTELMAkGA1UEBwwCQ0ExEjAQBgNVBAoMCVJlZGlz
TGFiczEtMCsGA1UEAwwkUmVkaXNMYWJzIFJvb3QgQ2VydGlmaWNhdGUgQXV0aG9y
aXR5MB4XDTE4MDIyNTE1MjA0MloXDTM4MDIyMDE1MjA0MlowajELMAkGA1UEBhMC
VVMxCzAJBgNVBAgMAkNBMQswCQYDVQQHDAJDQTESMBAGA1UECgwJUmVkaXNMYWJz
MS0wKwYDVQQDDCRSZWRpc0xhYnMgUm9vdCBDZXJ0aWZpY2F0ZSBBdXRob3JpdHkw
ggIiMA0GCSqGSIb3DQEBAQUAA4ICDwAwggIKAoICAQDLEjXy7YrbN5Waau5cd6g1
G5C2tMmeTpZ0duFAPxNU4oE3RHS5gGiok346fUXuUxbZ6QkuzeN2/2Z+RmRcJhQY
Dm0ZgdG4x59An1TJfnzKKoWj8ISmoHS/TGNBdFzXV7FYNLBuqZouqePI6ReC6Qhl
pp45huV32Q3a6IDrrvx7Wo5ZczEQeFNbCeCOQYNDdTmCyEkHqc2AGo8eoIlSTutT
ULOC7R5gzJVTS0e1hesQ7jmqHjbO+VQS1NAL4/5K6cuTEqUl+XhVhPdLWBXJQ5ag
54qhX4v+ojLzeU1R/Vc6NjMvVtptWY6JihpgplprN0Yh2556ewcXMeturcKgXfGJ
xeYzsjzXerEjrVocX5V8BNrg64NlifzTMKNOOv4fVZszq1SIHR8F9ROrqiOdh8iC
JpUbLpXH9hWCSEO6VRMB2xJoKu3cgl63kF30s77x7wLFMEHiwsQRKxooE1UhgS9K
2sO4TlQ1eWUvFvHSTVDQDlGQ6zu4qjbOpb3Q8bQwoK+ai2alkXVR4Ltxe9QlgYK3
StsnPhruzZGA0wbXdpw0bnM+YdlEm5ffSTpNIfgHeaa7Dtb801FtA71ZlH7A6TaI
SIQuUST9EKmv7xrJyx0W1pGoPOLw5T029aTjnICSLdtV9bLwysrLhIYG5bnPq78B
cS+jZHFGzD7PUVGQD01nOQIDAQABo2MwYTAdBgNVHQ4EFgQUIuNsB+oTOC9rLoxL
yzNP7vJUV08wHwYDVR0jBBgwFoAUIuNsB+oTOC9rLoxLyzNP7vJUV08wDwYDVR0T
AQH/BAUwAwEB/zAOBgNVHQ8BAf8EBAMCAYYwDQYJKoZIhvcNAQELBQADggIBAHfg
z5pMNUAKdMzK1aS1EDdK9yKz4qicILz5czSLj1mC7HKDRy8cVADUxEICis++CsCu
rYOvyCVergHQLREcxPq4rc5Nq1uj6J6649NEeh4WazOOjL4ZfQ1jVznMbGy+fJm3
3Hoelv6jWRG9iqeJZja7/1s6YC6bWymI/OY1e4wUKeNHAo+Vger7MlHV+RuabaX+
hSJ8bJAM59NCM7AgMTQpJCncrcdLeceYniGy5Q/qt2b5mJkQVkIdy4TPGGB+AXDJ
D0q3I/JDRkDUFNFdeW0js7fHdsvCR7O3tJy5zIgEV/o/BCkmJVtuwPYOrw/yOlKj
TY/U7ATAx9VFF6/vYEOMYSmrZlFX+98L6nJtwDqfLB5VTltqZ4H/KBxGE3IRSt9l
FXy40U+LnXzhhW+7VBAvyYX8GEXhHkKU8Gqk1xitrqfBXY74xKgyUSTolFSfFVgj
mcM/X4K45bka+qpkj7Kfv/8D4j6aZekwhN2ly6hhC1SmQ8qjMjpG/mrWOSSHZFmf
ybu9iD2AYHeIOkshIl6xYIa++Q/00/vs46IzAbQyriOi0XxlSMMVtPx0Q3isp+ji
n8Mq9eOuxYOEQ4of8twUkUDd528iwGtEdwf0Q01UyT84S62N8AySl1ZBKXJz6W4F
UhWfa/HQYOAPDdEjNgnVwLI23b8t0TozyCWw7q8h
-----END CERTIFICATE-----
`}}});var de=x(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});var Iy=require("url"),_i=Hr();Z.defaults=_i.defaults;Z.noop=_i.noop;Z.flatten=_i.flatten;var qP=Py();Z.Debug=qP.default;var BP=Ay();function FP(t,e){if(typeof t.equals=="function")return t.equals(e);if(t.length!==e.length)return!1;for(let r=0;r<t.length;++r)if(t[r]!==e[r])return!1;return!0}Z.bufferEqual=FP;function Ry(t,e){if(t instanceof Buffer)return t.toString(e);if(Array.isArray(t)){let r=t.length,n=Array(r);for(let s=0;s<r;++s)n[s]=t[s]instanceof Buffer&&e==="utf8"?t[s].toString():Ry(t[s],e);return n}return t}Z.convertBufferToString=Ry;function UP(t){if(!t)return null;let e=[],r=t.length;for(let n=0;n<r;++n){let s=t[n];s instanceof Error?e.push([s]):e.push([null,s])}return e}Z.wrapMultiResult=UP;function Ty(t){let e=parseFloat(t);return!isNaN(t)&&(e|0)===e}Z.isInt=Ty;function zP(t){let e={},r=t.length;for(let n=1;n<r;n+=2)e[t[n-1]]=t[n];return e}Z.packObject=zP;function HP(t,e){let r,n=function(){r&&(clearTimeout(r),r=null,t.apply(this,arguments))};return r=setTimeout(n,e,new Error("timeout")),n}Z.timeout=HP;function VP(t){let e=[],r=Object.keys(t);for(let n=0,s=r.length;n<s;n++)e.push(r[n],t[r[n]]);return e}Z.convertObjectToArray=VP;function GP(t){let e=[],r=0;return t.forEach(function(n,s){e[r]=s,e[r+1]=n,r+=2}),e}Z.convertMapToArray=GP;function WP(t){return t===null||typeof t>"u"?"":String(t)}Z.toArg=WP;function JP(t,e,r){let n=e.split(`
`),s="",i;for(i=1;i<n.length&&n[i].indexOf(r)!==-1;++i);for(let c=i;c<n.length;++c)s+=`
`+n[c];let o=t.stack.indexOf(`
`);return t.stack=t.stack.slice(0,o)+s,t}Z.optimizeErrorStack=JP;function QP(t){if(Ty(t))return{port:t};let e=Iy.parse(t,!0,!0);!e.slashes&&t[0]!=="/"&&(t="//"+t,e=Iy.parse(t,!0,!0));let r=e.query||{},n=r.allowUsernameInURI&&r.allowUsernameInURI!=="false";delete r.allowUsernameInURI;let s={};if(e.auth){let i=e.auth.indexOf(":");n&&(s.username=i===-1?e.auth:e.auth.slice(0,i)),s.password=i===-1?"":e.auth.slice(i+1)}return e.pathname&&(e.protocol==="redis:"||e.protocol==="rediss:"?e.pathname.length>1&&(s.db=e.pathname.slice(1)):s.path=e.pathname),e.host&&(s.host=e.hostname),e.port&&(s.port=e.port),_i.defaults(s,r),s}Z.parseURL=QP;function YP(t){let e=t?.tls;typeof e=="string"&&(e={profile:e});let r=BP.default[e?.profile];return r&&(e=Object.assign({},r,e),delete e.profile,t=Object.assign({},t,{tls:e})),t}Z.resolveTLSProfile=YP;function KP(t,e=0){let r=t.length;if(!(e>=r))return t[e+Math.floor(Math.random()*(r-e))]}Z.sample=KP;function XP(t){let e=t.length;for(;e>0;){let r=Math.floor(Math.random()*e);e--,[t[e],t[r]]=[t[r],t[e]]}return t}Z.shuffle=XP;Z.CONNECTION_CLOSED_ERROR_MSG="Connection is closed.";function ZP(t,e){let r=new Map;return t.forEach((n,s)=>{r.set(n,e[s])}),r}Z.zipMap=ZP});var gt=x(qn=>{"use strict";Object.defineProperty(qn,"__esModule",{value:!0});function eA(t){return!!t&&(typeof t=="object"||typeof t=="function")&&typeof t.then=="function"}qn.isPromise=eA;var My=Promise;function tA(){return My}qn.get=tA;function rA(t){if(typeof t!="function")throw new Error(`Provided Promise must be a function, got ${t}`);My=t}qn.set=rA});var mt=x(jc=>{"use strict";Object.defineProperty(jc,"__esModule",{value:!0});var Dy=Gr(),nA=mi(),sA=yt(),pr=de(),iA=Hr(),oA=gt(),st=class t{constructor(e,r=[],n={},s){this.name=e,this.transformed=!1,this.isCustomCommand=!1,this.inTransaction=!1,this.isResolved=!1,this.replyEncoding=n.replyEncoding,this.errorStack=n.errorStack,this.args=iA.flatten(r),this.callback=s,this.initPromise(),n.keyPrefix&&this._iterateKeys(i=>n.keyPrefix+i),n.readOnly&&(this.isReadOnly=!0)}static getFlagMap(){return this.flagMap||(this.flagMap=Object.keys(t.FLAGS).reduce((e,r)=>(e[r]={},t.FLAGS[r].forEach(n=>{e[r][n]=!0}),e),{})),this.flagMap}static checkFlag(e,r){return!!this.getFlagMap()[e][r]}static setArgumentTransformer(e,r){this._transformer.argument[e]=r}static setReplyTransformer(e,r){this._transformer.reply[e]=r}initPromise(){let e=oA.get(),r=new e((n,s)=>{if(!this.transformed){this.transformed=!0;let i=t._transformer.argument[this.name];i&&(this.args=i(this.args)),this.stringifyArguments()}this.resolve=this._convertValue(n),this.errorStack?this.reject=i=>{s(pr.optimizeErrorStack(i,this.errorStack.stack,__dirname))}:this.reject=s});this.promise=sA.default(r,this.callback)}getSlot(){if(typeof this.slot>"u"){let e=this.getKeys()[0];this.slot=e==null?null:nA(e)}return this.slot}getKeys(){return this._iterateKeys()}_iterateKeys(e=r=>r){if(typeof this.keys>"u"&&(this.keys=[],Dy.exists(this.name))){let r=Dy.getKeyIndexes(this.name,this.args);for(let n of r)this.args[n]=e(this.args[n]),this.keys.push(this.args[n])}return this.keys}toWritable(){let e=!1;for(let s of this.args)if(s instanceof Buffer){e=!0;break}let r,n="*"+(this.args.length+1)+`\r
$`+Buffer.byteLength(this.name)+`\r
`+this.name+`\r
`;if(e){let s=new Lc;s.push(n);for(let i of this.args)i instanceof Buffer?i.length===0?s.push(`$0\r
\r
`):(s.push("$"+i.length+`\r
`),s.push(i),s.push(`\r
`)):s.push("$"+Buffer.byteLength(i)+`\r
`+i+`\r
`);r=s.toBuffer()}else{r=n;for(let s of this.args)r+="$"+Buffer.byteLength(s)+`\r
`+s+`\r
`}return r}stringifyArguments(){for(let e=0;e<this.args.length;++e){let r=this.args[e];!(r instanceof Buffer)&&typeof r!="string"&&(this.args[e]=pr.toArg(r))}}_convertValue(e){return r=>{try{let n=this._commandTimeoutTimer;n&&(clearTimeout(n),delete this._commandTimeoutTimer),e(this.transformReply(r)),this.isResolved=!0}catch(n){this.reject(n)}return this.promise}}transformReply(e){this.replyEncoding&&(e=pr.convertBufferToString(e,this.replyEncoding));let r=t._transformer.reply[this.name];return r&&(e=r(e)),e}setTimeout(e){this._commandTimeoutTimer||(this._commandTimeoutTimer=setTimeout(()=>{this.isResolved||this.reject(new Error("Command timed out"))},e))}};jc.default=st;st.FLAGS={VALID_IN_SUBSCRIBER_MODE:["subscribe","psubscribe","unsubscribe","punsubscribe","ping","quit"],VALID_IN_MONITOR_MODE:["monitor","auth"],ENTER_SUBSCRIBER_MODE:["subscribe","psubscribe"],EXIT_SUBSCRIBER_MODE:["unsubscribe","punsubscribe"],WILL_DISCONNECT:["quit"]};st._transformer={argument:{},reply:{}};var $y=function(t){if(t.length===1){if(typeof Map<"u"&&t[0]instanceof Map)return pr.convertMapToArray(t[0]);if(typeof t[0]=="object"&&t[0]!==null)return pr.convertObjectToArray(t[0])}return t},Ny=function(t){if(t.length===2){if(typeof Map<"u"&&t[1]instanceof Map)return[t[0]].concat(pr.convertMapToArray(t[1]));if(typeof t[1]=="object"&&t[1]!==null)return[t[0]].concat(pr.convertObjectToArray(t[1]))}return t};st.setArgumentTransformer("mset",$y);st.setArgumentTransformer("msetnx",$y);st.setArgumentTransformer("hset",Ny);st.setArgumentTransformer("hmset",Ny);st.setReplyTransformer("hgetall",function(t){if(Array.isArray(t)){let e={};for(let r=0;r<t.length;r+=2){let n=t[r],s=t[r+1];n in e?Object.defineProperty(e,n,{value:s,configurable:!0,enumerable:!0,writable:!0}):e[n]=s}return e}return t});var Lc=class{constructor(){this.length=0,this.items=[]}push(e){this.length+=Buffer.byteLength(e),this.items.push(e)}toBuffer(){let e=Buffer.allocUnsafe(this.length),r=0;for(let n of this.items){let s=Buffer.byteLength(n);Buffer.isBuffer(n)?n.copy(e,r):e.write(n,r,s),r+=s}return e}}});var qy=x(Bc=>{"use strict";Object.defineProperty(Bc,"__esModule",{value:!0});var aA=require("crypto"),cA=gt(),Ly=mt(),jy=yt(),qc=class{constructor(e,r=null,n="",s=!1){this.lua=e,this.numberOfKeys=r,this.keyPrefix=n,this.readOnly=s,this.sha=aA.createHash("sha1").update(e).digest("hex")}execute(e,r,n,s){typeof this.numberOfKeys=="number"&&r.unshift(this.numberOfKeys),this.keyPrefix&&(n.keyPrefix=this.keyPrefix),this.readOnly&&(n.readOnly=!0);let i=new Ly.default("evalsha",[this.sha].concat(r),n);i.isCustomCommand=!0;let o=e.sendCommand(i);return cA.isPromise(o)?jy.default(o.catch(c=>{if(c.toString().indexOf("NOSCRIPT")===-1)throw c;return e.sendCommand(new Ly.default("eval",[this.lua].concat(r),n))}),s):(jy.default(i.promise,s),o)}};Bc.default=qc});var Hy=x(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});var uA=gt(),Fc=Hr(),lA=mi(),By=yt();ge.kExec=Symbol("exec");ge.kCallbacks=Symbol("callbacks");ge.notAllowedAutoPipelineCommands=["auth","info","script","quit","cluster","pipeline","multi","subscribe","psubscribe","unsubscribe","unpsubscribe"];function Fy(t,e){if(t._runningAutoPipelines.has(e)||!t._autoPipelines.has(e))return;t._runningAutoPipelines.add(e);let r=t._autoPipelines.get(e);t._autoPipelines.delete(e);let n=r[ge.kCallbacks];r[ge.kCallbacks]=null,r.exec(function(s,i){if(t._runningAutoPipelines.delete(e),s)for(let o=0;o<n.length;o++)process.nextTick(n[o],s);else for(let o=0;o<n.length;o++)process.nextTick(n[o],...i[o]);t._autoPipelines.has(e)&&Fy(t,e)})}function fA(t,e,r){return e&&t.options.enableAutoPipelining&&!t.isPipeline&&!ge.notAllowedAutoPipelineCommands.includes(r)&&!t.options.autoPipeliningIgnoredCommands.includes(r)}ge.shouldUseAutoPipelining=fA;function Uy(t){for(let e=0;e<t.length;e++){let r=t[e];if(typeof r=="string")return r;if(Array.isArray(r)||Fc.isArguments(r)){if(r.length===0)continue;return r[0]}let n=Fc.flatten([r]);if(n.length>0)return n[0]}}ge.getFirstValueInFlattenedArray=Uy;function zy(t,e,r,n,s){let i=uA.get();if(t.isCluster&&!t.slots.length)return t.status==="wait"&&t.connect().catch(Fc.noop),By.default(new i(function(a,f){t.delayUntilReady(h=>{if(h){f(h);return}zy(t,e,r,n,null).then(a,f)})}),s);let o=t.options.keyPrefix||"",c=t.isCluster?t.slots[lA(`${o}${Uy(n)}`)].join(","):"main";if(!t._autoPipelines.has(c)){let a=t.pipeline();a[ge.kExec]=!1,a[ge.kCallbacks]=[],t._autoPipelines.set(c,a)}let l=t._autoPipelines.get(c);l[ge.kExec]||(l[ge.kExec]=!0,setImmediate(Fy,t,c));let u=new i(function(a,f){l[ge.kCallbacks].push(function(h,d){if(h){f(h);return}a(d)}),l[e](...n)});return By.default(u,s)}ge.executeWithAutoPipelining=zy});var bi=x(zc=>{"use strict";Object.defineProperty(zc,"__esModule",{value:!0});var hA=Hr(),dA=mt(),pA=qy(),Gy=gt(),Wy=yt(),vi=Hy(),Jy='*Buffer methods are not available because "dropBufferSupport" option is enabled.Refer to https://github.com/luin/ioredis/wiki/Improve-Performance for more details.';function ze(){this.options=hA.defaults({},this.options||{},{showFriendlyErrorStack:!1}),this.scriptsSet={},this.addedBuiltinSet=new Set}zc.default=ze;var Uc=Gr().list.filter(function(t){return t!=="monitor"});Uc.push("sentinel");ze.prototype.getBuiltinCommands=function(){return Uc.slice(0)};ze.prototype.createBuiltinCommand=function(t){return{string:Nt(null,t,"utf8"),buffer:Nt(null,t,null)}};ze.prototype.addBuiltinCommand=function(t){this.addedBuiltinSet.add(t),this[t]=Nt(t,t,"utf8"),this[t+"Buffer"]=Nt(t+"Buffer",t,null)};Uc.forEach(function(t){ze.prototype[t]=Nt(t,t,"utf8"),ze.prototype[t+"Buffer"]=Nt(t+"Buffer",t,null)});ze.prototype.call=Nt("call","utf8");ze.prototype.callBuffer=Nt("callBuffer",null);ze.prototype.send_command=ze.prototype.call;ze.prototype.defineCommand=function(t,e){let r=new pA.default(e.lua,e.numberOfKeys,this.options.keyPrefix,e.readOnly);this.scriptsSet[t]=r,this[t]=Vy(t,t,r,"utf8"),this[t+"Buffer"]=Vy(t+"Buffer",t,r,null)};ze.prototype.sendCommand=function(){};function Nt(t,e,r){return typeof r>"u"&&(r=e,e=null),function(...n){let s=e||n.shift(),i=n[n.length-1];typeof i=="function"?n.pop():i=void 0;let o={errorStack:this.options.showFriendlyErrorStack?new Error:void 0,keyPrefix:this.options.keyPrefix,replyEncoding:r};return this.options.dropBufferSupport&&!r?Wy.default(Gy.get().reject(new Error(Jy)),i):vi.shouldUseAutoPipelining(this,t,s)?vi.executeWithAutoPipelining(this,t,s,n,i):this.sendCommand(new dA.default(s,n,o,i))}}function Vy(t,e,r,n){return function(){let s=arguments.length,i=s-1,o=arguments[i];typeof o!="function"?o=void 0:s=i;let c=new Array(s);for(let u=0;u<s;u++)c[u]=arguments[u];let l;if(this.options.dropBufferSupport){if(!n)return Wy.default(Gy.get().reject(new Error(Jy)),o);l={replyEncoding:null}}else l={replyEncoding:n};return this.options.showFriendlyErrorStack&&(l.errorStack=new Error),vi.shouldUseAutoPipelining(this,t,e)?vi.executeWithAutoPipelining(this,t,e,c,o):r.execute(this,c,l,o)}}});var Ky=x((GD,Yy)=>{"use strict";var Qy=require("assert"),Bn=require("util");function Qr(t){Object.defineProperty(this,"message",{value:t||"",configurable:!0,writable:!0}),Error.captureStackTrace(this,this.constructor)}Bn.inherits(Qr,Error);Object.defineProperty(Qr.prototype,"name",{value:"RedisError",configurable:!0,writable:!0});function Hc(t,e,r){Qy(e),Qy.strictEqual(typeof r,"number"),Object.defineProperty(this,"message",{value:t||"",configurable:!0,writable:!0});let n=Error.stackTraceLimit;Error.stackTraceLimit=2,Error.captureStackTrace(this,this.constructor),Error.stackTraceLimit=n,this.offset=r,this.buffer=e}Bn.inherits(Hc,Qr);Object.defineProperty(Hc.prototype,"name",{value:"ParserError",configurable:!0,writable:!0});function Vc(t){Object.defineProperty(this,"message",{value:t||"",configurable:!0,writable:!0});let e=Error.stackTraceLimit;Error.stackTraceLimit=2,Error.captureStackTrace(this,this.constructor),Error.stackTraceLimit=e}Bn.inherits(Vc,Qr);Object.defineProperty(Vc.prototype,"name",{value:"ReplyError",configurable:!0,writable:!0});function xi(t){Object.defineProperty(this,"message",{value:t||"",configurable:!0,writable:!0}),Error.captureStackTrace(this,this.constructor)}Bn.inherits(xi,Qr);Object.defineProperty(xi.prototype,"name",{value:"AbortError",configurable:!0,writable:!0});function Gc(t){Object.defineProperty(this,"message",{value:t||"",configurable:!0,writable:!0}),Error.captureStackTrace(this,this.constructor)}Bn.inherits(Gc,xi);Object.defineProperty(Gc.prototype,"name",{value:"InterruptError",configurable:!0,writable:!0});Yy.exports={RedisError:Qr,ParserError:Hc,ReplyError:Vc,AbortError:xi,InterruptError:Gc}});var eg=x((WD,Zy)=>{"use strict";var Xy=require("assert"),Yr=class extends Error{get name(){return this.constructor.name}},Wc=class extends Yr{constructor(e,r,n){Xy(r),Xy.strictEqual(typeof n,"number");let s=Error.stackTraceLimit;Error.stackTraceLimit=2,super(e),Error.stackTraceLimit=s,this.offset=n,this.buffer=r}get name(){return this.constructor.name}},Jc=class extends Yr{constructor(e){let r=Error.stackTraceLimit;Error.stackTraceLimit=2,super(e),Error.stackTraceLimit=r}get name(){return this.constructor.name}},Si=class extends Yr{get name(){return this.constructor.name}},Qc=class extends Si{get name(){return this.constructor.name}};Zy.exports={RedisError:Yr,ParserError:Wc,ReplyError:Jc,AbortError:Si,InterruptError:Qc}});var yr=x((JD,tg)=>{"use strict";var yA=process.version.charCodeAt(1)<55&&process.version.charCodeAt(2)===46?Ky():eg();tg.exports=yA});var rg=x(Kc=>{"use strict";Object.defineProperty(Kc,"__esModule",{value:!0});var gA=yr(),Yc=class extends gA.AbortError{constructor(e){let r=`Reached the max retries per request limit (which is ${e}). Refer to "maxRetriesPerRequest" option for details.`;super(r),Error.captureStackTrace(this,this.constructor)}get name(){return this.constructor.name}};Kc.default=Yc});var ng=x(Xc=>{"use strict";Object.defineProperty(Xc,"__esModule",{value:!0});var mA=rg();Xc.MaxRetriesPerRequestError=mA.default});var lg=x((KD,ug)=>{"use strict";var su=require("buffer").Buffer,_A=require("string_decoder").StringDecoder,Zc=new _A,sg=yr(),vA=sg.ReplyError,bA=sg.ParserError,Ve=su.allocUnsafe(32*1024),be=0,wi=null,Fn=0,eu=0;function xA(t){let e=t.buffer.length-1;var r=t.offset,n=0,s=1;for(t.buffer[r]===45&&(s=-1,r++);r<e;){let i=t.buffer[r++];if(i===13)return t.offset=r+1,s*n;n=n*10+(i-48)}}function SA(t){let e=t.buffer.length-1;var r=t.offset,n=0,s="";for(t.buffer[r]===45&&(s+="-",r++);r<e;){var i=t.buffer[r++];if(i===13)return t.offset=r+1,n!==0&&(s+=n),s;n>429496728?(s+=n*10+(i-48),n=0):i===48&&n===0?s+=0:n=n*10+(i-48)}}function ig(t){let e=t.offset,r=t.buffer,n=r.length-1;for(var s=e;s<n;)if(r[s++]===13)return t.offset=s+1,t.optionReturnBuffers===!0?t.buffer.slice(e,s-1):t.buffer.toString("utf8",e,s-1)}function og(t){let e=t.buffer.length-1;for(var r=t.offset,n=0;r<e;){let s=t.buffer[r++];if(s===13)return t.offset=r+1,n;n=n*10+(s-48)}}function wA(t){return t.optionStringNumbers===!0?SA(t):xA(t)}function OA(t){let e=og(t);if(e===void 0)return;if(e<0)return null;let r=t.offset+e;if(r+2>t.buffer.length){t.bigStrSize=r+2,t.totalChunkSize=t.buffer.length,t.bufferCache.push(t.buffer);return}let n=t.offset;return t.offset=r+2,t.optionReturnBuffers===!0?t.buffer.slice(n,r):t.buffer.toString("utf8",n,r)}function EA(t){var e=ig(t);if(e!==void 0)return t.optionReturnBuffers===!0&&(e=e.toString()),new vA(e)}function kA(t,e){let r=new bA("Protocol error, got "+JSON.stringify(String.fromCharCode(e))+" as reply type byte",JSON.stringify(t.buffer),t.offset);t.buffer=null,t.returnFatalError(r)}function CA(t){let e=og(t);if(e===void 0)return;if(e<0)return null;let r=new Array(e);return ag(t,r,0)}function tu(t,e,r){t.arrayCache.push(e),t.arrayPos.push(r)}function ru(t){let e=t.arrayCache.pop();var r=t.arrayPos.pop();if(t.arrayCache.length){let n=ru(t);if(n===void 0){tu(t,e,r);return}e[r++]=n}return ag(t,e,r)}function ag(t,e,r){let n=t.buffer.length;for(;r<e.length;){let s=t.offset;if(t.offset>=n){tu(t,e,r);return}let i=cg(t,t.buffer[t.offset++]);if(i===void 0){t.arrayCache.length||t.bufferCache.length||(t.offset=s),tu(t,e,r);return}e[r]=i,r++}return e}function cg(t,e){switch(e){case 36:return OA(t);case 43:return ig(t);case 42:return CA(t);case 58:return wA(t);case 45:return EA(t);default:return kA(t,e)}}function PA(){if(Ve.length>50*1024)if(Fn===1||eu>Fn*2){let t=Math.floor(Ve.length/10),e=t<be?be:t;be=0,Ve=Ve.slice(e,Ve.length)}else eu++,Fn--;else clearInterval(wi),Fn=0,eu=0,wi=null}function AA(t){if(Ve.length<t+be){let e=t>78643200?2:3;be>1024*1024*111&&(be=1024*1024*50),Ve=su.allocUnsafe(t*e+be),be=0,Fn++,wi===null&&(wi=setInterval(PA,50))}}function IA(t){let e=t.bufferCache,r=t.offset;var n=e.length,s=t.bigStrSize-t.totalChunkSize;if(t.offset=s,s<=2){if(n===2)return e[0].toString("utf8",r,e[0].length+s-2);n--,s=e[e.length-2].length+s}for(var i=Zc.write(e[0].slice(r)),o=1;o<n-1;o++)i+=Zc.write(e[o]);return i+=Zc.end(e[o].slice(0,s-2)),i}function RA(t){let e=t.bufferCache,r=t.offset,n=t.bigStrSize-r-2;var s=e.length,i=t.bigStrSize-t.totalChunkSize;if(t.offset=i,i<=2){if(s===2)return e[0].slice(r,e[0].length+i-2);s--,i=e[e.length-2].length+i}AA(n);let o=be;e[0].copy(Ve,o,r,e[0].length),be+=e[0].length-r;for(var c=1;c<s-1;c++)e[c].copy(Ve,be),be+=e[c].length;return e[c].copy(Ve,be,0,i-2),be+=i-2,Ve.slice(o,be)}var nu=class{constructor(e){if(!e)throw new TypeError("Options are mandatory.");if(typeof e.returnError!="function"||typeof e.returnReply!="function")throw new TypeError("The returnReply and returnError options have to be functions.");this.setReturnBuffers(!!e.returnBuffers),this.setStringNumbers(!!e.stringNumbers),this.returnError=e.returnError,this.returnFatalError=e.returnFatalError||e.returnError,this.returnReply=e.returnReply,this.reset()}reset(){this.offset=0,this.buffer=null,this.bigStrSize=0,this.totalChunkSize=0,this.bufferCache=[],this.arrayCache=[],this.arrayPos=[]}setReturnBuffers(e){if(typeof e!="boolean")throw new TypeError("The returnBuffers argument has to be a boolean");this.optionReturnBuffers=e}setStringNumbers(e){if(typeof e!="boolean")throw new TypeError("The stringNumbers argument has to be a boolean");this.optionStringNumbers=e}execute(e){if(this.buffer===null)this.buffer=e,this.offset=0;else if(this.bigStrSize===0){let n=this.buffer.length,s=n-this.offset,i=su.allocUnsafe(s+e.length);if(this.buffer.copy(i,0,this.offset,n),e.copy(i,s,0,e.length),this.buffer=i,this.offset=0,this.arrayCache.length){let o=ru(this);if(o===void 0)return;this.returnReply(o)}}else if(this.totalChunkSize+e.length>=this.bigStrSize){this.bufferCache.push(e);var r=this.optionReturnBuffers?RA(this):IA(this);if(this.bigStrSize=0,this.bufferCache=[],this.buffer=e,this.arrayCache.length&&(this.arrayCache[0][this.arrayPos[0]++]=r,r=ru(this),r===void 0))return;this.returnReply(r)}else{this.bufferCache.push(e),this.totalChunkSize+=e.length;return}for(;this.offset<this.buffer.length;){let n=this.offset,s=this.buffer[this.offset++],i=cg(this,s);if(i===void 0){this.arrayCache.length||this.bufferCache.length||(this.offset=n);return}s===45?this.returnError(i):this.returnReply(i)}this.buffer=null}};ug.exports=nu});var hg=x((XD,fg)=>{"use strict";fg.exports=lg()});var dg=x(au=>{"use strict";Object.defineProperty(au,"__esModule",{value:!0});var ou=class{constructor(){this.set={subscribe:{},psubscribe:{}}}add(e,r){this.set[iu(e)][r]=!0}del(e,r){delete this.set[iu(e)][r]}channels(e){return Object.keys(this.set[iu(e)])}isEmpty(){return this.channels("subscribe").length===0&&this.channels("psubscribe").length===0}};au.default=ou;function iu(t){return t==="unsubscribe"?"subscribe":t==="punsubscribe"?"psubscribe":t}});var mg=x(uu=>{"use strict";Object.defineProperty(uu,"__esModule",{value:!0});var pg=mt(),TA=de(),MA=hg(),DA=dg(),$A=TA.Debug("dataHandler"),cu=class{constructor(e,r){this.redis=e;let n=new MA({stringNumbers:r.stringNumbers,returnBuffers:!r.dropBufferSupport,returnError:s=>{this.returnError(s)},returnFatalError:s=>{this.returnFatalError(s)},returnReply:s=>{this.returnReply(s)}});e.stream.on("data",s=>{n.execute(s)})}returnFatalError(e){e.message+=". Please report this.",this.redis.recoverFromFatalError(e,e,{offlineQueue:!1})}returnError(e){let r=this.shiftCommand(e);r&&(e.command={name:r.command.name,args:r.command.args},this.redis.handleReconnection(e,r))}returnReply(e){if(this.handleMonitorReply(e)||this.handleSubscriberReply(e))return;let r=this.shiftCommand(e);r&&(pg.default.checkFlag("ENTER_SUBSCRIBER_MODE",r.command.name)?(this.redis.condition.subscriber=new DA.default,this.redis.condition.subscriber.add(r.command.name,e[1].toString()),yg(r.command,e[2])||this.redis.commandQueue.unshift(r)):pg.default.checkFlag("EXIT_SUBSCRIBER_MODE",r.command.name)?gg(r.command,e[2])||this.redis.commandQueue.unshift(r):r.command.resolve(e))}handleSubscriberReply(e){if(!this.redis.condition.subscriber)return!1;let r=Array.isArray(e)?e[0].toString():null;switch($A('receive reply "%s" in subscriber mode',r),r){case"message":this.redis.listeners("message").length>0&&this.redis.emit("message",e[1].toString(),e[2]?e[2].toString():""),this.redis.emit("messageBuffer",e[1],e[2]);break;case"pmessage":{let n=e[1].toString();this.redis.listeners("pmessage").length>0&&this.redis.emit("pmessage",n,e[2].toString(),e[3].toString()),this.redis.emit("pmessageBuffer",n,e[2],e[3]);break}case"subscribe":case"psubscribe":{let n=e[1].toString();this.redis.condition.subscriber.add(r,n);let s=this.shiftCommand(e);if(!s)return;yg(s.command,e[2])||this.redis.commandQueue.unshift(s);break}case"unsubscribe":case"punsubscribe":{let n=e[1]?e[1].toString():null;n&&this.redis.condition.subscriber.del(r,n);let s=e[2];s===0&&(this.redis.condition.subscriber=!1);let i=this.shiftCommand(e);if(!i)return;gg(i.command,s)||this.redis.commandQueue.unshift(i);break}default:{let n=this.shiftCommand(e);if(!n)return;n.command.resolve(e)}}return!0}handleMonitorReply(e){if(this.redis.status!=="monitoring")return!1;let r=e.toString();if(r==="OK")return!1;let n=r.indexOf(" "),s=r.slice(0,n),i=r.indexOf('"'),o=r.slice(i+1,-1).split('" "').map(l=>l.replace(/\\"/g,'"')),c=r.slice(n+2,i-2).split(" ");return this.redis.emit("monitor",s,o,c[1],c[0]),!0}shiftCommand(e){let r=this.redis.commandQueue.shift();if(!r){let n="Command queue state error. If you can reproduce this, please report it.",s=new Error(n+(e instanceof Error?` Last error: ${e.message}`:` Last reply: ${e.toString()}`));return this.redis.emit("error",s),null}return r}};uu.default=cu;function yg(t,e){return typeof t.remainReplies>"u"&&(t.remainReplies=t.args.length),--t.remainReplies===0?(t.resolve(e),!0):!1}function gg(t,e){return typeof t.remainReplies>"u"&&(t.remainReplies=t.args.length),t.remainReplies===0?e===0?(t.resolve(e),!0):!1:--t.remainReplies===0?(t.resolve(e),!0):!1}});var _g=x(Lt=>{"use strict";Object.defineProperty(Lt,"__esModule",{value:!0});var NA=yr(),LA=mt(),jA=ng(),Un=de(),qA=mg(),xe=Un.Debug("connection");function BA(t){return function(){t.setStatus("connect"),t.resetCommandQueue();let e=!1,{connectionEpoch:r}=t;t.condition.auth&&t.auth(t.condition.auth,function(n){r===t.connectionEpoch&&n&&(n.message.indexOf("no password is set")!==-1?console.warn("[WARN] Redis server does not require a password, but a password was supplied."):n.message.indexOf("without any password configured for the default user")!==-1?console.warn("[WARN] This Redis server's `default` user does not require a password, but a password was supplied"):n.message.indexOf("wrong number of arguments for 'auth' command")!==-1?console.warn(`[ERROR] The server returned "wrong number of arguments for 'auth' command". You are probably passing both username and password to Redis version 5 or below. You should only pass the 'password' option for Redis version 5 and under.`):(e=!0,t.recoverFromFatalError(n,n)))}),t.condition.select&&t.select(t.condition.select).catch(n=>{t.silentEmit("error",n)}),t.options.enableReadyCheck||Lt.readyHandler(t)(),new qA.default(t,{stringNumbers:t.options.stringNumbers,dropBufferSupport:t.options.dropBufferSupport}),t.options.enableReadyCheck&&t._readyCheck(function(n,s){r===t.connectionEpoch&&(n?e||t.recoverFromFatalError(new Error("Ready check failed: "+n.message),n):(t.serverInfo=s,t.connector.check(s)?Lt.readyHandler(t)():t.disconnect(!0)))})}}Lt.connectHandler=BA;function lu(t){let e=new NA.AbortError("Command aborted due to connection close");return e.command={name:t.name,args:t.args},e}function FA(t){let e=0;for(let r=0;r<t.length;){let n=t.peekAt(r).command,s=n.pipelineIndex;if((s===void 0||s===0)&&(e=0),s!==void 0&&s!==e++){t.remove(r,1),n.reject(lu(n));continue}r++}}function UA(t){for(let e=0;e<t.length;){let r=t.peekAt(e).command;if(r.name==="multi")break;if(r.name==="exec"){t.remove(e,1),r.reject(lu(r));break}r.inTransaction?(t.remove(e,1),r.reject(lu(r))):e++}}function zA(t){return function(){if(t.setStatus("close"),t.prevCondition||(t.prevCondition=t.condition),t.commandQueue.length&&(FA(t.commandQueue),t.prevCommandQueue=t.commandQueue),t.offlineQueue.length&&UA(t.offlineQueue),t.clearAddedScriptHashesCleanInterval(),t.manuallyClosing)return t.manuallyClosing=!1,xe("skip reconnecting since the connection is manually closed."),e();if(typeof t.options.retryStrategy!="function")return xe("skip reconnecting because `retryStrategy` is not a function"),e();let r=t.options.retryStrategy(++t.retryAttempts);if(typeof r!="number")return xe("skip reconnecting because `retryStrategy` doesn't return a number"),e();xe("reconnect in %sms",r),t.setStatus("reconnecting",r),t.reconnectTimeout=setTimeout(function(){t.reconnectTimeout=null,t.connect().catch(Un.noop)},r);let{maxRetriesPerRequest:n}=t.options;typeof n=="number"&&(n<0?xe("maxRetriesPerRequest is negative, ignoring..."):t.retryAttempts%(n+1)===0&&(xe("reach maxRetriesPerRequest limitation, flushing command queue..."),t.flushQueue(new jA.MaxRetriesPerRequestError(n))))};function e(){t.setStatus("end"),t.flushQueue(new Error(Un.CONNECTION_CLOSED_ERROR_MSG))}}Lt.closeHandler=zA;function HA(t){return function(e){xe("error: %s",e),t.silentEmit("error",e)}}Lt.errorHandler=HA;function VA(t){return function(){if(t.setStatus("ready"),t.retryAttempts=0,t.options.monitor){t.call("monitor");let{sendCommand:r}=t;t.sendCommand=function(n){return LA.default.checkFlag("VALID_IN_MONITOR_MODE",n.name)?r.call(t,n):(n.reject(new Error("Connection is in monitoring mode, can't process commands.")),n.promise)},t.once("close",function(){delete t.sendCommand}),t.setStatus("monitoring");return}let e=t.prevCondition?t.prevCondition.select:t.condition.select;if(t.options.connectionName&&(xe("set the connection name [%s]",t.options.connectionName),t.client("setname",t.options.connectionName).catch(Un.noop)),t.options.readOnly&&(xe("set the connection to readonly mode"),t.readonly().catch(Un.noop)),t.prevCondition){let r=t.prevCondition;if(t.prevCondition=null,r.subscriber&&t.options.autoResubscribe){t.condition.select!==e&&(xe("connect to db [%d]",e),t.select(e));let n=r.subscriber.channels("subscribe");n.length&&(xe("subscribe %d channels",n.length),t.subscribe(n));let s=r.subscriber.channels("psubscribe");s.length&&(xe("psubscribe %d channels",s.length),t.psubscribe(s))}}if(t.prevCommandQueue)if(t.options.autoResendUnfulfilledCommands)for(xe("resend %d unfulfilled commands",t.prevCommandQueue.length);t.prevCommandQueue.length>0;){let r=t.prevCommandQueue.shift();r.select!==t.condition.select&&r.command.name!=="select"&&t.select(r.select),t.sendCommand(r.command,r.stream)}else t.prevCommandQueue=null;if(t.offlineQueue.length){xe("send %d commands in offline queue",t.offlineQueue.length);let r=t.offlineQueue;for(t.resetOfflineQueue();r.length>0;){let n=r.shift();n.select!==t.condition.select&&n.command.name!=="select"&&t.select(n.select),t.sendCommand(n.command,n.stream)}}t.condition.select!==e&&(xe("connect to db [%d]",e),t.select(e))}}Lt.readyHandler=VA});var Oi=x(hu=>{"use strict";Object.defineProperty(hu,"__esModule",{value:!0});var GA=de(),WA=GA.Debug("AbstractConnector"),fu=class{constructor(e){this.connecting=!1,this.disconnectTimeout=e}check(e){return!0}disconnect(){if(this.connecting=!1,this.stream){let e=this.stream,r=setTimeout(()=>{WA("stream %s:%s still open, destroying it",e.remoteAddress,e.remotePort),e.destroy()},this.disconnectTimeout);e.on("close",()=>clearTimeout(r)),e.end()}}};hu.default=fu});var pu=x(Ei=>{"use strict";Object.defineProperty(Ei,"__esModule",{value:!0});var JA=require("net"),QA=require("tls"),YA=de(),KA=Oi();function vg(t){return t.path}Ei.isIIpcConnectionOptions=vg;var du=class extends KA.default{constructor(e){super(e.disconnectTimeout),this.options=e}connect(e){let{options:r}=this;this.connecting=!0;let n;return vg(r)?n={path:r.path}:(n={},r.port!=null&&(n.port=r.port),r.host!=null&&(n.host=r.host),r.family!=null&&(n.family=r.family)),r.tls&&Object.assign(n,r.tls),new Promise((s,i)=>{process.nextTick(()=>{if(!this.connecting){i(new Error(YA.CONNECTION_CLOSED_ERROR_MSG));return}try{r.tls?this.stream=QA.connect(n):this.stream=JA.createConnection(n)}catch(o){i(o);return}this.stream.once("error",o=>{this.firstError=o}),s(this.stream)})})}};Ei.default=du});var bg=x(gu=>{"use strict";Object.defineProperty(gu,"__esModule",{value:!0});function XA(t,e){return(t.host||"127.0.0.1")===(e.host||"127.0.0.1")&&(t.port||26379)===(e.port||26379)}var yu=class{constructor(e){this.cursor=0,this.sentinels=e.slice(0)}next(){let e=this.cursor>=this.sentinels.length;return{done:e,value:e?void 0:this.sentinels[this.cursor++]}}reset(e){e&&this.sentinels.length>1&&this.cursor!==1&&this.sentinels.unshift(...this.sentinels.splice(this.cursor-1)),this.cursor=0}add(e){for(let r=0;r<this.sentinels.length;r++)if(XA(e,this.sentinels[r]))return!1;return this.sentinels.push(e),!0}toString(){return`${JSON.stringify(this.sentinels)} @${this.cursor}`}};gu.default=yu});var Sg=x(zn=>{"use strict";var ZA=zn&&zn.__awaiter||function(t,e,r,n){function s(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function c(a){try{u(n.next(a))}catch(f){o(f)}}function l(a){try{u(n.throw(a))}catch(f){o(f)}}function u(a){a.done?i(a.value):s(a.value).then(c,l)}u((n=n.apply(t,e||[])).next())})};Object.defineProperty(zn,"__esModule",{value:!0});var eI=de(),mu=eI.Debug("FailoverDetector"),xg="+switch-master",_u=class{constructor(e,r){this.isDisconnected=!1,this.connector=e,this.sentinels=r}cleanup(){this.isDisconnected=!0;for(let e of this.sentinels)e.client.disconnect()}subscribe(){return ZA(this,void 0,void 0,function*(){mu("Starting FailoverDetector");let e=[];for(let r of this.sentinels){let n=r.client.subscribe(xg).catch(s=>{mu("Failed to subscribe to failover messages on sentinel %s:%s (%s)",r.address.host||"127.0.0.1",r.address.port||26739,s.message)});e.push(n),r.client.on("message",s=>{!this.isDisconnected&&s===xg&&this.disconnect()})}yield Promise.all(e)})}disconnect(){this.isDisconnected=!0,mu("Failover detected, disconnecting"),this.connector.disconnect()}};zn.FailoverDetector=_u});var bu=x(Zr=>{"use strict";var Kr=Zr&&Zr.__awaiter||function(t,e,r,n){function s(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function c(a){try{u(n.next(a))}catch(f){o(f)}}function l(a){try{u(n.throw(a))}catch(f){o(f)}}function u(a){a.done?i(a.value):s(a.value).then(c,l)}u((n=n.apply(t,e||[])).next())})};Object.defineProperty(Zr,"__esModule",{value:!0});var tI=require("net"),Hn=de(),rI=require("tls"),nI=pu(),wg=bg();Zr.SentinelIterator=wg.default;var sI=Oi(),iI=gr(),oI=Sg(),Xr=Hn.Debug("SentinelConnector"),vu=class extends sI.default{constructor(e){if(super(e.disconnectTimeout),this.options=e,this.failoverDetector=null,this.emitter=null,!this.options.sentinels.length)throw new Error("Requires at least one sentinel to connect to.");if(!this.options.name)throw new Error("Requires the name of master.");this.sentinelIterator=new wg.default(this.options.sentinels)}check(e){let r=!e.role||this.options.role===e.role;return r||(Xr("role invalid, expected %s, but got %s",this.options.role,e.role),this.sentinelIterator.next(),this.sentinelIterator.next(),this.sentinelIterator.reset(!0)),r}disconnect(){super.disconnect(),this.failoverDetector&&this.failoverDetector.cleanup()}connect(e){this.connecting=!0,this.retryAttempts=0;let r,n=()=>Kr(this,void 0,void 0,function*(){let s=this.sentinelIterator.next();if(s.done){this.sentinelIterator.reset(!1);let l=typeof this.options.sentinelRetryStrategy=="function"?this.options.sentinelRetryStrategy(++this.retryAttempts):null,u=typeof l!="number"?"All sentinels are unreachable and retry is disabled.":`All sentinels are unreachable. Retrying from scratch after ${l}ms.`;r&&(u+=` Last error: ${r.message}`),Xr(u);let a=new Error(u);if(typeof l=="number")return e("error",a),yield new Promise(f=>setTimeout(f,l)),n();throw a}let i=null,o=null;try{i=yield this.resolve(s.value)}catch(l){o=l}if(!this.connecting)throw new Error(Hn.CONNECTION_CLOSED_ERROR_MSG);let c=s.value.host+":"+s.value.port;if(i)return Xr("resolved: %s:%s from sentinel %s",i.host,i.port,c),this.options.enableTLSForSentinelMode&&this.options.tls?(Object.assign(i,this.options.tls),this.stream=rI.connect(i)):this.stream=tI.createConnection(i),this.stream.once("connect",()=>this.initFailoverDetector()),this.stream.once("error",l=>{this.firstError=l}),this.stream;{let l=o?"failed to connect to sentinel "+c+" because "+o.message:"connected to sentinel "+c+" successfully, but got an invalid reply: "+i;return Xr(l),e("sentinelError",new Error(l)),o&&(r=o),n()}});return n()}updateSentinels(e){return Kr(this,void 0,void 0,function*(){if(!this.options.updateSentinels)return;let r=yield e.sentinel("sentinels",this.options.name);Array.isArray(r)&&(r.map(Hn.packObject).forEach(n=>{if((n.flags?n.flags.split(","):[]).indexOf("disconnected")===-1&&n.ip&&n.port){let i=this.sentinelNatResolve(Og(n));this.sentinelIterator.add(i)&&Xr("adding sentinel %s:%s",i.host,i.port)}}),Xr("Updated internal sentinels: %s",this.sentinelIterator))})}resolveMaster(e){return Kr(this,void 0,void 0,function*(){let r=yield e.sentinel("get-master-addr-by-name",this.options.name);return yield this.updateSentinels(e),this.sentinelNatResolve(Array.isArray(r)?{host:r[0],port:Number(r[1])}:null)})}resolveSlave(e){return Kr(this,void 0,void 0,function*(){let r=yield e.sentinel("slaves",this.options.name);if(!Array.isArray(r))return null;let n=r.map(Hn.packObject).filter(s=>s.flags&&!s.flags.match(/(disconnected|s_down|o_down)/));return this.sentinelNatResolve(aI(n,this.options.preferredSlaves))})}sentinelNatResolve(e){return!e||!this.options.natMap?e:this.options.natMap[`${e.host}:${e.port}`]||e}connectToSentinel(e,r){return new iI.default(Object.assign({port:e.port||26379,host:e.host,username:this.options.sentinelUsername||null,password:this.options.sentinelPassword||null,family:e.family||(nI.isIIpcConnectionOptions(this.options)?void 0:this.options.family),tls:this.options.sentinelTLS,retryStrategy:null,enableReadyCheck:!1,connectTimeout:this.options.connectTimeout,commandTimeout:this.options.sentinelCommandTimeout,dropBufferSupport:!0},r))}resolve(e){return Kr(this,void 0,void 0,function*(){let r=this.connectToSentinel(e);r.on("error",cI);try{return this.options.role==="slave"?yield this.resolveSlave(r):yield this.resolveMaster(r)}finally{r.disconnect()}})}initFailoverDetector(){var e;return Kr(this,void 0,void 0,function*(){if(!this.options.failoverDetector)return;this.sentinelIterator.reset(!0);let r=[];for(;r.length<this.options.sentinelMaxConnections;){let{done:n,value:s}=this.sentinelIterator.next();if(n)break;let i=this.connectToSentinel(s,{lazyConnect:!0,retryStrategy:this.options.sentinelReconnectStrategy});i.on("reconnecting",()=>{var o;(o=this.emitter)===null||o===void 0||o.emit("sentinelReconnecting")}),r.push({address:s,client:i})}this.sentinelIterator.reset(!1),this.failoverDetector&&this.failoverDetector.cleanup(),this.failoverDetector=new oI.FailoverDetector(this,r),yield this.failoverDetector.subscribe(),(e=this.emitter)===null||e===void 0||e.emit("failoverSubscribed")})}};Zr.default=vu;function aI(t,e){if(t.length===0)return null;let r;if(typeof e=="function")r=e(t);else if(e!==null&&typeof e=="object"){let n=Array.isArray(e)?e:[e];n.sort((s,i)=>(s.prio||(s.prio=1),i.prio||(i.prio=1),s.prio<i.prio?-1:s.prio>i.prio?1:0));for(let s=0;s<n.length;s++){for(let i=0;i<t.length;i++){let o=t[i];if(o.ip===n[s].ip&&o.port===n[s].port){r=o;break}}if(r)break}}return r||(r=Hn.sample(t)),Og(r)}function Og(t){return{host:t.ip,port:Number(t.port)}}function cI(){}});var Eg=x(ki=>{"use strict";Object.defineProperty(ki,"__esModule",{value:!0});var uI=pu();ki.StandaloneConnector=uI.default;var lI=bu();ki.SentinelConnector=lI.default});var Ci=x(Su=>{"use strict";Object.defineProperty(Su,"__esModule",{value:!0});var fI=require("stream"),xu=class extends fI.Readable{constructor(e){super(e),this.opt=e,this._redisCursor="0",this._redisDrained=!1}_read(){if(this._redisDrained){this.push(null);return}let e=[this._redisCursor];this.opt.key&&e.unshift(this.opt.key),this.opt.match&&e.push("MATCH",this.opt.match),this.opt.type&&e.push("TYPE",this.opt.type),this.opt.count&&e.push("COUNT",String(this.opt.count)),this.opt.redis[this.opt.command](e,(r,n)=>{if(r){this.emit("error",r);return}this._redisCursor=n[0]instanceof Buffer?n[0].toString():n[0],this._redisCursor==="0"&&(this._redisDrained=!0),this.push(n[1])})}close(){this._redisDrained=!0}};Su.default=xu});var Cg=x((u$,wu)=>{"use strict";var kg=(t,e,r)=>new Promise((n,s)=>{if(r=Object.assign({concurrency:1/0},r),typeof e!="function")throw new TypeError("Mapper function is required");let{concurrency:i}=r;if(!(typeof i=="number"&&i>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${i}\` (${typeof i})`);let o=[],c=t[Symbol.iterator](),l=!1,u=!1,a=0,f=0,h=()=>{if(l)return;let d=c.next(),p=f;if(f++,d.done){u=!0,a===0&&n(o);return}a++,Promise.resolve(d.value).then(y=>e(y,p)).then(y=>{o[p]=y,a--,h()},y=>{l=!0,s(y)})};for(let d=0;d<i&&(h(),!u);d++);});wu.exports=kg;wu.exports.default=kg});var ku=x(Eu=>{"use strict";Object.defineProperty(Eu,"__esModule",{value:!0});var hI=mt(),dI=require("util"),pI=yt(),Pg=Gr(),Ou=mi(),yI=Cg(),Ag=gt(),Ig=bi(),gI=de();function mI(t,e){let r=Ou(e[0]),n=t._groupsBySlot[r];for(let s=1;s<e.length;s++)if(t._groupsBySlot[Ou(e[s])]!==n)return-1;return r}function Ge(t){Ig.default.call(this),this.redis=t,this.isCluster=this.redis.constructor.name==="Cluster"||this.redis.isCluster,this.isPipeline=!0,this.options=t.options,this._queue=[],this._result=[],this._transactions=0,this._shaToScript={},Object.keys(t.scriptsSet).forEach(n=>{let s=t.scriptsSet[n];this._shaToScript[s.sha]=s,this[n]=t[n],this[n+"Buffer"]=t[n+"Buffer"]}),t.addedBuiltinSet.forEach(n=>{this[n]=t[n],this[n+"Buffer"]=t[n+"Buffer"]});let e=Ag.get();this.promise=new e((n,s)=>{this.resolve=n,this.reject=s});let r=this;Object.defineProperty(this,"length",{get:function(){return r._queue.length}})}Eu.default=Ge;Object.assign(Ge.prototype,Ig.default.prototype);Ge.prototype.fillResult=function(t,e){if(this._queue[e].name==="exec"&&Array.isArray(t[1])){let n=t[1].length;for(let s=0;s<n;s++){if(t[1][s]instanceof Error)continue;let i=this._queue[e-(n-s)];try{t[1][s]=i.transformReply(t[1][s])}catch(o){t[1][s]=o}}}if(this._result[e]=t,--this.replyPending)return;if(this.isCluster){let n=!0,s;for(let i=0;i<this._result.length;++i){let o=this._result[i][0],c=this._queue[i];if(o){if(c.name==="exec"&&o.message==="EXECABORT Transaction discarded because of previous errors.")continue;if(!s)s={name:o.name,message:o.message};else if(s.name!==o.name||s.message!==o.message){n=!1;break}}else if(!c.inTransaction&&!(Pg.exists(c.name)&&Pg.hasFlag(c.name,"readonly"))){n=!1;break}}if(s&&n){let i=this,o=s.message.split(" "),c=this._queue,l=!1;this._queue=[];for(let f=0;f<c.length;++f){if(o[0]==="ASK"&&!l&&c[f].name!=="asking"&&(!c[f-1]||c[f-1].name!=="asking")){let h=new hI.default("asking");h.ignore=!0,this.sendCommand(h)}c[f].initPromise(),this.sendCommand(c[f]),l=c[f].inTransaction}let u=!0;typeof this.leftRedirections>"u"&&(this.leftRedirections={});let a=function(){i.exec()};if(this.redis.handleError(s,this.leftRedirections,{moved:function(f,h){i.preferKey=h,i.redis.slots[o[1]]=[h],i.redis._groupsBySlot[o[1]]=i.redis._groupsIds[i.redis.slots[o[1]].join(";")],i.redis.refreshSlotsCache(),i.exec()},ask:function(f,h){i.preferKey=h,i.exec()},tryagain:a,clusterDown:a,connectionClosed:a,maxRedirections:()=>{u=!1},defaults:()=>{u=!1}}),u)return}}let r=0;for(let n=0;n<this._queue.length-r;++n)this._queue[n+r].ignore&&(r+=1),this._result[n]=this._result[n+r];this.resolve(this._result.slice(0,this._result.length-r))};Ge.prototype.sendCommand=function(t){this._transactions>0&&(t.inTransaction=!0);let e=this._queue.length;return t.pipelineIndex=e,t.promise.then(r=>{this.fillResult([null,r],e)}).catch(r=>{this.fillResult([r],e)}),this._queue.push(t),this};Ge.prototype.addBatch=function(t){let e,r,n;for(let s=0;s<t.length;++s)e=t[s],r=e[0],n=e.slice(1),this[r].apply(this,n);return this};var _I=Ge.prototype.multi;Ge.prototype.multi=function(){return this._transactions+=1,_I.apply(this,arguments)};var Rg=Ge.prototype.execBuffer,vI=Ge.prototype.exec;Ge.prototype.execBuffer=dI.deprecate(function(){return this._transactions>0&&(this._transactions-=1),Rg.apply(this,arguments)},"Pipeline#execBuffer: Use Pipeline#exec instead");Ge.prototype.exec=function(t){if(this.isCluster&&!this.redis.slots.length)return this.redis.status==="wait"&&this.redis.connect().catch(gI.noop),this.redis.delayUntilReady(i=>{if(i){t(i);return}this.exec(t)}),this.promise;if(this._transactions>0)return this._transactions-=1,(this.options.dropBufferSupport?vI:Rg).apply(this,arguments);this.nodeifiedPromise||(this.nodeifiedPromise=!0,pI.default(this.promise,t)),this._queue.length||this.resolve([]);let e;if(this.isCluster){let i=[];for(let o=0;o<this._queue.length;o++){let c=this._queue[o].getKeys();if(c.length&&i.push(c[0]),c.length&&Ou.generateMulti(c)<0)return this.reject(new Error("All the keys in a pipeline command should belong to the same slot")),this.promise}if(i.length){if(e=mI(this.redis,i),e<0)return this.reject(new Error("All keys in the pipeline should belong to the same slots allocation group")),this.promise}else e=Math.random()*16384|0}let r=[];for(let i=0;i<this._queue.length;++i){let o=this._queue[i];if(o.name!=="evalsha")continue;let c=this._shaToScript[o.args[0]];!c||this.redis._addedScriptHashes[c.sha]||r.includes(c)||r.push(c)}let n=this;if(!r.length)return s();if(this.isCluster)return yI(r,i=>n.redis.script("load",i.lua),{concurrency:10}).then(function(){for(let i=0;i<r.length;i++)n.redis._addedScriptHashes[r[i].sha]=!0}).then(s,this.reject),this.promise;return this.redis.script("exists",r.map(({sha:i})=>i)).then(function(i){let o=[];for(let l=0;l<i.length;++l)i[l]||o.push(r[l]);return Ag.get().all(o.map(function(l){return n.redis.script("load",l.lua)}))}).then(function(){for(let i=0;i<r.length;i++)n.redis._addedScriptHashes[r[i].sha]=!0}).then(s,this.reject),this.promise;function s(){let i="",o,c=n.replyPending=n._queue.length,l;n.isCluster&&(l={slot:e,redis:n.redis.connectionPool.nodes.all[n.preferKey]});let u=!1,a={write:function(f){if(f instanceof Buffer&&(u=!0),u?(o||(o=[]),typeof i=="string"&&(o.push(Buffer.from(i,"utf8")),i=void 0),o.push(typeof f=="string"?Buffer.from(f,"utf8"):f)):i+=f,!--c){let h;o?h=Buffer.concat(o):h=i,n.isCluster?l.redis.stream.write(h):n.redis.stream.write(h),c=n._queue.length,i="",o=void 0,u=!1}}};for(let f=0;f<n._queue.length;++f)n.redis.sendCommand(n._queue[f],a,l);return n.promise}}});var Iu=x(Au=>{"use strict";Object.defineProperty(Au,"__esModule",{value:!0});var Cu=de(),Pu=yt(),Tg=ku();function bI(t){t.pipeline=function(n){let s=new Tg.default(this);return Array.isArray(n)&&s.addBatch(n),s};let{multi:e}=t;t.multi=function(n,s){if(typeof s>"u"&&!Array.isArray(n)&&(s=n,n=null),s&&s.pipeline===!1)return e.call(this);let i=new Tg.default(this);i.multi(),Array.isArray(n)&&i.addBatch(n);let o=i.exec;i.exec=function(l){if(this.isCluster&&!this.redis.slots.length)return this.redis.status==="wait"&&this.redis.connect().catch(Cu.noop),Pu.default(new Promise((a,f)=>{this.redis.delayUntilReady(h=>{if(h){f(h);return}this.exec(i).then(a,f)})}),l);if(this._transactions>0&&o.call(i),this.nodeifiedPromise)return o.call(i);let u=o.call(i);return Pu.default(u.then(function(a){let f=a[a.length-1];if(typeof f>"u")throw new Error("Pipeline cannot be used to send any commands when the `exec()` has been called on it.");if(f[0]){f[0].previousErrors=[];for(let h=0;h<a.length-1;++h)a[h][0]&&f[0].previousErrors.push(a[h][0]);throw f[0]}return Cu.wrapMultiResult(f[1])}),l)};let{execBuffer:c}=i;return i.execBuffer=function(l){return this._transactions>0&&c.call(i),i.exec(l)},i};let{exec:r}=t;t.exec=function(n){return Pu.default(r.call(this).then(function(s){return Array.isArray(s)&&(s=Cu.wrapMultiResult(s)),s}),n)}}Au.addTransactionSupport=bI});var Mg=x(Ru=>{"use strict";Object.defineProperty(Ru,"__esModule",{value:!0});Ru.DEFAULT_REDIS_OPTIONS={port:6379,host:"localhost",family:4,connectTimeout:1e4,disconnectTimeout:2e3,retryStrategy:function(t){return Math.min(t*50,2e3)},keepAlive:0,noDelay:!0,connectionName:null,sentinels:null,name:null,role:"master",sentinelRetryStrategy:function(t){return Math.min(t*10,1e3)},sentinelReconnectStrategy:function(){return 6e4},natMap:null,enableTLSForSentinelMode:!1,updateSentinels:!0,failoverDetector:!1,username:null,password:null,db:0,dropBufferSupport:!1,enableOfflineQueue:!0,enableReadyCheck:!0,autoResubscribe:!0,autoResendUnfulfilledCommands:!0,lazyConnect:!1,keyPrefix:"",reconnectOnError:null,readOnly:!1,stringNumbers:!1,maxRetriesPerRequest:20,maxLoadingRetryTime:1e4,enableAutoPipelining:!1,autoPipeliningIgnoredCommands:[],maxScriptsCachingTime:6e4,sentinelMaxConnections:10}});var gr=x(Mu=>{"use strict";Object.defineProperty(Mu,"__esModule",{value:!0});var Bt=Hr(),xI=require("util"),Lg=require("events"),jg=yi(),Dg=mt(),qg=bi(),mr=de(),Tu=yt(),jt=_g(),$g=Eg(),SI=Ci(),Ng=Gr(),Bg=gt(),wI=Iu(),OI=Mg(),qt=mr.Debug("redis");Mu.default=G;function G(){if(!(this instanceof G))return console.error(new Error("Calling `Redis()` like a function is deprecated. Using `new Redis()` instead.").stack.replace("Error","Warning")),new G(arguments[0],arguments[1],arguments[2]);if(this.parseOptions(arguments[0],arguments[1],arguments[2]),Lg.EventEmitter.call(this),qg.default.call(this),this.resetCommandQueue(),this.resetOfflineQueue(),this.connectionEpoch=0,this.options.Connector)this.connector=new this.options.Connector(this.options);else if(this.options.sentinels){let t=new $g.SentinelConnector(this.options);t.emitter=this,this.connector=t}else this.connector=new $g.StandaloneConnector(this.options);this.retryAttempts=0,this._addedScriptHashes={},this._autoPipelines=new Map,this._runningAutoPipelines=new Set,Object.defineProperty(this,"autoPipelineQueueSize",{get(){let t=0;for(let e of this._autoPipelines.values())t+=e.length;return t}}),this.options.lazyConnect?this.setStatus("wait"):this.connect().catch(Bt.noop)}xI.inherits(G,Lg.EventEmitter);Object.assign(G.prototype,qg.default.prototype);G.createClient=function(...t){return new G(...t)};G.defaultOptions=OI.DEFAULT_REDIS_OPTIONS;G.prototype.resetCommandQueue=function(){this.commandQueue=new jg};G.prototype.resetOfflineQueue=function(){this.offlineQueue=new jg};G.prototype.parseOptions=function(){this.options={};let t=!1;for(let e=0;e<arguments.length;++e){let r=arguments[e];if(!(r===null||typeof r>"u"))if(typeof r=="object")Bt.defaults(this.options,r);else if(typeof r=="string")Bt.defaults(this.options,mr.parseURL(r)),r.startsWith("rediss://")&&(t=!0);else if(typeof r=="number")this.options.port=r;else throw new Error("Invalid argument "+r)}t&&Bt.defaults(this.options,{tls:!0}),Bt.defaults(this.options,G.defaultOptions),typeof this.options.port=="string"&&(this.options.port=parseInt(this.options.port,10)),typeof this.options.db=="string"&&(this.options.db=parseInt(this.options.db,10)),this.options.parser==="hiredis"&&console.warn("Hiredis parser is abandoned since ioredis v3.0, and JavaScript parser will be used"),this.options=mr.resolveTLSProfile(this.options)};G.prototype.setStatus=function(t,e){qt.enabled&&qt("status[%s]: %s -> %s",this._getDescription(),this.status||"[empty]",t),this.status=t,process.nextTick(this.emit.bind(this,t,e))};G.prototype.clearAddedScriptHashesCleanInterval=function(){this._addedScriptHashesCleanInterval&&(clearInterval(this._addedScriptHashesCleanInterval),this._addedScriptHashesCleanInterval=null)};G.prototype.connect=function(t){let e=Bg.get(),r=new e((n,s)=>{if(this.status==="connecting"||this.status==="connect"||this.status==="ready"){s(new Error("Redis is already connecting/connected"));return}this.clearAddedScriptHashesCleanInterval(),this._addedScriptHashes={},this._addedScriptHashesCleanInterval=setInterval(()=>{this._addedScriptHashes={}},this.options.maxScriptsCachingTime),this.connectionEpoch+=1,this.setStatus("connecting");let{options:i}=this;this.condition={select:i.db,auth:i.username?[i.username,i.password]:i.password,subscriber:!1};let o=this;Tu.default(this.connector.connect(function(c,l){o.silentEmit(c,l)}),function(c,l){if(c){o.flushQueue(c),o.silentEmit("error",c),s(c),o.setStatus("end");return}let u=i.tls?"secureConnect":"connect";if(i.sentinels&&!i.enableTLSForSentinelMode&&(u="connect"),o.stream=l,typeof i.keepAlive=="number"&&l.setKeepAlive(!0,i.keepAlive),l.connecting){if(l.once(u,jt.connectHandler(o)),i.connectTimeout){let h=!1;l.setTimeout(i.connectTimeout,function(){if(h)return;l.setTimeout(0),l.destroy();let d=new Error("connect ETIMEDOUT");d.errorno="ETIMEDOUT",d.code="ETIMEDOUT",d.syscall="connect",jt.errorHandler(o)(d)}),l.once(u,function(){h=!0,l.setTimeout(0)})}}else if(l.destroyed){let h=o.connector.firstError;h&&process.nextTick(()=>{jt.errorHandler(o)(h)}),process.nextTick(jt.closeHandler(o))}else process.nextTick(jt.connectHandler(o));l.destroyed||(l.once("error",jt.errorHandler(o)),l.once("close",jt.closeHandler(o))),i.noDelay&&l.setNoDelay(!0);let a=function(){o.removeListener("close",f),n()};var f=function(){o.removeListener("ready",a),s(new Error(mr.CONNECTION_CLOSED_ERROR_MSG))};o.once("ready",a),o.once("close",f)})});return Tu.default(r,t)};G.prototype.disconnect=function(t){this.clearAddedScriptHashesCleanInterval(),t||(this.manuallyClosing=!0),this.reconnectTimeout&&!t&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.status==="wait"?jt.closeHandler(this)():this.connector.disconnect()};G.prototype.end=function(){this.disconnect()};G.prototype.duplicate=function(t){return new G(Object.assign({},this.options,t||{}))};G.prototype.recoverFromFatalError=function(t,e,r){this.flushQueue(e,r),this.silentEmit("error",e),this.disconnect(!0)};G.prototype.handleReconnection=function(e,r){let n=!1;switch(this.options.reconnectOnError&&(n=this.options.reconnectOnError(e)),n){case 1:case!0:this.status!=="reconnecting"&&this.disconnect(!0),r.command.reject(e);break;case 2:this.status!=="reconnecting"&&this.disconnect(!0),this.condition.select!==r.select&&r.command.name!=="select"&&this.select(r.select),this.sendCommand(r.command);break;default:r.command.reject(e)}};G.prototype.flushQueue=function(t,e){e=Bt.defaults({},e,{offlineQueue:!0,commandQueue:!0});let r;if(e.offlineQueue)for(;this.offlineQueue.length>0;)r=this.offlineQueue.shift(),r.command.reject(t);if(e.commandQueue&&this.commandQueue.length>0)for(this.stream&&this.stream.removeAllListeners("data");this.commandQueue.length>0;)r=this.commandQueue.shift(),r.command.reject(t)};G.prototype._readyCheck=function(t){let e=this;this.info(function(r,n){if(r)return t(r);if(typeof n!="string")return t(null,n);let s={},i=n.split(`\r
`);for(let o=0;o<i.length;++o){let[c,...l]=i[o].split(":"),u=l.join(":");u&&(s[c]=u)}if(!s.loading||s.loading==="0")t(null,s);else{let o=(s.loading_eta_seconds||1)*1e3,c=e.options.maxLoadingRetryTime&&e.options.maxLoadingRetryTime<o?e.options.maxLoadingRetryTime:o;qt("Redis server still loading, trying again in "+c+"ms"),setTimeout(function(){e._readyCheck(t)},c)}})};G.prototype.silentEmit=function(t){let e;if(!(t==="error"&&(e=arguments[1],this.status==="end"||this.manuallyClosing&&e instanceof Error&&(e.message===mr.CONNECTION_CLOSED_ERROR_MSG||e.syscall==="connect"||e.syscall==="read"))))return this.listeners(t).length>0?this.emit.apply(this,arguments):(e&&e instanceof Error&&console.error("[ioredis] Unhandled error event:",e.stack),!1)};G.prototype.monitor=function(t){let e=this.duplicate({monitor:!0,lazyConnect:!1}),r=Bg.get();return Tu.default(new r(function(n){e.once("monitoring",function(){n(e)})}),t)};wI.addTransactionSupport(G.prototype);G.prototype.sendCommand=function(t,e){if(this.status==="wait"&&this.connect().catch(Bt.noop),this.status==="end")return t.reject(new Error(mr.CONNECTION_CLOSED_ERROR_MSG)),t.promise;if(this.condition.subscriber&&!Dg.default.checkFlag("VALID_IN_SUBSCRIBER_MODE",t.name))return t.reject(new Error("Connection in subscriber mode, only subscriber commands may be used")),t.promise;typeof this.options.commandTimeout=="number"&&t.setTimeout(this.options.commandTimeout),t.name==="quit"&&this.clearAddedScriptHashesCleanInterval();let r=this.status==="ready"||!e&&this.status==="connect"&&Ng.exists(t.name)&&Ng.hasFlag(t.name,"loading");if(this.stream&&this.stream.writable?this.stream._writableState&&this.stream._writableState.ended&&(r=!1):r=!1,!r&&!this.options.enableOfflineQueue)return t.reject(new Error("Stream isn't writeable and enableOfflineQueue options is false")),t.promise;if(!r&&t.name==="quit"&&this.offlineQueue.length===0)return this.disconnect(),t.resolve(Buffer.from("OK")),t.promise;if(r?(qt.enabled&&qt("write command[%s]: %d -> %s(%o)",this._getDescription(),this.condition.select,t.name,t.args),(e||this.stream).write(t.toWritable()),this.commandQueue.push({command:t,stream:e,select:this.condition.select}),Dg.default.checkFlag("WILL_DISCONNECT",t.name)&&(this.manuallyClosing=!0)):this.options.enableOfflineQueue&&(qt.enabled&&qt("queue command[%s]: %d -> %s(%o)",this._getDescription(),this.condition.select,t.name,t.args),this.offlineQueue.push({command:t,stream:e,select:this.condition.select})),t.name==="select"&&mr.isInt(t.args[0])){let n=parseInt(t.args[0],10);this.condition.select!==n&&(this.condition.select=n,this.emit("select",n),qt("switch to db [%d]",this.condition.select))}return t.promise};G.prototype._getDescription=function(){let t;return this.options.path?t=this.options.path:this.stream&&this.stream.remoteAddress&&this.stream.remotePort?t=this.stream.remoteAddress+":"+this.stream.remotePort:t=this.options.host+":"+this.options.port,this.options.connectionName&&(t+=` (${this.options.connectionName})`),t};["scan","sscan","hscan","zscan","scanBuffer","sscanBuffer","hscanBuffer","zscanBuffer"].forEach(function(t){G.prototype[t+"Stream"]=function(e,r){return(t==="scan"||t==="scanBuffer")&&(r=e,e=null),new SI.default(Bt.defaults({objectMode:!0,key:e,redis:this,command:t},r))}})});var Fg=x($u=>{"use strict";Object.defineProperty($u,"__esModule",{value:!0});var EI=yr(),Du=class extends EI.RedisError{constructor(e,r){super(e),this.lastNodeError=r,Error.captureStackTrace(this,this.constructor)}get name(){return this.constructor.name}};$u.default=Du});var Pi=x(_t=>{"use strict";Object.defineProperty(_t,"__esModule",{value:!0});var Ug=de(),kI=require("net");function CI(t){return t.port=t.port||6379,t.host=t.host||"127.0.0.1",t.host+":"+t.port}_t.getNodeKey=CI;function PI(t){let e=t.lastIndexOf(":");if(e===-1)throw new Error(`Invalid node key ${t}`);return{host:t.slice(0,e),port:Number(t.slice(e+1))}}_t.nodeKeyToRedisOptions=PI;function AI(t){return t.map(e=>{let r={};if(typeof e=="object")Object.assign(r,e);else if(typeof e=="string")Object.assign(r,Ug.parseURL(e));else if(typeof e=="number")r.port=e;else throw new Error("Invalid argument "+e);return typeof r.port=="string"&&(r.port=parseInt(r.port,10)),delete r.db,r.port||(r.port=6379),r.host||(r.host="127.0.0.1"),Ug.resolveTLSProfile(r)})}_t.normalizeNodeOptions=AI;function II(t){let e={};return t.forEach(r=>{e[r.host]=!0}),Object.keys(e).filter(r=>!kI.isIP(r))}_t.getUniqueHostnamesFromOptions=II;function RI(t){let e={};for(let r of t)e.hasOwnProperty(r.priority)?(e[r.priority].totalWeight+=r.weight,e[r.priority].records.push(r)):e[r.priority]={totalWeight:r.weight,records:[r]};return e}_t.groupSrvRecords=RI;function TI(t){if(t.records.length===1)return t.totalWeight=0,t.records.shift();let e=Math.floor(Math.random()*(t.totalWeight+t.records.length)),r=0;for(let[n,s]of t.records.entries())if(r+=1+s.weight,r>e)return t.totalWeight-=s.weight,t.records.splice(n,1),s}_t.weightSrvRecords=TI;function MI(t,e){let r=`ioredis-cluster(${t})`;return e?`${r}:${e}`:r}_t.getConnectionName=MI});var Hg=x(Lu=>{"use strict";Object.defineProperty(Lu,"__esModule",{value:!0});var DI=require("events"),Ai=de(),zg=Pi(),$I=gr(),Vn=Ai.Debug("cluster:connectionPool"),Nu=class extends DI.EventEmitter{constructor(e){super(),this.redisOptions=e,this.nodes={all:{},master:{},slave:{}},this.specifiedOptions={}}getNodes(e="all"){let r=this.nodes[e];return Object.keys(r).map(n=>r[n])}getInstanceByKey(e){return this.nodes.all[e]}getSampleInstance(e){let r=Object.keys(this.nodes[e]),n=Ai.sample(r);return this.nodes[e][n]}findOrCreate(e,r=!1){let n=zg.getNodeKey(e);r=!!r,this.specifiedOptions[n]?Object.assign(e,this.specifiedOptions[n]):this.specifiedOptions[n]=e;let s;return this.nodes.all[n]?(s=this.nodes.all[n],s.options.readOnly!==r&&(s.options.readOnly=r,Vn("Change role of %s to %s",n,r?"slave":"master"),s[r?"readonly":"readwrite"]().catch(Ai.noop),r?(delete this.nodes.master[n],this.nodes.slave[n]=s):(delete this.nodes.slave[n],this.nodes.master[n]=s))):(Vn("Connecting to %s as %s",n,r?"slave":"master"),s=new $I.default(Ai.defaults({retryStrategy:null,enableOfflineQueue:!0,readOnly:r},e,this.redisOptions,{lazyConnect:!0})),this.nodes.all[n]=s,this.nodes[r?"slave":"master"][n]=s,s.once("end",()=>{this.removeNode(n),this.emit("-node",s,n),Object.keys(this.nodes.all).length||this.emit("drain")}),this.emit("+node",s,n),s.on("error",function(i){this.emit("nodeError",i,n)})),s}removeNode(e){let{nodes:r}=this;r.all[e]&&(Vn("Remove %s from the pool",e),delete r.all[e]),delete r.master[e],delete r.slave[e]}reset(e){Vn("Reset with %O",e);let r={};e.forEach(n=>{let s=zg.getNodeKey(n);n.readOnly&&r[s]||(r[s]=n)}),Object.keys(this.nodes.all).forEach(n=>{r[n]||(Vn("Disconnect %s because the node does not hold any slot",n),this.nodes.all[n].disconnect(),this.removeNode(n))}),Object.keys(r).forEach(n=>{let s=r[n];this.findOrCreate(s,s.readOnly)})}};Lu.default=Nu});var Gg=x(Bu=>{"use strict";Object.defineProperty(Bu,"__esModule",{value:!0});var Vg=Pi(),ju=de(),NI=gr(),Ft=ju.Debug("cluster:subscriber"),qu=class{constructor(e,r){this.connectionPool=e,this.emitter=r,this.started=!1,this.subscriber=null,this.connectionPool.on("-node",(n,s)=>{!this.started||!this.subscriber||Vg.getNodeKey(this.subscriber.options)===s&&(Ft("subscriber has left, selecting a new one..."),this.selectSubscriber())}),this.connectionPool.on("+node",()=>{!this.started||this.subscriber||(Ft("a new node is discovered and there is no subscriber, selecting a new one..."),this.selectSubscriber())})}getInstance(){return this.subscriber}selectSubscriber(){let e=this.lastActiveSubscriber;e&&e.disconnect(),this.subscriber&&this.subscriber.disconnect();let r=ju.sample(this.connectionPool.getNodes());if(!r){Ft("selecting subscriber failed since there is no node discovered in the cluster yet"),this.subscriber=null;return}let{options:n}=r;Ft("selected a subscriber %s:%s",n.host,n.port),this.subscriber=new NI.default({port:n.port,host:n.host,username:n.username,password:n.password,enableReadyCheck:!0,connectionName:Vg.getConnectionName("subscriber",n.connectionName),lazyConnect:!0,tls:n.tls}),this.subscriber.on("error",ju.noop);let s={subscribe:[],psubscribe:[]};if(e){let i=e.condition||e.prevCondition;i&&i.subscriber&&(s.subscribe=i.subscriber.channels("subscribe"),s.psubscribe=i.subscriber.channels("psubscribe"))}if(s.subscribe.length||s.psubscribe.length){let i=0;for(let o of["subscribe","psubscribe"]){let c=s[o];c.length&&(i+=1,Ft("%s %d channels",o,c.length),this.subscriber[o](c).then(()=>{--i||(this.lastActiveSubscriber=this.subscriber)}).catch(()=>{Ft("failed to %s %d channels",o,c.length)}))}}else this.lastActiveSubscriber=this.subscriber;for(let i of["message","messageBuffer"])this.subscriber.on(i,(o,c)=>{this.emitter.emit(i,o,c)});for(let i of["pmessage","pmessageBuffer"])this.subscriber.on(i,(o,c,l)=>{this.emitter.emit(i,o,c,l)})}start(){this.started=!0,this.selectSubscriber(),Ft("started")}stop(){this.started=!1,this.subscriber&&(this.subscriber.disconnect(),this.subscriber=null),Ft("stopped")}};Bu.default=qu});var Wg=x(Uu=>{"use strict";Object.defineProperty(Uu,"__esModule",{value:!0});var LI=de(),jI=yi(),qI=LI.Debug("delayqueue"),Fu=class{constructor(){this.queues={},this.timeouts={}}push(e,r,n){let s=n.callback||process.nextTick;this.queues[e]||(this.queues[e]=new jI),this.queues[e].push(r),this.timeouts[e]||(this.timeouts[e]=setTimeout(()=>{s(()=>{this.timeouts[e]=null,this.execute(e)})},n.timeout))}execute(e){let r=this.queues[e];if(!r)return;let{length:n}=r;if(n)for(qI("send %d commands in %s queue",n,e),this.queues[e]=null;r.length>0;)r.shift()()}};Uu.default=Fu});var Qg=x(zu=>{"use strict";Object.defineProperty(zu,"__esModule",{value:!0});var Jg=require("dns");zu.DEFAULT_CLUSTER_OPTIONS={clusterRetryStrategy:t=>Math.min(100+t*2,2e3),enableOfflineQueue:!0,enableReadyCheck:!0,scaleReads:"master",maxRedirections:16,retryDelayOnMoved:0,retryDelayOnFailover:100,retryDelayOnClusterDown:100,retryDelayOnTryAgain:100,slotsRefreshTimeout:1e3,slotsRefreshInterval:5e3,useSRVRecords:!1,resolveSrv:Jg.resolveSrv,dnsLookup:Jg.lookup,enableAutoPipelining:!1,autoPipeliningIgnoredCommands:[],maxScriptsCachingTime:6e4}});var tm=x(Vu=>{"use strict";Object.defineProperty(Vu,"__esModule",{value:!0});var BI=require("events"),FI=Fg(),Gn=de(),UI=Hg(),en=Pi(),zI=Gg(),HI=Wg(),VI=Ci(),Ii=yr(),Yg=yt(),Kg=gt(),GI=Qg(),vt=de(),Xg=Gr(),Zg=mt(),WI=gr(),Hu=bi(),em=yi(),ee=Gn.Debug("cluster"),_r=class t extends BI.EventEmitter{constructor(e,r={}){if(super(),this.slots=[],this.retryAttempts=0,this.delayQueue=new HI.default,this.offlineQueue=new em,this.isRefreshing=!1,this.isCluster=!0,this._autoPipelines=new Map,this._groupsIds={},this._groupsBySlot=Array(16384),this._runningAutoPipelines=new Set,this._readyDelayedCallbacks=[],this._addedScriptHashes={},this.connectionEpoch=0,Hu.default.call(this),this.startupNodes=e,this.options=Gn.defaults({},r,GI.DEFAULT_CLUSTER_OPTIONS,this.options),typeof this.options.scaleReads!="function"&&["all","master","slave"].indexOf(this.options.scaleReads)===-1)throw new Error('Invalid option scaleReads "'+this.options.scaleReads+'". Expected "all", "master", "slave" or a custom function');this.connectionPool=new UI.default(this.options.redisOptions),this.connectionPool.on("-node",(n,s)=>{this.emit("-node",n)}),this.connectionPool.on("+node",n=>{this.emit("+node",n)}),this.connectionPool.on("drain",()=>{this.setStatus("close")}),this.connectionPool.on("nodeError",(n,s)=>{this.emit("node error",n,s)}),this.subscriber=new zI.default(this.connectionPool,this),this.options.lazyConnect?this.setStatus("wait"):this.connect().catch(n=>{ee("connecting failed: %s",n)})}resetOfflineQueue(){this.offlineQueue=new em}clearNodesRefreshInterval(){this.slotsTimer&&(clearTimeout(this.slotsTimer),this.slotsTimer=null)}clearAddedScriptHashesCleanInterval(){this._addedScriptHashesCleanInterval&&(clearInterval(this._addedScriptHashesCleanInterval),this._addedScriptHashesCleanInterval=null)}resetNodesRefreshInterval(){if(this.slotsTimer)return;let e=()=>{this.slotsTimer=setTimeout(()=>{ee('refreshing slot caches... (triggered by "slotsRefreshInterval" option)'),this.refreshSlotsCache(()=>{e()})},this.options.slotsRefreshInterval)};e()}connect(){let e=Kg.get();return new e((r,n)=>{if(this.status==="connecting"||this.status==="connect"||this.status==="ready"){n(new Error("Redis is already connecting/connected"));return}this.clearAddedScriptHashesCleanInterval(),this._addedScriptHashesCleanInterval=setInterval(()=>{this._addedScriptHashes={}},this.options.maxScriptsCachingTime);let s=++this.connectionEpoch;this.setStatus("connecting"),this.resolveStartupNodeHostnames().then(i=>{if(this.connectionEpoch!==s){ee("discard connecting after resolving startup nodes because epoch not match: %d != %d",s,this.connectionEpoch),n(new Ii.RedisError("Connection is discarded because a new connection is made"));return}if(this.status!=="connecting"){ee("discard connecting after resolving startup nodes because the status changed to %s",this.status),n(new Ii.RedisError("Connection is aborted"));return}this.connectionPool.reset(i);function o(){this.setStatus("ready"),this.retryAttempts=0,this.executeOfflineCommands(),this.resetNodesRefreshInterval(),r()}let c,l=()=>{this.invokeReadyDelayedCallbacks(void 0),this.removeListener("close",c),this.manuallyClosing=!1,this.setStatus("connect"),this.options.enableReadyCheck?this.readyCheck((u,a)=>{u||a?(ee("Ready check failed (%s). Reconnecting...",u||a),this.status==="connect"&&this.disconnect(!0)):o.call(this)}):o.call(this)};c=function(){let u=new Error("None of startup nodes is available");this.removeListener("refresh",l),this.invokeReadyDelayedCallbacks(u),n(u)},this.once("refresh",l),this.once("close",c),this.once("close",this.handleCloseEvent.bind(this)),this.refreshSlotsCache(function(u){u&&u.message==="Failed to refresh slots cache."&&(WI.default.prototype.silentEmit.call(this,"error",u),this.connectionPool.reset([]))}.bind(this)),this.subscriber.start()}).catch(i=>{this.setStatus("close"),this.handleCloseEvent(i),this.invokeReadyDelayedCallbacks(i),n(i)})})}handleCloseEvent(e){e&&ee("closed because %s",e),this.clearAddedScriptHashesCleanInterval();let r;!this.manuallyClosing&&typeof this.options.clusterRetryStrategy=="function"&&(r=this.options.clusterRetryStrategy.call(this,++this.retryAttempts,e)),typeof r=="number"?(this.setStatus("reconnecting"),this.reconnectTimeout=setTimeout(function(){this.reconnectTimeout=null,ee("Cluster is disconnected. Retrying after %dms",r),this.connect().catch(function(n){ee("Got error %s when reconnecting. Ignoring...",n)})}.bind(this),r)):(this.setStatus("end"),this.flushQueue(new Error("None of startup nodes is available")))}disconnect(e=!1){let r=this.status;this.setStatus("disconnecting"),this.clearAddedScriptHashesCleanInterval(),e||(this.manuallyClosing=!0),this.reconnectTimeout&&!e&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null,ee("Canceled reconnecting attempts")),this.clearNodesRefreshInterval(),this.subscriber.stop(),r==="wait"?(this.setStatus("close"),this.handleCloseEvent()):this.connectionPool.reset([])}quit(e){let r=this.status;this.setStatus("disconnecting"),this.clearAddedScriptHashesCleanInterval(),this.manuallyClosing=!0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.clearNodesRefreshInterval(),this.subscriber.stop();let n=Kg.get();if(r==="wait"){let s=Yg.default(n.resolve("OK"),e);return setImmediate(function(){this.setStatus("close"),this.handleCloseEvent()}.bind(this)),s}return Yg.default(n.all(this.nodes().map(s=>s.quit().catch(i=>{if(i.message===vt.CONNECTION_CLOSED_ERROR_MSG)return"OK";throw i}))).then(()=>"OK"),e)}duplicate(e=[],r={}){let n=e.length>0?e:this.startupNodes.slice(0),s=Object.assign({},this.options,r);return new t(n,s)}nodes(e="all"){if(e!=="all"&&e!=="master"&&e!=="slave")throw new Error('Invalid role "'+e+'". Expected "all", "master" or "slave"');return this.connectionPool.getNodes(e)}delayUntilReady(e){this._readyDelayedCallbacks.push(e)}get autoPipelineQueueSize(){let e=0;for(let r of this._autoPipelines.values())e+=r.length;return e}setStatus(e){ee("status: %s -> %s",this.status||"[empty]",e),this.status=e,process.nextTick(()=>{this.emit(e)})}refreshSlotsCache(e){if(this.isRefreshing){typeof e=="function"&&process.nextTick(e);return}this.isRefreshing=!0;let r=this,n=function(c){r.isRefreshing=!1,typeof e=="function"&&e(c)},s=vt.shuffle(this.connectionPool.getNodes()),i=null;function o(c){if(c===s.length){let a=new FI.default("Failed to refresh slots cache.",i);return n(a)}let l=s[c],u=`${l.options.host}:${l.options.port}`;ee("getting slot cache from %s",u),r.getInfoFromNode(l,function(a){switch(r.status){case"close":case"end":return n(new Error("Cluster is disconnected."));case"disconnecting":return n(new Error("Cluster is disconnecting."))}a?(r.emit("node error",a,u),i=a,o(c+1)):(r.emit("refresh"),n())})}o(0)}flushQueue(e){let r;for(;this.offlineQueue.length>0;)r=this.offlineQueue.shift(),r.command.reject(e)}executeOfflineCommands(){if(this.offlineQueue.length){ee("send %d commands in offline queue",this.offlineQueue.length);let e=this.offlineQueue;for(this.resetOfflineQueue();e.length>0;){let r=e.shift();this.sendCommand(r.command,r.stream,r.node)}}}natMapper(e){if(this.options.natMap&&typeof this.options.natMap=="object"){let r=typeof e=="string"?e:`${e.host}:${e.port}`,n=this.options.natMap[r];if(n)return ee("NAT mapping %s -> %O",r,n),Object.assign({},n)}return typeof e=="string"?en.nodeKeyToRedisOptions(e):e}sendCommand(e,r,n){if(this.status==="wait"&&this.connect().catch(Gn.noop),this.status==="end")return e.reject(new Error(vt.CONNECTION_CLOSED_ERROR_MSG)),e.promise;let s=this.options.scaleReads;s!=="master"&&(e.isReadOnly||Xg.exists(e.name)&&Xg.hasFlag(e.name,"readonly")||(s="master"));let i=n?n.slot:e.getSlot(),o={},c=this;if(!n&&!e.__is_reject_overwritten){e.__is_reject_overwritten=!0;let u=e.reject;e.reject=function(a){let f=l.bind(null,!0);c.handleError(a,o,{moved:function(h,d){ee("command %s is moved to %s",e.name,d),i=Number(h),c.slots[h]?c.slots[h][0]=d:c.slots[h]=[d],c._groupsBySlot[h]=c._groupsIds[c.slots[h].join(";")],c.connectionPool.findOrCreate(c.natMapper(d)),l(),ee("refreshing slot caches... (triggered by MOVED error)"),c.refreshSlotsCache()},ask:function(h,d){ee("command %s is required to ask %s:%s",e.name,d);let p=c.natMapper(d);c.connectionPool.findOrCreate(p),l(!1,`${p.host}:${p.port}`)},tryagain:f,clusterDown:f,connectionClosed:f,maxRedirections:function(h){u.call(e,h)},defaults:function(){u.call(e,a)}})}}l();function l(u,a){if(c.status==="end"){e.reject(new Ii.AbortError("Cluster is ended."));return}let f;if(c.status==="ready"||e.name==="cluster"){if(n&&n.redis)f=n.redis;else if(Zg.default.checkFlag("ENTER_SUBSCRIBER_MODE",e.name)||Zg.default.checkFlag("EXIT_SUBSCRIBER_MODE",e.name)){if(f=c.subscriber.getInstance(),!f){e.reject(new Ii.AbortError("No subscriber for the cluster"));return}}else{if(!u){if(typeof i=="number"&&c.slots[i]){let h=c.slots[i];if(typeof s=="function"){let d=h.map(function(p){return c.connectionPool.getInstanceByKey(p)});f=s(d,e),Array.isArray(f)&&(f=vt.sample(f)),f||(f=d[0])}else{let d;s==="all"?d=vt.sample(h):s==="slave"&&h.length>1?d=vt.sample(h,1):d=h[0],f=c.connectionPool.getInstanceByKey(d)}}a&&(f=c.connectionPool.getInstanceByKey(a),f.asking())}f||(f=(typeof s=="function"?null:c.connectionPool.getSampleInstance(s))||c.connectionPool.getSampleInstance("all"))}n&&!n.redis&&(n.redis=f)}f?f.sendCommand(e,r):c.options.enableOfflineQueue?c.offlineQueue.push({command:e,stream:r,node:n}):e.reject(new Error("Cluster isn't ready and enableOfflineQueue options is false"))}return e.promise}handleError(e,r,n){if(typeof r.value>"u"?r.value=this.options.maxRedirections:r.value-=1,r.value<=0){n.maxRedirections(new Error("Too many Cluster redirections. Last error: "+e));return}let s=e.message.split(" ");if(s[0]==="MOVED"){let i=this.options.retryDelayOnMoved;i&&typeof i=="number"?this.delayQueue.push("moved",n.moved.bind(null,s[1],s[2]),{timeout:i}):n.moved(s[1],s[2])}else s[0]==="ASK"?n.ask(s[1],s[2]):s[0]==="TRYAGAIN"?this.delayQueue.push("tryagain",n.tryagain,{timeout:this.options.retryDelayOnTryAgain}):s[0]==="CLUSTERDOWN"&&this.options.retryDelayOnClusterDown>0?this.delayQueue.push("clusterdown",n.connectionClosed,{timeout:this.options.retryDelayOnClusterDown,callback:this.refreshSlotsCache.bind(this)}):e.message===vt.CONNECTION_CLOSED_ERROR_MSG&&this.options.retryDelayOnFailover>0&&this.status==="ready"?this.delayQueue.push("failover",n.connectionClosed,{timeout:this.options.retryDelayOnFailover,callback:this.refreshSlotsCache.bind(this)}):n.defaults()}getInfoFromNode(e,r){if(!e)return r(new Error("Node is disconnected"));let n=e.duplicate({enableOfflineQueue:!0,enableReadyCheck:!1,retryStrategy:null,connectionName:en.getConnectionName("refresher",this.options.redisOptions&&this.options.redisOptions.connectionName)});n.on("error",Gn.noop),n.cluster("slots",vt.timeout((s,i)=>{if(n.disconnect(),s)return r(s);if(this.status==="disconnecting"||this.status==="close"||this.status==="end"){ee("ignore CLUSTER.SLOTS results (count: %d) since cluster status is %s",i.length,this.status),r();return}let o=[];ee("cluster slots result count: %d",i.length);for(let l=0;l<i.length;++l){let u=i[l],a=u[0],f=u[1],h=[];for(let d=2;d<u.length;d++)u[d][0]&&(u[d]=this.natMapper({host:u[d][0],port:u[d][1]}),u[d].readOnly=d!==2,o.push(u[d]),h.push(u[d].host+":"+u[d].port));ee("cluster slots result [%d]: slots %d~%d served by %s",l,a,f,h);for(let d=a;d<=f;d++)this.slots[d]=h}this._groupsIds=Object.create(null);let c=0;for(let l=0;l<16384;l++){let u=(this.slots[l]||[]).join(";");if(!u.length){this._groupsBySlot[l]=void 0;continue}this._groupsIds[u]||(this._groupsIds[u]=++c),this._groupsBySlot[l]=this._groupsIds[u]}this.connectionPool.reset(o),r()},this.options.slotsRefreshTimeout))}invokeReadyDelayedCallbacks(e){for(let r of this._readyDelayedCallbacks)process.nextTick(r,e);this._readyDelayedCallbacks=[]}readyCheck(e){this.cluster("info",function(r,n){if(r)return e(r);if(typeof n!="string")return e();let s,i=n.split(`\r
`);for(let o=0;o<i.length;++o){let c=i[o].split(":");if(c[0]==="cluster_state"){s=c[1];break}}s==="fail"?(ee("cluster state not ok (%s)",s),e(null,s)):e()})}resolveSrv(e){return new Promise((r,n)=>{this.options.resolveSrv(e,(s,i)=>{if(s)return n(s);let o=this,c=en.groupSrvRecords(i),l=Object.keys(c).sort((a,f)=>parseInt(a)-parseInt(f));function u(a){if(!l.length)return n(a);let f=l[0],h=c[f],d=en.weightSrvRecords(h);h.records.length||l.shift(),o.dnsLookup(d.name).then(p=>r({host:p,port:d.port}),u)}u()})})}dnsLookup(e){return new Promise((r,n)=>{this.options.dnsLookup(e,(s,i)=>{s?(ee("failed to resolve hostname %s to IP: %s",e,s.message),n(s)):(ee("resolved hostname %s to IP %s",e,i),r(i))})})}resolveStartupNodeHostnames(){if(!Array.isArray(this.startupNodes)||this.startupNodes.length===0)return Promise.reject(new Error("`startupNodes` should contain at least one node."));let e=en.normalizeNodeOptions(this.startupNodes),r=en.getUniqueHostnamesFromOptions(e);return r.length===0?Promise.resolve(e):Promise.all(r.map((this.options.useSRVRecords?this.resolveSrv:this.dnsLookup).bind(this))).then(n=>{let s=vt.zipMap(r,n);return e.map(i=>{let o=s.get(i.host);return o?this.options.useSRVRecords?Object.assign({},i,o):Object.assign({},i,{host:o}):i})})}};Object.getOwnPropertyNames(Hu.default.prototype).forEach(t=>{_r.prototype.hasOwnProperty(t)||(_r.prototype[t]=Hu.default.prototype[t])});var JI=["sscan","hscan","zscan","sscanBuffer","hscanBuffer","zscanBuffer"];JI.forEach(t=>{_r.prototype[t+"Stream"]=function(e,r){return new VI.default(Gn.defaults({objectMode:!0,key:e,redis:this,command:t},r))}});Iu().addTransactionSupport(_r.prototype);Vu.default=_r});var Gu=x((Pe,sm)=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe=sm.exports=gr().default;var QI=gr();Pe.default=QI.default;var YI=tm();Pe.Cluster=YI.default;var KI=mt();Pe.Command=KI.default;var XI=Ci();Pe.ScanStream=XI.default;var ZI=ku();Pe.Pipeline=ZI.default;var eR=Oi();Pe.AbstractConnector=eR.default;var nm=bu();Pe.SentinelConnector=nm.default;Pe.SentinelIterator=nm.SentinelIterator;Pe.ReplyError=yr().ReplyError;var rm=gt();Object.defineProperty(Pe,"Promise",{get(){return rm.get()},set(t){rm.set(t)}});function tR(t,e){console.log(t?"Error: "+t:"Reply: "+e)}Pe.print=tR});var am=x((x$,om)=>{var Ju=Object.defineProperty,rR=Object.getOwnPropertyDescriptor,nR=Object.getOwnPropertyNames,sR=Object.prototype.hasOwnProperty,iR=(t,e)=>{for(var r in e)Ju(t,r,{get:e[r],enumerable:!0})},oR=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of nR(e))!sR.call(t,s)&&s!==r&&Ju(t,s,{get:()=>e[s],enumerable:!(n=rR(e,s))||n.enumerable});return t},aR=t=>oR(Ju({},"__esModule",{value:!0}),t),im={};iR(im,{Query:()=>Wu});om.exports=aR(im);var Wu=class{rooms;conditions;order=new Map;constructor(e,r){this.conditions=r,this.rooms=e}sort(e){this.order.clear();let r=Object.entries(e);if(r.length)for(let[n,s]of r)s===1||s==="asc"||s==="ascending"?this.order.set(n,1):this.order.set(n,-1);return this}then(e,r){return this.rooms.then(n=>{this.order.size&&n.sort((o,c)=>{for(let[l,u]of this.order)if(u===1){if(o[l]>c[l])return 1;if(o[l]<c[l])return-1}else{if(o[l]>c[l])return-1;if(o[l]<c[l])return 1}});let s=Object.entries(this.conditions),i=s.length>0;return e(n.find(o=>{if(i){for(let[c,l]of s)if(o[c]!==l)return!1}return!0}))})}}});var lm=x((S$,um)=>{var Yu=Object.defineProperty,cR=Object.getOwnPropertyDescriptor,uR=Object.getOwnPropertyNames,lR=Object.prototype.hasOwnProperty,fR=(t,e)=>{for(var r in e)Yu(t,r,{get:e[r],enumerable:!0})},hR=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of uR(e))!lR.call(t,s)&&s!==r&&Yu(t,s,{get:()=>e[s],enumerable:!(n=cR(e,s))||n.enumerable});return t},dR=t=>hR(Yu({},"__esModule",{value:!0}),t),cm={};fR(cm,{RoomData:()=>Qu});um.exports=dR(cm);var pR=rt(),Qu=class{clients=0;locked=!1;private=!1;maxClients=1/0;metadata;name;publicAddress;processId;roomId;createdAt;unlisted=!1;#e;#t=!1;constructor(e,r){this.#e=r,this.createdAt=e.createdAt?new Date(e.createdAt):new Date;for(let n in e)e.hasOwnProperty(n)&&(this[n]=e[n])}toJSON(){return{clients:this.clients,createdAt:this.createdAt,maxClients:this.maxClients,metadata:this.metadata,name:this.name,publicAddress:this.publicAddress,processId:this.processId,roomId:this.roomId}}async save(){if(!this.#t)if(this.roomId){let e=this.toJSON;this.toJSON=void 0;let r=JSON.stringify(this);this.toJSON=e,await this.hset("roomcaches",this.roomId,r)}else pR.logger.warn("RedisDriver: can't .save() without a `roomId`")}updateOne(e){if(e.$set)for(let r in e.$set)e.$set.hasOwnProperty(r)&&(this[r]=e.$set[r]);if(e.$inc)for(let r in e.$inc)e.$inc.hasOwnProperty(r)&&(this[r]+=e.$inc[r]);return this.save()}remove(){if(this.roomId)return this.#t=!0,this.hdel("roomcaches",this.roomId)}async hset(e,r,n){return await this.#e.hset(e,r,n)}async hdel(e,r){return await this.#e.hdel(e,r)}}});var pm=x((w$,dm)=>{var yR=Object.create,Ri=Object.defineProperty,gR=Object.getOwnPropertyDescriptor,mR=Object.getOwnPropertyNames,_R=Object.getPrototypeOf,vR=Object.prototype.hasOwnProperty,bR=(t,e)=>{for(var r in e)Ri(t,r,{get:e[r],enumerable:!0})},fm=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of mR(e))!vR.call(t,s)&&s!==r&&Ri(t,s,{get:()=>e[s],enumerable:!(n=gR(e,s))||n.enumerable});return t},xR=(t,e,r)=>(r=t!=null?yR(_R(t)):{},fm(e||!t||!t.__esModule?Ri(r,"default",{value:t,enumerable:!0}):r,t)),SR=t=>fm(Ri({},"__esModule",{value:!0}),t),hm={};bR(hm,{RedisDriver:()=>Xu});dm.exports=SR(hm);var wR=xR(Gu()),OR=am(),Ku=lm(),Xu=class{_client;constructor(e,r="roomcaches"){this._client=new wR.default(e)}createInstance(e={}){return new Ku.RoomData(e,this._client)}async has(e){return await this._client.hexists("roomcaches",e)===1}async find(e){return(await this.getRooms()).filter(n=>{if(!n.roomId)return!1;for(let s in e)if(e.hasOwnProperty(s)&&n[s]!==e[s])return!1;return!0})}findOne(e){return typeof e.roomId<"u"?new Promise((r,n)=>{this._client.hget("roomcaches",e.roomId).then(s=>{r(new Ku.RoomData(JSON.parse(s),this._client))}).catch(n)}):new OR.Query(this.getRooms(),e)}async getRooms(){return Object.entries(await this._client.hgetall("roomcaches")??[]).map(([,e])=>new Ku.RoomData(JSON.parse(e),this._client))}async shutdown(){await this._client.quit()}clear(){this._client.del("roomcaches")}}});var vm=x((O$,_m)=>{var ER=Object.create,Ti=Object.defineProperty,kR=Object.getOwnPropertyDescriptor,CR=Object.getOwnPropertyNames,PR=Object.getPrototypeOf,AR=Object.prototype.hasOwnProperty,IR=(t,e)=>{for(var r in e)Ti(t,r,{get:e[r],enumerable:!0})},gm=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of CR(e))!AR.call(t,s)&&s!==r&&Ti(t,s,{get:()=>e[s],enumerable:!(n=kR(e,s))||n.enumerable});return t},RR=(t,e,r)=>(r=t!=null?ER(PR(t)):{},gm(e||!t||!t.__esModule?Ti(r,"default",{value:t,enumerable:!0}):r,t)),TR=t=>gm(Ti({},"__esModule",{value:!0}),t),mm={};IR(mm,{RedisPresence:()=>Zu});_m.exports=TR(mm);var ym=RR(Gu()),Zu=class{sub;pub;subscriptions={};constructor(e){this.sub=new ym.default(e),this.pub=new ym.default(e),this.sub.setMaxListeners(0)}async subscribe(e,r){return this.subscriptions[e]||(this.subscriptions[e]=[]),this.subscriptions[e].push(r),this.sub.listeners("message").length===0&&this.sub.on("message",this.handleSubscription),await this.sub.subscribe(e),this}async unsubscribe(e,r){let n=this.subscriptions[e];if(n){if(r){let s=n.indexOf(r);n.splice(s,1)}else this.subscriptions[e]=[];return this.subscriptions[e].length===0&&(delete this.subscriptions[e],await this.sub.unsubscribe(e)),this}}async publish(e,r){r===void 0&&(r=!1),await this.pub.publish(e,JSON.stringify(r))}async exists(e){return(await this.pub.pubsub("channels",e)).length>0}async set(e,r){return new Promise(n=>this.pub.set(e,r,n))}async setex(e,r,n){return new Promise(s=>this.pub.setex(e,n,r,s))}async get(e){return new Promise((r,n)=>{this.pub.get(e,(s,i)=>{if(s)return n(s);r(i)})})}async del(e){return new Promise(r=>{this.pub.del(e,r)})}async sadd(e,r){return new Promise(n=>{this.pub.sadd(e,r,n)})}async smembers(e){return await this.pub.smembers(e)}async sismember(e,r){return await this.pub.sismember(e,r)}async srem(e,r){return await this.pub.srem(e,r)}async scard(e){return await this.pub.scard(e)}async sinter(...e){return await this.pub.sinter(...e)}async hset(e,r,n){return await this.pub.hset(e,r,n)}async hincrby(e,r,n){return new Promise((s,i)=>{this.pub.hincrby(e,r,n,(o,c)=>{if(o)return i(o);s(c)})})}async hget(e,r){return await this.pub.hget(e,r)}async hgetall(e){return await this.pub.hgetall(e)}async hdel(e,r){return await this.pub.hdel(e,r)}async hlen(e){return await this.pub.hlen(e)}async incr(e){return await this.pub.incr(e)}async decr(e){return await this.pub.decr(e)}shutdown(){this.sub.quit(),this.pub.quit()}handleSubscription=(e,r)=>{if(this.subscriptions[e])for(let n=0,s=this.subscriptions[e].length;n<s;n++)this.subscriptions[e][n](JSON.parse(r))}}});var rl=x((E$,km)=>{var MR=Object.create,$i=Object.defineProperty,DR=Object.getOwnPropertyDescriptor,$R=Object.getOwnPropertyNames,NR=Object.getPrototypeOf,LR=Object.prototype.hasOwnProperty,jR=(t,e)=>{for(var r in e)$i(t,r,{get:e[r],enumerable:!0})},Sm=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of $R(e))!LR.call(t,s)&&s!==r&&$i(t,s,{get:()=>e[s],enumerable:!(n=DR(e,s))||n.enumerable});return t},Ut=(t,e,r)=>(r=t!=null?MR(NR(t)):{},Sm(e||!t||!t.__esModule?$i(r,"default",{value:t,enumerable:!0}):r,t)),qR=t=>Sm($i({},"__esModule",{value:!0}),t),wm={};jR(wm,{default:()=>WR,getTransport:()=>Em,listen:()=>JR});km.exports=qR(wm);var BR=Ut(require("fs")),FR=Ut(require("os")),UR=Ut(require("http")),Mi=Ut(require("path")),zR=Ut(require("cors")),bm=Ut(require("express")),HR=Ut(ml()),xm=Ut(io()),se=rt(),VR=ty(),el;try{el=require("uwebsockets-express").default}catch{}function Om(){return"production"}function GR(){return(process.env.REGION||"unknown").toLowerCase()}function tl(t,e="none"){let r=[];t.forEach(s=>{r.push(Mi.default.resolve(Mi.default.dirname(require?.main?.filename||process.cwd()),"..",s)),r.push(Mi.default.resolve(process.cwd(),s))});let n=r.find(s=>BR.default.existsSync(s));n?(HR.default.config({path:n}),e!=="none"&&se.logger.info(`\u2705 ${Mi.default.basename(n)} loaded.`)):e==="both"&&se.logger.info(`\u2139\uFE0F  optional .env file not found: ${t.join(", ")}`)}process.env.COLYSEUS_CLOUD!==void 0&&tl([".env.cloud"]);tl([`.env.${Om()}`,".env"],"both");process.env.REGION!==void 0&&tl([`.env.${GR()}.${Om()}`],"success");var Di={displayLogs:"boolean",options:"object",getId:"function",initializeTransport:"function",initializeExpress:"function",initializeGameServer:"function",beforeListen:"function"};function WR(t){for(let e in t){if(!Di[e])throw new Error(`\u274C Invalid option '${e}'. Allowed options are: ${Object.keys(Di).join(", ")}`);if(t[e]!==void 0&&typeof t[e]!==Di[e])throw new Error(`\u274C Invalid type for ${e}: please provide a ${Di[e]} value.`)}return t}async function JR(t,e=Number(process.env.PORT||2567)){let r=t.options||{};t.displayLogs=t.displayLogs??!0,process.env.COLYSEUS_CLOUD!==void 0&&(e=2567);let n=Number(process.env.NODE_APP_INSTANCE||"0");if(e+=n,process.env.COLYSEUS_CLOUD!==void 0){let o=FR.default.cpus().length>1;if(!r.driver&&o){let c;try{c=pm().RedisDriver,r.driver=new c}catch{se.logger.warn(""),se.logger.warn("\u274C coult not initialize RedisDriver."),se.logger.warn("\u{1F449} npm install --save @colyseus/redis-driver"),se.logger.warn("")}}if(!r.presence&&o){let c;try{c=vm().RedisPresence,r.presence=new c}catch{se.logger.warn(""),se.logger.warn("\u274C coult not initialize RedisPresence."),se.logger.warn("\u{1F449} npm install --save @colyseus/redis-presence"),se.logger.warn("")}}r.publicAddress=process.env.SUBDOMAIN+"."+process.env.SERVER_NAME,o&&(r.publicAddress+="/"+e)}let s=await Em(t),i=new se.Server({...r,transport:s});return await t.initializeGameServer?.(i),await t.beforeListen?.(),process.env.COLYSEUS_CLOUD!==void 0?await i.listen(`/run/colyseus/${e}.sock`):await i.listen(e),typeof process.send=="function"&&process.send("ready"),t.displayLogs&&se.logger.info(`\u2694\uFE0F  Listening on http://localhost:${e}`),i}async function Em(t){let e;t.initializeTransport||(t.initializeTransport=s=>new VR.WebSocketTransport(s));let r=(0,bm.default)(),n=UR.default.createServer(r);return e=await t.initializeTransport({server:n}),t.initializeExpress&&e.app&&(typeof el=="function"?(t.displayLogs&&se.logger.info("\u2705 uWebSockets.js + Express compatibility enabled"),n=void 0,r=el(e.app)):(t.displayLogs&&(se.logger.warn(""),se.logger.warn("\u274C uWebSockets.js + Express compatibility mode couldn't be loaded, run the following command to fix:"),se.logger.warn("\u{1F449} npm install --save uwebsockets-express"),se.logger.warn("")),r=void 0)),r&&(r.use((0,zR.default)()),r.use(bm.default.json()),t.initializeExpress&&await t.initializeExpress(r),r.get("/__cloudstats",async(s,i)=>{if(process.env.CLOUD_SECRET&&s.headers.authorization!==process.env.CLOUD_SECRET){i.status(401).end();return}let o=await se.matchMaker.presence.hgetall("roomcount"),c=0;for(let f in o)c+=Number(o[f]);let l=await se.matchMaker.presence.get("_ccu"),u=await xm.default.mem.used(),a=await xm.default.cpu.usage()/100;i.json({version:1,mem:u.usedMemMb/u.totalMemMb,cpu:a,ccu:l,rooms:c})}),t.displayLogs&&se.logger.info("\u2705 Express initialized")),e}});var Rm=x(zt=>{"use strict";var nl=zt&&zt.__awaiter||function(t,e,r,n){function s(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function c(a){try{u(n.next(a))}catch(f){o(f)}}function l(a){try{u(n.throw(a))}catch(f){o(f)}}function u(a){a.done?i(a.value):s(a.value).then(c,l)}u((n=n.apply(t,e||[])).next())})},Im=zt&&zt.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(zt,"__esModule",{value:!0});zt.getAPI=void 0;var sl=rt(),YR=Im(require("express")),Pm=Im(io()),Am="@colyseus/monitor: room $roomId is not available anymore.";function KR(t){let e=YR.default.Router();return e.get("/",(r,n)=>nl(this,void 0,void 0,function*(){try{let s=yield sl.matchMaker.query({}),i=t.columns||["roomId","name","clients","maxClients","locked","elapsedTime"];!t.columns&&s[0]&&s[0].publicAddress!==void 0&&i.push("publicAddress");let o=0;n.json({columns:i,rooms:s.map(c=>{let l=JSON.parse(JSON.stringify(c));return o+=c.clients,l.locked=c.locked||!1,l.private=c.private,l.maxClients=`${c.maxClients}`,l.elapsedTime=Date.now()-new Date(c.createdAt).getTime(),l}),connections:o,cpu:yield Pm.default.cpu.usage(),memory:yield Pm.default.mem.used()})}catch(s){let i=s.message;console.error(i),n.status(500),n.json({message:i})}})),e.get("/room",(r,n)=>nl(this,void 0,void 0,function*(){let s=r.query.roomId;try{let i=yield sl.matchMaker.remoteRoomCall(s,"getInspectData");n.json(i)}catch{let o=Am.replace("$roomId",s);console.error(o),n.status(500),n.json({message:o})}})),e.get("/room/call",(r,n)=>nl(this,void 0,void 0,function*(){let s=r.query.roomId,i=r.query.method,o=JSON.parse(r.query.args);try{let c=yield sl.matchMaker.remoteRoomCall(s,i,o);n.json(c)}catch{let l=Am.replace("$roomId",s);console.error(l),n.status(500),n.json({message:l})}})),e}zt.getAPI=KR});var Mm=x(Ni=>{"use strict";var Li=Ni&&Ni.__awaiter||function(t,e,r,n){function s(i){return i instanceof r?i:new r(function(o){o(i)})}return new(r||(r=Promise))(function(i,o){function c(a){try{u(n.next(a))}catch(f){o(f)}}function l(a){try{u(n.throw(a))}catch(f){o(f)}}function u(a){a.done?i(a.value):s(a.value).then(c,l)}u((n=n.apply(t,e||[])).next())})};Object.defineProperty(Ni,"__esModule",{value:!0});var Wn=rt();function Tm(t){let r=(t._serializer.state||t._serializer.previousState)&&t._serializer.getFullState();return r&&(r.byteLength||r.length)||0}Wn.Room.prototype.getAvailableData=function(){return{clients:this.clients.length,maxClients:this.maxClients,metadata:this.metadata,roomId:this.roomId}};Wn.Room.prototype.getRoomListData=function(){return Li(this,void 0,void 0,function*(){let t=Tm(this),e=this.clock.elapsedTime,r=this.locked,n=this.getAvailableData();return Object.assign(Object.assign({},n),{locked:r,elapsedTime:e,stateSize:t})})};Wn.Room.prototype.getInspectData=function(){return Li(this,void 0,void 0,function*(){let t=this.state,e=Tm(this),r=this.getAvailableData(),n=this.clients.map(i=>({sessionId:i.sessionId})),s=this.locked;return Object.assign(Object.assign({},r),{locked:s,clients:n,state:t,stateSize:e})})};Wn.Room.prototype._forceClientDisconnect=function(t){return Li(this,void 0,void 0,function*(){for(let e=0;e<this.clients.length;e++)if(this.clients[e].sessionId===t){this.clients[e].leave();break}})};Wn.Room.prototype._sendMessageToClient=function(t,e,r){return Li(this,void 0,void 0,function*(){for(let n=0;n<this.clients.length;n++)if(this.clients[n].sessionId===t){this.clients[n].send(e,r);break}})}});var Nm=x(tn=>{"use strict";var $m=tn&&tn.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(tn,"__esModule",{value:!0});tn.monitor=void 0;var Dm=$m(require("express")),XR=$m(require("path")),ZR=Rm();Mm();var eT=XR.default.resolve(__dirname,"..","build","static");function tT(t={}){let e=Dm.default.Router();return e.use(Dm.default.static(eT)),e.use("/api",(0,ZR.getAPI)(t)),e}tn.monitor=tT});var Fm=x((A$,Bm)=>{"use strict";var il=Object.defineProperty,rT=Object.getOwnPropertyDescriptor,nT=Object.getOwnPropertyNames,sT=Object.prototype.hasOwnProperty,iT=(t,e)=>{for(var r in e)il(t,r,{get:e[r],enumerable:!0})},oT=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of nT(e))!sT.call(t,s)&&s!==r&&il(t,s,{get:()=>e[s],enumerable:!(n=rT(e,s))||n.enumerable});return t},aT=t=>oT(il({},"__esModule",{value:!0}),t),Lm={};iT(Lm,{allRoomNames:()=>qm});Bm.exports=aT(Lm);var jm=rt(),cT=jm.Server.prototype.define,qm=[];jm.Server.prototype.define=function(t,e,r){qm.push(t);let n=cT.call(this,t,e,r);return n.on("join",(s,i)=>{i.send("__playground_message_types",Object.keys(s.onMessageHandlers))}),n}});var Wm=x((I$,Gm)=>{"use strict";var uT=Object.create,ji=Object.defineProperty,lT=Object.getOwnPropertyDescriptor,fT=Object.getOwnPropertyNames,hT=Object.getPrototypeOf,dT=Object.prototype.hasOwnProperty,pT=(t,e)=>{for(var r in e)ji(t,r,{get:e[r],enumerable:!0})},Um=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of fT(e))!dT.call(t,s)&&s!==r&&ji(t,s,{get:()=>e[s],enumerable:!(n=lT(e,s))||n.enumerable});return t},zm=(t,e,r)=>(r=t!=null?uT(hT(t)):{},Um(e||!t||!t.__esModule?ji(r,"default",{value:t,enumerable:!0}):r,t)),yT=t=>Um(ji({},"__esModule",{value:!0}),t),Hm={};pT(Hm,{playground:()=>ol});Gm.exports=yT(Hm);var gT=zm(require("path")),Vm=zm(require("express")),mT=rt(),_T=Fm(),ol=Vm.default.Router();ol.use("/",Vm.default.static(gT.default.resolve(__dirname,"..","build")));ol.get("/rooms",async(t,e)=>{let r=await mT.matchMaker.driver.find({}),n={},s={};r.forEach(i=>{n[i.name]||(n[i.name]=0),n[i.name]++,s[i.roomId]=i}),e.json({rooms:_T.allRoomNames,roomsByType:n,roomsById:s})})});var p_=sn(rl());var Cm="commo1hhhhhhhhn";var f_=sn(rl()),h_=sn(Nm()),B$=sn(Wm());var l_=sn(rt());var $;(function(t){t[t.ADD=128]="ADD",t[t.REPLACE=0]="REPLACE",t[t.DELETE=64]="DELETE",t[t.DELETE_AND_ADD=192]="DELETE_AND_ADD",t[t.TOUCH=1]="TOUCH",t[t.CLEAR=10]="CLEAR"})($||($={}));var br=class t{ref;refId;root;parent;parentIndex;indexes;changed=!1;changes=new Map;allChanges=new Set;caches={};currentCustomOperation=0;constructor(e,r,n){this.ref=e,this.setParent(r,n)}setParent(e,r,n){if(this.indexes||(this.indexes=this.ref instanceof we?this.ref._definition.indexes:{}),this.parent=e,this.parentIndex=n,!!r)if(this.root=r,this.ref instanceof we){let s=this.ref._definition;for(let i in s.schema){let o=this.ref[i];if(o&&o.$changes){let c=s.indexes[i];o.$changes.setParent(this.ref,r,c)}}}else typeof this.ref=="object"&&this.ref.forEach((s,i)=>{if(s instanceof we){let o=s.$changes,c=this.ref.$changes.indexes[i];o.setParent(this.ref,this.root,c)}})}operation(e){this.changes.set(--this.currentCustomOperation,e)}change(e,r=$.ADD){let n=typeof e=="number"?e:this.indexes[e];this.assertValidIndex(n,e);let s=this.changes.get(n);(!s||s.op===$.DELETE||s.op===$.TOUCH)&&this.changes.set(n,{op:s&&s.op===$.DELETE?$.DELETE_AND_ADD:r,index:n}),this.allChanges.add(n),this.changed=!0,this.touchParents()}touch(e){let r=typeof e=="number"?e:this.indexes[e];this.assertValidIndex(r,e),this.changes.has(r)||this.changes.set(r,{op:$.TOUCH,index:r}),this.allChanges.add(r),this.touchParents()}touchParents(){this.parent&&this.parent.$changes.touch(this.parentIndex)}getType(e){if(this.ref._definition){let r=this.ref._definition;return r.schema[r.fieldsByIndex[e]]}else{let r=this.parent._definition,n=r.schema[r.fieldsByIndex[this.parentIndex]];return Object.values(n)[0]}}getChildrenFilter(){let e=this.parent._definition.childFilters;return e&&e[this.parentIndex]}getValue(e){return this.ref.getByIndex(e)}delete(e){let r=typeof e=="number"?e:this.indexes[e];if(r===void 0){console.warn(`@colyseus/schema ${this.ref.constructor.name}: trying to delete non-existing index: ${e} (${r})`);return}let n=this.getValue(r);this.changes.set(r,{op:$.DELETE,index:r}),this.allChanges.delete(r),delete this.caches[r],n&&n.$changes&&(n.$changes.parent=void 0),this.changed=!0,this.touchParents()}discard(e=!1,r=!1){this.ref instanceof we||this.changes.forEach(n=>{if(n.op===$.DELETE){let s=this.ref.getIndex(n.index);delete this.indexes[s]}}),this.changes.clear(),this.changed=e,r&&this.allChanges.clear(),this.currentCustomOperation=0}discardAll(){this.changes.forEach(e=>{let r=this.getValue(e.index);r&&r.$changes&&r.$changes.discardAll()}),this.discard()}cache(e,r){this.caches[e]=r}clone(){return new t(this.ref,this.parent,this.root)}ensureRefId(){this.refId===void 0&&(this.refId=this.root.getNextUniqueId())}assertValidIndex(e,r){if(e===void 0)throw new Error(`ChangeTree: missing index for field "${r}"`)}};function Ie(t,e,r,n){return t[e]||(t[e]=[]),t[e].push(r),n?.forEach((s,i)=>r(s,i)),()=>Qm(t[e],t[e].indexOf(r))}function Vi(t){let e=typeof this.$changes.getType()!="string";this.$items.forEach((r,n)=>{t.push({refId:this.$changes.refId,op:$.DELETE,field:n,value:void 0,previousValue:r}),e&&this.$changes.root.removeRef(r.$changes.refId)})}function Qm(t,e){if(e===-1||e>=t.length)return!1;let r=t.length-1;for(let n=e;n<r;n++)t[n]=t[n+1];return t.length=r,!0}var vT=(t,e)=>{let r=t.toString(),n=e.toString();return r<n?-1:r>n?1:0};function bT(t){return t.$proxy=!0,t=new Proxy(t,{get:(e,r)=>typeof r!="symbol"&&!isNaN(r)?e.at(r):e[r],set:(e,r,n)=>{if(typeof r!="symbol"&&!isNaN(r)){let s=Array.from(e.$items.keys()),i=parseInt(s[r]||r);n==null?e.deleteAt(i):e.setAt(i,n)}else e[r]=n;return!0},deleteProperty:(e,r)=>(typeof r=="number"?e.deleteAt(r):delete e[r],!0)}),t}var bt=class t{$changes=new br(this);$items=new Map;$indexes=new Map;$refId=0;$callbacks;onAdd(e,r=!0){return Ie(this.$callbacks||(this.$callbacks=[]),$.ADD,e,r?this.$items:void 0)}onRemove(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.DELETE,e)}onChange(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.REPLACE,e)}static is(e){return Array.isArray(e)||e.array!==void 0}constructor(...e){this.push.apply(this,e)}set length(e){e===0?this.clear():this.splice(e,this.length-e)}get length(){return this.$items.size}push(...e){let r;return e.forEach(n=>{r=this.$refId++,this.setAt(r,n)}),r}pop(){let e=Array.from(this.$indexes.values()).pop();if(e===void 0)return;this.$changes.delete(e),this.$indexes.delete(e);let r=this.$items.get(e);return this.$items.delete(e),r}at(e){let r=Array.from(this.$items.keys())[e];return this.$items.get(r)}setAt(e,r){r.$changes!==void 0&&r.$changes.setParent(this,this.$changes.root,e);let n=this.$changes.indexes[e]?.op??$.ADD;this.$changes.indexes[e]=e,this.$indexes.set(e,e),this.$items.set(e,r),this.$changes.change(e,n)}deleteAt(e){let r=Array.from(this.$items.keys())[e];return r===void 0?!1:this.$deleteAt(r)}$deleteAt(e){return this.$changes.delete(e),this.$indexes.delete(e),this.$items.delete(e)}clear(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Vi.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:$.CLEAR}),this.$changes.touchParents()}concat(...e){return new t(...Array.from(this.$items.values()).concat(...e))}join(e){return Array.from(this.$items.values()).join(e)}reverse(){let e=Array.from(this.$items.keys());return Array.from(this.$items.values()).reverse().forEach((n,s)=>{this.setAt(e[s],n)}),this}shift(){let r=Array.from(this.$items.keys()).shift();if(r===void 0)return;let n=this.$items.get(r);return this.$deleteAt(r),n}slice(e,r){let n=new t;return n.push(...Array.from(this.$items.values()).slice(e,r)),n}sort(e=vT){let r=Array.from(this.$items.keys());return Array.from(this.$items.values()).sort(e).forEach((s,i)=>{this.setAt(r[i],s)}),this}splice(e,r=this.length-e,...n){let s=Array.from(this.$items.keys()),i=[];for(let o=e;o<e+r;o++)i.push(this.$items.get(s[o])),this.$deleteAt(s[o]);return i}unshift(...e){let r=this.length,n=e.length,s=Array.from(this.$items.values());return e.forEach((i,o)=>{this.setAt(o,i)}),s.forEach((i,o)=>{this.setAt(n+o,i)}),r+n}indexOf(e,r){return Array.from(this.$items.values()).indexOf(e,r)}lastIndexOf(e,r=this.length-1){return Array.from(this.$items.values()).lastIndexOf(e,r)}every(e,r){return Array.from(this.$items.values()).every(e,r)}some(e,r){return Array.from(this.$items.values()).some(e,r)}forEach(e,r){Array.from(this.$items.values()).forEach(e,r)}map(e,r){return Array.from(this.$items.values()).map(e,r)}filter(e,r){return Array.from(this.$items.values()).filter(e,r)}reduce(e,r){return Array.prototype.reduce.apply(Array.from(this.$items.values()),arguments)}reduceRight(e,r){return Array.prototype.reduceRight.apply(Array.from(this.$items.values()),arguments)}find(e,r){return Array.from(this.$items.values()).find(e,r)}findIndex(e,r){return Array.from(this.$items.values()).findIndex(e,r)}fill(e,r,n){throw new Error("ArraySchema#fill() not implemented")}copyWithin(e,r,n){throw new Error("ArraySchema#copyWithin() not implemented")}toString(){return this.$items.toString()}toLocaleString(){return this.$items.toLocaleString()}[Symbol.iterator](){return Array.from(this.$items.values())[Symbol.iterator]()}[Symbol.unscopables];entries(){return this.$items.entries()}keys(){return this.$items.keys()}values(){return this.$items.values()}includes(e,r){return Array.from(this.$items.values()).includes(e,r)}flatMap(e,r){throw new Error("ArraySchema#flatMap() is not supported.")}flat(e){throw new Error("ArraySchema#flat() is not supported.")}findLast(){let e=Array.from(this.$items.values());return e.findLast.apply(e,arguments)}findLastIndex(...e){let r=Array.from(this.$items.values());return r.findLastIndex.apply(r,arguments)}setIndex(e,r){this.$indexes.set(e,r)}getIndex(e){return this.$indexes.get(e)}getByIndex(e){return this.$items.get(this.$indexes.get(e))}deleteByIndex(e){let r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)}toArray(){return Array.from(this.$items.values())}toJSON(){return this.toArray().map(e=>typeof e.toJSON=="function"?e.toJSON():e)}clone(e){let r;return e?r=new t(...Array.from(this.$items.values())):r=new t(...this.map(n=>n.$changes?n.clone():n)),r}};function xT(t){return t.$proxy=!0,t=new Proxy(t,{get:(e,r)=>typeof r!="symbol"&&typeof e[r]>"u"?e.get(r):e[r],set:(e,r,n)=>(typeof r!="symbol"&&r.indexOf("$")===-1&&r!=="onAdd"&&r!=="onRemove"&&r!=="onChange"?e.set(r,n):e[r]=n,!0),deleteProperty:(e,r)=>(e.delete(r),!0)}),t}var We=class t{$changes=new br(this);$items=new Map;$indexes=new Map;$refId=0;$callbacks;onAdd(e,r=!0){return Ie(this.$callbacks||(this.$callbacks=[]),$.ADD,e,r?this.$items:void 0)}onRemove(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.DELETE,e)}onChange(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.REPLACE,e)}static is(e){return e.map!==void 0}constructor(e){if(e)if(e instanceof Map||e instanceof t)e.forEach((r,n)=>this.set(n,r));else for(let r in e)this.set(r,e[r])}[Symbol.iterator](){return this.$items[Symbol.iterator]()}get[Symbol.toStringTag](){return this.$items[Symbol.toStringTag]}set(e,r){if(r==null)throw new Error(`MapSchema#set('${e}', ${r}): trying to set ${r} value on '${e}'.`);let n=typeof this.$changes.indexes[e]<"u",s=n?this.$changes.indexes[e]:this.$refId++,i=n?$.REPLACE:$.ADD,o=r.$changes!==void 0;return o&&r.$changes.setParent(this,this.$changes.root,s),n?o&&this.$items.get(e)!==r&&(i=$.ADD):(this.$changes.indexes[e]=s,this.$indexes.set(s,e)),this.$items.set(e,r),this.$changes.change(e,i),this}get(e){return this.$items.get(e)}delete(e){return this.$changes.delete(e),this.$items.delete(e)}clear(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Vi.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:$.CLEAR}),this.$changes.touchParents()}has(e){return this.$items.has(e)}forEach(e){this.$items.forEach(e)}entries(){return this.$items.entries()}keys(){return this.$items.keys()}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(e,r){this.$indexes.set(e,r)}getIndex(e){return this.$indexes.get(e)}getByIndex(e){return this.$items.get(this.$indexes.get(e))}deleteByIndex(e){let r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)}toJSON(){let e={};return this.forEach((r,n)=>{e[n]=typeof r.toJSON=="function"?r.toJSON():r}),e}clone(e){let r;return e?r=Object.assign(new t,this):(r=new t,this.forEach((n,s)=>{n.$changes?r.set(s,n.clone()):r.set(s,n)})),r}},Ym={};function Gi(t,e){Ym[t]=e}function Bi(t){return Ym[t]}var Fi=class t{schema;indexes={};fieldsByIndex={};filters;indexesWithFilters;childFilters;deprecated={};descriptors={};static create(e){let r=new t;return r.schema=Object.assign({},e&&e.schema||{}),r.indexes=Object.assign({},e&&e.indexes||{}),r.fieldsByIndex=Object.assign({},e&&e.fieldsByIndex||{}),r.descriptors=Object.assign({},e&&e.descriptors||{}),r.deprecated=Object.assign({},e&&e.deprecated||{}),r}addField(e,r){let n=this.getNextFieldIndex();this.fieldsByIndex[n]=e,this.indexes[e]=n,this.schema[e]=Array.isArray(r)?{array:r[0]}:r}hasField(e){return this.indexes[e]!==void 0}addFilter(e,r){return this.filters||(this.filters={},this.indexesWithFilters=[]),this.filters[this.indexes[e]]=r,this.indexesWithFilters.push(this.indexes[e]),!0}addChildrenFilter(e,r){let n=this.indexes[e],s=this.schema[e];if(Bi(Object.keys(s)[0]))return this.childFilters||(this.childFilters={}),this.childFilters[n]=r,!0;console.warn(`@filterChildren: field '${e}' can't have children. Ignoring filter.`)}getChildrenFilter(e){return this.childFilters&&this.childFilters[this.indexes[e]]}getNextFieldIndex(){return Object.keys(this.schema||{}).length}};var Jn=class t{types={};schemas=new Map;useFilters=!1;has(e){return this.schemas.has(e)}get(e){return this.types[e]}add(e,r=this.schemas.size){e._definition=Fi.create(e._definition),e._typeid=r,this.types[r]=e,this.schemas.set(e,r)}static create(e={}){return function(r){return e.context||(e.context=new t),Ne(r,e)}}},ST=new Jn;function Ne(t,e={}){return function(r,n){let s=e.context||ST,i=r.constructor;if(i._context=s,!t)throw new Error(`${i.name}: @type() reference provided for "${n}" is undefined. Make sure you don't have any circular dependencies.`);s.has(i)||s.add(i);let o=i._definition;if(o.addField(n,t),o.descriptors[n]){if(o.deprecated[n])return;try{throw new Error(`@colyseus/schema: Duplicate '${n}' definition on '${i.name}'.
Check @type() annotation`)}catch(a){let f=a.stack.split(`
`)[4].trim();throw new Error(`${a.message} ${f}`)}}let c=bt.is(t),l=!c&&We.is(t);if(typeof t!="string"&&!we.is(t)){let a=Object.values(t)[0];typeof a!="string"&&!s.has(a)&&s.add(a)}if(e.manual){o.descriptors[n]={enumerable:!0,configurable:!0,writable:!0};return}let u=`_${n}`;o.descriptors[u]={enumerable:!1,configurable:!1,writable:!0},o.descriptors[n]={get:function(){return this[u]},set:function(a){a!==this[u]&&(a!=null?(c&&!(a instanceof bt)&&(a=new bt(...a)),l&&!(a instanceof We)&&(a=new We(a)),a.$proxy===void 0&&(l?a=xT(a):c&&(a=bT(a))),this.$changes.change(n),a.$changes&&a.$changes.setParent(this,this.$changes.root,this._definition.indexes[n])):this[u]&&this.$changes.delete(n),this[u]=a)},enumerable:!0,configurable:!0}}}function wT(t){for(var e=0,r=0,n=0,s=t.length;n<s;n++)e=t.charCodeAt(n),e<128?r+=1:e<2048?r+=2:e<55296||e>=57344?r+=3:(n++,r+=4);return r}function Km(t,e,r){for(var n=0,s=0,i=r.length;s<i;s++)n=r.charCodeAt(s),n<128?t[e++]=n:n<2048?(t[e++]=192|n>>6,t[e++]=128|n&63):n<55296||n>=57344?(t[e++]=224|n>>12,t[e++]=128|n>>6&63,t[e++]=128|n&63):(s++,n=65536+((n&1023)<<10|r.charCodeAt(s)&1023),t[e++]=240|n>>18,t[e++]=128|n>>12&63,t[e++]=128|n>>6&63,t[e++]=128|n&63)}function Xm(t,e){t.push(e&255)}function Se(t,e){t.push(e&255)}function Zm(t,e){t.push(e&255),t.push(e>>8&255)}function ul(t,e){t.push(e&255),t.push(e>>8&255)}function Qn(t,e){t.push(e&255),t.push(e>>8&255),t.push(e>>16&255),t.push(e>>24&255)}function xr(t,e){let r=e>>24,n=e>>16,s=e>>8,i=e;t.push(i&255),t.push(s&255),t.push(n&255),t.push(r&255)}function e_(t,e){let r=Math.floor(e/Math.pow(2,32)),n=e>>>0;xr(t,n),xr(t,r)}function t_(t,e){let r=e/Math.pow(2,32)>>0,n=e>>>0;xr(t,n),xr(t,r)}function OT(t,e){r_(t,e)}function ET(t,e){ll(t,e)}var Yn=new Int32Array(2),kT=new Float32Array(Yn.buffer),CT=new Float64Array(Yn.buffer);function r_(t,e){kT[0]=e,Qn(t,Yn[0])}function ll(t,e){CT[0]=e,Qn(t,Yn[0]),Qn(t,Yn[1])}function PT(t,e){return Se(t,e?1:0)}function qi(t,e){e||(e="");let r=wT(e),n=0;if(r<32)t.push(r|160),n=1;else if(r<256)t.push(217),Se(t,r),n=2;else if(r<65536)t.push(218),ul(t,r),n=3;else if(r<4294967296)t.push(219),xr(t,r),n=5;else throw new Error("String too long");return Km(t,t.length,e),n+r}function Ae(t,e){if(isNaN(e))return Ae(t,0);if(isFinite(e)){if(e!==(e|0))return t.push(203),ll(t,e),9}else return Ae(t,e>0?Number.MAX_SAFE_INTEGER:-Number.MAX_SAFE_INTEGER);return e>=0?e<128?(Se(t,e),1):e<256?(t.push(204),Se(t,e),2):e<65536?(t.push(205),ul(t,e),3):e<4294967296?(t.push(206),xr(t,e),5):(t.push(207),t_(t,e),9):e>=-32?(t.push(224|e+32),1):e>=-128?(t.push(208),Xm(t,e),2):e>=-32768?(t.push(209),Zm(t,e),3):e>=-2147483648?(t.push(210),Qn(t,e),5):(t.push(211),e_(t,e),9)}var n_=Object.freeze({__proto__:null,utf8Write:Km,int8:Xm,uint8:Se,int16:Zm,uint16:ul,int32:Qn,uint32:xr,int64:e_,uint64:t_,float32:OT,float64:ET,writeFloat32:r_,writeFloat64:ll,boolean:PT,string:qi,number:Ae});function AT(t,e,r){for(var n="",s=0,i=e,o=e+r;i<o;i++){var c=t[i];if(!(c&128)){n+=String.fromCharCode(c);continue}if((c&224)===192){n+=String.fromCharCode((c&31)<<6|t[++i]&63);continue}if((c&240)===224){n+=String.fromCharCode((c&15)<<12|(t[++i]&63)<<6|(t[++i]&63)<<0);continue}if((c&248)===240){s=(c&7)<<18|(t[++i]&63)<<12|(t[++i]&63)<<6|(t[++i]&63)<<0,s>=65536?(s-=65536,n+=String.fromCharCode((s>>>10)+55296,(s&1023)+56320)):n+=String.fromCharCode(s);continue}console.error("Invalid byte "+c.toString(16))}return n}function s_(t,e){return Zn(t,e)<<24>>24}function Zn(t,e){return t[e.offset++]}function i_(t,e){return Wi(t,e)<<16>>16}function Wi(t,e){return t[e.offset++]|t[e.offset++]<<8}function Sr(t,e){return t[e.offset++]|t[e.offset++]<<8|t[e.offset++]<<16|t[e.offset++]<<24}function rn(t,e){return Sr(t,e)>>>0}function IT(t,e){return fl(t,e)}function RT(t,e){return hl(t,e)}function o_(t,e){let r=rn(t,e);return Sr(t,e)*Math.pow(2,32)+r}function a_(t,e){let r=rn(t,e);return rn(t,e)*Math.pow(2,32)+r}var Kn=new Int32Array(2),TT=new Float32Array(Kn.buffer),MT=new Float64Array(Kn.buffer);function fl(t,e){return Kn[0]=Sr(t,e),TT[0]}function hl(t,e){return Kn[0]=Sr(t,e),Kn[1]=Sr(t,e),MT[0]}function DT(t,e){return Zn(t,e)>0}function c_(t,e){let r=t[e.offset++],n;r<192?n=r&31:r===217?n=Zn(t,e):r===218?n=Wi(t,e):r===219&&(n=rn(t,e));let s=AT(t,e.offset,n);return e.offset+=n,s}function $T(t,e){let r=t[e.offset];return r<192&&r>160||r===217||r===218||r===219}function vr(t,e){let r=t[e.offset++];if(r<128)return r;if(r===202)return fl(t,e);if(r===203)return hl(t,e);if(r===204)return Zn(t,e);if(r===205)return Wi(t,e);if(r===206)return rn(t,e);if(r===207)return a_(t,e);if(r===208)return s_(t,e);if(r===209)return i_(t,e);if(r===210)return Sr(t,e);if(r===211)return o_(t,e);if(r>223)return(255-r+1)*-1}function NT(t,e){let r=t[e.offset];return r<128||r>=202&&r<=211}function LT(t,e){return t[e.offset]<160}function u_(t,e){return t[e.offset-1]===255&&(t[e.offset]<128||t[e.offset]>=202&&t[e.offset]<=211)}var jT=Object.freeze({__proto__:null,int8:s_,uint8:Zn,int16:i_,uint16:Wi,int32:Sr,uint32:rn,float32:IT,float64:RT,int64:o_,uint64:a_,readFloat32:fl,readFloat64:hl,boolean:DT,string:c_,stringCheck:$T,number:vr,numberCheck:NT,arrayCheck:LT,switchStructureCheck:u_}),Ui=class t{$changes=new br(this);$items=new Map;$indexes=new Map;$refId=0;$callbacks;onAdd(e,r=!0){return Ie(this.$callbacks||(this.$callbacks=[]),$.ADD,e,r?this.$items:void 0)}onRemove(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.DELETE,e)}onChange(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.REPLACE,e)}static is(e){return e.collection!==void 0}constructor(e){e&&e.forEach(r=>this.add(r))}add(e){let r=this.$refId++;return e.$changes!==void 0&&e.$changes.setParent(this,this.$changes.root,r),this.$changes.indexes[r]=r,this.$indexes.set(r,r),this.$items.set(r,e),this.$changes.change(r),r}at(e){let r=Array.from(this.$items.keys())[e];return this.$items.get(r)}entries(){return this.$items.entries()}delete(e){let r=this.$items.entries(),n,s;for(;(s=r.next())&&!s.done;)if(e===s.value[1]){n=s.value[0];break}return n===void 0?!1:(this.$changes.delete(n),this.$indexes.delete(n),this.$items.delete(n))}clear(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Vi.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:$.CLEAR}),this.$changes.touchParents()}has(e){return Array.from(this.$items.values()).some(r=>r===e)}forEach(e){this.$items.forEach((r,n,s)=>e(r,n,this))}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(e,r){this.$indexes.set(e,r)}getIndex(e){return this.$indexes.get(e)}getByIndex(e){return this.$items.get(this.$indexes.get(e))}deleteByIndex(e){let r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)}toArray(){return Array.from(this.$items.values())}toJSON(){let e=[];return this.forEach((r,n)=>{e.push(typeof r.toJSON=="function"?r.toJSON():r)}),e}clone(e){let r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(n=>{n.$changes?r.add(n.clone()):r.add(n)})),r}},zi=class t{$changes=new br(this);$items=new Map;$indexes=new Map;$refId=0;$callbacks;onAdd(e,r=!0){return Ie(this.$callbacks||(this.$callbacks=[]),$.ADD,e,r?this.$items:void 0)}onRemove(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.DELETE,e)}onChange(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.REPLACE,e)}static is(e){return e.set!==void 0}constructor(e){e&&e.forEach(r=>this.add(r))}add(e){if(this.has(e))return!1;let r=this.$refId++;e.$changes!==void 0&&e.$changes.setParent(this,this.$changes.root,r);let n=this.$changes.indexes[r]?.op??$.ADD;return this.$changes.indexes[r]=r,this.$indexes.set(r,r),this.$items.set(r,e),this.$changes.change(r,n),r}entries(){return this.$items.entries()}delete(e){let r=this.$items.entries(),n,s;for(;(s=r.next())&&!s.done;)if(e===s.value[1]){n=s.value[0];break}return n===void 0?!1:(this.$changes.delete(n),this.$indexes.delete(n),this.$items.delete(n))}clear(e){this.$changes.discard(!0,!0),this.$changes.indexes={},this.$indexes.clear(),e&&Vi.call(this,e),this.$items.clear(),this.$changes.operation({index:0,op:$.CLEAR}),this.$changes.touchParents()}has(e){let r=this.$items.values(),n=!1,s;for(;(s=r.next())&&!s.done;)if(e===s.value){n=!0;break}return n}forEach(e){this.$items.forEach((r,n,s)=>e(r,n,this))}values(){return this.$items.values()}get size(){return this.$items.size}setIndex(e,r){this.$indexes.set(e,r)}getIndex(e){return this.$indexes.get(e)}getByIndex(e){return this.$items.get(this.$indexes.get(e))}deleteByIndex(e){let r=this.$indexes.get(e);this.$items.delete(r),this.$indexes.delete(e)}toArray(){return Array.from(this.$items.values())}toJSON(){let e=[];return this.forEach((r,n)=>{e.push(typeof r.toJSON=="function"?r.toJSON():r)}),e}clone(e){let r;return e?r=Object.assign(new t,this):(r=new t,this.forEach(n=>{n.$changes?r.add(n.clone()):r.add(n)})),r}},al=class t{refIds=new WeakSet;containerIndexes=new WeakMap;addRefId(e){this.refIds.has(e)||(this.refIds.add(e),this.containerIndexes.set(e,new Set))}static get(e){return e.$filterState===void 0&&(e.$filterState=new t),e.$filterState}},cl=class{refs=new Map;refCounts={};deletedRefs=new Set;nextUniqueId=0;getNextUniqueId(){return this.nextUniqueId++}addRef(e,r,n=!0){this.refs.set(e,r),n&&(this.refCounts[e]=(this.refCounts[e]||0)+1)}removeRef(e){this.refCounts[e]=this.refCounts[e]-1,this.deletedRefs.add(e)}clearRefs(){this.refs.clear(),this.deletedRefs.clear(),this.refCounts={}}garbageCollectDeletedRefs(){this.deletedRefs.forEach(e=>{if(this.refCounts[e]>0)return;let r=this.refs.get(e);if(r instanceof we)for(let n in r._definition.schema)typeof r._definition.schema[n]!="string"&&r[n]&&r[n].$changes&&this.removeRef(r[n].$changes.refId);else{let n=r.$changes.parent._definition,s=n.schema[n.fieldsByIndex[r.$changes.parentIndex]];typeof Object.values(s)[0]=="function"&&Array.from(r.values()).forEach(i=>this.removeRef(i.$changes.refId))}this.refs.delete(e),delete this.refCounts[e]}),this.deletedRefs.clear()}},Xn=class extends Error{};function qT(t,e,r,n){let s,i=!1;switch(e){case"number":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":case"int64":case"uint64":case"float32":case"float64":s="number",isNaN(t)&&console.log(`trying to encode "NaN" in ${r.constructor.name}#${n}`);break;case"string":s="string",i=!0;break;case"boolean":return}if(typeof t!==s&&(!i||i&&t!==null)){let o=`'${JSON.stringify(t)}'${t&&t.constructor&&` (${t.constructor.name})`||""}`;throw new Xn(`a '${s}' was expected, but ${o} was provided in ${r.constructor.name}#${n}`)}}function Jm(t,e,r,n){if(!(t instanceof e))throw new Xn(`a '${e.name}' was expected, but '${t.constructor.name}' was provided in ${r.constructor.name}#${n}`)}function BT(t,e,r,n,s){qT(r,t,n,s);let i=n_[t];if(i)i(e,r);else throw new Xn(`a '${t}' was expected, but ${r} was provided in ${n.constructor.name}#${s}`)}function FT(t,e,r){return jT[t](e,r)}var we=class t{static _typeid;static _context;static _definition=Fi.create();static onError(e){console.error(e)}static is(e){return e._definition&&e._definition.schema!==void 0}$changes;$callbacks;onChange(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.REPLACE,e)}onRemove(e){return Ie(this.$callbacks||(this.$callbacks=[]),$.DELETE,e)}constructor(...e){Object.defineProperties(this,{$changes:{value:new br(this,void 0,new cl),enumerable:!1,writable:!0},$callbacks:{value:void 0,enumerable:!1,writable:!0}});let r=this._definition.descriptors;r&&Object.defineProperties(this,r),e[0]&&this.assign(e[0])}assign(e){return Object.assign(this,e),this}get _definition(){return this.constructor._definition}setDirty(e,r){this.$changes.change(e,r)}listen(e,r,n=!0){return this.$callbacks||(this.$callbacks={}),this.$callbacks[e]||(this.$callbacks[e]=[]),this.$callbacks[e].push(r),n&&this[e]!==void 0&&r(this[e],void 0),()=>Qm(this.$callbacks[e],this.$callbacks[e].indexOf(r))}decode(e,r={offset:0},n=this){let s=[],i=this.$changes.root,o=e.length,c=0;for(i.refs.set(c,this);r.offset<o;){let l=e[r.offset++];if(l==255){c=vr(e,r);let R=i.refs.get(c);if(!R)throw new Error(`"refId" not found: ${c}`);n=R;continue}let u=n.$changes,a=n._definition!==void 0,f=a?l>>6<<6:l;if(f===$.CLEAR){n.clear(s);continue}let h=a?l%(f||255):vr(e,r),d=a?n._definition.fieldsByIndex[h]:"",p=u.getType(h),y,m,S;if(a?m=n[`_${d}`]:(m=n.getByIndex(h),(f&$.ADD)===$.ADD?(S=n instanceof We?c_(e,r):h,n.setIndex(h,S)):S=n.getIndex(h)),(f&$.DELETE)===$.DELETE&&(f!==$.DELETE_AND_ADD&&n.deleteByIndex(h),m&&m.$changes&&i.removeRef(m.$changes.refId),y=null),d===void 0){console.warn("@colyseus/schema: definition mismatch");let R={offset:r.offset};for(;r.offset<o&&!(u_(e,r)&&(R.offset=r.offset+1,i.refs.has(vr(e,R))));)r.offset++;continue}else if(f!==$.DELETE)if(t.is(p)){let R=vr(e,r);if(y=i.refs.get(R),f!==$.REPLACE){let w=this.getSchemaType(e,r,p);y||(y=this.createTypeInstance(w),y.$changes.refId=R,m&&(y.$callbacks=m.$callbacks,m.$changes.refId&&R!==m.$changes.refId&&i.removeRef(m.$changes.refId))),i.addRef(R,y,y!==m)}}else if(typeof p=="string")y=FT(p,e,r);else{let R=Bi(Object.keys(p)[0]),w=vr(e,r),E=i.refs.has(w)?m||i.refs.get(w):new R.constructor;if(y=E.clone(!0),y.$changes.refId=w,m&&(y.$callbacks=m.$callbacks,m.$changes.refId&&w!==m.$changes.refId)){i.removeRef(m.$changes.refId);let C=m.entries(),T;for(;(T=C.next())&&!T.done;){let[O,P]=T.value;s.push({refId:w,op:$.DELETE,field:O,value:void 0,previousValue:P})}}i.addRef(w,y,E!==m)}if(y!=null){if(y.$changes&&y.$changes.setParent(u.ref,u.root,h),n instanceof t)n[d]=y;else if(n instanceof We){let R=S;n.$items.set(R,y),n.$changes.allChanges.add(h)}else if(n instanceof bt)n.setAt(h,y);else if(n instanceof Ui){let R=n.add(y);n.setIndex(h,R)}else if(n instanceof zi){let R=n.add(y);R!==!1&&n.setIndex(h,R)}}m!==y&&s.push({refId:c,op:f,field:d,dynamicIndex:S,value:y,previousValue:m})}return this._triggerChanges(s),i.garbageCollectDeletedRefs(),s}encode(e=!1,r=[],n=!1){let s=this.$changes,i=new WeakSet,o=[s],c=1;for(let l=0;l<c;l++){let u=o[l],a=u.ref,f=a instanceof t;u.ensureRefId(),i.add(u),u!==s&&(u.changed||e)&&(Se(r,255),Ae(r,u.refId));let h=e?Array.from(u.allChanges):Array.from(u.changes.values());for(let d=0,p=h.length;d<p;d++){let y=e?{op:$.ADD,index:h[d]}:h[d],m=y.index,S=f?a._definition.fieldsByIndex&&a._definition.fieldsByIndex[m]:m,R=r.length;if(y.op!==$.TOUCH)if(f)Se(r,m|y.op);else{if(Se(r,y.op),y.op===$.CLEAR)continue;Ae(r,m)}if(!f&&(y.op&$.ADD)==$.ADD&&a instanceof We){let C=u.ref.$indexes.get(m);qi(r,C)}if(y.op===$.DELETE)continue;let w=u.getType(m),E=u.getValue(m);if(E&&E.$changes&&!i.has(E.$changes)&&(o.push(E.$changes),E.$changes.ensureRefId(),c++),y.op!==$.TOUCH){if(t.is(w))Jm(E,w,a,S),Ae(r,E.$changes.refId),(y.op&$.ADD)===$.ADD&&this.tryEncodeTypeId(r,w,E.constructor);else if(typeof w=="string")BT(w,r,E,a,S);else{let C=Bi(Object.keys(w)[0]);Jm(a[`_${S}`],C.constructor,a,S),Ae(r,E.$changes.refId)}n&&u.cache(m,r.slice(R))}}!e&&!n&&u.discard()}return r}encodeAll(e){return this.encode(!0,[],e)}applyFilters(e,r=!1){let n=this,s=new Set,i=al.get(e),o=[this.$changes],c=1,l=[];for(let u=0;u<c;u++){let a=o[u];if(s.has(a.refId))continue;let f=a.ref,h=f instanceof t;Se(l,255),Ae(l,a.refId);let d=i.refIds.has(a),p=r||!d;i.addRefId(a);let y=i.containerIndexes.get(a),m=p?Array.from(a.allChanges):Array.from(a.changes.values());!r&&h&&f._definition.indexesWithFilters&&f._definition.indexesWithFilters.forEach(R=>{!y.has(R)&&a.allChanges.has(R)&&(p?m.push(R):m.push({op:$.ADD,index:R}))});for(let S=0,R=m.length;S<R;S++){let w=p?{op:$.ADD,index:m[S]}:m[S];if(w.op===$.CLEAR){Se(l,w.op);continue}let E=w.index;if(w.op===$.DELETE){h?Se(l,w.op|E):(Se(l,w.op),Ae(l,E));continue}let C=a.getValue(E),T=a.getType(E);if(h){let O=f._definition.filters&&f._definition.filters[E];if(O&&!O.call(f,e,C,n)){C&&C.$changes&&s.add(C.$changes.refId);continue}}else{let O=a.parent,P=a.getChildrenFilter();if(P&&!P.call(O,e,f.$indexes.get(E),C,n)){C&&C.$changes&&s.add(C.$changes.refId);continue}}if(C.$changes&&(o.push(C.$changes),c++),w.op!==$.TOUCH)if(w.op===$.ADD||h)l.push.apply(l,a.caches[E]??[]),y.add(E);else if(y.has(E))l.push.apply(l,a.caches[E]??[]);else{if(y.add(E),Se(l,$.ADD),Ae(l,E),f instanceof We){let O=a.ref.$indexes.get(E);qi(l,O)}C.$changes?Ae(l,C.$changes.refId):n_[T](l,C)}else if(C.$changes&&!h){if(Se(l,$.ADD),Ae(l,E),f instanceof We){let O=a.ref.$indexes.get(E);qi(l,O)}Ae(l,C.$changes.refId)}}}return l}clone(){let e=new this.constructor,r=this._definition.schema;for(let n in r)typeof this[n]=="object"&&typeof this[n]?.clone=="function"?e[n]=this[n].clone():e[n]=this[n];return e}toJSON(){let e=this._definition.schema,r=this._definition.deprecated,n={};for(let s in e)!r[s]&&this[s]!==null&&typeof this[s]<"u"&&(n[s]=typeof this[s].toJSON=="function"?this[s].toJSON():this[`_${s}`]);return n}discardAllChanges(){this.$changes.discardAll()}getByIndex(e){return this[this._definition.fieldsByIndex[e]]}deleteByIndex(e){this[this._definition.fieldsByIndex[e]]=void 0}tryEncodeTypeId(e,r,n){r._typeid!==n._typeid&&(Se(e,213),Ae(e,n._typeid))}getSchemaType(e,r,n){let s;return e[r.offset]===213&&(r.offset++,s=this.constructor._context.get(vr(e,r))),s||n}createTypeInstance(e){let r=new e;return r.$changes.root=this.$changes.root,r}_triggerChanges(e){let r=new Set,n=this.$changes.root.refs;for(let s=0;s<e.length;s++){let i=e[s],o=i.refId,c=n.get(o),l=c.$callbacks;if((i.op&$.DELETE)===$.DELETE&&i.previousValue instanceof t&&i.previousValue.$callbacks?.[$.DELETE]?.forEach(u=>u()),!!l){if(c instanceof t){if(!r.has(o))try{l?.[$.REPLACE]?.forEach(u=>u(e))}catch(u){t.onError(u)}try{l.hasOwnProperty(i.field)&&l[i.field]?.forEach(u=>u(i.value,i.previousValue))}catch(u){t.onError(u)}}else i.op===$.ADD&&i.previousValue===void 0?l[$.ADD]?.forEach(u=>u(i.value,i.dynamicIndex??i.field)):i.op===$.DELETE?i.previousValue!==void 0&&l[$.DELETE]?.forEach(u=>u(i.previousValue,i.dynamicIndex??i.field)):i.op===$.DELETE_AND_ADD&&(i.previousValue!==void 0&&l[$.DELETE]?.forEach(u=>u(i.previousValue,i.dynamicIndex??i.field)),l[$.ADD]?.forEach(u=>u(i.value,i.dynamicIndex??i.field))),i.value!==i.previousValue&&l[$.REPLACE]?.forEach(u=>u(i.value,i.dynamicIndex??i.field));r.add(o)}}}};function Or(t,e,r,n){var s=arguments.length,i=s<3?e:n===null?n=Object.getOwnPropertyDescriptor(e,r):n,o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")i=Reflect.decorate(t,e,r,n);else for(var c=t.length-1;c>=0;c--)(o=t[c])&&(i=(s<3?o(i):s>3?o(e,r,i):o(e,r))||i);return s>3&&i&&Object.defineProperty(e,r,i),i}var Er={context:new Jn},wr=class extends we{name;type;referencedType};Or([Ne("string",Er)],wr.prototype,"name",void 0);Or([Ne("string",Er)],wr.prototype,"type",void 0);Or([Ne("number",Er)],wr.prototype,"referencedType",void 0);var nn=class extends we{id;fields=new bt};Or([Ne("number",Er)],nn.prototype,"id",void 0);Or([Ne([wr],Er)],nn.prototype,"fields",void 0);var Hi=class t extends we{types=new bt;rootType;static encode(e){let r=e.constructor,n=new t;n.rootType=r._typeid;let s=(o,c)=>{for(let l in c){let u=new wr;u.name=l;let a;if(typeof c[l]=="string")a=c[l];else{let f=c[l],h;we.is(f)?(a="ref",h=c[l]):(a=Object.keys(f)[0],typeof f[a]=="string"?a+=":"+f[a]:h=f[a]),u.referencedType=h?h._typeid:-1}u.type=a,o.fields.push(u)}n.types.push(o)},i=r._context.types;for(let o in i){let c=new nn;c.id=Number(o),s(c,i[o]._definition.schema)}return n.encodeAll()}static decode(e,r){let n=new Jn,s=new t;s.decode(e,r);let i=s.types.reduce((l,u)=>{let a=class extends we{},f=u.id;return l[f]=a,n.add(a,f),l},{});s.types.forEach(l=>{let u=i[l.id];l.fields.forEach(a=>{if(a.referencedType!==void 0){let f=a.type,h=i[a.referencedType];if(!h){let d=a.type.split(":");f=d[0],h=d[1]}f==="ref"?Ne(h,{context:n})(u.prototype,a.name):Ne({[f]:h},{context:n})(u.prototype,a.name)}else Ne(a.type,{context:n})(u.prototype,a.name)})});let o=i[s.rootType],c=new o;for(let l in o._definition.schema){let u=o._definition.schema[l];typeof u!="string"&&(c[l]=typeof u=="function"?new u:new(Bi(Object.keys(u)[0])).constructor)}return c}};Or([Ne([nn],Er)],Hi.prototype,"types",void 0);Or([Ne("number",Er)],Hi.prototype,"rootType",void 0);Gi("map",{constructor:We});Gi("array",{constructor:bt});Gi("set",{constructor:zi});Gi("collection",{constructor:Ui});var es=class extends we{constructor(){super(...arguments);this.mySynchronizedProperty="Hello world"}};pl([Ne("string")],es.prototype,"mySynchronizedProperty",2);var Ji=class extends l_.Room{constructor(){super(...arguments);this.maxClients=4}onCreate(r){this.setState(new es),this.onMessage("type",(n,s)=>{})}onJoin(r,n){console.log(r.sessionId,"joined!")}onLeave(r,n){console.log(r.sessionId,"left!")}onDispose(){console.log("room",this.roomId,"disposing...")}};var d_=(0,f_.default)({initializeGameServer:t=>{t.define("my_room",Ji)},initializeExpress:t=>{t.get("/hello_world",(e,r)=>{r.send("It's time to kick ass and chew bubblegum!")}),t.use("/colyseus",(0,h_.monitor)())},beforeListen:()=>{}});console.log(Cm);(0,p_.listen)(d_);
